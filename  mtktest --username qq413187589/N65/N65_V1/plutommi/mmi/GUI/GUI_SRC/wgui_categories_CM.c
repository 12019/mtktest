/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 *  wgui_categories_CM.c
 *
 * Project:
 * --------
 *  Maui_Software
 *
 * Description:
 * ------------
 *  Call Management related categories.
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_features.h"
#include "stdC.h"
#include "L4Dr1.h"
#include "MMIDataType.h"
#include "GlobalDefs.h"
#include "gui_data_types.h"
#include "CustDataProts.h"
#include "CustMenuRes.h"
#include "EventsDef.h"
#include "gui_themes.h"
#include "wgui.h"
#include "CustThemesRes.h"
#include "DebugInitDef.h"
#include "wgui_tab_bars.h"
#include "wgui_inputs.h"
#include "wgui_categories.h"
#include "wgui_softkeys.h"
#include "wgui_status_icons.h"
#include "wgui_categories_defs.h"
#include "wgui_categories_inputs.h"
#include "wgui_categories_idlescreen.h"
#include "wgui_categories_multimedia.h"
#include "wgui_categories_MM.h"
#include "wgui_categories_CM.h"
#include "CallManagementStruct.h"
#include "CallSetup.h"
#include "PhoneBookDef.h"
#include "gdi_include.h"
#include "lcd_if.h"
#include "wgui_draw_manager.h"
#include "app_mem.h"
#include "EditorPenGprot.h"

#ifdef __MMI_TOUCH_DIAL_SCREEN__
#include "wgui_touch_screen.h"
#include "gui_setting.h"
#include "IdleAppProt.h"
#if defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__)
#include "PhoneBookGprot.h"
#include "IdleAppDef.h"
#include "SimDetectionGprot.h"
#endif /* defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__) */ 
#include "CallStructureManagementProt.h"
#include "PsCallHelperGprot.h"
#endif /* __MMI_TOUCH_DIAL_SCREEN__ */ 

#ifdef __GDI_MEMORY_PROFILE_2__
#include "gdi_datatype.h"
#include "gdi_layer.h"
#endif /* __GDI_MEMORY_PROFILE_2__ */ 

#ifdef __MMI_VIDEO_PLAYER__
#include "ProfileGprots.h"      /* to set volume */
#include "mdi_datatype.h"
#include "mdi_audio.h"
#include "mdi_video.h"
#endif /* __MMI_VIDEO_PLAYER__ */ 

#ifdef __MMI_SWFLASH__
#include "mdi_datatype.h"
#include "mdi_swflash.h"
#include "swflashGprot.h"
#endif 

#ifdef __MMI_DUAL_SIM_MASTER__
#include "IncomingCallManagementProt.h"
#include "MTPNP_PFAL_CC.h"
#endif  /*__MMI_DUAL_SIM_MASTER__*/

#include "gpioInc.h"    /* 033105 Calvin added */

#define CATEGORY17_TEXT_SCROLL_WAIT (1000)
#define CM_TEXT_SCROLL_GAP    (32)
#define CM_TEXT_SCROLL_SIZE   (3)
#define CM_TEXT_SCROLL_TIME   (100)
#define CM_TEXT_SCROLL_WAIT   (1000)
#define CM_TEXT_SCROLL_X      (0)
#define CM_TEXT_SCROLL_Y      (20)

#if !defined(__MMI_TOUCH_DIAL_SCREEN__)
    #if defined(__MMI_MAINLCD_320X240__)
        #define MMI_CAT16_DIALING_BOX_BG_X      (58)
        #define MMI_CAT16_DIALING_BOX_BG_Y      (36)
    #elif defined(__MMI_MAINLCD_240X320__)
        #define MMI_CAT16_DIALING_BOX_BG_X      (0)
        #define MMI_CAT16_DIALING_BOX_BG_Y      (70)
    #elif defined(__MMI_MAINLCD_176X220__)
        #define MMI_CAT16_DIALING_BOX_BG_X      (0)
        #define MMI_CAT16_DIALING_BOX_BG_Y      (54)
    #endif
#endif /* !defined(__MMI_TOUCH_DIAL_SCREEN__) */

#if defined(__MMI_MAINLCD_320X240__)
    #define MMI_CM_MAX_IMG_HEIGHT   122
#elif defined(__MMI_MAINLCD_240X320__)
    #define MMI_CM_MAX_IMG_HEIGHT   199
#elif defined( __MMI_MAINLCD_176X220__)
    #define MMI_CM_MAX_IMG_HEIGHT   142
#elif defined(__MMI_MAINLCD_128X160__)
    #define MMI_CM_MAX_IMG_HEIGHT   80
#endif

#define WGUI_CM_DRAW_BG_AREA(x1, y1, x2, y2, c) \
    do                                          \
    {                                           \
        gdi_layer_push_clip();                  \
        gdi_layer_set_clip(x1, y1, x2, y2);     \
        gdi_draw_solid_rect(x1, y1, x2, y2, c); \
        gdi_layer_pop_clip();                   \
    } while (0)

/*-------------------------------
External Global variables
-------------------------------*/
extern BOOL r2lMMIFlag;
extern U16 on_idle_screen;
extern U16 gCurrLangIndex;  /* Need to Revise */

extern bitmap *current_LCD_device_bitmap;   /* Need to Revise */
extern bitmap main_LCD_device_bitmap;       /* Need to Revise */
extern bitmap sub_LCD_device_bitmap;        /* defined in wingui.c */

extern S32 wgui_image_clip_x1;
extern S32 wgui_image_clip_y1;
extern S32 wgui_image_clip_x2;
extern S32 wgui_image_clip_y2;
extern S32 _MMI_animated_icon_x;
extern S32 _MMI_animated_icon_y;

extern U8 gMMI_UI_U8_flag_1;
extern U8 gMMI_UI_U8_flag_2;
extern S16 status_icon;

extern PU8 _MMI_animated_icon;
extern U8 *_MMI_animated_icon_name;
extern S32 _MMI_animated_icon_x;
extern S32 _MMI_animated_icon_y;
extern UI_animated_image_handle _MMI_animated_icon_handle;
extern icontext_button MMI_softkeys[];

#ifdef __MMI_VIDEO_PLAYER__
extern mdi_video_info_struct wgui_video_info;
#endif 

#ifdef __MMI_SWFLASH__
extern mdi_swflash_info_struct wgui_swflash_info;
#endif 

#ifdef __GDI_MEMORY_PROFILE_2__
extern gdi_handle wgui_layer_1;
extern gdi_handle wgui_base_layer;
#endif /* __GDI_MEMORY_PROFILE_2__ */ 

extern S16 MMI_current_input_ext_type;

/*-------------------------------
External Global Functions
-------------------------------*/
extern MMI_BOOL GetCallTimeDisplay(void);
extern void (*_MMI_hide_fixed_list_menu) (void);
extern void (*wgui_dialer_inputbox_RSK_function) (void);    /* Store the clipping value of current image */
extern void dialer_inputbox_handle_multitap_complete(S32 type);
extern void close_dialer_inputbox(void);
extern void leave_idle_screen(void);
extern void wgui_setup_dialer_inputbox(
                S32 x,
                S32 y,
                S32 width,
                S32 height,
                U8 *buffer,
                S32 buffer_size,
                U16 category_screen_ID,
                UI_string_type RSK_label,
                PU8 RSK_icon,
                U8 *history_buffer,
                U32 flags);
extern void draw_wallpaper(void);
extern void idle_screen_hide_status_icons_bar0(void);
extern void idle_screen_hide_status_icons_bar1(void);
extern pBOOL GetShowAOC(void);
extern void wgui_show_transparent_animation(void);
extern void wgui_set_animation_image_y(S32 x, S32 y, PU8 img);
extern void dialer_inputbox_handle_multitap_star_key_up(void);
extern void get_dialer_inputbox_category_history(U16 history_ID, U8 *history_buffer);
extern void wgui_fill_rectangle_clip(S32 x1, S32 y1, S32 x2, S32 y2, color c);
extern U8 mmi_kbn_key_tone_hdlr(KEYBRD_MESSAGE *eventKey);

#ifdef __MMI_TOUCH_DIAL_SCREEN__
void setup_dialing_keypad(dialing_keypad_struct *dialing_keypad);
#endif 

#ifndef __MMI_MAINLCD_128X128__
extern void set_main_lcd_duration_position(U16 x, U16 y);
extern void dt_update_duration(void);
#endif /* __MMI_MAINLCD_128X128__ */ 

extern void redraw_call_cost_UI(void);
extern void reset_call_cost_UI(void);

extern void cat5_virtual_keypad_callback(void);
extern void cat33_hide_lsk(void);
extern void cat33_hide_rsk(void);
extern void wgui_clear_center_softkey(void);

#if defined(__MMI_SWFLASH__) || defined(__MMI_AVATAR__)
extern mdi_result SetupCat34Media(U16 bg_media_id, S8 *bg_media_filename);
#endif

#ifdef __MMI_T9__
#include "T9Main.h"
extern void InuptMethodEnterCategory5(void);
#elif defined __MMI_ZI__
extern void ZiInuptMethodEnterCategory5(void);
#elif defined __MMI_CSTAR__
#include "CStarHMI.h"
extern void CstarInputMethodEnterCategory5(void);
#elif defined __MMI_KA__
extern void KonkaInuptMethodEnterCategory5(void);
#elif defined __MMI_ITAP__
/* under construction !*/
#endif

/*-------------------------------
Global variables
-------------------------------*/
scrolling_text CM_scrolling_text;
#if defined(__MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
scrolling_text CM_mtpnpscrolling_text;
#endif  /*defined(__MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/

S32 CM_text_offset_x = 0;
S32 CM_text_width = 0;
S32 CM_text_height = 0;
S32 CM_x = 0;
S32 CM_y = 0;
S32 CM_n_frame = 0;
S32 CM_total_frames = 0;
U8 CM_Screen_show_date_time_bar = 0;
BOOL CM_need_change_clip = FALSE;
S8 CM_string_buf[(MAX_IP_NUMBER_LEN + MAX_DIGIT) * 2];
#if defined(__MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
S8 CM_mtpnpstring_buf[(MAX_IP_NUMBER_LEN + MAX_DIGIT) * 2];
#endif  /*defined(__MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/
U8* CM_media_buffer = NULL;

BOOL cat_momt_is_aud_enable = FALSE;
BOOL cat_momt_is_visual_update = FALSE;
BOOL cat_momt_is_video_open = FALSE;
BOOL cat_momt_is_video_play = FALSE;
BOOL cat_momt_is_swflash_open = FALSE;
BOOL cat_momt_is_swflash_play = FALSE;
BOOL cat_momt_is_avatar_play = FALSE;
BOOL cat_momt_is_play_aud_when_start = FALSE;
BOOL cat_momt_is_aud_muted = FALSE;
BOOL cat_momt_is_show_default = FALSE;

S16 cat_momt_repeat_count = 0;
U16 cat_momt_resource_id = 0;
U16 cat_momt_default_image_id = 0;
PS8 cat_momt_resource_filename = NULL;
U64 cat_momt_video_play_time = 0;
U64 cat_momt_swflash_play_time = 0;
wgui_cate_momt_res_type_enum cat_momt_resource_type = 0;

GDI_HANDLE MOMT_animation_handle = GDI_ERROR_HANDLE;
MMI_BOOL isCallDisconnecting = MMI_FALSE;

U16 gCallLine = 0;

/***************************************************************************** 
* Local Function
*****************************************************************************/
static void ShowMOMTCallScreen(
                U16 title_id,
                U16 left_softkey,
                U16 left_softkey_icon,
                U16 right_softkey,
                U16 right_softkey_icon,
                U16 NotificationStringId,
                PU8 NameOrNumber,
                PU8 IP_Number,
                U16 CallLine,
                U16 default_image_id,
                U16 resource_id,
                PS8 resource_filename,
                wgui_cate_momt_res_type_enum resource_type,
                U16 repeat_count,              /* video only. 0 means infinite loop */ 
                BOOL is_visaul_update,         /* video only. update to LCM */ 
                BOOL is_video_aud,             /* video only. eanble video's audio */ 
                BOOL is_play_aud_when_start,   /* video only. play video's audio when start */ 
                PU8 history_buffer);

#if defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
static void ShowMOMTCallBothScreen(
                U16 title_id,
                U16 left_softkey,
                U16 left_softkey_icon,
                U16 right_softkey,
                U16 right_softkey_icon,
                U16 NotificationStringId,
                PU8 NameOrNumber,
                PU8 SlaveNameOrNumber,
                PU8 IP_Number,
                U16 CallLine,
                U16 default_image_id,
                U16 resource_id,
                PS8 resource_filename,
                wgui_cate_momt_res_type_enum resource_type,
                U16 repeat_count,            /* video/swflash only. 0 means infinite loop */
                BOOL is_visaul_update,       /* video/swflash only. update to LCM */
                BOOL is_aud_enable,          /* video/swflash only. play video's audio */
                BOOL is_play_aud_when_start, /* video/swflash only. play audio when start */
                PU8 history_buffer);
#endif   /*#if defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/

static void RedrawMOMTCallScreen(void);
static void ExitMOMTCallScreen(void);
static void SetMOMTCallImageClip(S32 image_width, S32 image_height);

#if 0//def __MMI_VIDEO_PLAYER__//110606 compile warning
/* under construction !*/
#endif 

#ifdef __MMI_SWFLASH__
static void MOMTPlaySWFlashResultCallback(MDI_RESULT result);
#endif 

static void DrawMOMTCallScreenControllArea(dm_coordinates *coordinate);


/*****************************************************************************
 * FUNCTION
 *  CM_scrolling_text_timer_callback
 * DESCRIPTION
 *  callback function when scrolling text timer expires
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void CM_scrolling_text_timer_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_handle_scrolling_text(&CM_scrolling_text);
}   /* end of CM_scrolling_text_timer_callback */

#if defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
/*****************************************************************************
 * FUNCTION
 *  CM_mtpnpscrolling_text_timer_callback
 * DESCRIPTION
 *  callback function when scrolling text timer expires
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void CM_mtpnpscrolling_text_timer_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_handle_scrolling_text(&CM_mtpnpscrolling_text);
}   /* end of CM_scrolling_text_timer_callback */
#endif  /*defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/

/*****************************************************************************
 * FUNCTION
 *  handle_CM_text_scroll
 * DESCRIPTION
 *  handle the text scrolling of CM screens
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void handle_CM_text_scroll(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    GDI_HANDLE previous_act_lcd = GDI_NULL_HANDLE;
    color bc = gui_color(0, 0, 0);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_lcd_get_active(&previous_act_lcd);

    UI_set_main_LCD_graphics_context();
    gdi_layer_push_clip();
    gui_set_text_color(bc);
    gui_set_font(current_UI_theme->multi_line_input_box_theme->text_font);

    if (r2lMMIFlag)
    {
        CM_text_offset_x += CM_TEXT_SCROLL_SIZE;
        if ((CM_TEXT_SCROLL_X + CM_text_offset_x) >= (CM_text_width + CM_TEXT_SCROLL_GAP))
        {
            CM_text_offset_x = CM_TEXT_SCROLL_X;
        }
    }
    else
    {
        CM_text_offset_x -= CM_TEXT_SCROLL_SIZE;
        if ((CM_text_offset_x + CM_text_width + CM_TEXT_SCROLL_GAP) < CM_TEXT_SCROLL_X)
        {
            CM_text_offset_x = CM_TEXT_SCROLL_X;
        }
    }

    gdi_layer_set_clip(0, CM_y, UI_device_width - 1, CM_y + CM_text_height - 1);
    
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, current_MMI_theme->CM_screen_background_filler);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_draw_solid_rect(0, 0, UI_device_width - 1, UI_device_height - 1, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

    if (r2lMMIFlag)
    {
        gui_move_text_cursor(CM_text_offset_x + UI_device_width, CM_y);
    }
    else
    {
        gui_move_text_cursor(CM_text_offset_x, CM_y);
    }

    gui_print_text(MMI_message_string);

    if (r2lMMIFlag)
    {
        gui_move_text_cursor(CM_text_offset_x - (CM_text_width + CM_TEXT_SCROLL_GAP), CM_y);
    }
    else
    {
        if ((CM_text_offset_x + CM_text_width + CM_TEXT_SCROLL_GAP) < UI_device_width)
        {
            gui_move_text_cursor(CM_text_offset_x + CM_text_width + CM_TEXT_SCROLL_GAP, CM_y);
        }
    }

    gui_print_text(MMI_message_string);

    gui_start_timer(CM_TEXT_SCROLL_TIME, handle_CM_text_scroll);
    gdi_layer_pop_clip();
    gdi_layer_blt_previous(0, CM_y, UI_device_width - 1, CM_y + CM_text_height - 1);

    gdi_lcd_get_active(&previous_act_lcd);
    if (previous_act_lcd == GDI_LCD_MAIN_LCD_HANDLE)
    {
        UI_set_main_LCD_graphics_context();
    }
    else if (previous_act_lcd == GDI_LCD_SUB_LCD_HANDLE)
    {
        UI_set_sub_LCD_graphics_context();
    }

}   /* end of handle_CM_text_scroll */


/*****************************************************************************
 * FUNCTION
 *  CM_screens_hide_status_icons
 * DESCRIPTION
 *  Hide status icons function used in CM screens.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void CM_screens_hide_status_icons(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    //color c = gui_color(216, 212, 212);//*current_MMI_theme->statusbar0_background_color;
    UI_filled_area *f = current_MMI_theme->status_icon_bar_filler;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_draw_filled_area(0, 0, UI_device_width - 1, MMI_STATUS_BAR_HEIGHT, f);
    //wgui_fill_rectangle_clip(0, 0, UI_device_width - 1, MMI_STATUS_BAR_HEIGHT, c);
}   /* end of CM_screens_hide_status_icons */


/*****************************************************************************
 * FUNCTION
 *  CM_screens_hide_date_time_display
 * DESCRIPTION
 *  Hide date/time function used in CM screens.
 * PARAMETERS
 *  x1      [IN]        Start x position
 *  y1      [IN]        Start y position
 *  x2      [IN]        End of x position
 *  y2      [IN]        End of y position
 * RETURNS
 *  void
 *****************************************************************************/
void CM_screens_hide_date_time_display(S32 x1, S32 y1, S32 x2, S32 y2)
{
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color c = *current_MMI_theme->datetime_bar_background_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_fill_rectangle_clip(x1, y1, x2, y2, c);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    WGUI_CM_DRAW_BG_AREA(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}


/*****************************************************************************
 * FUNCTION
 *  CM_screens_hide_duration_display
 * DESCRIPTION
 *  Hide duration function used in CM screens.
 * PARAMETERS
 *  x1      [IN]        Start x position
 *  y1      [IN]        Start y position
 *  x2      [IN]        End of x position
 *  y2      [IN]        End of y position
 * RETURNS
 *  void
 *****************************************************************************/
void CM_screens_hide_duration_display(S32 x1, S32 y1, S32 x2, S32 y2)
{
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color c = *current_MMI_theme->datetime_bar_duration_background_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_fill_rectangle_clip(x1, y1, x2, y2, c);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    WGUI_CM_DRAW_BG_AREA(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}   /* end of CM_screens_hide_duration_display */


/*****************************************************************************
 * FUNCTION
 *  CM_screens_draw_date_time_bar
 * DESCRIPTION
 *  Function used in CM screens to draw date-time bar
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void CM_screens_draw_date_time_bar(void)
{
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color c = *current_MMI_theme->datetime_bar_background_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_fill_rectangle_clip(
        0,
        main_LCD_dt_object.date.y,
        UI_device_width - 1,
        main_LCD_dt_object.time.y + main_LCD_dt_object.time.height - 1,
        c);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    WGUI_CM_DRAW_BG_AREA(
        0,
        main_LCD_dt_object.date.y,
        UI_device_width - 1,
        main_LCD_dt_object.time.y + main_LCD_dt_object.time.height - 1,
        GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}   /* end of CM_screens_draw_date_time_bar */


/*****************************************************************************
 * FUNCTION
 *  CM_screens_draw_duration_bar
 * DESCRIPTION
 *  Function used in CM screens to draw duration bar
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void CM_screens_draw_duration_bar(void)
{
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    color c = *current_MMI_theme->datetime_bar_duration_background_color;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_fill_rectangle_clip(
        0,
        main_LCD_dt_object.duration.y,
        UI_device_width - 1,
        main_LCD_dt_object.duration.y + main_LCD_dt_object.duration.height - 1,
        c);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    WGUI_CM_DRAW_BG_AREA(
        0,
        main_LCD_dt_object.duration.y,
        UI_device_width - 1,
        main_LCD_dt_object.duration.y + main_LCD_dt_object.duration.height - 1,
        GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}   /* end of CM_screens_draw_duration_bar */


/*****************************************************************************
 * FUNCTION
 *  CM_draw_scrolling_text_background
 * DESCRIPTION
 *  Ffunction used in CM screens to draw scrolling text background
 * PARAMETERS
 *  x1      [IN]        Start x position
 *  y1      [IN]        Start y position
 *  x2      [IN]        End of x position
 *  y2      [IN]        End of y position
 * RETURNS
 *  void
 *****************************************************************************/
void CM_draw_scrolling_text_background(S32 x1, S32 y1, S32 x2, S32 y2)
{
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_filled_area *f = current_MMI_theme->CM_screen_background_filler;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, f);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_draw_solid_rect(0, 0, UI_device_width - 1, UI_device_height - 1, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}   /* end of CM_draw_scrolling_text_background */


/*****************************************************************************
 * FUNCTION
 *  dialing_screen_hide_left_softkey
 * DESCRIPTION
 *  Left softkey hide function of dialing screen.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void dialing_screen_hide_left_softkey(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_push_clip();
    gdi_layer_set_clip(
        MMI_left_softkey.x,
        MMI_left_softkey.y,
        MMI_left_softkey.x + MMI_left_softkey.width + 2,
        MMI_left_softkey.y + MMI_left_softkey.height + 2);
    gdi_draw_solid_rect(
        MMI_left_softkey.x,
        MMI_left_softkey.y,
        MMI_left_softkey.x + MMI_left_softkey.width + 2,
        MMI_left_softkey.y + MMI_left_softkey.height + 2,
        GDI_COLOR_TRANSPARENT);
    gdi_layer_pop_clip();
}   /* end of dialing_screen_hide_left_softkey */


/*****************************************************************************
 * FUNCTION
 *  dialing_screen_hide_right_softkey
 * DESCRIPTION
 *  Right softkey hide function of dialing screen.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void dialing_screen_hide_right_softkey(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_push_clip();
    gdi_layer_set_clip(
        MMI_right_softkey.x,
        MMI_right_softkey.y,
        MMI_right_softkey.x + MMI_right_softkey.width + 2,
        MMI_right_softkey.y + MMI_right_softkey.height + 2);
    gdi_draw_solid_rect(
        MMI_right_softkey.x,
        MMI_right_softkey.y,
        MMI_right_softkey.x + MMI_right_softkey.width + 2,
        MMI_right_softkey.y + MMI_right_softkey.height + 2,
        GDI_COLOR_TRANSPARENT);
    gdi_layer_pop_clip();
}   /* end of dialing_screen_hide_right_softkey */

#ifdef __MMI_TOUCH_DIAL_SCREEN__

#ifdef __MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__
void (*dialing_keypad_call_handler) (void) = NULL;
void (*dialing_keypad_phonebook_handler) (void) = MMI_dummy_function; 


/*****************************************************************************
 * FUNCTION
 *  SetDialingKeypadCallHandler
 * DESCRIPTION
 *  Set hte callback function for Dialing Icon of touch dialing screen
 * PARAMETERS
 *  handler     [IN]        keypad call handle function
 * RETURNS
 *  void
 *****************************************************************************/
void SetDialingKeypadCallHandler(void (*handler) (void))
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    dialing_keypad_call_handler = handler;
}


/*****************************************************************************
 * FUNCTION
 *  SetDialingKeypadPhonebookHandler
 * DESCRIPTION
 *  Set hte callback function for Phonebook Icon of touch dialing screen
 * PARAMETERS
 *  handler     [IN]        keypad callback function
 * RETURNS
 *  void
 *****************************************************************************/
void SetDialingKeypadPhonebookHandler(void (*handler) (void))
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    dialing_keypad_phonebook_handler = handler;
}
#endif /* __MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__ */ 


/*****************************************************************************
 * FUNCTION
 *  PlayDialKeyPadTone
 * DESCRIPTION
 *  Play key tone for dial keypad keys.
 * PARAMETERS
 *  key_type        [IN]        key type
 * RETURNS
 *  void
 *****************************************************************************/
void PlayDialKeyPadTone(S16 key_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 key_id = dialing_keypad.key_type;
    KEYBRD_MESSAGE msg;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg.nKeyCode = KEY_0;

    if (key_id >= MMI_DIALING_KEY_START && key_id < MMI_DIALING_KEY_STAR)
    {
        msg.nKeyCode = KEY_0 + key_id;
    }
    /* 0 */
    else if (key_id == MMI_DIALING_KEY_ZERO)
    {
        msg.nKeyCode = KEY_0;
    }
    /* star key */
    else if (key_id == MMI_DIALING_KEY_STAR)
    {
        msg.nKeyCode = KEY_STAR;
    }
    /* pound key */
    else if (key_id == MMI_DIALING_KEY_HASH)
    {
        msg.nKeyCode = KEY_POUND;
    }
    msg.nMsgType = key_type;
    mmi_kbn_key_tone_hdlr(&msg);
}


/*****************************************************************************
 * FUNCTION
 *  ExecuteDialKeyPadKeyHandler
 * DESCRIPTION
 *  Excute key handler for dial keypad keys.
 * PARAMETERS
 *  key_type        [IN]        key type
 * RETURNS
 *  void
 *****************************************************************************/
void ExecuteDialKeyPadKeyHandler(S16 key_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 key_id = dialing_keypad.key_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* 1-9 */
    if (key_id >= MMI_DIALING_KEY_START && key_id < MMI_DIALING_KEY_STAR)
    {
        PlayDialKeyPadTone(key_type);
        ExecuteCurrKeyHandler((S16) (KEY_0 + key_id), key_type);
    }
    /* 0 */
    else if (key_id == MMI_DIALING_KEY_ZERO)
    {
        PlayDialKeyPadTone(key_type);
        ExecuteCurrKeyHandler(KEY_0, key_type);
    }
    /* star key */
    else if (key_id == MMI_DIALING_KEY_STAR)
    {
        PlayDialKeyPadTone(key_type);
        ExecuteCurrKeyHandler(KEY_STAR, key_type);
    }
    /* pound key */
    else if (key_id == MMI_DIALING_KEY_HASH)
    {
        PlayDialKeyPadTone(key_type);
        ExecuteCurrKeyHandler(KEY_POUND, key_type);
    }
}   /* end of ExecuteDialKeyPadKeyHandler */


/*****************************************************************************
 * FUNCTION
 *  Cate16CategoryControlAreaPenDownHandler
 * DESCRIPTION
 *  Pen down events handler function for category16 control area.
 * PARAMETERS
 *  point                       [IN]        pen down position
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL Cate16CategoryControlAreaPenDownHandler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    gui_pen_event_param_struct dialing_key_param;
    gui_dialing_key_pen_enum dialing_key_menu_event;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Get dialing screen  event type according to current state of dialing screen */
    ret = gui_dialing_screen_translate_pen_event(
            &dialing_keypad,
            point.x,
            point.y,
            MMI_PEN_EVENT_DOWN,
            &dialing_key_menu_event,
            &dialing_key_param);

    if (ret)
    {
        gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
        ExecuteDialKeyPadKeyHandler(KEY_EVENT_DOWN);
    }
    return ret;
}   /* end of Cate16CategoryControlAreaPenDownHandler */


/*****************************************************************************
 * FUNCTION
 *  Cate16CategoryControlAreaPenUpHandler
 * DESCRIPTION
 *  Pen up events handler function for category16 control area.
 * PARAMETERS
 *  point                       [IN]        pen up position
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL Cate16CategoryControlAreaPenUpHandler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret = MMI_FALSE;
    gui_pen_event_param_struct dialing_key_param;
    gui_dialing_key_pen_enum dialing_key_menu_event;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Get dialing screen  event type according to current state of dialing screen */
    ret = gui_dialing_screen_translate_pen_event(
            &dialing_keypad,
            point.x,
            point.y,
            MMI_PEN_EVENT_UP,
            &dialing_key_menu_event,
            &dialing_key_param);
    if (ret)
    {
        ExecuteDialKeyPadKeyHandler(KEY_EVENT_UP);

    #if defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__)
        if (dialing_key_menu_event == GUI_DIALING_KEYPAD_PEN_INSERT_PHB)
        {
            if (dialing_keypad_phonebook_handler != NULL && dialing_keypad_phonebook_handler != MMI_dummy_function)
            {
                dialing_keypad_phonebook_handler();
            }
            else
            {
                mmi_phb_idle_enter_phb_list();
            }
        }
	#ifdef __DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__
	else if(dialing_key_menu_event == GUI_DIALING_KEYPAD_PEN_INSERT_CALL_SLAVE)
	{
	      if ((mmi_bootup_get_active_flight_mode() == 0 || MTPNP_PFAL_Is_Card2Absent()) &&
                (dialing_keypad_call_handler != NULL))
	      	{
		       if((MTPNP_AD_Get_UsableSide() == MTPNP_AD_SIMCARD2_USABLE) ||
			    (MTPNP_AD_Get_UsableSide() == MTPNP_AD_DUALSIM_USABLE))
		       {
			   	MTPNP_AD_Set_Channel(MTPNP_AD_CALL_CHANNEL, MTPNP_AD_CHANNEL_SLAVE);
		       }
			else
			{
			       MTPNP_AD_Set_Channel(MTPNP_AD_CALL_CHANNEL, MTPNP_AD_CHANNEL_MASTER);
			}
			dialing_keypad_call_handler();
	      	}
	}
	else if(dialing_key_menu_event == GUI_DIALING_KEYPAD_PEN_INSERT_CALL)
	{
	      if ((mmi_bootup_get_active_flight_mode() == 0 || mmi_bootup_is_sim_valid() == 0) &&
                (dialing_keypad_call_handler != NULL))
	      	{
			if((MTPNP_AD_Get_UsableSide() == MTPNP_AD_SIMCARD1_USABLE) ||
			    (MTPNP_AD_Get_UsableSide() == MTPNP_AD_DUALSIM_USABLE))
			{
			   	MTPNP_AD_Set_Channel(MTPNP_AD_CALL_CHANNEL, MTPNP_AD_CHANNEL_MASTER);
			}
			else
			{
				MTPNP_AD_Set_Channel(MTPNP_AD_CALL_CHANNEL, MTPNP_AD_CHANNEL_SLAVE);
			}
			dialing_keypad_call_handler();
	      	}
	}
	#else/*__DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__*/
        else if (dialing_key_menu_event == GUI_DIALING_KEYPAD_PEN_INSERT_CALL)
        {
            /* ASSERT(dialing_keypad_call_handler != NULL); */
            /* This handler might be null in flight mode, not necessary to assert */
            if ((mmi_bootup_get_active_flight_mode() == 0 || mmi_bootup_is_sim_valid() == 0) &&
                (dialing_keypad_call_handler != NULL))
            {
                dialing_keypad_call_handler();
            }
        }
	#endif/*__DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__*/
    #endif /* defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__) */ 

    }
    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
    return ret;
}   /* end of Cate16CategoryControlAreaPenUpHandler */


/*****************************************************************************
 * FUNCTION
 *  Cate16CategoryControlAreaPenMoveHandler
 * DESCRIPTION
 *  Pen move events handler function for category16 control area.
 * PARAMETERS
 *  point                       [IN]        pen move position
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL Cate16CategoryControlAreaPenMoveHandler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 x1, x2, y1, y2;
    gui_dialing_key_pen_enum menu_event;
    gui_pen_event_param_struct dialing_key_param;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Get dialing screen  event type according to current state of dialing screen */
    gui_dialing_screen_translate_pen_event(
        &dialing_keypad,
        point.x,
        point.y,
        MMI_PEN_EVENT_MOVE,
        &menu_event,
        &dialing_key_param);
    if (menu_event == GUI_DIALING_KEYPAD_HIGHLIGHT_CHANGED || menu_event == GUI_DIALING_KEYPAD_PEN_INSERT_STAR)
    {
        //PlayDialKeyPadTone(KEY_EVENT_UP);
        ExecuteDialKeyPadKeyHandler(KEY_EVENT_UP);
        x1 = dialing_keypad.selected_key_x;
        y1 = dialing_keypad.selected_key_y;

    #if defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__)
        if (dialing_keypad.key_type >= MMI_DIALING_KEY_FUNC)
        {
            x2 = x1 + dialing_keypad.func_key_width - 1;
            y2 = y1 + dialing_keypad.func_key_height - 1;
        }
        else
    #endif /* defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__) */ 
        {
            x2 = x1 + dialing_keypad.key_width - 1;
            y2 = y1 + dialing_keypad.key_height - 1;
        }

        gdi_layer_push_clip();
        gdi_layer_set_clip(x1, y1, x2, y2);

    #ifdef __GDI_MEMORY_PROFILE_2__
        gdi_draw_solid_rect(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
    #else 
        gdi_image_cache_bmp_draw(x1, y1, &(dialing_keypad.selected_key_bitmap));
    #endif 
        gdi_layer_pop_clip();

#if !defined(__MMI_MULTITAP_KEY_0__)
        if (menu_event == GUI_DIALING_KEYPAD_PEN_INSERT_STAR)
        {
            dialer_inputbox_handle_multitap_star_key_up();
        }
#endif
    }

    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
    if (GetDTMFKeyUpFlag())
    {
        MakePsStopDTMFTone();
        SetDTMFKeyUpFlag(FALSE);
    }
    return MMI_TRUE;
}   /* end of Cate16CategoryControlAreaPenMoveHandler */


/*****************************************************************************
 * FUNCTION
 *  Cate16CategoryControlAreaPenRepeatHandler
 * DESCRIPTION
 *  Pen repeat events handler function for category16 control area.
 * PARAMETERS
 *  point                       [IN]        pen repeat position
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL Cate16CategoryControlAreaPenRepeatHandler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_BOOL ret;
    gui_pen_event_param_struct dialing_key_param;
    gui_dialing_key_pen_enum dialing_key_menu_event;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Get dialing screen  event type according to current state of dialing screen */
    ret = gui_dialing_screen_translate_pen_event(
            &dialing_keypad,
            point.x,
            point.y,
            MMI_PEN_EVENT_REPEAT,
            &dialing_key_menu_event,
            &dialing_key_param);

    if (ret)
    {
        ExecuteDialKeyPadKeyHandler(KEY_EVENT_REPEAT);
    }

    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
    return MMI_TRUE;
}   /* end of Cate16CategoryControlAreaPenRepeatHandler */


/*****************************************************************************
 * FUNCTION
 *  Cate16CategoryControlAreaPenLongTapHandler
 * DESCRIPTION
 *  Pen long tap events handler function for category16 control area.
 * PARAMETERS
 *  point                       [IN]        pen long tap position
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL Cate16CategoryControlAreaPenLongTapHandler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    gui_pen_event_param_struct dialing_key_param;
    gui_dialing_key_pen_enum dialing_key_menu_event;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Get dialing screen  event type according to current state of dialing screen */
    gui_dialing_screen_translate_pen_event(
        &dialing_keypad,
        point.x,
        point.y,
        MMI_PEN_EVENT_LONG_TAP,
        &dialing_key_menu_event,
        &dialing_key_param);
    ExecuteDialKeyPadKeyHandler(KEY_EVENT_LONG_PRESS);

    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
    return MMI_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  Cate16CategoryControlAreaPenAbortHandler
 * DESCRIPTION
 *  Pen Abort events handler function for category16 control area.
 * PARAMETERS
 *  point                       [IN]        pen abort position
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL Cate16CategoryControlAreaPenAbortHandler(mmi_pen_point_struct point)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PlayDialKeyPadTone(KEY_EVENT_UP);
    return MMI_TRUE;
}
#endif /* __MMI_TOUCH_DIAL_SCREEN__ */ 

#ifdef __MMI_TOUCH_DIAL_SCREEN__
/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea_big_touch
 * DESCRIPTION
 *  Draws the category16 category control area for touch
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
static void DrawCate16CategoryControlArea_touch(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* draw background image */
    gdi_layer_push_clip();
    gdi_layer_reset_clip();
    gdi_image_draw_id(0, 0, IMG_DIALING_SCREEN);

#ifdef __MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__
    if (dialing_keypad_phonebook_handler == NULL)
    {
        gui_show_dialing_key(MMI_DIALING_KEY_PHB, FALSE);
    }

    if (mmi_bootup_get_active_flight_mode())
    {
        gui_show_dialing_key(MMI_DIALING_KEY_CALL, FALSE);
#ifdef __DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__
	gui_show_dialing_key(MMI_DIALING_KEY_CALL_SLAVE, FALSE);
#endif	/* __DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__ */
    }
#if defined(__MMI_DUAL_SIM_MASTER__)
    else
    {
        U8 m_dial_enable = 1;
        U8 s_dial_enable = 1;
    
        if (MTPNP_PFAL_Retrieve_CallDial_State(&m_dial_enable, &s_dial_enable))
        {
            if (!m_dial_enable)
            {
                gui_show_dialing_key(MMI_DIALING_KEY_CALL, FALSE);
            }
        #ifdef __DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__
            if (!s_dial_enable)
            {
                gui_show_dialing_key(MMI_DIALING_KEY_CALL_SLAVE, FALSE);
            }
        #endif  /* __DUALMODE_TOUCH_DIAL_SCREEN_WITH_SLAVE_FUNCTION__ */
        }
    }
#endif	/* __MMI_DUAL_SIM_MASTER__ */
#endif /* __MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__ */ 

    gdi_layer_pop_clip();
}   /* end of DrawCate16CategoryControlArea_touch */
#else /* __MMI_TOUCH_DIAL_SCREEN__ */
/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea_small_key
 * DESCRIPTION
 *  This function is used to draw the category controlled area of category16 screen
 *  for 128x128 128x160 without touch
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCate16CategoryControlArea_small_key(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_filled_area *f = current_MMI_theme->CM_screen_background_filler;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    gdi_layer_reset_clip();
    gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, f);

    show_status_icons();

#ifndef __MMI_CM_SCREEN_HIDE_DATE_TIME__
    CM_screens_draw_date_time_bar();
    show_main_LCD_dt_display();
#endif /* __MMI_CM_SCREEN_HIDE_DATE_TIME__ */ 
    show_dialer_inputbox();
    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
}   /* end of DrawCate16CategoryControlArea_small_key */
#endif

#if (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) )
#ifndef __MMI_TOUCH_DIAL_SCREEN__
/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryDialingBoxBg 
 * DESCRIPTION
 *  Draw the background image of the dialing input box
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void DrawCate16CategoryDialingBoxBg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 x, y, w, h;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_image_abm_set_source_layer(dm_get_layer_handle(0));

    /* up */
    gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_UP, &w, &h);
    x = MMI_CAT16_DIALING_BOX_BG_X;
    y = MMI_CAT16_DIALING_BOX_BG_Y;
    gdi_layer_push_clip();
    gdi_layer_set_clip(x, y, x + w, y + h);
    gdi_image_draw_id(x, y, IMG_DIALING_SCREEN_BG_UP);
    gdi_layer_pop_clip();

    /* left */
    y += h;
    gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_LEFT, &w, &h);
    gdi_layer_push_clip();
    gdi_layer_set_clip(x, y, x + w, y + h);
    gdi_image_draw_id(x, y, IMG_DIALING_SCREEN_BG_LEFT);
    gdi_layer_pop_clip();
    
    /* right */
    gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_UP, &w, &h);
    x = MMI_CAT16_DIALING_BOX_BG_X + w;
    gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_RIGHT, &w, &h);
    x -= w;
    gdi_layer_push_clip();
    gdi_layer_set_clip(x, y, x + w, y + h);
    gdi_image_draw_id(x, y, IMG_DIALING_SCREEN_BG_RIGHT);
    gdi_layer_pop_clip();
    
    /* right */
    y += h;
    x = MMI_CAT16_DIALING_BOX_BG_X;
    gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_DOWN, &w, &h);
    gdi_layer_push_clip();
    gdi_layer_set_clip(x, y, x + w, y + h);
    gdi_image_draw_id(x, y, IMG_DIALING_SCREEN_BG_DOWN);
    gdi_layer_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea_big_key
 * DESCRIPTION
 *  Draws the category16 category control area for 176x220 up without touch
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
static void DrawCate16CategoryControlArea_big_key(dm_coordinates *coordinate)
    {
    /*-----------------------------------------------------------------*/
    /* Local Variables                                                                           */
    /*-----------------------------------------------------------------*/
#if 0
/* under construction !*/
/* under construction !*/
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    gdi_layer_clear(GDI_COLOR_TRANSPARENT);
    
    DrawCate16CategoryDialingBoxBg();
    show_dialer_inputbox();
    
    gdi_layer_unlock_frame_buffer();

    gdi_layer_blt(wgui_layer_1, wgui_base_layer, 0, 0, 0, 0, UI_device_width - 1, UI_device_height - 1);
}   /* end of DrawCate16CategoryControlArea_big_key */


/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryBeforeBLTCallback
 * DESCRIPTION
 * Before blt callback function of the wallpaper animation 
 * PARAMETERS
 *  return_code [IN]
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCate16CategoryBeforeBLTCallback(GDI_RESULT return_code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    gdi_layer_push_and_set_active(GDI_LAYER_MAIN_BASE_LAYER_HANDLE);
    DrawCate16CategoryDialingBoxBg();
    gdi_layer_pop_and_restore_active();

    gdi_layer_unlock_frame_buffer();

}

#ifdef __MMI_ALPHA_BLENDING__
void cat16_swflash_callback(S32 offset_x, S32 offset_y, S32 width, S32 height)
{
    DrawCate16CategoryBeforeBLTCallback(0);
}
#endif

/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea
 * DESCRIPTION
 *  Draws the category16 category control area
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
static void DrawCate16CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    DrawCate16CategoryControlArea_big_key(coordinate);
}   /* end of DrawCate16CategoryControlArea */
#else /* !__MMI_TOUCH_DIAL_SCREEN__ */
/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea
 * DESCRIPTION
 *  Draws the category16 category control area
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
static void DrawCate16CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    DrawCate16CategoryControlArea_touch(coordinate);
}   /* end of DrawCate16CategoryControlArea */
#endif /* !__MMI_TOUCH_DIAL_SCREEN__ */


/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea2
 * DESCRIPTION
 *  Draws the category16 category control area2
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
static void DrawCate16CategoryControlArea2(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_SWFLASH__
    if (GetCat34MediaType()== MMI_IDLE_BG_MEDIA_SWFLASH)
    {
        GDI_HANDLE act_layer;

        gdi_layer_get_active(&act_layer);
        SetSWFlashPlayerLayer(act_layer);
        DrawCateSWFlashCategoryControlArea(coordinate);
    }
    else
#endif /* __MMI_SWFLASH__ */ 
#ifdef __MMI_AVATAR__
    if (GetCat34MediaType()== MMI_IDLE_BG_MEDIA_AVATAR)
    {
        GDI_HANDLE act_layer;

        gdi_layer_get_active(&act_layer);
        SetSWFlashPlayerLayer(act_layer);
        DrawCateAvatarCategoryControlArea(coordinate);
    }
    else
#endif
    {
#ifndef __MMI_TOUCH_DIAL_SCREEN__
        gdi_anim_set_blt_before_callback(DrawCate16CategoryBeforeBLTCallback);
#endif
            
        gdi_layer_set_source_key(FALSE, GDI_COLOR_TRANSPARENT);
        draw_wallpaper();
    #if defined(ENABLE_ANIMATED_WALLPAPERS) && defined(__GDI_MEMORY_PROFILE_2__) && defined(__MMI_LITE_DISPLAY__)//071007 dialing performance
        if (animation_handle != GDI_ERROR_HANDLE)
        {
            gdi_image_stop_animation(animation_handle);
            animation_handle = GDI_ERROR_HANDLE;
        }
    #endif
    }
}

#elif (defined ( __MMI_MAINLCD_128X160__ ) && defined (__GDI_MEMORY_PROFILE_2__))
#ifndef __MMI_TOUCH_DIAL_SCREEN__
void DrawCate16CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    DrawCate16CategoryControlArea_small_key(coordinate);
}   /* end of DrawCate16CategoryControlArea */
#else
void DrawCate16CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    DrawCate16CategoryControlArea_touch(coordinate);
}   /* end of DrawCate16CategoryControlArea */
#endif
#else /* (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) ) */ 


/*****************************************************************************
 * FUNCTION
 *  DrawCate16CategoryControlArea
 * DESCRIPTION
 *  This function is used to draw the category controlled area of category16 screen
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCate16CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    DrawCate16CategoryControlArea_small_key(coordinate);
}   /* end of DrawCate16CategoryControlArea */
#endif /* (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) ) */ 


/*****************************************************************************
 * FUNCTION
 *  RegisterCategory16NavigationKeys
 * DESCRIPTION
 *  Register the keys ofdialing scrren.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void RegisterCategory16NavigationKeys(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    register_left_softkey_handler();
    register_right_softkey_handler();
    register_dialer_inputbox_keys();
}   /* end of RegisterCategory16NavigationKeys */


/*****************************************************************************
 * FUNCTION
 *  SetCategory16RightSoftkeyFunction
 * DESCRIPTION
 *  set the RSK function of dialing scrren.
 * PARAMETERS
 *  f       [IN]        Function pointer
 *  k       [IN]        Event type
 * RETURNS
 *  void
 *****************************************************************************/
void SetCategory16RightSoftkeyFunction(void (*f) (void), MMI_key_event_type k)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    UI_UNUSED_PARAMETER(k);
    wgui_dialer_inputbox_RSK_function = f;
}   /* end of SetCategory16RightSoftkeyFunction */

#if 1//def __MMI_APPLE_DIAL__
static U16 dial_scr_id = 0;
static void dial_store_dial_scr_id() //sc.wu
{
    dial_scr_id = GetActiveScreenId();
}

U16 dial_get_dial_scr_id()
{
    return dial_scr_id;
}

BOOL dial_is_in_scr_digit()
{
    if( dial_get_dial_scr_id() == GetActiveScreenId() )
    {
	return TRUE;
    }
    else
    {
	return FALSE;
    }
}
#endif

extern void show_dial_status_icons_bg(void);
/*****************************************************************************
 * FUNCTION
 *  ShowCategory16Screen
 * DESCRIPTION
 *  Displays the category16 screen(Dialing Screen)
 * PARAMETERS
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Icon for the Left softkey
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Icon for the right softkey
 *  Buffer                  [IN]        Message string
 *  BufferLength            [IN]        Length of buffer
 *  history_buffer          [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory16Screen(
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U8 *Buffer,
        U32 BufferLength,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;

#if 0
#if (!defined (__MMI_TOUCH_DIAL_SCREEN__) && ( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__)) && defined (__GDI_MEMORY_PROFILE_2__) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__))
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* (!defined (__MMI_TOUCH_DIAL_SCREEN__) && ( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__)) && defined (__GDI_MEMORY_PROFILE_2__) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__)) */ 
#endif

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	dial_store_dial_scr_id(); //sc.wu	
    UI_UNUSED_PARAMETER(history_buffer);

#if ( (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__MMI_TOUCH_DIAL_SCREEN__) && defined  (__MMI_UI_SMALL_SCREEN_SUPPORT__) )
    set_small_screen();
#endif 

    gdi_layer_lock_frame_buffer();
    in_idle_screen();
    clear_key_handlers();
    clear_left_softkey();
    clear_right_softkey();
    change_right_softkey(right_softkey, right_softkey_icon);
    change_left_softkey(left_softkey, left_softkey_icon);
    register_left_softkey_handler();
    register_right_softkey_handler();

#if defined(__MMI_SWFLASH__) || defined(__MMI_AVATAR__)
    SetupCat34Media(0xFFFF, NULL);
#endif

/*shaokai add it start 090908*/
#ifdef __MMI_TOUCH_SCREEN__
    entry_full_screen();
#endif 
/*shaokai add it end 090908*/

#if (((defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__)) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__))
    on_idle_screen = 1;
    set_on_idlescreen(1);
#ifndef __MMI_TOUCH_DIAL_SCREEN__
    register_hide_status_icon_bar(0, idle_screen_hide_status_icons_bar0);
    register_hide_status_icon_bar(1, MMI_dummy_function);
#endif /* __MMI_TOUCH_DIAL_SCREEN__ */ 
    move_status_icons(0, 0, MMI_STATUS_BAR_IDLE_Y, UI_device_width - 1, MMI_status_bar_height + MMI_STATUS_BAR_IDLE_Y - 1);
    set_status_icon_bar_clip(0, 0, MMI_STATUS_BAR_IDLE_Y, UI_device_width - 1, MMI_status_bar_height + MMI_STATUS_BAR_IDLE_Y - 1);
    show_status_icon_bar(0);
    hide_status_icon_bar(1);
#else /* (((defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__)) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__)) */ 
#ifndef __MMI_TOUCH_DIAL_SCREEN__
    set_main_LCD_dt_date_hide_function(CM_screens_hide_date_time_display);
    set_main_LCD_dt_time_hide_function(CM_screens_hide_date_time_display);
    set_dt_display(DT_MO_CALL_SCREEN);
#endif /* __MMI_TOUCH_DIAL_SCREEN__ */ 

#if (!defined(__MMI_MAINLCD_128X160__) || !defined(__MMI_TOUCH_DIAL_SCREEN__))//061507 128x160 touch
    ShowStatusIconsTitle();
#endif

#ifdef __MMI_UI_DALMATIAN_IDLESCREEN__
    arrange_status_icons();
#endif 

#endif /* (((defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__)) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__)) */ 

#if (((defined ( __MMI_MAINLCD_128X160__ ) || defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__)) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__))
       /*shaokai add it start 090908*/
//if(GetActiveScreenId() == IDLE_SCREEN_DIGIT_HANDLER_ID)
{
    //show_dial_status_icons_bg();
    show_status_icons();
}
	/*shaokai add it end 090908*/

#ifdef __MMI_TOUCH_DIAL_SCREEN__
    /* initialize dialing_keypad */
    setup_dialing_keypad(&dialing_keypad);

    register_default_hide_softkeys();

#if (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__))
    wgui_setup_dialer_inputbox(
        MMI_DIALING_KEYPAD_LAYER_X,
        MMI_DIALING_KEYPAD_LAYER_Y - MMI_DIALING_BOX_HEIGHT,
        MMI_DIALING_KEYPAD_LAYER_WIDTH,
        MMI_DIALING_BOX_HEIGHT,
        (UI_buffer_type) Buffer,
        BufferLength,
        MMI_CATEGORY16_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        history_buffer,
        0);
#elif defined (__MMI_MAINLCD_176X220__)//061507 128x160 touch
    wgui_setup_dialer_inputbox(
        0,
        MMI_status_bar_height,
        UI_device_width,
        29,
        (UI_buffer_type) Buffer,
        BufferLength,
        MMI_CATEGORY16_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        history_buffer,
        0);
#else
    wgui_setup_dialer_inputbox(
        0,
        0,//MMI_status_bar_height,
        UI_device_width,
        MMI_DIALING_BOX_HEIGHT,
        (UI_buffer_type) Buffer,
        BufferLength,
        MMI_CATEGORY16_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        history_buffer,
        0);
#endif

#else /* __MMI_TOUCH_DIAL_SCREEN__ */ 
#if (defined ( __MMI_MAINLCD_320X240__ ) || defined ( __MMI_MAINLCD_240X320__ ) || defined ( __MMI_MAINLCD_176X220__ ))
    disable_softkey_background();
    register_hide_left_softkey(dialing_screen_hide_left_softkey);
    register_hide_right_softkey(dialing_screen_hide_right_softkey);
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
    { /* setup dialer inputbox */
        S32 x, y, w, h;
        S32 img_w, img_h;

        gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_UP, &img_w, &img_h);
        y = MMI_CAT16_DIALING_BOX_BG_Y + img_h;
        w = img_w;
        
        gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_LEFT, &img_w, &img_h);
        x = MMI_CAT16_DIALING_BOX_BG_X + img_w;
        h = img_h;
        w -= img_w;

        gdi_image_get_dimension_id(IMG_DIALING_SCREEN_BG_RIGHT, &img_w, &img_h);
        w -= img_w;

        wgui_setup_dialer_inputbox(
                x, y, w, h,
                (UI_buffer_type) Buffer,
                BufferLength,
                MMI_CATEGORY16_ID,
                get_string(right_softkey),
                get_image(right_softkey_icon),
                history_buffer,
                0);
    }
    wgui_dialer_inputbox_set_border(MMI_TRUE, UI_COLOR_BLACK);
#else /* (defined ( __MMI_MAINLCD_320X240__ ) || defined ( __MMI_MAINLCD_240X320__ ) || defined ( __MMI_MAINLCD_176X220__ )) */
    register_default_hide_softkeys();
    wgui_setup_dialer_inputbox(
        0,
        main_LCD_dt_object.time.y + main_LCD_dt_object.time.height,
        UI_device_width,
        UI_device_height - (MMI_button_bar_height + main_LCD_dt_object.time.y + main_LCD_dt_object.time.height),
        (UI_buffer_type) Buffer,
        BufferLength,
        MMI_CATEGORY16_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        history_buffer,
        0);
#endif /* (defined ( __MMI_MAINLCD_320X240__ ) || defined ( __MMI_MAINLCD_240X320__ ) || defined ( __MMI_MAINLCD_176X220__ )) */
#endif /* __MMI_TOUCH_DIAL_SCREEN__ */ 

#else /* (((defined ( __MMI_MAINLCD_128X160__ ) || defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__)) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__)) */

    register_default_hide_softkeys();
    wgui_setup_dialer_inputbox(
        0,
        main_LCD_dt_object.time.y + main_LCD_dt_object.time.height,
        UI_device_width,
        UI_device_height - (MMI_button_bar_height + main_LCD_dt_object.time.y + main_LCD_dt_object.time.height),
        (UI_buffer_type) Buffer,
        BufferLength,
        MMI_CATEGORY16_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        history_buffer,
        0);

#endif /* (((defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__)) && !defined(__MMI_UI_DALMATIAN_IDLESCREEN__)) */ 

    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitCategory16Screen;
    gdi_layer_restore_base_active();
    gdi_layer_set_source_key(TRUE, GDI_COLOR_TRANSPARENT);

#if ( (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__MMI_TOUCH_DIAL_SCREEN__) )
    gdi_layer_push_clip();
    gdi_layer_reset_clip();

    /* 103105 Calvin added: After 6228, alpha channel is supported */
#ifndef __MMI_LITE_DISPLAY__
    gui_greyscale_rectangle(0, 0, MAIN_LCD_DEVICE_WIDTH - 1, MAIN_LCD_DEVICE_HEIGHT - 1, MMI_BG_GREYSCALE_VALUE, MMI_BG_GREYSCALE_BLACK_VALUE); /* 102605 greyscale Calvin modified */
#endif 

    gdi_draw_solid_rect(
        MMI_DIALING_KEYPAD_LAYER_X,
        MMI_DIALING_KEYPAD_LAYER_Y,
        MMI_DIALING_KEYPAD_LAYER_X + MMI_DIALING_KEYPAD_LAYER_WIDTH - 1,
        MMI_DIALING_KEYPAD_LAYER_Y + MMI_DIALING_KEYPAD_LAYER_HEIGHT - 1,
        GDI_COLOR_TRANSPARENT);
    gdi_layer_pop_clip();
#else /* ( (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__MMI_TOUCH_DIAL_SCREEN__) ) */ 
    gdi_layer_clear(GDI_COLOR_TRANSPARENT);
#endif /* ( (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__MMI_TOUCH_DIAL_SCREEN__) ) */ 

    dm_setup_category_functions(dm_redraw_category_screen, GetCategory16History, GetCategory16HistorySize);
    dm_register_category_controlled_callback(DrawCate16CategoryControlArea);
#if (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) )
    dm_register_category_controlled2_callback(DrawCate16CategoryControlArea2);
#endif /* (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) ) */
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY16_ID;
#ifndef __MMI_TOUCH_DIAL_SCREEN__
    dm_data.s32flags = DM_SPECIFIC_HIDE_STATUS_BAR;
#else 
    dm_data.s32flags = 0;
#endif 
    dm_setup_data(&dm_data);

#ifdef __MMI_TOUCH_DIAL_SCREEN__
    wgui_register_category_screen_control_area_pen_handlers(
        Cate16CategoryControlAreaPenDownHandler,
        MMI_PEN_EVENT_DOWN);
    wgui_register_category_screen_control_area_pen_handlers(Cate16CategoryControlAreaPenUpHandler, MMI_PEN_EVENT_UP);
    wgui_register_category_screen_control_area_pen_handlers(
        Cate16CategoryControlAreaPenMoveHandler,
        MMI_PEN_EVENT_MOVE);
    wgui_register_category_screen_control_area_pen_handlers(
        Cate16CategoryControlAreaPenRepeatHandler,
        MMI_PEN_EVENT_REPEAT);
    wgui_register_category_screen_control_area_pen_handlers(
        Cate16CategoryControlAreaPenLongTapHandler,
        MMI_PEN_EVENT_LONG_TAP);
    wgui_register_category_screen_control_area_pen_handlers(
        Cate16CategoryControlAreaPenAbortHandler,
        MMI_PEN_EVENT_ABORT);
#endif /* __MMI_TOUCH_DIAL_SCREEN__ */ 

    dm_redraw_category_screen();

#if defined(__MMI_SWFLASH__) || defined(__MMI_AVATAR__)
    HandleCat34MediaPlayFailed();
#endif
}   /* end of ShowCategory16Screen */


/*****************************************************************************
 * FUNCTION
 *  ExitCategory16Screen
 * DESCRIPTION
 *  Exits the category16 screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory16Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if( (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__MMI_TOUCH_DIAL_SCREEN__) && defined (__MMI_UI_SMALL_SCREEN_SUPPORT__) )
    reset_small_screen();
#endif /* ( (defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__MMI_TOUCH_DIAL_SCREEN__) && defined (__MMI_UI_SMALL_SCREEN_SUPPORT__) ) */ 

    gdi_layer_lock_frame_buffer();
    move_status_icons(0, 0, 0, UI_device_width - 1, MMI_status_bar_height - 1);
    set_status_icon_bar_clip(0, 0, 0, UI_device_width - 1, MMI_status_bar_height - 1);
    dialer_inputbox_handle_multitap_complete(WGUI_DIALER_BOX_ACTIVE_MULTITAP_ANY);
    reset_multitaps();
    close_dialer_inputbox();
    close_main_LCD_dt_display();
    close_status_icons();
    reset_softkeys();
#if (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) )
    on_idle_screen = 0;
    set_on_idlescreen(0);
    leave_idle_screen();
    enactive_main_lcd_update_date_time();
    enable_softkey_background();
    register_hide_status_icon_bar(1, MMI_dummy_function);
    register_hide_status_icon_bar(0, MMI_dummy_function);
#endif /* (( defined ( __MMI_MAINLCD_176X220__ ) || defined (__MMI_MAINLCD_240X320__) || defined (__MMI_MAINLCD_320X240__)) && defined (__GDI_MEMORY_PROFILE_2__) ) */ 
    gdi_layer_unlock_frame_buffer();

#if defined (__MMI_TOUCH_SCREEN__) && defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__)
    dialing_keypad_call_handler = NULL;
    dialing_keypad_phonebook_handler = MMI_dummy_function;
#endif /* defined (__MMI_TOUCH_SCREEN__) && defined (__MMI_TOUCH_DIAL_SCREEN_WITH_FUNCTION__) */ 

#ifdef __MMI_SWFLASH__
    if ( GetCat34MediaType() == MMI_IDLE_BG_MEDIA_SWFLASH )
    {
        ExitCategorySWFlashScreen();
    }
#endif /* __MMI_SWFLASH__ */ 
#ifdef __MMI_AVATAR__
    if ( GetCat34MediaType() == MMI_IDLE_BG_MEDIA_AVATAR )
    {
        ExitCategoryAvatarScreen();
    }
#endif /* __MMI_AVATAR__ */ 

}   /* end of ExitCategory16Screen */


/*****************************************************************************
 * FUNCTION
 *  GetCategory16History
 * DESCRIPTION
 *  Get the category16 screen history
 * PARAMETERS
 *  history_buffer      [IN/OUT]        History_buffer
 * RETURNS
 *  U8*
 *****************************************************************************/
U8 *GetCategory16History(U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    get_dialer_inputbox_category_history(MMI_CATEGORY16_ID, history_buffer);
    return (history_buffer);
}   /* end of GetCategory16History */


/*****************************************************************************
 * FUNCTION
 *  GetCategory16HistorySize
 * DESCRIPTION
 *  Get the category16 screen history size
 * PARAMETERS
 *  void
 * RETURNS
 *  S32 size of category 16 history
 *****************************************************************************/
S32 GetCategory16HistorySize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return sizeof(dialer_inputbox_category_history);
}   /* end of GetCategory16HistorySize */


/*****************************************************************************
 * FUNCTION
 *  ShowCategory17Screen
 * DESCRIPTION
 *  Show category ShowCategory17Screen screen.
 * PARAMETERS
 *  title_id                    [IN]        
 *  left_softkey                [IN]        Lsk string id
 *  left_softkey_icon           [IN]        Lsk image id
 *  right_softkey               [IN]        Rsk string id
 *  right_softkey_icon          [IN]        Rsk image id
 *  NotificationStringId        [IN]        Notification string, notification string
 *  NameOrNumber                [IN]        Name or number text, name or number text
 *  IP_Number                   [IN]        String of IP number
 *  CallLine                    [IN]        Image ID of line indicator(Zero for not displaying line indicators)
 *  default_image_id            [IN]        Image ID of default displayed image
 *  resource_id                 [IN]        Image ID of displayed resource (if any)
 *  resource_filename           [IN]        String of displayed iamge filename (if any)
 *  resource_type               [IN]        Enum value of which resource type
 *  repeat_count                [IN]        Repeat count, used for video only, 0 means infiniate loop
 *  is_visaul_update            [IN]        Update video's visual
 *  is_aud_enable               [IN]        Audio of animation
 *  is_play_aud_when_start      [IN]        Play video at start
 *  history_buffer              [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory17Screen(
        U16 title_id,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U16 NotificationStringId,
        PU8 NameOrNumber,
        PU8 IP_Number,
        U16 CallLine,
        U16 default_image_id,
        U16 resource_id,
        PS8 resource_filename,
        wgui_cate_momt_res_type_enum resource_type,
        U16 repeat_count,
        BOOL is_visaul_update,
        BOOL is_aud_enable,
        BOOL is_play_aud_when_start,
        PU8 history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ShowMOMTCallScreen(
        title_id,
        left_softkey,
        left_softkey_icon,
        right_softkey,
        right_softkey_icon,
        NotificationStringId,
        NameOrNumber,
        IP_Number,
        CallLine,
        default_image_id,
        resource_id,
        resource_filename,
        resource_type,
        repeat_count,
        is_visaul_update,
        is_aud_enable,
        is_play_aud_when_start,
        history_buffer);
}   /* end of ShowCategory17Screen */


/*****************************************************************************
 * FUNCTION
 *  RedrawCategory17Screen
 * DESCRIPTION
 *  Redraw Category 17 screen.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void RedrawCategory17Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    RedrawMOMTCallScreen();
}   /* end of RedrawCategory17Screen */


/*****************************************************************************
 * FUNCTION
 *  ExitCategory17Screen
 * DESCRIPTION
 *  Exit Category 17 screen.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory17Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ExitMOMTCallScreen();
}   /* end of ExitCategory17Screen */


/*****************************************************************************
 * FUNCTION
 *  StopCategory17Video
 * DESCRIPTION
 *  Stop Category 17 screen's video clip.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void StopCategory17Video(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_VIDEO_PLAYER__
    if (cat_momt_is_video_open && cat_momt_is_video_play)
    {
        /* stop video playing */
        mdi_video_ply_stop();
        cat_momt_is_video_play = FALSE;
    }
#endif /* __MMI_VIDEO_PLAYER__ */ 
}   /* end of StopCategory17Video */


/*****************************************************************************
 * FUNCTION
 *  DisableCategory17Audio
 * DESCRIPTION
 *  Disable Category 17 screen video' audio
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DisableCategory17Audio(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!cat_momt_is_show_default)
    {
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
        {
        #ifdef __MMI_VIDEO_PLAYER__
            if (cat_momt_is_video_open && cat_momt_is_video_play)
            {
                mdi_audio_set_mute(MDI_VOLUME_MEDIA, TRUE);
                cat_momt_is_aud_muted = TRUE;
            }
        #endif /* __MMI_VIDEO_PLAYER__ */ 
        }
        else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
                 (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
        {
        #ifdef __MMI_SWFLASH__
            if (cat_momt_is_swflash_open && cat_momt_is_swflash_play)
            {
                mdi_audio_set_mute(MDI_VOLUME_MEDIA, TRUE);
                cat_momt_is_aud_muted = TRUE;
            }
        #endif /* __MMI_SWFLASH__ */ 
        }

    }

}


/*****************************************************************************
 * FUNCTION
 *  EnableCategory17Audio
 * DESCRIPTION
 *  Enable Category 17 screen video' audio
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EnableCategory17Audio(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!cat_momt_is_show_default)
    {
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
        {
        #ifdef __MMI_VIDEO_PLAYER__
            if (cat_momt_is_video_open && cat_momt_is_video_play)
            {
                mdi_audio_set_mute(MDI_VOLUME_MEDIA, FALSE);
                cat_momt_is_aud_muted = FALSE;
            }
        #endif /* __MMI_VIDEO_PLAYER__ */ 
        }
        else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
                 (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
        {
        #ifdef __MMI_SWFLASH__
            if (cat_momt_is_swflash_open && cat_momt_is_swflash_play)
            {
                mdi_audio_set_mute(MDI_VOLUME_MEDIA, FALSE);
                cat_momt_is_aud_muted = FALSE;
            }
        #endif /* __MMI_SWFLASH__ */ 
        }
    }

}


/*****************************************************************************
 * FUNCTION
 *  DisableCategory17VideoUpdate
 * DESCRIPTION
 *  Disable update video to LCM
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DisableCategory17VideoUpdate(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_VIDEO_PLAYER__
    if (cat_momt_is_video_open && cat_momt_is_video_play)
    {
        mdi_video_ply_set_lcm_update(FALSE);
    }
#endif /* __MMI_VIDEO__ */ /* __MMI_VIDEO_PLAYER__ */
}


/*****************************************************************************
 * FUNCTION
 *  EnableCategory17VideoUpdate
 * DESCRIPTION
 *  Enable update video to LCM
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EnableCategory17VideoUpdate(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_VIDEO_PLAYER__
    if (cat_momt_is_video_open && cat_momt_is_video_play)
    {
        mdi_video_ply_set_lcm_update(TRUE);
    }
#endif /* __MMI_VIDEO_PLAYER__ */ 
}


/*****************************************************************************
 * FUNCTION
 *  IsCategory17VideoValid
 * DESCRIPTION
 *  Call this function to check if Cat17 show video success or not
 * PARAMETERS
 *  void
 * RETURNS
 * BOOL
 *****************************************************************************/
MMI_BOOL IsCategory17VideoValid(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION("[WGUI CAT CM] IsCategory17VideoValid()");
    PRINT_INFORMATION("[WGUI CAT CM] open %d", cat_momt_is_video_open);
    PRINT_INFORMATION("[WGUI CAT CM] play %d", cat_momt_is_video_play);
#ifdef __MMI_VIDEO_PLAYER__
    if (cat_momt_is_video_open && cat_momt_is_video_play)
    {
        return MMI_TRUE;
    }
#endif /* __MMI_VIDEO_PLAYER__ */ 

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  IsCategory17AvatarValid
 * DESCRIPTION
 *  Call this function to check if Cat17 show avatar success or not
 * PARAMETERS
 *  void
 * RETURNS
 * BOOL
 *****************************************************************************/
MMI_BOOL IsCategory17AvatarValid(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_AVATAR__
    if (cat_momt_is_avatar_play)
    {
        return MMI_TRUE;
    }
#endif /* __MMI_AVATAR__ */ 

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  IsCategory17SWFlashValid
 * DESCRIPTION
 *  Call this function to check if Cat17 show swflash success or not
 * PARAMETERS
 *  void
 * RETURNS
 * BOOL
 *****************************************************************************/
MMI_BOOL IsCategory17SWFlashValid(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_SWFLASH__
    if (cat_momt_is_swflash_open && cat_momt_is_swflash_play)
    {
        return MMI_TRUE;
    }
#endif /* __MMI_SWFLASH__ */ 

    return MMI_FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  ShowCategory18Screen
 * DESCRIPTION
 *  Show Cateogry 18, for MO MT call. for call disconnecting screen
 * PARAMETERS
 *  title_id                    [IN]        
 *  left_softkey                [IN]        Lsk string id
 *  left_softkey_icon           [IN]        Lsk image id
 *  right_softkey               [IN]        Rsk string id
 *  right_softkey_icon          [IN]        Rsk image id
 *  NotificationStringId        [IN]        Notification string, notification string
 *  NameOrNumber                [IN]        Name or number text, name or number text
 *  IP_Number                   [IN]        String of IP number
 *  CallLine                    [IN]        Image ID of line indicator(Zero for not displaying line indicators)
 *  image_id                    [IN]        Resource to be displayed (ID)
 *  image_filename              [IN]        Resource to be displayed (file)
 *  isDisconnecting             [IN]        Whether the call is disconnecting
 *  history_buffer              [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory18Screen(
        U16 title_id,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U16 NotificationStringId,
        PU8 NameOrNumber,
        PU8 IP_Number,
        U16 CallLine,
        U16 image_id,
        PS8 image_filename,
        MMI_BOOL isDisconnecting,
        PU8 history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    isCallDisconnecting = isDisconnecting;

    if (image_filename)
    {
        ShowMOMTCallScreen(
            title_id,
            left_softkey,
            left_softkey_icon,
            right_softkey,
            right_softkey_icon,
            NotificationStringId,
            NameOrNumber,
            IP_Number,
            CallLine,
            image_id,
            0,
            image_filename,
            WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE,
            0,
            FALSE,
            FALSE,
            FALSE,
            history_buffer);

    }
    else
    {
        ShowMOMTCallScreen(
            title_id,
            left_softkey,
            left_softkey_icon,
            right_softkey,
            right_softkey_icon,
            NotificationStringId,
            NameOrNumber,
            IP_Number,
            CallLine,
            image_id,
            image_id,
            NULL,
            WGUI_CATE_MOMT_RES_TYPE_IMAGE_ID,
            0,
            FALSE,
            FALSE,
            FALSE,
            history_buffer);
    }

}


MMI_BOOL CM_call_cost_show = MMI_FALSE; /* 102506 call cost */
/*****************************************************************************
 * FUNCTION
 *  Cat19_hide_fixed_list
 * DESCRIPTION
 *  hide the fixed list of category 19
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void Cat19_hide_fixed_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (MMI_fixed_list_menu.normal_filler->gc)
    {
        S32 x1 = MMI_fixed_list_menu.x + 2;
        S32 y1 = MMI_fixed_list_menu.y + 2;
        S32 x2 = x1 + MMI_fixed_list_menu.width - 8;
        S32 y2 = y1 + MMI_fixed_list_menu.height - 7;

        gdi_layer_push_clip();
        gdi_layer_reset_clip();
        gui_gradient_fill_rectangle(x1, y1, x2, y2, MMI_fixed_list_menu.normal_filler->gc, UI_GRADIENT_COLOR_VERTICAL);
        gdi_layer_pop_clip();
    }
    else
    {
        gdi_layer_push_clip();
        gdi_layer_set_clip(
            MMI_fixed_list_menu.x,
            MMI_fixed_list_menu.y,
            MMI_fixed_list_menu.x + MMI_fixed_list_menu.width - 1,
            MMI_fixed_list_menu.y + MMI_fixed_list_menu.height - 1);
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
        gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, current_MMI_theme->CM_screen_background_filler);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
        gdi_draw_solid_rect(0, 0, UI_device_width - 1, UI_device_height - 1, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        gdi_layer_pop_clip();
    }
}   /* end of Cat19_hide_fixed_list */


/*****************************************************************************
 * FUNCTION
 *  DrawCate19CategoryControlArea
 * DESCRIPTION
 *  Show control area of category19
 * PARAMETERS
 *  coordinate      [IN]     area to redraw
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCate19CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    RedrawCategory19Screen();
}


/*****************************************************************************
 * FUNCTION
 *  RedrawCategory19Screen
 * DESCRIPTION
 *  Redraw function of category19
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void RedrawCategory19Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    UI_filled_area *f = current_MMI_theme->CM_screen_background_filler;
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
    U8 aoc_flag;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_push_clip();
    gdi_layer_reset_clip();

#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, f);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_draw_solid_rect(0, 0, UI_device_width - 1, UI_device_height - 1, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

#if 1
//#ifndef __MMI_WALLPAPER_ON_BOTTOM__
#ifndef __MMI_CM_SCREEN_HIDE_DATE_TIME__
    CM_screens_draw_date_time_bar();
    show_main_LCD_dt_display();
#endif /* __MMI_CM_SCREEN_HIDE_DATE_TIME__ */ 
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */ 
/* under construction !*/
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */ 

    if (!(FALSE == GetCallTimeDisplay()))
    {
        CM_screens_draw_duration_bar();
    }

    show_main_LCD_dt_display();

    /* call cost*/
    aoc_flag = (U8) GetShowAOC();
    if (aoc_flag)
    {
        CM_call_cost_show = MMI_TRUE;
        redraw_call_cost_UI();
    }
    else
    {
        CM_call_cost_show = MMI_FALSE;
        reset_call_cost_UI();
    }
    
    show_fixed_list();

    gdi_layer_pop_clip();
}


/*****************************************************************************
 * FUNCTION
 *  Cat19_list_highlight_handler
 * DESCRIPTION
 *  highlight handler for category19
 * PARAMETERS
 *  item_index      [IN]        Index of item highlighted.
 * RETURNS
 *  void
 *****************************************************************************/
void Cat19_list_highlight_handler(S32 item_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_menu_shortcut_number = item_index + 1;
    MMI_highlighted_item_text = get_item_text(item_index);
    MMI_list_highlight_handler(item_index);
}   /* end of Cat19_list_highlight_handler */


/*****************************************************************************
 * FUNCTION
 *  ShowCategory19Screen
 * DESCRIPTION
 *  Displays the active calls screen
 * PARAMETERS
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Icon for the Left softkey
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Icon for the right softkey
 *  number_of_calls         [IN]        Number of active calls
 *  CallList                [IN]        String array for identifying the calls
 *  CallLines               [IN]        Image ID array of line indicator(Zero array for not displaying line indicators)
 *  CallStates              [IN]        Image ID array of call state
 *  CurrCallTime            [IN]        Current call duration timer structure
 *  highlighted_item        [IN]        Current highlighted item
 *  history_buffer          [IN]        History
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory19Screen(
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        S32 number_of_calls,
        U8 **CallList,
        U16 *CallLines,
        U16 *CallStates,
        MYTIME *CurrCallTime,
        S32 highlighted_item,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 i, text_width, icon_position;
    S32 w, h, temp_w, temp_h;
    U8 h_flag;
    U8 *img = NULL;
    U8 calllines_no_display = 1;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    entry_full_screen();
    gdi_layer_lock_frame_buffer();
    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();
#if ( (defined  __MMI_WGUI_CSK_ENABLE__) && (defined __MMI_TOUCH_SCREEN__) )
    EnableCenterSoftkey(0, IMG_CSK_DIAL_ICON);
#endif 

    set_main_LCD_dt_date_hide_function(CM_screens_hide_date_time_display);
    set_main_LCD_dt_time_hide_function(CM_screens_hide_date_time_display);

    if (!(FALSE == GetCallTimeDisplay()))
    {
        set_main_LCD_dt_duration_hide_function(CM_screens_hide_duration_display);
    }

    set_dt_duration(CurrCallTime);
    set_dt_display(DT_ACTIVE_CALL_SCREEN);

    ShowStatusIconsTitle();

    MMI_menu_shortcut_number = -1;
    MMI_disable_title_shortcut_display = 1;

    resize_fixed_list(
        UI_device_width /*MMI_content_width + MMI_fixed_list_menu.vbar.width*/,
        UI_device_height - MMI_button_bar_height - (main_LCD_dt_object.duration.y + main_LCD_dt_object.duration.height));

    for (i = 0; i < number_of_calls; i++)
    {
        if (CallLines[i] != 0)
        {
            calllines_no_display = 0;
            break;
        }
    }
    if (calllines_no_display)
    {
        create_fixed_icontext_list_menuitems(1, 1);
    }
    else
    {
        create_fixed_icontext_list_menuitems(1, 2);
    }

    img = (U8*) GetImage(CallStates[0]);
    gui_measure_image(img, &w, &h);
    for (i = 1; i < number_of_calls; i++)
    {
        img = (U8*) GetImage(CallStates[i]);
        gui_measure_image(img, &temp_w, &temp_h);
        if (temp_w > w)
        {
            w = temp_w;
        }
        if (temp_h > h)
        {
            h = temp_h;
        }
    }

    if (w > MMI_MENUITEM_HEIGHT)
    {
        w = MMI_MENUITEM_HEIGHT;
    }
    if (h > MMI_MENUITEM_HEIGHT)
    {
        h = MMI_MENUITEM_HEIGHT;
    }

    if (calllines_no_display)
    {
        text_width = UI_device_width - w - GUI_TEXT_MENUITEM_TEXT_X - 2/* 6 */;
        set_fixed_icontext_list_text_coordinates(0, GUI_TEXT_MENUITEM_TEXT_X/*2*/, 0, text_width, MMI_MENUITEM_HEIGHT);

        icon_position = GUI_TEXT_MENUITEM_TEXT_X /*4*/ + text_width;
        set_fixed_icontext_list_icon_coordinates(0, icon_position, 0, w, h);
    }
    else
    {
        icon_position = GUI_ICONTEXT_MENUITEM_ICON_X/*1*/;
        set_fixed_icontext_list_icon_coordinates(0, icon_position, 0, w, h);

        text_width = UI_device_width - GUI_ICONTEXT_MENUITEM_TEXT_X/*(MMI_MENUITEM_HEIGHT + 1)*/ - w - 2;
        set_fixed_icontext_list_text_coordinates(0, GUI_ICONTEXT_MENUITEM_TEXT_X/*MMI_MENUITEM_HEIGHT + 1*/, 0, text_width, MMI_MENUITEM_HEIGHT);

        icon_position = UI_device_width - 1 - w;
        set_fixed_icontext_list_icon_coordinates(1, icon_position, 0, w, h);
    }

    associate_fixed_icontext_list_list();

    MMI_fixed_icontext_list_menuitem.flags &= ~UI_MENUITEM_MARQUEE_SCROLL;
    MMI_fixed_icontext_list_menuitem.flags |= UI_MENUITEM_TRUNCATE_CONTENT;

    for (i = 0; i < number_of_calls; i++)
    {
        fixed_icontext_list_item_insert(i);

        if (calllines_no_display)
        {
            add_fixed_icontext_list_item_text(i, 0, (UI_string_type) CallList[i]);
            add_fixed_icontext_list_item_icon(i, 0, get_image(CallStates[i]));
        }
        else
        {
            add_fixed_icontext_list_item_icon(i, 0, get_image(CallLines[i]));
            add_fixed_icontext_list_item_text(i, 0, (UI_string_type) CallList[i]);
            add_fixed_icontext_list_item_icon(i, 1, get_image(CallStates[i]));
        }
    }

    MMI_current_menu_type = LIST_MENU;
    register_fixed_list_keys();

#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    MMI_fixed_list_menu.flags |= (UI_LIST_MENU_DISABLE_BACKGROUND | UI_LIST_MENU_DISABLE_SCROLLBAR);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    MMI_fixed_list_menu.flags |= (UI_LIST_MENU_DISABLE_SCROLLBAR);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
    register_hide_fixed_list(Cat19_hide_fixed_list);
    resize_fixed_icontext_list_menuitems(UI_device_width /*0*/, MMI_MENUITEM_HEIGHT);

    register_fixed_list_highlight_handler(Cat19_list_highlight_handler);

    h_flag = set_list_menu_category_history(MMI_CATEGORY19_ID, history_buffer);
    if (h_flag)
    {
        fixed_list_goto_item_no_redraw(MMI_fixed_list_menu.highlighted_item);
    }
    else
    {
        fixed_list_goto_item_no_redraw(highlighted_item);
    }

    resize_fixed_list(
        UI_device_width /*MMI_content_width + MMI_fixed_list_menu.vbar.width*/,
        UI_device_height - MMI_button_bar_height - (main_LCD_dt_object.duration.y + main_LCD_dt_object.duration.height));

    move_fixed_list(0, UI_device_height - MMI_button_bar_height - MMI_fixed_list_menu.height);

    gdi_layer_unlock_frame_buffer();

#if 0
/* under construction !*/
/* under construction !*/
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

    ExitCategoryFunction = ExitCategory19Screen;
    dm_setup_category_functions(dm_redraw_category_screen, GetCategory19History, GetCategory19HistorySize);
    dm_register_category_controlled_callback(DrawCate19CategoryControlArea);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY19_ID;
    dm_data.s32flags = 0;
    dm_setup_data(&dm_data);
    dm_redraw_category_screen();
}


/*****************************************************************************
 * FUNCTION
 *  ExitCategory19Screen
 * DESCRIPTION
 *  Exits the Active_call screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory19Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    close_main_LCD_dt_display();
    close_status_icons();
    reset_softkeys();
    reset_menu_shortcut_handler();
    MMI_fixed_list_menu.flags &= ~(UI_LIST_MENU_DISABLE_BACKGROUND | UI_LIST_MENU_DISABLE_SCROLLBAR);
    _MMI_hide_fixed_list_menu = UI_dummy_function;
    reset_fixed_list();
    gdi_layer_unlock_frame_buffer();
#if ( (defined  __MMI_WGUI_CSK_ENABLE__) && defined (__MMI_TOUCH_SCREEN__))
    ResetCenterSoftkey();
#endif 
}   /* end of ExitCategory19Screen */


/*****************************************************************************
 * FUNCTION
 *  GetCategory19HistorySize
 * DESCRIPTION
 *  Gets the size of the history buffer for the Active calls screen
 * PARAMETERS
 *  void
 * RETURNS
 *  size of history buffer in U8s
 *****************************************************************************/
S32 GetCategory19HistorySize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (sizeof(list_menu_category_history));
}


/*****************************************************************************
 * FUNCTION
 *  GetCategory19History
 * DESCRIPTION
 *  Gets the history buffer for the Active_calls screen
 * PARAMETERS
 *  history_buffer      [IN]        Is the buffer into which the history data is stored (pre-allocated)
 * RETURNS
 *  pointer to the history buffer
 *****************************************************************************/
U8 *GetCategory19History(U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    get_list_menu_category_history(MMI_CATEGORY19_ID, history_buffer);
    return (history_buffer);
}


/*****************************************************************************
 * FUNCTION
 *  DrawCMImageBackground
 * DESCRIPTION
 *  This function is used to draw the background of the calling image in MO/MT
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCMImageBackground(void)
{
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UI_filled_area *f = current_MMI_theme->CM_screen_background_filler;
#if 0
	//Huyanwei Modify It 
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gui_draw_filled_area(
        0,
        UI_device_height - MMI_BUTTON_BAR_HEIGHT - MMI_CM_MAX_IMG_HEIGHT,
        UI_device_width - 1,
        UI_device_height - MMI_BUTTON_BAR_HEIGHT - 1,
        f);
#endif
#endif /* __MMI_MAINLCD_128X128__ */
}


/*****************************************************************************
 * FUNCTION
 *  DrawCate20CategoryControlArea
 * DESCRIPTION
 *  This function is used to draw the category controlled area of category20 screen
 * PARAMETERS
 *  coordinate      [IN/OUT]        Coordinates of category controlled area.
 * RETURNS
 *  void
 *****************************************************************************/
void DrawCate20CategoryControlArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    RedrawCategory20Screen();
}


/*****************************************************************************
 * FUNCTION
 *  RedrawCategory20Screen
 * DESCRIPTION
 *  Redraws the single Active call screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void RedrawCategory20Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    UI_filled_area *f = current_MMI_theme->CM_screen_background_filler;
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
    U8 aoc_flag;
    S32 icon_w = 0, icon_h = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    gui_hide_animations();

    gdi_layer_reset_clip();

#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, f);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_draw_solid_rect(0, 0, UI_device_width - 1, UI_device_height - 1, GDI_COLOR_TRANSPARENT);
    DrawCMImageBackground();
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

    show_title_status_icon();
    show_status_icons();

#ifdef __MMI_MAINLCD_128X128__
#ifndef __MMI_CM_SCREEN_HIDE_DATE_TIME__
    CM_screens_draw_date_time_bar();
    show_main_LCD_dt_display();
#endif /* __MMI_CM_SCREEN_HIDE_DATE_TIME__ */ 
#else /* __MMI_MAINLCD_128X128__ */ 
	if (r2lMMIFlag)
	{
		UI_character_type s[64];
		S32 w;

		gui_set_font(main_LCD_dt_object.duration.font);
		UI_sprintf((S8*) s, "%02d:%02d:%02d", 8, 8, 8);
		w = gui_get_string_width(s);

		set_main_lcd_duration_position((U16)(UI_device_width - w - 1), (U16) MMI_status_bar_height);
	}
	else
	{
		set_main_lcd_duration_position(0, (U16) MMI_status_bar_height);
	}
#endif /* __MMI_MAINLCD_128X128__ */ 

    if (!(FALSE == GetCallTimeDisplay()))
    {
        CM_screens_draw_duration_bar();
    }

    /* 102506 call cost Start */
    aoc_flag = (U8) GetShowAOC();
    if (aoc_flag)
    {
        CM_call_cost_show = MMI_TRUE;
        redraw_call_cost_UI();
    }
    else
    {
        CM_call_cost_show = MMI_FALSE;
        reset_call_cost_UI();
    }
    /* 102506 call cost End */

#ifdef __MMI_MAINLCD_128X128__
    show_main_LCD_dt_display();
#else /* __MMI_MAINLCD_128X128__ */ 
    if (!(FALSE == GetCallTimeDisplay()))
    {
        dt_update_duration();
    }
#endif /* __MMI_MAINLCD_128X128__ */ 

    if (gCallLine != 0)
    {
#ifdef __MMI_MAINLCD_128X128__
        S32 sw = 0, sh = 0;
#endif
        S32 tx = 0, ty = 0;

        gdi_image_get_dimension_id(gCallLine, &icon_w, &icon_h);
#ifdef __MMI_MAINLCD_128X128__
        gui_set_font(current_MMI_theme->title_text_font);
        gui_measure_string(MMI_message_string, &sw, &sh);
        tx = (UI_device_width >> 1) - ((sw + icon_w + 1) >> 1);
        if (tx < 1)
        {
            tx = 1;
        }
        ty = UI_device_height - MMI_button_bar_height - sh - 2;
#else /* __MMI_MAINLCD_128X128__ */ 
        tx = 1;
        ty = MMI_status_bar_height + main_LCD_dt_object.duration.height + 1;
#endif /* __MMI_MAINLCD_128X128__ */

        gdi_layer_push_clip();
        gdi_layer_reset_clip();
        gdi_image_draw_id(tx, ty, gCallLine);
        gdi_layer_pop_clip();
    }
    if (MMI_message_string)
    {
        gui_show_scrolling_text(&CM_scrolling_text);
    }

    gdi_layer_push_clip();
    gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);
    gdi_image_draw_animation(wgui_image_clip_x1, wgui_image_clip_y1, _MMI_animated_icon, &MOMT_animation_handle);
    gdi_layer_pop_clip();

    if (isCallDisconnecting)
    {
        MOMTHideAnimation();
    }

    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
}


/*****************************************************************************
 * FUNCTION
 *  ShowCategory20Screen
 * DESCRIPTION
 *  Displays the single active call screen
 * PARAMETERS
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Icon for the Left softkey
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Icon for the right softkey
 *  NameOrNumber            [IN]        String for identifying the call
 *  CallDuration            [IN]        Call duration timer structure
 *  CallLine                [IN]        Image ID of line indicator(Zero for not displaying line indicators)
 *  CallState               [IN]        Image ID of call state
 *  isDisconnecting         [IN]        Whether the call is disconnecting
 *  history_buffer          [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory20Screen(
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U8 *NameOrNumber,
        MYTIME *CallDuration,
        U16 CallLine,
        U16 CallState,
        MMI_BOOL isDisconnecting,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;

#ifdef __MMI_MAINLCD_128X128__
    S32 h;
#endif 
    S32 l = 0;
    S32 y = 0;
    S32 ty2 = 0;
    S32 sh = 0;
    S32 sw = 0;
    S32 tw = 0;
    S32 tx = 0;
    S32 ty = 0;
    S32 iwidth = 0;
    S32 iheight = 0;
    S32 content_height;
    PU8 img = get_image(CallState);
    S32 x_shift = 1;
    S32 icon_w = 0, icon_h = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    UI_UNUSED_PARAMETER(history_buffer);

    gdi_layer_lock_frame_buffer();

    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();
#if ( (defined  __MMI_WGUI_CSK_ENABLE__) && (defined __MMI_TOUCH_SCREEN__) )
    EnableCenterSoftkey(0, IMG_CSK_DIAL_ICON);
#endif 

    isCallDisconnecting = isDisconnecting;

    set_main_LCD_dt_date_hide_function(CM_screens_hide_date_time_display);
    set_main_LCD_dt_time_hide_function(CM_screens_hide_date_time_display);

    if (!(FALSE == GetCallTimeDisplay()))
    {
        set_main_LCD_dt_duration_hide_function(CM_screens_hide_duration_display);
    }

    set_dt_duration(CallDuration);
    set_dt_display(DT_ACTIVE_CALL_SCREEN);
    ty2 = main_LCD_dt_object.duration.y + main_LCD_dt_object.duration.height + 2;
    content_height = UI_device_height - MMI_button_bar_height - ty2;
    ShowStatusIconsTitle();

    gdi_image_get_dimension((U8*) img, &iwidth, &iheight);

    gCallLine = CallLine;
    if (gCallLine != 0)
    {
        gdi_image_get_dimension_id(gCallLine, &icon_w, &icon_h);
        x_shift = icon_w + 2;
    }

    l = gui_strlen((UI_string_type) NameOrNumber);
    if (NameOrNumber)
    {
        MMI_message_string = (UI_string_type) NameOrNumber;
    }
    else
    {
        MMI_message_string = NULL;
    }
    gui_set_font(current_MMI_theme->title_text_font);
    gui_measure_string((UI_string_type) NameOrNumber, &sw, &sh);
#ifdef __MMI_MAINLCD_128X128__
    if (gCallLine != 0)
    {
        tx = (UI_device_width >> 1) - ((sw + icon_w + 1) >> 1) + icon_w + 1;
    }
    else
#endif /* __MMI_MAINLCD_128X128__ */ 
    {
    tx = (UI_device_width >> 1) - (sw >> 1);
    }
    if (tx < x_shift)
    {
        tx = x_shift;
    }

#ifdef __MMI_MAINLCD_128X128__
    ty = UI_device_height - MMI_button_bar_height - sh - 2;
    tw = sw;

    if (gCallLine == 0)
    {
    if (tw > (UI_device_width - 2))
    {
        tw = UI_device_width - 2;
    }
    }
    else
    {
        if (tw > (UI_device_width - 3 - icon_w))
        {
            tw = UI_device_width - 3 - icon_w;
        }
    }

    /* PMT DLT_FIXES - TK 20060321 START */
#ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
    gui_create_scrolling_text(
        &CM_scrolling_text,
        tx,
        ty,
        tw,
        sh,
        (UI_string_type) NameOrNumber,
        CM_scrolling_text_timer_callback,
        CM_draw_scrolling_text_background,
        *current_MMI_theme->CM_screen_text_color,
        gui_color(255, 255, 255));
#else /* __MMI_DOWNLOADABLE_THEMES_SUPPORT__ */ 
    gui_create_scrolling_text(
        &CM_scrolling_text,
        tx,
        ty,
        tw,
        sh,
        (UI_string_type) NameOrNumber,
        CM_scrolling_text_timer_callback,
        CM_draw_scrolling_text_background,
        gui_color(0, 0, 0),
        gui_color(255, 255, 255));
#endif /* __MMI_DOWNLOADABLE_THEMES_SUPPORT__ */ 
    gui_change_scrolling_text_font(&CM_scrolling_text, current_MMI_theme->title_text_font);
    /* PMT DLT_FIXES - TK 20060321 END */
    CM_scrolling_text.flags &= ~UI_SCROLLING_TEXT_BORDERED_TEXT;

    h = sh + iheight + 4;
    y = ty2 + (content_height >> 1) - (h >> 1);
#else /* __MMI_MAINLCD_128X128__ */ 
    ty = MMI_status_bar_height + main_LCD_dt_object.duration.height + 1;
    tw = sw;
    if (gCallLine == 0)
    {
        //if (tw > (UI_device_width - 2))
        {
            tw = UI_device_width - 2;
        }
    }
    else
    {
        //if (tw > (UI_device_width - 3 - icon_w))
        {
            tw = UI_device_width - 3 - icon_w;
        }
    }
    /* PMT DLT_FIXES - TK 20060321 START */
#ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
    gui_create_scrolling_text(
        &CM_scrolling_text,
        0 + x_shift,
        ty,
        tw,
        sh,
        (UI_string_type) NameOrNumber,
        CM_scrolling_text_timer_callback,
        CM_draw_scrolling_text_background,
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
        *current_MMI_theme->CM_screen_text_color,
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
        *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        gui_color(255, 255, 255));
#else /* __MMI_DOWNLOADABLE_THEMES_SUPPORT__ */ 
    gui_create_scrolling_text(
        &CM_scrolling_text,
        0 + x_shift,
        ty,
        tw,
        sh,
        (UI_string_type) NameOrNumber,
        CM_scrolling_text_timer_callback,
        CM_draw_scrolling_text_background,
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
        gui_color(0, 0, 0),
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
        *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        gui_color(255, 255, 255));
#endif /* __MMI_DOWNLOADABLE_THEMES_SUPPORT__ */ 
    gui_change_scrolling_text_font(&CM_scrolling_text, current_MMI_theme->title_text_font);
    /* PMT DLT_FIXES - TK 20060321 END */
    CM_scrolling_text.flags &= ~UI_SCROLLING_TEXT_BORDERED_TEXT;

    y = UI_device_height - MMI_button_bar_height - iheight;
#endif /* __MMI_MAINLCD_128X128__ */ 

    wgui_image_clip_x1 = (UI_device_width - iwidth) >> 1;
    wgui_image_clip_x2 = (UI_device_width + iwidth) >> 1;
    wgui_image_clip_y1 = y;
    wgui_image_clip_y2 = y + iheight - 1;

    _MMI_animated_icon = img;

    gdi_layer_unlock_frame_buffer();

#ifndef __MMI_MAINLCD_128X128__
    deactive_main_lcd_update_date_time();
#endif 

    ExitCategoryFunction = ExitCategory20Screen;
    dm_setup_category_functions(dm_redraw_category_screen, GetCategory20History, GetCategory20HistorySize);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY20_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
    dm_setup_data(&dm_data);
    dm_register_category_controlled_callback(DrawCate20CategoryControlArea);
    dm_redraw_category_screen();

/* 102506 call cost Start */
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif
/* 102506 call cost End */
}


/*****************************************************************************
 * FUNCTION
 *  ExitCategory20Screen
 * DESCRIPTION
 *  Exits the single Active_call screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory20Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    gui_cancel_timer(CM_scrolling_text_timer_callback);
    gui_cancel_timer(handle_CM_text_scroll);
    gui_hide_animations();

    MOMT_animation_handle = GDI_ERROR_HANDLE;
    isCallDisconnecting = MMI_FALSE;

    close_main_LCD_dt_display();
    close_status_icons();
    reset_softkeys();
    reset_singleline_inputbox();

#ifndef __MMI_MAINLCD_128X128__
    enactive_main_lcd_update_date_time();
#endif 

    gdi_layer_unlock_frame_buffer();
#if ( (defined  __MMI_WGUI_CSK_ENABLE__) && (defined __MMI_TOUCH_SCREEN__) )
    ResetCenterSoftkey();
#endif 
}   /* end of ExitCategory20Screen */


/*****************************************************************************
 * FUNCTION
 *  GetCategory20HistorySize
 * DESCRIPTION
 *  Gets the size of the history buffer of category 20
 * PARAMETERS
 *  void
 * RETURNS
 *  S32         size of history
 *****************************************************************************/
S32 GetCategory20HistorySize(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (2);
}


/*****************************************************************************
 * FUNCTION
 *  GetCategory20History
 * DESCRIPTION
 *  Gets category history buffer
 * PARAMETERS
 *  history_buffer      [IN]        History buffer
 * RETURNS
 *  U8*         history buffer
 *****************************************************************************/
U8 *GetCategory20History(U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (history_buffer != NULL)
    {
        history_buffer[0] = (U8) MMI_CATEGORY20_ID;
        history_buffer[1] = (U8) 0x80;
    }
    return (history_buffer);
}


#if defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_SWFLASH__)
/*****************************************************************************
 * FUNCTION
 *  MOMT_allocate_media_layer 
 * DESCRIPTION
 *  allocate screen-based memory & create layer for MOMT screen with media content
 * PARAMETERS
 *  x   [IN]    x
 *  y   [IN]    y
 *  w   [IN]    width
 *  h   [IN]    height
 * RETURNS
 *  void
 *****************************************************************************/
static void MOMT_allocate_media_layer(S32 x, S32 y, S32 w, S32 h)
{
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 buffer_size;
    GDI_RESULT ret;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    buffer_size = (w*h*gdi_layer_get_bit_per_pixel() + 7) >> 3;
    CM_media_buffer = (U8*)applib_mem_screen_alloc(buffer_size);
    MMI_ASSERT(CM_media_buffer);
    
    ret = gdi_layer_create_using_outside_memory(
            x, y, w, h,
            &wgui_layer_1,
            CM_media_buffer,
            buffer_size);
    MMI_ASSERT(ret == GDI_SUCCEED);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_layer_create(
            x, y, w, h,
            &wgui_layer_1);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}
#endif /* defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_SWFLASH__) */


#if defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_SWFLASH__)
/*****************************************************************************
 * FUNCTION
 *  MOMT_set_blt_layer 
 * DESCRIPTION
 *  set blt layer for MOMT call screen with media content
 * PARAMETERS
 *  x   [IN]    x
 *  y   [IN]    y
 *  w   [IN]    width
 *  h   [IN]    height
 * RETURNS
 *  void
 *****************************************************************************/
static void MOMT_set_blt_layer(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    gdi_layer_set_blt_layer(wgui_base_layer, wgui_layer_1, 0, 0);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_layer_set_blt_layer(dm_get_scr_bg_layer(), wgui_base_layer, wgui_layer_1, 0);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
}
#endif /* defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_SWFLASH__) */


/*****************************************************************************
* [MO/MT Cateogry Screen]
*
* This category is for MT/MO call screen.
*
*  (128x128)
*  **********************
*  *                    *  
*  * 200x/xx/xx         *
*  *  ****************  *
*  *  *              *  *
*  *  *              *  *
*  *  *           ------------ image or video
*  *  ****************  *
*  *                    *
*  * LSK            RSK *
*  **********************
*
*
*  (128x160) (176x220)
*  **********************
*  * ##################------ status bar
*  * Calling...         *
*  *  ****************  *
*  *  *              *  *
*  *  *              *  *
*  *  *           ----------- image or video
*  *  *              *  *
*  *  *              *  *
*  *  ****************  *
*  *     09xxxxxxxx---------- phone number or name
*  * LSK            RSK *
*  **********************
*
*****************************************************************************/
/*****************************************************************************
 * FUNCTION
 *  ShowMOMTCallScreen
 * DESCRIPTION
 *  Show MO MT call cateogry.
 * PARAMETERS
 *  title_id                    [IN]        
 *  left_softkey                [IN]        Lsk string id
 *  left_softkey_icon           [IN]        Lsk image id
 *  right_softkey               [IN]        Rsk string id
 *  right_softkey_icon          [IN]        Rsk image id
 *  NotificationStringId        [IN]        Notification string, notification string
 *  NameOrNumber                [IN]        Name or number text, name or number text
 *  IP_Number                   [IN]        String of IP number
 *  CallLine                    [IN]        Image ID of line indicator(Zero for not displaying line indicators)
 *  default_image_id            [IN]        Image ID of default displayed image
 *  resource_id                 [IN]        Image ID of displayed resource (if any)
 *  resource_filename           [IN]        Resource to be displayed (file)
 *  resource_type               [IN]        Resource type
 *  repeat_count                [IN]        Repeat count, used for video only, 0 means infiniate loop
 *  is_visaul_update            [IN]        Update video's visual
 *  is_aud_enable               [IN]        Audio of animation
 *  is_play_aud_when_start      [IN]        Play video at start
 *  history_buffer              [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
static void ShowMOMTCallScreen(
                U16 title_id,
                U16 left_softkey,
                U16 left_softkey_icon,
                U16 right_softkey,
                U16 right_softkey_icon,
                U16 NotificationStringId,
                PU8 NameOrNumber,
                PU8 IP_Number,
                U16 CallLine,
                U16 default_image_id,
                U16 resource_id,
                PS8 resource_filename,
                wgui_cate_momt_res_type_enum resource_type,
                U16 repeat_count,            /* video/swflash only. 0 means infinite loop */
                BOOL is_visaul_update,       /* video/swflash only. update to LCM */
                BOOL is_aud_enable,          /* video/swflash only. play video's audio */
                BOOL is_play_aud_when_start, /* video/swflash only. play audio when start */
                PU8 history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 fh, text_y;
    S32 text_width;
    S32 text_height;
    S32 text_offset_x;
    S32 text_offset_y;
    S32 image_spacing;
    S32 text_spaing;
    S32 string_width, string_height;
    S32 image_width, image_height;
    UI_string_type str;
    PU8 image_ptr;
    GDI_RESULT img_ret;
    MDI_RESULT mdi_ret = 0;
    S32 icon_w = 0, icon_h = 0;
    S32 x_shift = 0;

#if defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_SWFLASH__)
    S32 resized_width, resized_height;
    S32 resized_offset_x, resized_offset_y;

#endif /* __MMI_VIDEO_PLAYER__ */ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* init var */
    cat_momt_is_visual_update = is_visaul_update;
    cat_momt_is_aud_enable = is_aud_enable;
    cat_momt_is_play_aud_when_start = is_play_aud_when_start;

    cat_momt_is_video_open = FALSE;
    cat_momt_is_video_play = FALSE;
    cat_momt_is_swflash_open = FALSE;
    cat_momt_is_swflash_play = FALSE;
    cat_momt_is_avatar_play = FALSE;
    cat_momt_is_aud_muted = FALSE;
    cat_momt_is_show_default = FALSE;

    MMI_ASSERT(CM_media_buffer == NULL);

    /* spacing pixel from boundry */
    image_spacing = 2;
    text_spaing = 2;

    cat_momt_repeat_count = repeat_count;
    cat_momt_resource_filename = (PS8) resource_filename;
    cat_momt_resource_id = resource_id;
    cat_momt_default_image_id = default_image_id;
    cat_momt_resource_type = resource_type;

    if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
        (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
    {
        /* video case */
    #ifdef __MMI_VIDEO_PLAYER__
        /* if is newly entry, do not need resume, play from start */
        if (history_buffer == NULL)
        {
            cat_momt_video_play_time = 0;
        }

        /* stop MMI LCM sleep */
        TurnOnBacklight(0);

        /* we need play video on an extra layer, so will use multi-layer */
        gdi_layer_multi_layer_enable();
        gdi_layer_get_base_handle(&wgui_base_layer);
        wgui_layer_1 = GDI_LAYER_EMPTY_HANDLE;
    #else /* __MMI_VIDEO_PLAYER__ */ 
        /* try to play video when no video function support */
        MMI_ASSERT(0);
    #endif /* __MMI_VIDEO_PLAYER__ */ 

    }
    else if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_AVATAR_FILE)
    {
    #ifdef __MMI_AVATAR__
        /* currently do nothing */
    #else /* __MMI_AVATAR__ */ 
        /* try to play video when no video function support */
        MMI_ASSERT(0);
    #endif /* __MMI_AVATAR__ */ 

    }  
    else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
             (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
    {
        /* swflash case */
    #ifdef __MMI_SWFLASH__
        /* if is newly entry, do not need resume, play from start */
        if (history_buffer == NULL)
        {
            cat_momt_swflash_play_time = 0;
        }

        /* stop MMI LCM sleep */
        TurnOnBacklight(0);

        /* we need play swflash on an extra layer, so will use multi-layer */
        gdi_layer_multi_layer_enable();
        gdi_layer_get_base_handle(&wgui_base_layer);
        wgui_layer_1 = GDI_LAYER_EMPTY_HANDLE;
    #else /* __MMI_SWFLASH__ */ 
        /* try to play swflash when no swflash function support */
        MMI_ASSERT(0);
    #endif /* __MMI_SWFLASH__ */ 

    }
    else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE) ||
             (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_IMAGE_ID))
    {
        /* image case */
        /* currently do nothing */
    }
    else
    {
        /* shall no enter here */
        MMI_ASSERT(0);
    }

    gdi_layer_lock_frame_buffer();

    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();

    set_main_LCD_dt_date_hide_function(CM_screens_hide_date_time_display);
    set_main_LCD_dt_time_hide_function(CM_screens_hide_date_time_display);
    set_dt_display(DT_MT_CALL_SCREEN);

    MMI_title_icon = NULL;
    MMI_disable_title_shortcut_display = 1;

    /* draw title */
    if (title_id == 0)
    {
        status_icon = 1;
        ShowStatusIconsTitle();
    #ifdef __MMI_UI_DALMATIAN_IDLESCREEN__
        arrange_status_icons();
    #endif 
    }
    else if (!((title_id == 0xffff)))
    {
        status_icon = 2;
        MMI_title_string = (UI_string_type) get_string(title_id);
    }
    else
    {
        status_icon = 0;
    }

    if (UI_device_height == 128)
    {
        text_y = MMI_status_bar_height + main_LCD_dt_object.date.height + main_LCD_dt_object.time.height + 2;
    }
    else
    {
        text_y = MMI_status_bar_height;
    }

   /****************************************************************************
   * Message String                                                               
   * gMMI_UI_U8_flag_1 = 0 (No "Calling..." String, for MT Call)
   * gMMI_UI_U8_flag_1 = 1 (With "Calling..." String, for MO Call)
   ****************************************************************************/

    /* support IP dialing */
    if (NameOrNumber)
    {
        memset((PS8) CM_string_buf, 0, (MAX_IP_NUMBER_LEN + MAX_DIGIT) * 2);
        gui_strcpy((UI_string_type) CM_string_buf, (UI_string_type) IP_Number);
        gui_strcat((UI_string_type) CM_string_buf, (UI_string_type) NameOrNumber);
        MMI_message_string = (UI_string_type) CM_string_buf;
    }
    else
    {
        MMI_message_string = NULL;
    }

    gui_set_font(&MMI_medium_font);
    gui_measure_string(MMI_message_string, &string_width, &string_height);

    text_offset_x = (UI_device_width >> 1) - (string_width >> 1);

    if (text_offset_x < 1)
    {
        text_offset_x = 1;
    }

    text_offset_y = UI_device_height - MMI_button_bar_height - string_height - text_spaing;
    text_width = string_width;

    text_height = string_height;

    if (NotificationStringId != 0)
    {
        str = get_string(NotificationStringId);
        create_multiline_inputbox_set_buffer(
            str,
            gui_strlen((UI_string_type) str),
            gui_strlen((UI_string_type) str),
            0);
    #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
        MMI_multiline_inputbox.normal_text_color = *current_MMI_theme->CM_screen_text_color;
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
        MMI_multiline_inputbox.normal_text_color = *current_MMI_theme->list_normal_text_color;
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
    #endif 
        MMI_multiline_inputbox.flags |=
            UI_MULTI_LINE_INPUT_BOX_DISABLE_SCROLLBAR | UI_MULTI_LINE_INPUT_BOX_DISABLE_BACKGROUND |
            UI_MULTI_LINE_INPUT_BOX_DISABLE_CURSOR_DRAW | UI_MULTI_LINE_INPUT_BOX_CENTER_JUSTIFY;

        if (UI_device_height != 128)
        {
            MMI_multiline_inputbox.flags &= ~UI_MULTI_LINE_INPUT_BOX_CENTER_JUSTIFY;
        }

        MMI_multiline_inputbox.text_y = 0;
        show_multiline_inputbox_no_draw();
        fh = get_multiline_inputbox_line_height();

        resize_multiline_inputbox(UI_device_width, fh + MULTILINE_INPUTBOX_HEIGHT_PAD);
        gMMI_UI_U8_flag_1 = 1;  /* With "Calling" string,MO calling */
    }
    else
    {
        fh = Get_FontHeight(*UI_font, (U8) gCurrLangIndex);
        gMMI_UI_U8_flag_1 = 0;  /* Without "Calling" string, MT calling */
    }

   /****************************************************************************
   *  Get Image, Video or SWFlash info
   *****************************************************************************/

    /* prepare image, video or swflash */
    switch (cat_momt_resource_type)
    {

    #ifdef __MMI_AVATAR__
        case WGUI_CATE_MOMT_RES_TYPE_AVATAR_FILE:
        {
            gdi_image_get_dimension_mem(GDI_IMAGE_TYPE_AVATAR,(PU8) cat_momt_resource_filename,0,&image_width,&image_height);        
        }
            break;

    #endif /* __MMI_AVATAR__*/

        case WGUI_CATE_MOMT_RES_TYPE_IMAGE_ID:
        {
            image_ptr = get_image(cat_momt_resource_id);
            gdi_image_get_dimension(image_ptr, &image_width, &image_height);
        }
            break;

        case WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE:
        {
            img_ret = gdi_image_get_dimension_file((PS8) resource_filename, &image_width, &image_height);

            if (img_ret < 0)
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
            break;

    #ifdef __MMI_VIDEO_PLAYER__
        case WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE:
        {
            /* open with audio is on */
            mdi_ret = mdi_video_ply_open_clip_file(cat_momt_resource_filename, &wgui_video_info);

            cat_momt_is_video_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_video_info.width;
                image_height = wgui_video_info.height;

                mdi_video_ply_close_clip_file();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }

        }
            break;

        case WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID:
        {
            mdi_ret = mdi_video_ply_open_clip_id(cat_momt_resource_id, &wgui_video_info);

            cat_momt_is_video_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_video_info.width;
                image_height = wgui_video_info.height;
                
                mdi_video_ply_close_clip_id();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
            break;
    #endif /* __MMI_VIDEO_PLAYER__ */ 

    #ifdef __MMI_SWFLASH__
        case WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE:
        {
            if (cat_momt_is_aud_enable)
            {            
                mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_PLAYER, &wgui_swflash_info);
            }
            else
            {
                mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_SCREEN, &wgui_swflash_info);
            }
            
            cat_momt_is_swflash_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_swflash_info.width;
                image_height = wgui_swflash_info.height;

                mdi_swflash_close_file();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }

        }
            break;

        case WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID:
        {
            if (cat_momt_is_aud_enable)
            {
                mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_PLAYER, &wgui_swflash_info);
            }
            else
            {
                mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_SCREEN, &wgui_swflash_info);
            }

            cat_momt_is_swflash_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_swflash_info.width;
                image_height = wgui_swflash_info.height;

                mdi_swflash_close_id();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
            break;
    #endif /* __MMI_SWFLASH__ */ 

        default:
        {
            /* wrong resouce type */
            MMI_ASSERT(0);
        }
    }

   /********************************************************************************
   *  Calculate drawable region for Image and Video
   ********************************************************************************/
    SetMOMTCallImageClip(image_width, image_height);

   /********************************************************************************
   *  Create Video or SWFlash Layer 
   ********************************************************************************/
    if (!cat_momt_is_show_default)
    {
    #ifdef __MMI_VIDEO_PLAYER__
        /* video is successfully opened, create video playback layer */
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
        {
            if (mdi_ret >= 0)
            {
                if (CM_need_change_clip)
                {
                    /* video larger than drawable region, need resize */

                    /* calc draw size */
                    gdi_image_util_fit_bbox(
                        wgui_image_clip_x2 - wgui_image_clip_x1 + 1,
                        wgui_image_clip_y2 - wgui_image_clip_y1 + 1,
                        wgui_video_info.width,
                        wgui_video_info.height,
                        &resized_offset_x,
                        &resized_offset_y,
                        &resized_width,
                        &resized_height);
                }
                else
                {
                    /* video smaller than region - align at center */
                    resized_offset_x = ((wgui_image_clip_x2 - wgui_image_clip_x1 + 1) - wgui_video_info.width) >> 1;
                #ifdef __MMI_MAINLCD_128X128__
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_video_info.height) >> 1;
                #else 
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_video_info.height);
                #endif 

                    resized_width = wgui_video_info.width;
                    resized_height = wgui_video_info.height;
                }

                MMI_ASSERT(wgui_layer_1 == GDI_LAYER_EMPTY_HANDLE);

                MOMT_allocate_media_layer(
                        wgui_image_clip_x1 + resized_offset_x,
                        wgui_image_clip_y1 + resized_offset_y,
                        resized_width,
                        resized_height);
            }
        }
    #endif /* __MMI_VIDEO_PLAYER__ */ 

    #ifdef __MMI_SWFLASH__
        /* SWFlash is successfully opened, create video playback layer */
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
        {
            if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID)
            {
                if (cat_momt_is_aud_enable)
                {
                    mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_PLAYER, &wgui_swflash_info);
                }
                else
                {
                    mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_SCREEN, &wgui_swflash_info);
                }
            }
            else
            {
                if (cat_momt_is_aud_enable)
                {            
                    mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_PLAYER, &wgui_swflash_info);
                }
                else
                {
                    mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_SCREEN, &wgui_swflash_info);
                }
            }

            if (mdi_ret >= 0)
            {
                if (CM_need_change_clip)
                {
                    /* swflash larger than drawable region, need resize */

                    /* calc draw size */
                    gdi_image_util_fit_bbox(
                        wgui_image_clip_x2 - wgui_image_clip_x1 + 1,
                        wgui_image_clip_y2 - wgui_image_clip_y1 + 1,
                        wgui_swflash_info.width,
                        wgui_swflash_info.height,
                        &resized_offset_x,
                        &resized_offset_y,
                        &resized_width,
                        &resized_height);
                }
                else
                {
                    /* video smaller than region - align at center */
                    resized_offset_x = ((wgui_image_clip_x2 - wgui_image_clip_x1 + 1) - wgui_swflash_info.width) >> 1;
                #ifdef __MMI_MAINLCD_128X128__
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_swflash_info.height) >> 1;
                #else 
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_swflash_info.height);
                #endif 

                    resized_width = wgui_swflash_info.width;
                    resized_height = wgui_swflash_info.height;
                }

                MMI_ASSERT(wgui_layer_1 == GDI_LAYER_EMPTY_HANDLE);

                MOMT_allocate_media_layer(
                        wgui_image_clip_x1 + resized_offset_x,
                        wgui_image_clip_y1 + resized_offset_y,
                        resized_width,
                        resized_height);

                if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID)
                {
                    mdi_swflash_close_id();
                }
                else
                {
                    mdi_swflash_close_file();
                }
            }
        }
    #endif /* __MMI_SWFLASH__ */ /* __MMI_VIDEO_PLAYER__ */
    }

   /********************************************************************************
   *  Create scrolling text
   ********************************************************************************/
    {
        gCallLine = CallLine;
        if (gCallLine == 0)
        {
#ifdef __MMI_MAINLCD_128X128__
            if (text_width > (UI_device_width - 2))
#endif /* __MMI_MAINLCD_128X128__ */
            {
                text_width = UI_device_width - 2;
            }
        }
        else
        {
            gdi_image_get_dimension_id(gCallLine, &icon_w, &icon_h);
            x_shift = icon_w + 2;
#ifdef __MMI_MAINLCD_128X128__
            if (text_width > (UI_device_width - 3 - icon_w))
#endif /* __MMI_MAINLCD_128X128__ */
            {
                text_width = UI_device_width - 3 - icon_w;
            }
        }
    }

    if (UI_device_height == 128)
    {
        S32 tx = 0;

        if (gCallLine != 0)
        {
            tx = ((UI_device_width - text_width - icon_w - 1) >> 1) + icon_w + 1;
        }
        else
        {
            tx = (UI_device_width - text_width) >> 1;
        }
        if (tx < x_shift)
        {
            tx = x_shift;
        }

        gui_create_scrolling_text(
            &CM_scrolling_text,
            tx,
            CM_y,
            text_width,
            text_height,
            MMI_message_string,
            CM_scrolling_text_timer_callback, CM_draw_scrolling_text_background,
        #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
            *current_MMI_theme->CM_screen_text_color,
        #else 
            gui_color(0, 0, 0),
        #endif 
            gui_color(255, 255, 255));
    }
    else
    {
        gui_create_scrolling_text(
            &CM_scrolling_text, x_shift, CM_y + 1,
            text_width, text_height,
            MMI_message_string,
            CM_scrolling_text_timer_callback, CM_draw_scrolling_text_background,
        #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
            *current_MMI_theme->CM_screen_text_color,
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
            *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        #else
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
            gui_color(0, 0, 0),
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
            *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        #endif 
            gui_color(255, 255, 255));
    }

    CM_scrolling_text.flags &= ~UI_SCROLLING_TEXT_BORDERED_TEXT;

    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitMOMTCallScreen;
    dm_setup_category_functions(dm_redraw_category_screen, dummy_get_history, dummy_get_history_size);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY18_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
#ifdef __MMI_VIDEO_PLAYER__
    if (!cat_momt_is_show_default)
    {
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE))
        {
            if (cat_momt_is_video_open)
            {
                dm_data.s32flags |= DM_NO_BLT;
            }
        }
    }
#endif /* __MMI_VIDEO_PLAYER__ */
    dm_setup_data(&dm_data);
    dm_register_category_controlled_callback(DrawMOMTCallScreenControllArea);
    dm_redraw_category_screen();

    /* we open & close video before, reset the flag */
    cat_momt_is_video_open = FALSE;
    cat_momt_is_video_play = FALSE;

    /* if the screen is from the pop-up go-back, do not play video */
    if (mmi_is_redrawing_bk_screens())
    {
        return;
    }

#ifdef __MMI_VIDEO_PLAYER__
    if (!cat_momt_is_show_default)
    {
        /* start play video */
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE))
        {
            if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID)
            {
                mdi_ret = mdi_video_ply_open_clip_id(cat_momt_resource_id, &wgui_video_info);
            }
            else
            {
                mdi_ret = mdi_video_ply_open_clip_file(cat_momt_resource_filename, &wgui_video_info);
            }
            cat_momt_is_video_open = (mdi_ret >= 0) ? TRUE : FALSE;

            mdi_ret = mdi_video_ply_seek(cat_momt_video_play_time);

            if (mdi_ret >= 0)
            {
                /* if aud is on but not play when start, mute it */
                if (cat_momt_is_aud_enable && !cat_momt_is_play_aud_when_start)
                {
                    mdi_audio_set_mute(MDI_VOLUME_MEDIA, TRUE);
                    cat_momt_is_aud_muted = TRUE;
                }
            }

            if (mdi_ret >= 0)
            {
                MOMT_set_blt_layer();

                /* dm_redraw_category_screen will not blt when call video,
                 * blt here for the first frame of the video */
                gdi_lcd_repaint_all();
                
                mdi_ret = mdi_video_ply_play(
                            wgui_layer_1,
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
                            GDI_LAYER_ENABLE_LAYER_0 | GDI_LAYER_ENABLE_LAYER_1,
                            GDI_LAYER_ENABLE_LAYER_1,
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
                            GDI_LAYER_ENABLE_LAYER_0 | GDI_LAYER_ENABLE_LAYER_1 | GDI_LAYER_ENABLE_LAYER_2,
                            GDI_LAYER_ENABLE_LAYER_2,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
                            (U16) cat_momt_repeat_count,    /* this to recrod repeat count */
                            cat_momt_is_visual_update,      /* update to LCM or not */
                            cat_momt_is_aud_enable,         /* play aud or not */
                            MDI_DEVICE_SPEAKER_BOTH,        /* speaker & earphone */
                            MDI_VIDEO_LCD_ROTATE_0,         /* rotate */
                            100,                            /* 1x play speed */
                            NULL);                          /* do not hook callback */
            }

            cat_momt_is_video_play = (mdi_ret >= 0) ? TRUE : FALSE;

            /* play failed */
            if (mdi_ret < 0)
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
    }
#endif /* __MMI_VIDEO_PLAYER__ */ 

#ifdef __MMI_SWFLASH__
    if (!cat_momt_is_show_default)
    {
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE))
        {
            MOMT_set_blt_layer();
            
            gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
        }
     }
#endif /* __MMI_SWFLASH__ */
}

#if defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
static void ShowMOMTCallBothScreen(
                U16 title_id,
                U16 left_softkey,
                U16 left_softkey_icon,
                U16 right_softkey,
                U16 right_softkey_icon,
                U16 NotificationStringId,
                PU8 NameOrNumber,
                PU8 SlaveNameOrNumber,
                PU8 IP_Number,
                U16 CallLine,
                U16 default_image_id,
                U16 resource_id,
                PS8 resource_filename,
                wgui_cate_momt_res_type_enum resource_type,
                U16 repeat_count,            /* video/swflash only. 0 means infinite loop */
                BOOL is_visaul_update,       /* video/swflash only. update to LCM */
                BOOL is_aud_enable,          /* video/swflash only. play video's audio */
                BOOL is_play_aud_when_start, /* video/swflash only. play audio when start */
                PU8 history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 fh, text_y;
    S32 text_width;
    S32 text_height;
    S32 text_offset_x;
    S32 text_offset_y;
    S32 image_spacing;
    S32 text_spaing;
    S32 string_width, string_height;
    S32 image_width, image_height;
    UI_string_type str;
    PU8 image_ptr;
    GDI_RESULT img_ret;
    MDI_RESULT mdi_ret = 0;
    S32 icon_w = 0, icon_h = 0;
    S32 x_shift = 0;

#ifdef __MMI_VIDEO_PLAYER__
    S32 resized_width, resized_height;
    S32 resized_offset_x, resized_offset_y;

#endif /* __MMI_VIDEO_PLAYER__ */ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* init var */
    cat_momt_is_visual_update = is_visaul_update;
    cat_momt_is_aud_enable = is_aud_enable;
    cat_momt_is_play_aud_when_start = is_play_aud_when_start;

    cat_momt_is_video_open = FALSE;
    cat_momt_is_video_play = FALSE;
    cat_momt_is_swflash_open = FALSE;
    cat_momt_is_swflash_play = FALSE;
    cat_momt_is_avatar_play = FALSE;
    cat_momt_is_aud_muted = FALSE;
    cat_momt_is_show_default = FALSE;

    MMI_ASSERT(CM_media_buffer == NULL);

    /* spacing pixel from boundry */
    image_spacing = 2;
    text_spaing = 2;

    cat_momt_repeat_count = repeat_count;
    cat_momt_resource_filename = (PS8) resource_filename;
    cat_momt_resource_id = resource_id;
    cat_momt_default_image_id = default_image_id;
    cat_momt_resource_type = resource_type;

    if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
        (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
    {
        /* video case */
    #ifdef __MMI_VIDEO_PLAYER__
        /* if is newly entry, do not need resume, play from start */
        if (history_buffer == NULL)
        {
            cat_momt_video_play_time = 0;
        }

        /* stop MMI LCM sleep */
        TurnOnBacklight(0);

        /* we need play video on an extra layer, so will use multi-layer */
        gdi_layer_multi_layer_enable();
        gdi_layer_get_base_handle(&wgui_base_layer);
        wgui_layer_1 = GDI_LAYER_EMPTY_HANDLE;
    #else /* __MMI_VIDEO_PLAYER__ */ 
        /* try to play video when no video function support */
        MMI_ASSERT(0);
    #endif /* __MMI_VIDEO_PLAYER__ */ 

    }
    else if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_AVATAR_FILE)
    {
    #ifdef __MMI_AVATAR__
        /* currently do nothing */
    #else /* __MMI_AVATAR__ */ 
        /* try to play video when no video function support */
        MMI_ASSERT(0);
    #endif /* __MMI_AVATAR__ */ 

    }  
    else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
             (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
    {
        /* swflash case */
    #ifdef __MMI_SWFLASH__
        /* if is newly entry, do not need resume, play from start */
        if (history_buffer == NULL)
        {
            cat_momt_swflash_play_time = 0;
        }

        /* stop MMI LCM sleep */
        TurnOnBacklight(0);

        /* we need play swflash on an extra layer, so will use multi-layer */
        gdi_layer_multi_layer_enable();
        gdi_layer_get_base_handle(&wgui_base_layer);
        wgui_layer_1 = GDI_LAYER_EMPTY_HANDLE;
    #else /* __MMI_SWFLASH__ */ 
        /* try to play swflash when no swflash function support */
        MMI_ASSERT(0);
    #endif /* __MMI_SWFLASH__ */ 

    }
    else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE) ||
             (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_IMAGE_ID))
    {
        /* image case */
        /* currently do nothing */
    }
    else
    {
        /* shall no enter here */
        MMI_ASSERT(0);
    }

    gdi_layer_lock_frame_buffer();

    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();

    set_main_LCD_dt_date_hide_function(CM_screens_hide_date_time_display);
    set_main_LCD_dt_time_hide_function(CM_screens_hide_date_time_display);
    set_dt_display(DT_MT_CALL_SCREEN);

    MMI_title_icon = NULL;
    MMI_disable_title_shortcut_display = 1;

    /* draw title */
    if (title_id == 0)
    {
        status_icon = 1;
        ShowStatusIconsTitle();
    #ifdef __MMI_UI_DALMATIAN_IDLESCREEN__
        arrange_status_icons();
    #endif 
    }
    else if (!((title_id == 0xffff)))
    {
        status_icon = 2;
        MMI_title_string = (UI_string_type) get_string(title_id);
    }
    else
    {
        status_icon = 0;
    }

    if (UI_device_height == 128)
    {
        text_y = MMI_status_bar_height + main_LCD_dt_object.date.height + main_LCD_dt_object.time.height + 2;
    }
    else
    {
        text_y = MMI_status_bar_height;
    }

   /****************************************************************************
   * Message String                                                               
   * gMMI_UI_U8_flag_1 = 0 (No "Calling..." String, for MT Call)
   * gMMI_UI_U8_flag_1 = 1 (With "Calling..." String, for MO Call)
   ****************************************************************************/

    /* support IP dialing */
    if (NameOrNumber)
    {
        memset((PS8) CM_string_buf, 0, (MAX_IP_NUMBER_LEN + MAX_DIGIT) * 2);
        gui_strcpy((UI_string_type) CM_string_buf, (UI_string_type) IP_Number);
        gui_strcat((UI_string_type) CM_string_buf, (UI_string_type) NameOrNumber);
        MMI_message_string = (UI_string_type) CM_string_buf;
    }
    else
    {
        MMI_message_string = NULL;
    }

    if(SlaveNameOrNumber)
   {
	memset ((PS8)CM_mtpnpstring_buf,0,(MAX_IP_NUMBER_LEN+MAX_DIGIT)*2);
	gui_strcpy((UI_string_type)CM_mtpnpstring_buf,(UI_string_type)IP_Number);
	gui_strcat((UI_string_type)CM_mtpnpstring_buf,(UI_string_type)SlaveNameOrNumber);
	MMI_message_string2 = (UI_string_type) CM_mtpnpstring_buf;
    }
    else
    {
	MMI_message_string2 = NULL;
    }
    gui_set_font(&MMI_medium_font);
    gui_measure_string(MMI_message_string, &string_width, &string_height);
    gui_measure_string(MMI_message_string2, &string_width, &string_height);

    text_offset_x = (UI_device_width >> 1) - (string_width >> 1);

    if (text_offset_x < 1)
    {
        text_offset_x = 1;
    }

    text_offset_y = UI_device_height - MMI_button_bar_height - string_height - text_spaing;
    text_width = string_width;

    text_height = string_height;

    if (NotificationStringId != 0)
    {
        str = get_string(NotificationStringId);
        create_multiline_inputbox_set_buffer(
            str,
            gui_strlen((UI_string_type) str),
            gui_strlen((UI_string_type) str),
            0);
    #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
        MMI_multiline_inputbox.normal_text_color = *current_MMI_theme->CM_screen_text_color;
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
        MMI_multiline_inputbox.normal_text_color = *current_MMI_theme->list_normal_text_color;
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
    #endif 
        MMI_multiline_inputbox.flags |=
            UI_MULTI_LINE_INPUT_BOX_DISABLE_SCROLLBAR | UI_MULTI_LINE_INPUT_BOX_DISABLE_BACKGROUND |
            UI_MULTI_LINE_INPUT_BOX_DISABLE_CURSOR_DRAW | UI_MULTI_LINE_INPUT_BOX_CENTER_JUSTIFY;

        if (UI_device_height != 128)
        {
            MMI_multiline_inputbox.flags &= ~UI_MULTI_LINE_INPUT_BOX_CENTER_JUSTIFY;
        }

        MMI_multiline_inputbox.text_y = 0;
        show_multiline_inputbox_no_draw();
        fh = get_multiline_inputbox_line_height();

        resize_multiline_inputbox(UI_device_width, fh + MULTILINE_INPUTBOX_HEIGHT_PAD);
        gMMI_UI_U8_flag_1 = 1;  /* With "Calling" string,MO calling */
    }
    else
    {
        fh = Get_FontHeight(*UI_font, (U8) gCurrLangIndex);
        gMMI_UI_U8_flag_1 = 0;  /* Without "Calling" string, MT calling */
    }

   /****************************************************************************
   *  Get Image, Video or SWFlash info
   *****************************************************************************/

    /* prepare image, video or swflash */
    switch (cat_momt_resource_type)
    {

    #ifdef __MMI_AVATAR__
        case WGUI_CATE_MOMT_RES_TYPE_AVATAR_FILE:
        {
            gdi_image_get_dimension_mem(GDI_IMAGE_TYPE_AVATAR,(PU8) cat_momt_resource_filename,0,&image_width,&image_height);        
        }
            break;

    #endif /* __MMI_AVATAR__*/

        case WGUI_CATE_MOMT_RES_TYPE_IMAGE_ID:
        {
            image_ptr = get_image(cat_momt_resource_id);
            gdi_image_get_dimension(image_ptr, &image_width, &image_height);
        }
            break;

        case WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE:
        {
            img_ret = gdi_image_get_dimension_file((PS8) resource_filename, &image_width, &image_height);

            if (img_ret < 0)
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
            break;

    #ifdef __MMI_VIDEO_PLAYER__
        case WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE:
        {
            /* open with audio is on */
            mdi_ret = mdi_video_ply_open_clip_file(cat_momt_resource_filename, &wgui_video_info);

            cat_momt_is_video_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_video_info.width;
                image_height = wgui_video_info.height;

                mdi_video_ply_close_clip_file();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }

        }
            break;

        case WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID:
        {
            mdi_ret = mdi_video_ply_open_clip_id(cat_momt_resource_id, &wgui_video_info);

            cat_momt_is_video_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_video_info.width;
                image_height = wgui_video_info.height;
                
                mdi_video_ply_close_clip_id();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
            break;
    #endif /* __MMI_VIDEO_PLAYER__ */ 

    #ifdef __MMI_SWFLASH__
        case WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE:
        {
            if (cat_momt_is_aud_enable)
            {            
                mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_PLAYER, &wgui_swflash_info);
            }
            else
            {
                mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_SCREEN, &wgui_swflash_info);
            }
            
            cat_momt_is_swflash_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_swflash_info.width;
                image_height = wgui_swflash_info.height;

                mdi_swflash_close_file();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }

        }
            break;

        case WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID:
        {
            if (cat_momt_is_aud_enable)
            {
                mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_PLAYER, &wgui_swflash_info);
            }
            else
            {
                mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_SCREEN, &wgui_swflash_info);
            }

            cat_momt_is_swflash_open = (mdi_ret >= 0) ? TRUE : FALSE;

            if (mdi_ret >= 0)
            {
                mdi_audio_set_volume(MDI_VOLUME_MEDIA, GetRingVolumeLevel());

                image_width = wgui_swflash_info.width;
                image_height = wgui_swflash_info.height;

                mdi_swflash_close_id();
            }
            else
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
                img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                MMI_ASSERT(img_ret >= 0);
            }
        }
            break;
    #endif /* __MMI_SWFLASH__ */ 

        default:
        {
            /* wrong resouce type */
            MMI_ASSERT(0);
        }
    }

   /********************************************************************************
   *  Calculate drawable region for Image and Video
   ********************************************************************************/
    SetMOMTCallImageClip(image_width, image_height);

   /********************************************************************************
   *  Create Video or SWFlash Layer 
   ********************************************************************************/
    if (!cat_momt_is_show_default)
    {
    #ifdef __MMI_VIDEO_PLAYER__
        /* video is successfully opened, create video playback layer */
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
        {
            if (mdi_ret >= 0)
            {
                if (CM_need_change_clip)
                {
                    /* video larger than drawable region, need resize */

                    /* calc draw size */
                    gdi_image_util_fit_bbox(
                        wgui_image_clip_x2 - wgui_image_clip_x1 + 1,
                        wgui_image_clip_y2 - wgui_image_clip_y1 + 1,
                        wgui_video_info.width,
                        wgui_video_info.height,
                        &resized_offset_x,
                        &resized_offset_y,
                        &resized_width,
                        &resized_height);
                }
                else
                {
                    /* video smaller than region - align at center */
                    resized_offset_x = ((wgui_image_clip_x2 - wgui_image_clip_x1 + 1) - wgui_video_info.width) >> 1;
                #ifdef __MMI_MAINLCD_128X128__
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_video_info.height) >> 1;
                #else 
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_video_info.height);
                #endif 

                    resized_width = wgui_video_info.width;
                    resized_height = wgui_video_info.height;
                }

                MMI_ASSERT(wgui_layer_1 == GDI_LAYER_EMPTY_HANDLE);

                MOMT_allocate_media_layer(
                        wgui_image_clip_x1 + resized_offset_x,
                        wgui_image_clip_y1 + resized_offset_y,
                        resized_width,
                        resized_height);
            }
        }
    #endif /* __MMI_VIDEO_PLAYER__ */ 

    #ifdef __MMI_SWFLASH__
        /* SWFlash is successfully opened, create video playback layer */
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
        {
            if (mdi_ret >= 0)
            {
                if (CM_need_change_clip)
                {
                    /* swflash larger than drawable region, need resize */

                    /* calc draw size */
                    gdi_image_util_fit_bbox(
                        wgui_image_clip_x2 - wgui_image_clip_x1 + 1,
                        wgui_image_clip_y2 - wgui_image_clip_y1 + 1,
                        wgui_swflash_info.width,
                        wgui_swflash_info.height,
                        &resized_offset_x,
                        &resized_offset_y,
                        &resized_width,
                        &resized_height);
                }
                else
                {
                    /* video smaller than region - align at center */
                    resized_offset_x = ((wgui_image_clip_x2 - wgui_image_clip_x1 + 1) - wgui_swflash_info.width) >> 1;
                #ifdef __MMI_MAINLCD_128X128__
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_swflash_info.height) >> 1;
                #else 
                    resized_offset_y = ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1) - wgui_swflash_info.height);
                #endif 

                    resized_width = wgui_swflash_info.width;
                    resized_height = wgui_swflash_info.height;
                }

                MMI_ASSERT(wgui_layer_1 == GDI_LAYER_EMPTY_HANDLE);

                MOMT_allocate_media_layer(
                        wgui_image_clip_x1 + resized_offset_x,
                        wgui_image_clip_y1 + resized_offset_y,
                        resized_width,
                        resized_height);
            }
        }
    #endif /* __MMI_SWFLASH__ */ /* __MMI_VIDEO_PLAYER__ */
    }

   /********************************************************************************
   *  Create scrolling text
   ********************************************************************************/
    {
        gCallLine = CallLine;
        if (gCallLine == 0)
        {
            if (text_width > (UI_device_width - 2))
            {
                text_width = UI_device_width - 2;
            }
        }
        else
        {
            gdi_image_get_dimension_id(gCallLine, &icon_w, &icon_h);
            x_shift = icon_w + 2;
            if (text_width > (UI_device_width - 3 - icon_w))
            {
                text_width = UI_device_width - 3 - icon_w;
            }
        }
    }

    if (UI_device_height == 128)
    {
        S32 tx = 0;

        if (gCallLine != 0)
        {
            tx = ((UI_device_width - text_width - icon_w - 1) >> 1) + icon_w + 1;
        }
        else
        {
            tx = (UI_device_width - text_width) >> 1;
        }
        if (tx < x_shift)
        {
            tx = x_shift;
        }

        gui_create_scrolling_text(
            &CM_scrolling_text,
            tx,
            CM_y,
            text_width,
            text_height,
            MMI_message_string,
            CM_scrolling_text_timer_callback, CM_draw_scrolling_text_background,
        #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
            *current_MMI_theme->CM_screen_text_color,
        #else 
            gui_color(0, 0, 0),
        #endif 
            gui_color(255, 255, 255));
		
	 gui_create_scrolling_text(
            &CM_mtpnpscrolling_text,
            tx,
            CM_y+text_height+4,
            text_width,
            text_height,
            MMI_message_string2,
            CM_mtpnpscrolling_text_timer_callback, CM_draw_scrolling_text_background,
        #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
            *current_MMI_theme->CM_screen_text_color,
        #else 
            gui_color(0, 0, 0),
        #endif 
            gui_color(255, 255, 255));
    }
    else
    {
    	 kal_prompt_trace(MOD_MMI,"ShowMOMTCallBothScreen uihight not equal 128");
        gui_create_scrolling_text(
            &CM_scrolling_text, x_shift, CM_y + 1,
            text_width, text_height,
            MMI_message_string,
            CM_scrolling_text_timer_callback, CM_draw_scrolling_text_background,
        #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
            *current_MMI_theme->CM_screen_text_color,
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
            *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        #else
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
            gui_color(0, 0, 0),
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
            *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        #endif 
            gui_color(255, 255, 255));
		
	 gui_create_scrolling_text(
            &CM_mtpnpscrolling_text, x_shift, 
            CM_y + text_height + 5,
            text_width, text_height,
            MMI_message_string2,
            CM_mtpnpscrolling_text_timer_callback, CM_draw_scrolling_text_background,
        #ifdef __MMI_DOWNLOADABLE_THEMES_SUPPORT__
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
            *current_MMI_theme->CM_screen_text_color,
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
            *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        #else
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
            gui_color(0, 0, 0),
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
            *current_MMI_theme->list_normal_text_color,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
        #endif 
            gui_color(255, 255, 255));
   kal_prompt_trace(MOD_MMI,"ShowMOMTCallBothScreen gui_create_scrolling_text first = %x",CM_y + 1);
   kal_prompt_trace(MOD_MMI,"ShowMOMTCallBothScreen gui_create_scrolling_text second = %x",CM_y +  text_height + 5);
    }

    CM_scrolling_text.flags &= ~UI_SCROLLING_TEXT_BORDERED_TEXT;
    CM_mtpnpscrolling_text.flags &= ~UI_SCROLLING_TEXT_BORDERED_TEXT;

    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitMOMTCallScreen;
    dm_setup_category_functions(dm_redraw_category_screen, dummy_get_history, dummy_get_history_size);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY18_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
#ifdef __MMI_VIDEO_PLAYER__
    if (!cat_momt_is_show_default)
    {
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE))
        {
            if (cat_momt_is_video_open)
            {
                dm_data.s32flags |= DM_NO_BLT;
            }
        }
    }
#endif /* __MMI_VIDEO_PLAYER__ */
    dm_setup_data(&dm_data);
    dm_register_category_controlled_callback(DrawMOMTCallScreenControllArea);
    dm_redraw_category_screen();

#ifdef __MMI_VIDEO_PLAYER__
    if (!cat_momt_is_show_default)
    {
        /* start play video */
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE))
        {
            if (cat_momt_is_video_open) /* open file successfully */
            {
                if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID)
                {
                    mdi_video_ply_open_clip_id(cat_momt_resource_id, &wgui_video_info);
                }
                else
                {
                    mdi_video_ply_open_clip_file(cat_momt_resource_filename, &wgui_video_info);
                }

                mdi_ret = mdi_video_ply_seek(cat_momt_video_play_time);

                if (mdi_ret >= 0)
                {
                    /* if aud is on but not play when start, mute it */
                    if (cat_momt_is_aud_enable && !cat_momt_is_play_aud_when_start)
                    {
                        mdi_audio_set_mute(MDI_VOLUME_MEDIA, TRUE);
                        cat_momt_is_aud_muted = TRUE;
                    }
                }

                if (mdi_ret >= 0)
                {
                    MOMT_set_blt_layer();

                    /* dm_redraw_category_screen will not blt when call video,
                     * blt here for the first frame of the video */
                    gdi_lcd_repaint_all();

                    mdi_ret = mdi_video_ply_play(
                                wgui_layer_1,
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
                                GDI_LAYER_ENABLE_LAYER_0 | GDI_LAYER_ENABLE_LAYER_1,
                                GDI_LAYER_ENABLE_LAYER_1,
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
                                GDI_LAYER_ENABLE_LAYER_0 | GDI_LAYER_ENABLE_LAYER_1 | GDI_LAYER_ENABLE_LAYER_2,
                                GDI_LAYER_ENABLE_LAYER_2,
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
                                (U16) cat_momt_repeat_count,    /* this to recrod repeat count */
                                cat_momt_is_visual_update,      /* update to LCM or not */
                                cat_momt_is_aud_enable,         /* play aud or not */
                                MDI_DEVICE_SPEAKER_BOTH,        /* speaker & earphone */
                                MDI_VIDEO_LCD_ROTATE_0,         /* rotate */
                                100,                            /* 1x play speed */
                                NULL);                          /* do not hook callback */
                }

                cat_momt_is_video_play = (mdi_ret >= 0) ? TRUE : FALSE;

                /* play failed */
                if (mdi_ret < 0)
                {
                    /* faild, need to play default image */
                    cat_momt_is_show_default = TRUE;
                    img_ret = gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);
                    MMI_ASSERT(img_ret >= 0);
                }
            }
        }
     }
#endif /* __MMI_VIDEO_PLAYER__ */ 

#ifdef __MMI_SWFLASH__
    if (!cat_momt_is_show_default)
    {
        if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID) ||
            (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE))
        {
            MOMT_set_blt_layer();
            
            gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);
        }
     }
#endif /* __MMI_SWFLASH__ */
MMI_message_string2 = NULL;
}

void ShowCategoryBothIncomingScreen(
        U16 title_id,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U16 NotificationStringId,
        PU8 NameOrNumber,
        PU8 SlaveNameOrNumber,
        PU8 IP_Number,
        U16 CallLine,
        U16 default_image_id,
        U16 resource_id,
        PS8 resource_filename,
        wgui_cate_momt_res_type_enum resource_type,
        U16 repeat_count,
        BOOL is_visaul_update,
        BOOL is_aud_enable,
        BOOL is_play_aud_when_start,
        PU8 history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ShowMOMTCallBothScreen(
        title_id,
        left_softkey,
        left_softkey_icon,
        right_softkey,
        right_softkey_icon,
        NotificationStringId,
        NameOrNumber,
        SlaveNameOrNumber,
        IP_Number,
        CallLine,
        default_image_id,
        resource_id,
        resource_filename,
        resource_type,
        repeat_count,
        is_visaul_update,
        is_aud_enable,
        is_play_aud_when_start,
        history_buffer);
}   /* end of ShowCategoryBothIncomingScreen */
#endif  /*defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/

/*****************************************************************************
 * FUNCTION
 *  MOMTHideAnimation
 * DESCRIPTION
 *  Stop and grey MOMT Call image files
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void MOMTHideAnimation(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (MOMT_animation_handle != GDI_ERROR_HANDLE)
    {
        gdi_image_stop_animation(MOMT_animation_handle);
        MOMT_animation_handle = GDI_ERROR_HANDLE;
    }
    gui_cross_hatch_fill_rectangle(
        wgui_image_clip_x1,
        wgui_image_clip_y1,
        wgui_image_clip_x2,
        wgui_image_clip_y2,
        UI_COLOR_BLACK);
}


/*****************************************************************************
 * FUNCTION
 *  RedrawMOMTCallScreen
 * DESCRIPTION
 *  Redraw MOMT Call Screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void RedrawMOMTCallScreen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    UI_filled_area *bg_filler;
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */
    S32 image_width;
    S32 image_height;
    S32 image_offset_x;
    S32 image_offset_y;
    S32 resized_width, resized_height;
    GDI_RESULT image_ret;

#if defined(__MMI_VIDEO_PLAYER__) || defined(__MMI_SWFLASH__)
    MDI_RESULT mdi_ret;
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    UI_set_main_LCD_graphics_context();
    gui_hide_animations();

#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    /* fill with theme background color */
    bg_filler = current_MMI_theme->CM_screen_background_filler;
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

    gdi_layer_reset_clip();
#ifndef __MMI_WALLPAPER_ON_BOTTOM__
    gui_draw_filled_area(0, 0, UI_device_width - 1, UI_device_height - 1, bg_filler);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
    gdi_draw_solid_rect(0, 0, UI_device_width - 1, UI_device_height - 1, GDI_COLOR_TRANSPARENT);
    DrawCMImageBackground();
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

    if (status_icon == 1)
    {
        show_title_status_icon();
        show_status_icons();
    }
    else if (status_icon == 2)
    {
        draw_title();
        show_title_status_icon();
    }

#ifndef __MMI_CM_SCREEN_HIDE_DATE_TIME__
    if (UI_device_height == 128 && CM_Screen_show_date_time_bar == 1)
    {
        CM_screens_draw_date_time_bar();
        show_main_LCD_dt_display();
    }
#endif /* __MMI_CM_SCREEN_HIDE_DATE_TIME__ */ 

    if (!cat_momt_is_show_default)
    {

        if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_IMAGE_ID) /* iamge from id */
        {
            gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);
            gdi_image_draw_animation(
                wgui_image_clip_x1,
                wgui_image_clip_y1,
                (U8*) GetImage(cat_momt_resource_id),
                &MOMT_animation_handle);

            if (isCallDisconnecting)
            {
                MOMTHideAnimation();
            }
        }
        else if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_AVATAR_FILE)
        {
        #ifdef __MMI_AVATAR__       
            image_ret = gdi_image_get_dimension_mem(GDI_IMAGE_TYPE_AVATAR,(PU8) cat_momt_resource_filename,0,&image_width,&image_height);        

            if (image_ret >= 0)
            {
                if (CM_need_change_clip)
                {
                    wgui_image_clip_x1 = 0;
                    wgui_image_clip_x2 = UI_device_width - 1;
                    gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);

                    /* image larger than drawable region */
                    gdi_image_util_fit_bbox(
                        UI_device_width,
                        wgui_image_clip_y2 - wgui_image_clip_y1 + 1,
                        image_width,
                        image_height,
                        &image_offset_x,
                        &image_offset_y,
                        &resized_width,
                        &resized_height);

                    image_ret = gdi_anim_draw_mem_resized(
                                    wgui_image_clip_x1 + image_offset_x,
                                    wgui_image_clip_y1 + image_offset_y,
                                    resized_width,
                                    resized_height,
                                    (PS8) cat_momt_resource_filename,
                                    GDI_IMAGE_TYPE_AVATAR,
                                    0, 
                                    &MOMT_animation_handle);

                    if (isCallDisconnecting)
                    {
                        MOMTHideAnimation();
                    }

                }
                else
                {
                    gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);

                    image_ret = gdi_anim_draw_mem(
                                    wgui_image_clip_x1,
                                    wgui_image_clip_y1,
                                    (PS8) cat_momt_resource_filename,
                                    GDI_IMAGE_TYPE_AVATAR,
                                    0, 
                                    &MOMT_animation_handle);
                }
                if (image_ret >= 0)
                    cat_momt_is_avatar_play = TRUE;
            }

            if (image_ret < 0)
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
            }

            if (isCallDisconnecting)
            {
                MOMTHideAnimation();
            }

        #endif /* __MMI_AVATAR__ */ 
        }
        else if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE)  /* image from file */
        {
            image_ret = gdi_image_get_dimension_file((PS8) cat_momt_resource_filename, &image_width, &image_height);

            if (image_ret >= 0)
            {
                if (CM_need_change_clip)
                {
                    wgui_image_clip_x1 = 0;
                    wgui_image_clip_x2 = UI_device_width - 1;
                    gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);

                    /* image larger than drawable region */
                    gdi_image_util_fit_bbox(
                        UI_device_width,
                        wgui_image_clip_y2 - wgui_image_clip_y1 + 1,
                        image_width,
                        image_height,
                        &image_offset_x,
                        &image_offset_y,
                        &resized_width,
                        &resized_height);

                    image_ret = gdi_anim_draw_file_resized(
                                    wgui_image_clip_x1 + image_offset_x,
                                    wgui_image_clip_y1 + image_offset_y,
                                    resized_width,
                                    resized_height,
                                    (PS8) cat_momt_resource_filename,
                                    &MOMT_animation_handle);

                    if (isCallDisconnecting)
                    {
                        MOMTHideAnimation();
                    }

                }
                else
                {
                    gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);

                    image_ret = gdi_image_draw_animation_file(
                                    wgui_image_clip_x1 + ((wgui_image_clip_x2 - wgui_image_clip_x1 + 1 - image_width) >> 2),
                                    wgui_image_clip_y1 + ((wgui_image_clip_y2 - wgui_image_clip_y1 + 1 - image_height) >> 2),
                                    (PS8) cat_momt_resource_filename,
                                    &MOMT_animation_handle);
                }
            }

            if (image_ret < 0)
            {
                /* faild, need to play default image */
                cat_momt_is_show_default = TRUE;
            }

            if (isCallDisconnecting)
            {
                MOMTHideAnimation();
            }
        }
        else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
                 (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
        {
        #ifdef __MMI_VIDEO_PLAYER__
            if (cat_momt_is_video_open) /* open file successfully */
            {
                if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID)
                {
                    mdi_video_ply_open_clip_id(cat_momt_resource_id, &wgui_video_info);
                }
                else
                {
                    mdi_video_ply_open_clip_file(cat_momt_resource_filename, &wgui_video_info);
                }

                /* seek to first frame */
                mdi_ret = mdi_video_ply_seek_and_get_frame(cat_momt_video_play_time, wgui_layer_1);

                if (mdi_ret < 0)
                {
                    /* faild, need to play default image */
                    cat_momt_is_show_default = TRUE;
                }
                else
                {
                    if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID)
                    {
                        mdi_video_ply_close_clip_id();
                    }
                    else
                    {
                        mdi_video_ply_close_clip_file();
                    }
                }
            }
            else
            {
                MMI_ASSERT(0);
            }
        #endif /* __MMI_VIDEO_PLAYER__ */ 
        }
        else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
                 (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
        {
        #ifdef __MMI_SWFLASH__
            if (cat_momt_is_swflash_open)    /* open file successfully */
            {
                MOMT_set_blt_layer();

                if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID)
                {
                    if (cat_momt_is_aud_enable)
                    {
                        mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_PLAYER, &wgui_swflash_info);
                    }
                    else
                    {
                        mdi_ret = mdi_swflash_open_id(cat_momt_resource_id, SWFLASH_SCREEN, &wgui_swflash_info);
                    }
                }
                else
                {
                    if (cat_momt_is_aud_enable)
                    {            
                        mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_PLAYER, &wgui_swflash_info);
                    }
                    else
                    {
                        mdi_ret = mdi_swflash_open_file(cat_momt_resource_filename, SWFLASH_SCREEN, &wgui_swflash_info);
                    }
                }

                if (mdi_ret >= 0)
                {
                    mdi_ret = mdi_swflash_play(
                                wgui_layer_1,                       /* layer */
                                0,                                  /* repeat_count */
                                MDI_DEVICE_SPEAKER_BOTH,            /* audio_path */
                                MOMTPlaySWFlashResultCallback);     /* play_result_callback */
                }

                cat_momt_is_swflash_play = (mdi_ret >= 0) ? TRUE : FALSE;

                if (mdi_ret >= 0)
                {
                    /* if aud is on but not play when start, mute it */
                    if (cat_momt_is_aud_enable && !cat_momt_is_play_aud_when_start)
                    {
                        mdi_audio_set_mute(MDI_VOLUME_MEDIA, TRUE);
                        cat_momt_is_aud_muted = TRUE;
                    }
                }

                if (mdi_ret < 0)
                {
                    /* faild, need to play default image */
                    cat_momt_is_show_default = TRUE;
                }
            }
            else
            {
                MMI_ASSERT(0);
            }

        #endif /* __MMI_SWFLASH__ */ 
        }
        else
        {
            MMI_ASSERT(0);
        }
    }   /* not show default image */

    /* show default image if needed */
    if (cat_momt_is_show_default)
    {
        gdi_image_get_dimension_id(cat_momt_default_image_id, &image_width, &image_height);

#ifndef __MMI_WALLPAPER_ON_BOTTOM__
        gui_draw_filled_area(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2, bg_filler);
#else /* __MMI_WALLPAPER_ON_BOTTOM__ */
        gdi_draw_solid_rect(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2, GDI_COLOR_TRANSPARENT);
#endif /* __MMI_WALLPAPER_ON_BOTTOM__ */

        SetMOMTCallImageClip(image_width, image_height);
        gdi_layer_set_clip(wgui_image_clip_x1, wgui_image_clip_y1, wgui_image_clip_x2, wgui_image_clip_y2);

        gdi_image_draw_animation(
            wgui_image_clip_x1,
            wgui_image_clip_y1,
            (U8*) GetImage(cat_momt_default_image_id),
            &MOMT_animation_handle);

        if (isCallDisconnecting)
        {
            MOMTHideAnimation();
        }
    }

    if (gMMI_UI_U8_flag_1 == 1)
    {
        show_multiline_inputbox();
    }

    if (gCallLine != 0)
    {
        S32 icon_w = 0, icon_h = 0;
#ifdef __MMI_MAINLCD_128X128__
        S32 sw = 0, sh = 0;
#endif
        S32 tx = 0;

        gdi_image_get_dimension_id(gCallLine, &icon_w, &icon_h);

#ifdef __MMI_MAINLCD_128X128__
        gui_set_font(current_MMI_theme->title_text_font);
        gui_measure_string(MMI_message_string, &sw, &sh);
        tx = (UI_device_width >> 1) - ((sw + icon_w + 1) >> 1);
        if (tx < 1)
        {
            tx = 1;
        }
#else /* __MMI_MAINLCD_128X128__ */ 
            tx = 1;
#endif /* __MMI_MAINLCD_128X128__ */
        gdi_layer_push_clip();
        gdi_layer_reset_clip();
        gdi_layer_set_clip(tx, CM_y, tx + icon_w, CM_y + icon_h);
        gdi_image_draw_id(tx, CM_y, gCallLine);
        gdi_layer_pop_clip();
    }

    if (MMI_message_string)
    {
        gui_show_scrolling_text(&CM_scrolling_text);
    }
#if defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
    if (MMI_message_string2)
    {
        gui_show_scrolling_text(&CM_mtpnpscrolling_text);
    }
#endif  /*defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/

    show_softkey_background();
    show_left_softkey();
    show_right_softkey();

    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(0, 0, UI_device_width - 1, UI_device_height - 1);

}


/*****************************************************************************
 * FUNCTION
 *  SetMOMTCallImageClip
 * DESCRIPTION
 *  Set image clips for  MO MT call cateogryscreen
 * PARAMETERS
 *  image_width         [IN]        Image width
 *  image_height        [IN]        Image height
 * RETURNS
 *  void
 *****************************************************************************/
static void SetMOMTCallImageClip(S32 image_width, S32 image_height)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 font_height;
    S32 text_y;
    S32 string_width;
    S32 string_height;
    S32 y;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    CM_need_change_clip = FALSE;

    if (gMMI_UI_U8_flag_1)
    {
        //font_height = get_multiline_inputbox_line_height();
        font_height = MMI_multiline_inputbox.text_height + 4 /* editor border */;
    }
    else
    {
        font_height = Get_FontHeight(*UI_font, (U8) gCurrLangIndex);
    }

    gui_set_font(&MMI_medium_font);
    gui_measure_string(MMI_message_string, &string_width, &string_height);

    if (UI_device_height == 128)
    {
        text_y = MMI_status_bar_height + main_LCD_dt_object.date.height + main_LCD_dt_object.time.height + 2;

        y = UI_device_height - MMI_button_bar_height - font_height - string_height - 1;
        move_multiline_inputbox(0, y);

        CM_y = UI_device_height - MMI_button_bar_height - string_height;

        /* calcaute drawable region for image and video */
        wgui_image_clip_x1 = 0;
        wgui_image_clip_x2 = UI_device_width - 1;
        wgui_image_clip_y1 = text_y + 2;

        if (gMMI_UI_U8_flag_1 == 1) /* with Calling string, MO */
        {
            wgui_image_clip_y2 = y - 1;
        }
        else    /* without Calling string, MT */
        {
            wgui_image_clip_y2 = CM_y - 1 - 2;
        }

        if (image_width <= UI_device_width)
        {
            wgui_image_clip_x1 = (UI_device_width - image_width) >> 1;
            wgui_image_clip_x2 = wgui_image_clip_x1 + image_width - 1;
        }
        else
        {
            wgui_image_clip_x1 = 0; /* indicate the input image is wider than displayable area */
            wgui_image_clip_x2 = UI_device_width - 1;
            CM_need_change_clip = TRUE;
        }

        if (wgui_image_clip_y2 - wgui_image_clip_y1 + 1 < image_height)
        {
            /* no enough space to display image */
            CM_Screen_show_date_time_bar = 0;
            wgui_image_clip_y1 = MMI_status_bar_height + 2;
            deactive_main_lcd_update_date_time();
            if (wgui_image_clip_y2 - wgui_image_clip_y1 + 1 < image_height)
            {
                CM_need_change_clip = TRUE;
            }
        }
        else
        {
            CM_Screen_show_date_time_bar = 1;
        }

    }
    else    /* UI_device_height == 160, 220 */
    {
        text_y = MMI_status_bar_height;

        deactive_main_lcd_update_date_time();
        move_multiline_inputbox(0, MMI_status_bar_height);

        CM_y = MMI_status_bar_height + font_height;

        /* calcaute drawable region for image and video */
        wgui_image_clip_x1 = 0;
        wgui_image_clip_x2 = UI_device_width - 1;

#ifdef __MMI_MAINLCD_128X128__ 
        /* put the image at the bottom */
        if (image_height < UI_device_height - MMI_button_bar_height - (CM_y + 1 + string_height))
        {
            wgui_image_clip_y1 = UI_device_height - MMI_button_bar_height - image_height;
            wgui_image_clip_y2 = wgui_image_clip_y1 + image_height - 1;
        }
#else /* __MMI_MAINLCD_128X128__ */
        if (image_height < MMI_CM_MAX_IMG_HEIGHT)
        {
            /* put the image at the center */
            wgui_image_clip_y1 = UI_device_height - MMI_button_bar_height - image_height - ((MMI_CM_MAX_IMG_HEIGHT - image_height) >> 1);
            wgui_image_clip_y2 = wgui_image_clip_y1 + image_height - 1;
        }
#endif /* __MMI_MAINLCD_128X128__ */
        else
        {
#ifdef __MMI_MAINLCD_128X128__ 
            /* put the image at the bottom */
            wgui_image_clip_y1 = CM_y + 1 + string_height + 1;  /* one pixel for gap */
#else /* __MMI_MAINLCD_128X128__ */
            wgui_image_clip_y1 = UI_device_height - MMI_button_bar_height - MMI_CM_MAX_IMG_HEIGHT;
#endif /* __MMI_MAINLCD_128X128__ */
            /* indicate the input image is higher than displayable area */
            wgui_image_clip_y2 = UI_device_height - MMI_button_bar_height - 1;
            CM_need_change_clip = TRUE;
        }
        if (image_width <= UI_device_width)
        {
            wgui_image_clip_x1 = (UI_device_width - image_width) >> 1;
            wgui_image_clip_x2 = wgui_image_clip_x1 + image_width - 1;
        }
        else
        {
            /* indicate the input image is wider than displayable area */
            wgui_image_clip_x1 = 0;
            wgui_image_clip_x2 = UI_device_width - 1;
            CM_need_change_clip = TRUE;
        }

    }
}


/*****************************************************************************
 * FUNCTION
 *  DrawMOMTCallScreenControllArea
 * DESCRIPTION
 *  draw MOMT screen control area
 * PARAMETERS
 *  coordinate      [IN]        Coordinae of redraw area
 * RETURNS
 *  void
 *****************************************************************************/
void DrawMOMTCallScreenControllArea(dm_coordinates *coordinate)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    RedrawMOMTCallScreen();
}


/*****************************************************************************
 * FUNCTION
 *  MOMTPlayVideoResultCallback
 * DESCRIPTION
 *  play video result callback function
 * PARAMETERS
 *  result      [IN]        Play vido result
 * RETURNS
 *  void
 *****************************************************************************/
#if 0//def __MMI_VIDEO_PLAYER__//110606 compile warning
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* __MMI_VIDEO_PLAYER__ */ 


/*****************************************************************************
 * FUNCTION
 *  MOMTPlaySWFlashResultCallback
 * DESCRIPTION
 *  play swflash result callback function
 * PARAMETERS
 *  result      [IN]        Play vido result
 * RETURNS
 *  void
 *****************************************************************************/
#ifdef __MMI_SWFLASH__
static void MOMTPlaySWFlashResultCallback(MDI_RESULT result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* do nothing */
}
#endif /* __MMI_SWFLASH__ */ 


/*****************************************************************************
 * FUNCTION
 *  ExitMOMTCallScreen
 * DESCRIPTION
 *  Exit MO MT call screen.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void ExitMOMTCallScreen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    UI_set_main_LCD_graphics_context();
    close_status_icons();
    gui_hide_animations();

    MOMT_animation_handle = GDI_ERROR_HANDLE;
    isCallDisconnecting = MMI_FALSE;

    gui_cancel_timer(CM_scrolling_text_timer_callback);
#if defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)
    gui_cancel_timer(CM_mtpnpscrolling_text_timer_callback);
#endif  /*defined( __MMI_DUAL_SIM_MASTER__) && !defined(__MMI_UCM__)*/
    gui_cancel_timer(handle_CM_text_scroll);
    close_main_LCD_dt_display();
    reset_softkeys();
    reset_multitaps();
    reset_multiline_inputbox();
    enactive_main_lcd_update_date_time();

    if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE) ||
        (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID))
    {
    #ifdef __MMI_VIDEO_PLAYER__

        if (cat_momt_is_video_open)
        {
            /* get current play time */
            mdi_video_ply_get_cur_play_time(&cat_momt_video_play_time);

            /* stop video playing */
            if (cat_momt_is_video_play)
            {
                mdi_video_ply_stop();
                cat_momt_is_video_play = FALSE;
                mdi_video_ply_seek_and_get_frame(cat_momt_video_play_time, wgui_layer_1);
            }

            if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE)
            {
                mdi_video_ply_close_clip_file();
            }
            else
            {
                mdi_video_ply_close_clip_id();
            }

            /* unmute */
            if (cat_momt_is_aud_muted)
            {
                cat_momt_is_aud_muted = FALSE;
                mdi_audio_set_mute(MDI_VOLUME_MEDIA, FALSE);
            }

            cat_momt_is_video_open = FALSE;
        }

        if (wgui_layer_1 != GDI_LAYER_EMPTY_HANDLE)
        {
            /* flatten layers */
            gdi_layer_flatten_previous_to_base();

            gdi_layer_free(wgui_layer_1);
            wgui_layer_1 = GDI_LAYER_EMPTY_HANDLE;
        }

        gdi_layer_set_blt_layer(wgui_base_layer, 0, 0, 0);
        gdi_layer_multi_layer_disable();

        /* allows MMI LCD sleep */
        TurnOffBacklight();
    #else /* __MMI_VIDEO_PLAYER__ */ 
        MMI_ASSERT(0);  /* try to play video when no video function support */
    #endif /* __MMI_VIDEO_PLAYER__ */ 
    }
    else if ((cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE) ||
             (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID))
    {
    #ifdef __MMI_SWFLASH__
        if (cat_momt_is_swflash_open)
        {
            /* stop video playing */
            if (cat_momt_is_swflash_play)
            {
                mdi_swflash_stop();
                cat_momt_is_video_play = FALSE;
            }

            if (cat_momt_resource_type == WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE)
            {
                mdi_swflash_close_file();
            }
            else
            {
                mdi_swflash_close_id();
            }

            /* unmute */
            if (cat_momt_is_aud_muted)
            {
                cat_momt_is_aud_muted = FALSE;
                mdi_audio_set_mute(MDI_VOLUME_MEDIA, FALSE);
            }

            cat_momt_is_swflash_open = FALSE;
        }

        if (wgui_layer_1 != GDI_LAYER_EMPTY_HANDLE)
        {
            /* flatten layers */
            gdi_layer_flatten_previous_to_base();

            gdi_layer_free(wgui_layer_1);
            wgui_layer_1 = GDI_LAYER_EMPTY_HANDLE;
        }

        gdi_layer_set_blt_layer(wgui_base_layer, 0, 0, 0);
        gdi_layer_multi_layer_disable();

        /* allows MMI LCD sleep */
        TurnOffBacklight();
    #else /* __MMI_SWFLASH__ */ 
        MMI_ASSERT(0);  /* try to play video when no video function support */
    #endif /* __MMI_SWFLASH__ */ /* __MMI_VIDEO_PLAYER__ */
    }

    if (CM_media_buffer != NULL)
    {
        applib_mem_screen_free(CM_media_buffer);
        CM_media_buffer = NULL;
    }

    ExitCategoryFunction = MMI_dummy_function;
    RedrawCategoryFunction = MMI_dummy_function;
    GetCategoryHistory = dummy_get_history;
    GetCategoryHistorySize = dummy_get_history_size;
}


/*****************************************************************************
 * FUNCTION
 *  Cat403ListHighliteHandler
 * DESCRIPTION
 *  set category 403 highlight handler
 * PARAMETERS
 *  index       [IN]        index of list item
 * RETURNS
 *  void
 *****************************************************************************/
void Cat403ListHighliteHandler(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_list_highlight_handler(index);
}


/*****************************************************************************
 * FUNCTION
 *  SetCategory403TabSelectCallback
 * DESCRIPTION
 *  set category 403 tab bar select callback
 * PARAMETERS
 *  select_callback     [IN]        callback function
 * RETURNS
 *  void
 *****************************************************************************/
void SetCategory403TabSelectCallback(void (*select_callback) (int index))
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_set_horizontal_tab_bar_select_callback(select_callback);
}


/*****************************************************************************
 * FUNCTION
 *  Category403BlinkTab
 * DESCRIPTION
 *  start blinking tab
 * PARAMETERS
 *  tab     [IN]        tab index
 * RETURNS
 *  void
 *****************************************************************************/
void Category403BlinkTab(S8 tab)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_horizontal_tab_bar_start_blinking(tab);
}


/*****************************************************************************
 * FUNCTION
 *  Category403UnBlinkTab
 * DESCRIPTION
 *  stop blinking tab
 * PARAMETERS
 *  tab     [IN]        tab index
 * RETURNS
 *  void
 *****************************************************************************/
void Category403UnBlinkTab(S8 tab)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    wgui_horizontal_tab_bar_stop_blinking(tab);
}


/*****************************************************************************
 * FUNCTION
 *  UpdateCategory403TabBar
 * DESCRIPTION
 *  Update 403 tab bar
 * PARAMETERS
 *  title               [IN]        Title for the screen
 *  n_tabs              [IN]        Total number of tabs
 *  highlighted_tab     [IN]        The index of highlighted tab
 *  tab_items           [IN]        Array of tab item data
 * RETURNS
 *  void
 *****************************************************************************/
void UpdateCategory403TabBar(UI_string_type title, S8 n_tabs, S8 highlighted_tab, tab_bar_item_type *tab_items)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S32 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    wgui_close_horizontal_tab_bar();

    /* Setup horizontal tab bar */
    for (i = 0; i < n_tabs; i++)
    {
        MMI_tab_bar_items[i] = tab_items[i];
    }
    wgui_create_horizontal_tab_bar(TRUE, title, n_tabs, highlighted_tab, MMI_TRUE);

    gdi_layer_unlock_frame_buffer();

    wgui_show_horizontal_tab_bar();
}

void ExitCategory403Screen(void);

/*****************************************************************************
 * FUNCTION
 *  cat403_screens_hide_duration_display
 * DESCRIPTION
 *  Hide duration function used in 403 screens.
 * PARAMETERS
 *  x1      [IN]        Start x position
 *  y1      [IN]        Start y position
 *  x2      [IN]        End of x position
 *  y2      [IN]        End of y position
 * RETURNS
 *  void
 *****************************************************************************/
void cat403_screens_hide_duration_display(S32 x1, S32 y1, S32 x2, S32 y2)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_draw_solid_rect(x1, y1, x2, y2, GDI_COLOR_TRANSPARENT);
}   /* end of CM_screens_hide_duration_display */

/*****************************************************************************
 * FUNCTION
 *  ShowCategory403Screen
 * DESCRIPTION
 *  Show category 403 screen(VoIP Active Call Screen)
 * PARAMETERS
 *  title                   [IN]        Title for the screen
 *  title_icon              [IN]        Icon shown with the title
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Icon for the Left softkey
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Icon for the right softkey
 *  n_tabs                  [IN]        Total number of tabs
 *  highlighted_tab         [IN]        The index of highlighted tab
 *  tab_items               [IN]        Array of tab item data
 *  CallDuration            [IN]        Duration time
 *  list_of_items           [IN]        Array of list menu item data
 *  list_of_icons           [IN]        Array of list menu item icon
 *  number_of_items         [IN]        Total number of menu items
 *  highlighted_item        [IN]        Index of highlighted menu item
 *  history_buffer          [IN]        history buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory403Screen(
        U8 *title,
        U16 title_icon,
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        S8 n_tabs,
        S8 highlighted_tab,
        tab_bar_item_type *tab_items,
        MYTIME *CallDuration,
        U16 duration_icon,
        U8 **list_of_items,
        U16 *list_of_icons,
        S32 number_of_items,
        U16 highlighted_item,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S32 i = 0;
    U8 h_flag;
    S32 duration_width, duration_height;
    U16 duration_x;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    MMI_menu_shortcut_number = -1;
    MMI_disable_title_shortcut_display = 1;
    MMI_title_string = NULL;
    MMI_title_icon = NULL;

    change_left_softkey(left_softkey, left_softkey_icon);
    change_right_softkey(right_softkey, right_softkey_icon);
    SetupCategoryKeyHandlers();

    /* get duration string size */
    set_time_display(0, 0, 0, 0, 0);
    main_LCD_measure_time_duration_string(&duration_width, &duration_height);

    for (i = 0; i < n_tabs; i++)
    {
        MMI_tab_bar_items[i] = tab_items[i];
    }

    wgui_create_horizontal_tab_bar(TRUE, (UI_string_type) title, n_tabs, highlighted_tab, MMI_FALSE);

    set_dt_duration(CallDuration);
    
    set_main_LCD_dt_duration_hide_function(cat403_screens_hide_duration_display);
    set_dt_display(DT_VOIP_CALL_SCREEN);
    if (duration_icon != 0)
    {
        dm_add_image(get_image(duration_icon), NULL, NULL);
    }    

    /* List */
    create_fixed_icontext_menuitems();
    associate_fixed_icontext_list();
    MMI_current_menu_type = LIST_MENU;
    register_fixed_list_keys();
    resize_fixed_icontext_menuitems(0, MMI_MENUITEM_HEIGHT);

    register_fixed_list_highlight_handler(Cat403ListHighliteHandler);

    for (i = 0; i < number_of_items; i++)
    {
        if (list_of_icons == NULL)
        {
            set_fixed_icontext_positions(GUI_TEXT_MENUITEM_TEXT_X, 0, 1, 0);
            add_fixed_icontext_item((UI_string_type) list_of_items[i], 0);
        }
        else
        {
            set_fixed_icontext_positions(GUI_ICONTEXT_MENUITEM_TEXT_X, 0, GUI_ICONTEXT_MENUITEM_ICON_X, 0);
            add_fixed_icontext_item((UI_string_type) list_of_items[i], wgui_get_list_menu_icon(i, list_of_icons[i]));
        }
        wgui_pop_up_description_strings[i].text_strings[0] = NULL;
    }
    h_flag = set_list_menu_category_history(MMI_CATEGORY403_ID, history_buffer);
    if (h_flag)
    {
        fixed_list_goto_item_no_redraw(MMI_fixed_list_menu.highlighted_item);
    }
    else
    {
        fixed_list_goto_item_no_redraw(highlighted_item);
    }

    if (duration_icon != 0)
    {
        duration_x = (r2lMMIFlag) ? ((U16)(MMI_fixed_icontext_menuitem.width - GUI_ICONTEXT_MENUITEM_TEXT_X - duration_width)) : ((U16)(GUI_ICONTEXT_MENUITEM_TEXT_X));
    }
    else
    {
        duration_x = (r2lMMIFlag) ? ((U16)(MMI_fixed_icontext_menuitem.width - GUI_TEXT_MENUITEM_TEXT_X - duration_width)) : ((U16)(GUI_TEXT_MENUITEM_TEXT_X));
    }

#if defined (__MMI_MAINLCD_128X160__) || defined (__MMI_MAINLCD_128X128__)
    set_main_lcd_duration_position(duration_x, (U16) (MMI_HORIZONTAL_TAB_BAR_TAB_AREA_HEIGHT + MMI_HORIZONTAL_TAB_BAR_HINT_AREA_HEIGHT));        
#else
    set_main_lcd_duration_position(duration_x, (U16) (MMI_STATUS_BAR_HEIGHT + MMI_HORIZONTAL_TAB_BAR_TAB_AREA_HEIGHT + MMI_HORIZONTAL_TAB_BAR_HINT_AREA_HEIGHT));
#endif

    gdi_layer_unlock_frame_buffer();

    ExitCategoryFunction = ExitCategory403Screen;
    dm_setup_category_functions(dm_redraw_category_screen, dm_get_category_history, dm_get_category_history_size);
    dm_data.s32ScrId = (S32) GetActiveScreenId();
    dm_data.s32CatId = MMI_CATEGORY403_ID;
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND;
    dm_setup_data(&dm_data);
    dm_redraw_category_screen();

}


/*****************************************************************************
 * FUNCTION
 *  ExitCategory403Screen
 * DESCRIPTION
 *  Exit category 403 screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory403Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    close_main_LCD_dt_display();
    close_status_icons();
    reset_softkeys();
    reset_fixed_list();
    reset_pop_up_descriptions();
    wgui_close_horizontal_tab_bar();
}

UI_filled_area cat404_fibox={
UI_FILLED_AREA_TYPE_COLOR,
UI_IMAGE_ID_NULL,
NULL,
{255,255,255,100},
{0,0,0,100},
{0,0,0,0},
{0,0,0,100},
0};
UI_filled_area *cat404_fibox_backup = NULL;


/*****************************************************************************
 * FUNCTION
 *  ExitCategory404Screen
 * DESCRIPTION
 *  Exits the VoIP dialing screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExitCategory404Screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    set_MMI_current_input_type();
    wgui_close_inputbox();
    MMI_multiline_inputbox.normal_filler = cat404_fibox_backup;
    reset_softkeys();
    enable_softkey_background();
    reset_multitaps();
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    wgui_reset_wallpaper_on_bottom();
#endif
    wgui_unset_AP_required_input_mode_set_flag();
}


/*****************************************************************************
 * FUNCTION
 *  category404_hide_multitap
 * DESCRIPTION
 *  Hide function for multitap
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void category404_hide_multitap(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();
    gdi_layer_push_clip();
    gdi_layer_reset_clip();
    gdi_draw_solid_rect(
        0,
        MMI_multitap_y,
        UI_device_width - 1,
        MMI_multitap_y + MMI_multitap_height - 1,
        GDI_COLOR_TRANSPARENT);
    gdi_layer_pop_clip();
    gdi_layer_unlock_frame_buffer();
    gdi_layer_blt_previous(0, MMI_multitap_y, UI_device_width - 1, MMI_multitap_y + MMI_multitap_height + 1);
}


/*****************************************************************************
 * FUNCTION
 *  ShowCategory404Screen
 * DESCRIPTION
 *  Displays the category404 screen(VoIP Dialing Screen)
 * PARAMETERS
 *  left_softkey            [IN]        Left softkey label
 *  left_softkey_icon       [IN]        Icon for the Left softkey
 *  right_softkey           [IN]        Right softkey label
 *  right_softkey_icon      [IN]        Icon for the right softkey
 *  bg_image                [IN]        Background image id
 *  Buffer                  [IN]        Message string
 *  BufferLength            [IN]        Length of buffer
 *  history_buffer          [IN]        History buffer
 * RETURNS
 *  void
 *****************************************************************************/
void ShowCategory404Screen(
        U16 left_softkey,
        U16 left_softkey_icon,
        U16 right_softkey,
        U16 right_softkey_icon,
        U16 bg_image,
        U8 *Buffer,
        U32 BufferLength,
        U8 *history_buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    dm_data_struct dm_data;
    S16 required_input_mode[] = 
    {
        INPUT_MODE_MULTITAP_LOWERCASE_ABC,
        INPUT_MODE_MULTITAP_UPPERCASE_ABC,
        INPUT_MODE_123,
        -1
    };

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    gdi_layer_lock_frame_buffer();

    entry_full_screen();

    /* setup bg */
#ifdef __MMI_WALLPAPER_ON_BOTTOM__
    wgui_set_wallpaper_on_bottom(MMI_TRUE);
#endif 
    dm_add_image(get_image(bg_image), NULL, NULL);

    /* setup title */
    MMI_title_string = NULL;
    MMI_title_icon = NULL;

    /* menu shortcut */
    MMI_menu_shortcut_number = -1;
    MMI_disable_title_shortcut_display = 1;

    /* setup key handlers */
    clear_key_handlers();
    change_right_softkey(right_softkey, right_softkey_icon);
    change_left_softkey(left_softkey, left_softkey_icon);
    clear_left_softkey();
    clear_right_softkey();
    register_left_softkey_handler();
    register_right_softkey_handler();
    register_hide_softkey(cat33_hide_lsk, MMI_LEFT_SOFTKEY);
    register_hide_softkey(cat33_hide_rsk, MMI_RIGHT_SOFTKEY);
#ifdef __MMI_WGUI_CSK_ENABLE__
    register_hide_softkey(wgui_clear_center_softkey, MMI_CENTER_SOFTKEY);
#endif

    /* softkey */
    disable_softkey_background();

    /* status bar */
    show_status_icon_bar(0);
    register_hide_status_icon_bar(0,hide_status_icons_bar0_by_transparent);
    
    /* setup multiline inputbox */
#ifdef __MMI_T9__
    InuptMethodEnterCategory5();
#elif defined __MMI_ZI__
    ZiInuptMethodEnterCategory5();
#elif defined __MMI_CSTAR__
    CstarInputMethodEnterCategory5();
#elif defined __MMI_KA__
    KonkaInuptMethodEnterCategory5();
#elif defined __MMI_ITAP__
/* under construction !*/
#endif 
    register_hide_multitap(category404_hide_multitap);
    
    wgui_fill_AP_required_input_mode_set(required_input_mode);
    wgui_set_AP_required_input_mode_set_flag();
    wgui_setup_inputbox(
        MMI_content_x + 10,
        MMI_content_y + 10,
        MMI_content_width - 20,
        get_menu_item_height() * 4,
        Buffer,
        BufferLength,
        MMI_CATEGORY404_ID,
        get_string(right_softkey),
        get_image(right_softkey_icon),
        INPUT_TYPE_ALPHANUMERIC_SENTENCECASE | INPUT_TYPE_USE_ONLY_ENGLISH_MODES,
        history_buffer,
        1);
#if defined(__MMI_TOUCH_SCREEN__)
    mmi_pen_editor_do_not_resize_input_box();
#endif /* __MMI_TOUCH_SCREEN__ */
    MMI_multiline_inputbox.normal_text_color = gui_color(0, 0, 0);
    MMI_multiline_inputbox.flags |=
        UI_MULTI_LINE_INPUT_BOX_TRANSPARENT_BACKGROUND | UI_MULTI_LINE_INPUT_BOX_DISABLE_SCROLLBAR;
    /* disable new line symbol */
    MMI_current_input_ext_type = INPUT_TYPE_EXT_NO_SHOW_NEW_LINE_SYMBOL;
    cat404_fibox_backup = MMI_multiline_inputbox.normal_filler;
    MMI_multiline_inputbox.normal_filler = &cat404_fibox;

    gdi_layer_unlock_frame_buffer();
    /* setup draw manager functions */
    ExitCategoryFunction = ExitCategory404Screen;
    dm_setup_category_functions(dm_redraw_category_screen, dm_get_category_history, dm_get_category_history_size);
    dm_data.s32CatId = MMI_CATEGORY404_ID;
    dm_data.s32ScrId = GetActiveScreenId();
    dm_data.s32flags = DM_CLEAR_SCREEN_BACKGROUND | DM_SHOW_VKPAD | DM_NO_TITLE | DM_SPECIFIC_HIDE_STATUS_BAR;
    dm_setup_data(&dm_data);
    {
        extern void cat257_virtual_keypad_callback(void);
        dm_register_vkpad_callback(cat257_virtual_keypad_callback);
    }
    dm_redraw_category_screen();
}

