/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE.
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * PhoneBookStubsToOthers.c
 *
 * Project:
 * --------
 *   MAUI
 *
 * Description:
 * ------------
 *   PhoneBook APIs for other applications
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 *
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
#include "MMI_include.h"
#ifndef _PHONEBOOKSTUBSTOOTHERS_C
#define _PHONEBOOKSTUBSTOOTHERS_C

#include "ProtocolEvents.h"
#include "Gui_data_types.h"
#include "PhonebookDef.h"
#include "PhonebookGprot.h"
#include "PhonebookProt.h"
#include "IdleAppDef.h"
#include "IdleAppProt.h"
#include "SpeedDial.h"
#include "CommonScreens.h"
#include "SimDetectionGprot.h"
#include "CallManagementGProt.h"        /* For isInCall */
#include "ProfileGprots.h"              /* For IsSilentModeActivated */

#if defined(MMS_SUPPORT)        /* For MMS */
#include "wap_ps_struct.h"
#endif /* defined(MMS_SUPPORT) */ 

#if defined(__MOD_SMSAL__)
#include "SMSApi.h"
#include "MessagesExDcl.h"
#include "MessagesResourceData.h"
#endif /* defined(__MOD_SMSAL__) */ 

#if defined(__MMI_FILE_MANAGER__)       /* Also for __MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__ */
#include "FileManagerGProt.h"
#include "FileMgr.h"
#endif /* defined(__MMI_FILE_MANAGER__) */ 

#include "SettingDefs.h"
#include "SettingsGdcl.h"
#include "SettingGenum.h"
#include "SecuritySetup.h"

#if defined(__MMI_EMAIL__)
#include "EmailAppGProt.h"      /* Email App List Screen */
#endif 

#if defined(__MMI_VRSD_DIAL__)
#include "mdi_datatype.h"
#include "mdi_audio.h"
#include "VRSD.h"
#include "VRSDResDef.h"
#include "VRSDDial.h"   /* Voice dial application list screen */
#endif /* defined(__MMI_VRSD_DIAL__) */ 

#if defined(__MMI_VRSI__)
#include "Mdi_datatype.h"
#include "VRSIResDef.h"
#include "VRSIType.h"
#include "VRSIProt.h"
#include "MainMenuDef.h"
#endif /* defined(__MMI_VRSI__) */ 

#if defined(MMS_SUPPORT)
#include "Wapadp.h"
#endif 
#ifdef __MMI_PHB_BIRTHDAY_FIELD__
#include "app_datetime.h"
#endif
#ifdef __J2ME__
#include "j2me_custom_option.h"
#endif

#ifdef __SYNCML_SUPPORT__
#include "vObjects.h"
#include "vCard.h"
#include "SyncMLDef.h"
#include "SyncMLGprot.h"
#endif /* __SYNCML_SUPPORT__ */

#ifdef __MMI_UCM__
#endif /* __MMI_UCM__*/

#ifdef __MMI_DUAL_SIM_MASTER__
#include "UCMGprot.h"
#include "MTPNP_PFAL_Master_ADN.h"
#include "MTPNP_AD_resdef.h"
#endif	/* __MMI_DUAL_SIM_MASTER__ */

/*
 * Local Variable
 */
U8 phb_list_view_type;
static mmi_phb_get_data_callback_type phb_list_view_call_back;
#if defined(__MMI_MESSAGES_SEND_BY_GROUP__) || defined(__UNIFIED_COMPOSER_SUPPORT__) || defined(__MMI_JATAAYU_MMS_ADD_NUMBER_BY_GROUP__)
static mmi_phb_get_index_from_group_callback_type phb_group_view_call_back;
#endif
MMI_PHB_LIST_VIEW phbListView;
U8 g_phb_enter_from;                            /* Identify Save number from idle screen */
FuncPhbListCallback g_phb_list_callback = NULL; /* For generic list call back function */


/*
 * Global Variable
 */
extern U16 PhoneBookEntryCount;
extern MMI_PHB_ENTRY_BCD_STRUCT PhoneBook[];

#ifdef __MMI_PHB_USIM_FIELD__
extern MMI_PHB_EMAIL_STRUCT phb_email[MAX_PB_SIM_ENTRIES];
extern MMI_PHB_NUMBER_BCD_STRUCT phb_anr[MAX_PB_SIM_ENTRIES][3];
#endif /* __MMI_PHB_USIM_FIELD__ */ 

extern const U8 AsciiToDefaultArray[];
extern const U8 DefaultToAsciiArray[];

#ifndef __MMI_PHB_NO_OPTIONAL_FIELD__
extern PHB_OPTIONAL_FIELDS_STRUCT PhoneBookOptionalFields;
#endif 

#if defined(__MMI_PHB_INFO_FIELD__)
extern PHB_INFO_FIELDS_STRUCT PhoneBookInfoFields;
#endif

extern U8 MMI_current_input_mode;

extern S8 pbName[];
extern S8 pbNumber[];
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) || defined(__MMI_PHB_USIM_FIELD__)
extern S8 pbHomeNumber[];
extern S8 pbCompanyName[];
extern S8 pbEmailAddress[];
extern S8 pbOfficeNumber[];
extern S8 pbFaxNumber[];
#endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) || defined(__MMI_PHB_USIM_FIELD__) */

#ifdef __MMI_PHB_BIRTHDAY_FIELD__
extern const kal_uint8 g_dt_day_per_mon[];
extern S8 pbDay[];
extern S8 pbMon[];
extern S8 pbYear[];
#endif /* __MMI_PHB_BIRTHDAY_FIELD__ */

#if defined(__MMI_PHB_INFO_FIELD__)
extern S8 pbTitle[];
extern S8 pbUrl[];
extern S8 pbAddress[];
extern S8 pbNote[];
#endif /* defined(__MMI_PHB_INFO_FIELD__) */ 

#if defined(__MMI_VOIP__)
extern S8 pbVoip[(VOIP_URI_LEN) * ENCODING_LENGTH];
#endif

#ifdef __MMI_PHB_USIM_FIELD__
extern S8 pbNickName[];
#endif /* __MMI_PHB_USIM_FIELD__ */ 

#if defined(__MMI_FILE_MANAGER__)
extern S8 g_phb_file_path[];    /* Select file from file manager */
#ifdef __MTK_TARGET__
__align(2) static S8 phb_caller_pic_file_path[MMI_PHB_MAX_PATH_LENGTH];
#else
static S8 phb_caller_pic_file_path[MMI_PHB_MAX_PATH_LENGTH];
#endif
#endif /* defined(__MMI_FILE_MANAGER__) */ 
extern U16 g_phb_image_type_id;

extern U16 g_phb_name_index[];

#if defined(__MMI_INCOMING_CALL_VIDEO__)
extern S8 g_phb_video_file_path[];  /* Select video file from file manager */
#endif 

#if defined(__MMI_INCOMING_CALL_VIDEO__)
#if defined(__MMI_SWFLASH__) && defined(__MMI_AVATAR__)
extern U8 g_phb_swflash_video_minus;
extern U8 g_phb_avatar_video_minus;
#elif defined(__MMI_SWFLASH__) /* defined(__MMI_SWFLASH__) && defined(__MMI_AVATAR__) */
extern U8 g_phb_swflash_video_minus;
#elif defined(__MMI_AVATAR__)
extern U8 g_phb_avatar_video_minus;
#endif /* defined(__MMI_SWFLASH__) && defined(__MMI_AVATAR__) */
#endif 

#ifdef __SYNCML_SUPPORT__
extern vcard_context_struct g_vcard_cntx;
#endif /* def __SYNCML_SUPPORT__ */

#if defined(__MMI_PHB_GENERIC_MULTI_SELECT__)
extern U16 g_phb_multi_select_limit;
#endif /* defined(__MMI_PHB_GENERIC_MULTI_SELECT__) */

/*
 * Local Function
 */
#if defined(__MMI_PHB_GENERIC_MULTI_SELECT__)
mmi_phb_get_index_from_group_callback_type phb_generic_multi_select_list_call_back;
#endif

/*
 * Global Function
 */
extern void IdleShowScrInvalidLocation(void);
extern void IdleShowScrNoPhoneNumEntry(void);
extern void SendPhbEntryForDivert(S8* name, S8* number);
extern void CBackCallDeflectNumberFromPB(PS8 CallDeflectBuffer);

extern void mmi_msg_send_msg_to_group(U16, U16 *);
extern void mmi_frm_sms_go_back_from_send(void);
extern void mmi_frm_sms_end_key_from_send(void);
extern MMI_PHB_ENTRY_STRUCT *mmi_phb_get_sim_entry(void);
#ifdef __MMI_DUAL_SIM_MASTER__
#ifndef WIN32
extern MMI_PHB_ENTRY_STRUCT *mmi_phb_get_slave_sim_entry(void);
#endif /* __MMI_DUAL_SIM_MASTER__*/
#endif
#ifdef __J2ME__
extern void mmiapi_fullscreen_editor_set_number(S8* name, S8* number);
#endif

#if defined(__MMI_VRSI__) && defined(__MMI_VRSI_TRAIN_TAG__)
static vrsi_sd_tag_struct* g_phb_vrsi_tag_list;
#endif

#if defined (JATAAYU_SUPPORT)
extern void update_mms_number_from_phonebook(S8 *number);
extern void update_mms_email_from_phonebook(S8 *email);
#endif /* JATAAYU_SUPPORT */

#if defined(__MMI_BARCODEREADER__) || defined(__MMI_BROWSER_2__)
mmi_phb_save_entry_from_others_callback_type mmi_phb_add_new_entry_callback;
#endif /* defined(__MMI_BARCODEREADER__) || defined(__MMI_BROWSER_2__) */

#if defined(__MMI_PHB_GENERIC_MULTI_SELECT__)
extern mmi_phb_check_selected_index_callback_type phb_generic_multi_select_check_call_back;
#endif


/*****************************************************************************
 * FUNCTION
 *  lookUpName
 * DESCRIPTION
 *  Search for the number entry for corresponding name input
 * PARAMETERS
 *  name        [IN]        Input name to be serach
 * RETURNS
 *  result number string if found
 *****************************************************************************/
PS8 lookUpName(PS8 name)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < PhoneBookEntryCount; i++)
    {
        store_index = g_phb_name_index[i];

        if (mmi_ucs2cmp((PS8) name, (PS8) PhoneBook[store_index].alpha_id.name) == 0)
        {
            mmi_phb_convert_get_ucs2_number(pbNumber, i);   /* BCD number format. */
            return (S8*) pbNumber;
        }
    }
    return NULL;
}


/*****************************************************************************
 * FUNCTION
 *  lookUpNumber
 * DESCRIPTION
 *  Search for the name entry for corresponding number input
 * PARAMETERS
 *  number      [IN]        Input number to be serach
 * RETURNS
 *  result name string if found
 *****************************************************************************/
PS8 lookUpNumber(PS8 number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U8 flag = 0;
    U32 num;
    U8 number_ASCII[MAX_PB_NUMBER_LENGTH + 1 + 1];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_FUNC_lookUpNumber);

    memset(number_ASCII, 0, ENCODING_LENGTH);
    mmi_ucs2_to_asc((PS8) number_ASCII, (PS8) number);

    /* Lookup into table when (1) lookup table not empty (2)Not Processing (3)All Entries populated and sorted */
    if (g_phb_cntx.lookup_table_count && !g_phb_cntx.processing && (g_phb_cntx.populate_count == 0xffff)
    #ifdef __SYNCML_SUPPORT__
      && !(mmi_syncml_is_phb_sync_now())
    #endif /* __SYNCML_SUPPORT__ */
    )
    {
        num = mmi_phb_util_convert_number_to_int(number_ASCII);
        if (num < INVALID_NUMBER)
        {
            i = mmi_phb_lookup_table_search(num, 0, (U16) (g_phb_cntx.lookup_table_count - 1), 
                (S8*) number_ASCII, MMI_STORAGE_BOTH);

            if (i < 0xffff) /* i is storage location in array, begin from 0. */
            {
                flag = 1;
            }
        }
    }

    if (flag)
    {
        return (PS8) PhoneBook[i].alpha_id.name;
    }
    else
    {
        return NULL;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_generic_enter_list
 * DESCRIPTION
 *  Phonebook list interface for other application.
 * PARAMETERS
 *  func_list       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_generic_enter_list(FuncPhbListCallback func_list)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phbListView = MMI_PHB_LIST_FOR_ALL_SHARED;
    g_phb_list_callback = func_list;
    mmi_phb_list_pre_entry_second_level();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_generic_enter_list_result
 * DESCRIPTION
 *  choose entry result, send result back to caller app.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_generic_enter_list_result(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    S16 pError;
#endif
    U16 store_index;
    MMI_PHB_VCARD_STRUCT *result_entry = OslMalloc(sizeof(MMI_PHB_VCARD_STRUCT));

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Clear buffer */
    memset(result_entry, 0, sizeof(MMI_PHB_VCARD_STRUCT));

    store_index = g_phb_name_index[g_phb_cntx.active_index_second];

    /* Copy Name */
    mmi_ucs2cpy(result_entry->name, (S8*) PhoneBook[store_index].alpha_id.name);

    /* Copy Number - ASCII Type */
    if (((PhoneBook[store_index].tel.type & 0x90) == 0x90) && (PhoneBook[store_index].tel.type != 0xFF))
    {
        *result_entry->number = '+';
        mmi_phb_convert_to_digit((U8*) result_entry->number+1, PhoneBook[store_index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {		
        mmi_phb_convert_to_digit((U8*) result_entry->number, PhoneBook[store_index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
    }

#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    if (store_index < MAX_PB_PHONE_ENTRIES) /* in NVRAM */
    {
        ReadRecord(
            NVRAM_EF_PHB_FIELDS_LID,
            (U16) (store_index + 1),
            (void*)&PhoneBookOptionalFields,
            OPTIONAL_FIELDS_RECORD_SIZE,
            &pError);

        strcpy(result_entry->homeNumber, (PS8) PhoneBookOptionalFields.homeNumber);
        strcpy(result_entry->officeNumber, (PS8) PhoneBookOptionalFields.officeNumber);
        strcpy(result_entry->faxNumber, (PS8) PhoneBookOptionalFields.faxNumber);
        strcpy(result_entry->emailAddress, (S8*) PhoneBookOptionalFields.emailAddress);
        mmi_ucs2cpy(result_entry->companyName, (PS8) PhoneBookOptionalFields.companyName);
    }
#endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 

    /* Send back to email app. */
    if (g_phb_list_callback != NULL)
    {
        g_phb_list_callback(result_entry);
    }

    OslMfree(result_entry);
    g_phb_list_callback = NULL;
    DeleteScreenIfPresent(SCR_PBOOK_LIST);
}


#define MMI_PHB_IDLE_SCREEN
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_idle_enter_phb_list
 * DESCRIPTION
 *  Displays PHB list from RSK of idle screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_idle_enter_phb_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_idle_context.ToNameScrFromIdleApp = 1;
    g_idle_context.RskPressedFromIdleApp = 1;
    phbListView = MMI_PHB_LIST_FOR_PHB;
    g_phb_cntx.highlight_entry = 0;
    
    g_phb_cntx.refresh_list = MMI_PHB_ENTRY_REFRESH;

#if defined(__MMI_PHB_RSK_QUICK_SEARCH__)
    mmi_phb_quick_search_list_pre_entry();
#else 
#if defined(__MMI_PHB_NAME_LIST_FILTER__)
    mmi_phb_nlf_list_pre_entry();
#else /* defined(__MMI_PHB_NAME_LIST_FILTER__) */
    mmi_phb_list_pre_entry();
#endif /* defined(__MMI_PHB_NAME_LIST_FILTER__) */
#endif /* defined(__MMI_PHB_RSK_QUICK_SEARCH__) */

#if (defined(__MMI_KEYPAD_LOCK_PATTERN_1__) && !defined(__MMI_DISABLE_KEYPAD_LOCK__))
    if (g_idle_context.RskPressedFromIdleApp == 1)
    {
        StartTimer(KEYPAD_LOCK_TIMER, KEYPAD_LOCK_TIMEOUT, IdleHandleKeypadLockProcess);
        SetKeyHandler(IdleHandlePoundKeyForKeypadLock, KEY_POUND, KEY_EVENT_UP);
    }
#endif /* (defined(__MMI_KEYPAD_LOCK_PATTERN_1__) && !defined(__MMI_DISABLE_KEYPAD_LOCK__)) */ 
}


/*****************************************************************************
 * FUNCTION
 *  SaveNumberFromIdleScrn
 * DESCRIPTION
 *  Saves number from idle screen
 * PARAMETERS
 *  number          [IN]        Number string to be saved
 *  enter           [IN]        Enter location
 * RETURNS
 *  void
 *****************************************************************************/
void SaveNumberFromIdleScrn(PS8 number, U8 enter)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<SaveNumberFromIdleScrn.>\n", __FILE__, __LINE__);

    /* Check number length first */
    if (mmi_ucs2strlen((PS8) number) > MAX_PB_NUMBER_LENGTH + 1)
    {
        DisplayPopup((PU8) GetString(STR_NUMBER_TOO_LONG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
    }
    /* Avoid add entry while copy all and delete all */
#ifdef __MMI_DUAL_SIM_MASTER__
     if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
     if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __MMI_PHB_USIM_FIELD__
    else if (g_phb_cntx.is_usim && g_phb_cntx.usim_ready_stage != MMI_PHB_USIM_READY)
    {
        mmi_phb_entry_not_ready(STR_ID_PHB_PROCESSING_USIM);
    }
#endif /* __MMI_PHB_USIM_FIELD__ */
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
    else
    {
        g_phb_cntx.set_done_flag = 1;
        mmi_ucs2cpy(pbNumber, number);

        g_phb_enter_from = enter;
        mmi_phb_clear_old_history();
        mmi_phb_op_add_pre_entry();
    }
}


#ifdef __MMI_PHB_BIRTHDAY_FIELD__
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_retrieve_bday
 * DESCRIPTION
 *  parse birthday field of a vcard object.s
 * PARAMETERS
 *  b_string        [?]         
 *  pb_year         [?]         
 *  pb_mon          [?]         
 *  pb_day          [?]         
 *  change_flag     [IN]        
 *  String(?)       [IN]        String read from file for one line
 * RETURNS
 *  parse error cause(?)
 *****************************************************************************/
void mmi_phb_retrieve_bday(S8 *b_string, S8 *pb_year, S8 *pb_mon, S8 *pb_day, BOOL change_flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 temp_buf[10 + 1]; /* 19990101 or 1999-01-01 */
    S8 ascii_buff[6];

    U16 b_year;
    U8 b_month;
    U8 b_day;
    U8 is_valid = TRUE;
    U8 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* b_string; */
    memset(temp_buf, 0, sizeof(temp_buf));
    strncpy(temp_buf, b_string, 10);

    /* Year */
    strncpy(ascii_buff, temp_buf, 4);
    ascii_buff[4] = '\0';
    mmi_asc_to_ucs2(pb_year, ascii_buff);
    b_year = (U16) gui_atoi((U16*) pb_year);
    i = 4;
    /* Month */
    if (*(temp_buf + i) == '-')
    {
        i++;
    }
    strncpy(ascii_buff, temp_buf + i, 2);
    ascii_buff[2] = '\0';
    mmi_asc_to_ucs2(pb_mon, ascii_buff);
    b_month = (U8) gui_atoi((U16*) pb_mon);
    i += 2;
    /* Day */
    if (*(temp_buf + i) == '-')
    {
        i++;
    }    
    strncpy(ascii_buff, temp_buf + i, 2);
    ascii_buff[2] = '\0';
    mmi_asc_to_ucs2(pb_day, ascii_buff);
    b_day = (U8) gui_atoi((U16*) pb_day);

    if (b_year > MMI_PHB_BDAY_MAX_YEAR_INT || b_year < 1900)
    {
        is_valid = FALSE;
    }
    else if (b_month > 12)
    {
        is_valid = FALSE;
    }

    if (b_month == 2)
    {
        if (b_day > (g_dt_day_per_mon[b_month - 1] + applib_dt_is_leap_year(b_year)))
            is_valid = FALSE;
    }
    else if (b_day > g_dt_day_per_mon[b_month - 1])
    {
        is_valid = FALSE;
    }

    if (is_valid && change_flag)
    {
        mmi_phb_bday_set_changed();
    }
    else
    {
        mmi_phb_util_clear_bday_buffer();
    }
}
#endif /* __MMI_PHB_BIRTHDAY_FIELD__ */ 


#if defined(__MMI_BARCODEREADER__) || defined(__MMI_BROWSER_2__) /* could extend in the future */
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_save_entry_from_others
 * DESCRIPTION
 *  Saves phonebook entry from other applications
 * PARAMETERS
 *  ucs2_name       [IN]        Name string to be saved. Max length is MAX_PB_NAME_LENGTH
 *  number          [IN]        Number string to be saved(UCS2)
 *  opt_fields      [IN]        Optional fields
 *  b_day           [IN]         Birthday to be saved. Format: yyyymmdd. ex: 19750101
 *  info_fields     [IN]        Information fields
 *  nick_name       [IN]        Nick name string to be saved(UCS2). Max length is MAX_PB_NAME_LENGTH
 *  phb_callback    [IN]        callback function after saving  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_save_entry_from_others(
        S8 *ucs2_name,
        S8 *number,
        PHB_OPTIONAL_FIELDS_STRUCT *opt_fields,
        S8 *b_day,
        PHB_INFO_FIELDS_STRUCT *info_fields,
        S8 *nick_name,
        mmi_phb_save_entry_from_others_callback_type phb_callback)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<mmi_phb_save_entry_from_barcode.>\n", __FILE__,
                         __LINE__);

    /* Check number length first */
    if ((mmi_ucs2strlen(number) > MAX_PB_NUMBER_LENGTH + 1))
    {
        DisplayPopup((PU8) GetString(STR_NUMBER_TOO_LONG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
    }
    /* Avoid add entry while copy all and delete all */
#ifdef __MMI_DUAL_SIM_MASTER__
     if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
     if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __MMI_PHB_USIM_FIELD__
    else if (g_phb_cntx.is_usim && g_phb_cntx.usim_ready_stage != MMI_PHB_USIM_READY)
    {
        mmi_phb_entry_not_ready(STR_ID_PHB_PROCESSING_USIM);
    }
#endif /* __MMI_PHB_USIM_FIELD__ */
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    else if (PhoneBookEntryCount == g_phb_cntx.sim_total + g_phb_cntx.phone_total+MTPNP_AD_ADN_SIM2GetCapacity())
#else   /* __MMI_DUAL_SIM_MASTER__ */
    else if (PhoneBookEntryCount == (g_phb_cntx.sim_total + g_phb_cntx.phone_total))
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        DisplayPopup((PU8) GetString(STR_PBOOK_FULL_MSG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
    }
    else
    {
        g_phb_cntx.set_done_flag = 1;
        mmi_phb_clear_old_history();
        mmi_phb_util_clear_buffer(TRUE);

        if (ucs2_name)
        {        	
            mmi_ucs2ncpy(pbName, ucs2_name, MAX_PB_NAME_LENGTH);        	
            mmi_phb_truncate_pbname_buffer(MMI_NVRAM);
        }
        if (number)
        {
            mmi_ucs2ncpy(pbNumber, number, MAX_PB_NUMBER_LENGTH);
        }
    #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) || defined(__MMI_PHB_USIM_FIELD__)
        if (opt_fields)
        {
            mmi_asc_to_ucs2(pbHomeNumber, (PS8) opt_fields->homeNumber);
            mmi_asc_to_ucs2(pbEmailAddress, (PS8) opt_fields->emailAddress);
            mmi_asc_to_ucs2(pbOfficeNumber, (PS8) opt_fields->officeNumber);
            mmi_ucs2cpy(pbCompanyName, (PS8) opt_fields->companyName);
            mmi_asc_to_ucs2(pbFaxNumber, (PS8) opt_fields->faxNumber);
        }
    #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) || defined(__MMI_PHB_USIM_FIELD__) */        
    #ifdef __MMI_PHB_BIRTHDAY_FIELD__
        if (b_day)
        {
            mmi_phb_retrieve_bday(b_day, (S8*) pbYear, (S8*) pbMon, (S8*) pbDay, TRUE);
        }
    #endif /* __MMI_PHB_BIRTHDAY_FIELD__ */ 
    #ifdef __MMI_PHB_INFO_FIELD__
        if (info_fields)
        {
            mmi_ucs2cpy(pbTitle, (PS8) info_fields->title);
            mmi_ucs2cpy(pbUrl, (PS8) info_fields->url);
            mmi_asc_to_ucs2(pbAddress, (PS8) info_fields->address);
            mmi_ucs2cpy(pbNote, (PS8) info_fields->note);
        }
    #endif /* __MMI_PHB_INFO_FIELD__ */ 
    #ifdef __MMI_PHB_USIM_FIELD__
        if (nick_name)
        {
            mmi_ucs2cpy(pbNickName, (PS8) info_fields->note);
        }
    #endif /* __MMI_PHB_USIM_FIELD__ */ 
        g_phb_enter_from = MMI_PHB_ENTER_FROM_OTHERS;
        mmi_phb_add_new_entry_callback = phb_callback;
        mmi_phb_entry_op_add_choose_storage();
    }
}
#endif /* defined(__MMI_BARCODEREADER__) || defined(__MMI_BROWSER_2__) */


#ifdef __MMI_VOIP__
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_get_data_for_voip
 * DESCRIPTION
 *  Returns the names/ringtone/image tag/caller group details for the incoming
 *  call number if it is present in PHB
 * PARAMETERS
 *  uri         [IN]        uri string to be matched
 *  is_mo_call  [IN]        dial_from_list only for mo call
 * RETURNS
 *  PHB_CM_INTERFACE  a interface structure
 *****************************************************************************/
PHB_VOIP_INTERFACE mmi_phb_call_get_data_for_voip(PU8 uri, BOOL is_mo_call)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index = 0xffff, grp_id;
    PHB_VOIP_INTERFACE phbDetails;
    U8 flag = 0;
    U8 uri_ASCII[VOIP_URI_LEN];
    U8 *uri_ptr;
    PHB_OPTIONAL_IDS_STRUCT *opt_ids = NULL;
    PHB_CALLER_GROUP_STRUCT *callerGroups;

#if defined(__MMI_INCOMING_CALL_VIDEO__)
    U16 video_id;
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    memset(uri_ASCII, 0, ENCODING_LENGTH);
    memset((void*)&phbDetails, 0, sizeof(phbDetails));

    phbDetails.pictureId = IMG_PHB_DEFAULT;
    phbDetails.dialInList = MMI_PHB_NONE;
    mmi_ucs2_to_asc((PS8) uri_ASCII, (PS8) uri);

    PRINT_INFORMATION("---[PhonebookStubsToOthers.c] mmi_phb_call_get_data_for_call_mgnt() => number: [%s] dial list:[%d] \n", uri_ASCII, g_phb_cntx.dial_from_list);

    uri_ptr = uri_ASCII;

    /* Check if dial out from phonebook list */
    if (g_phb_cntx.dial_from_list == MMI_PHB_PHONEBOOK && is_mo_call)
    {
        g_phb_cntx.dial_from_list = MMI_PHB_NONE;
        flag = 1;
        store_index = g_phb_name_index[g_phb_cntx.active_index];
        phbDetails.dialInList = MMI_PHB_PHONEBOOK;
    }
    /* For example, from birthday */
    else if ((g_phb_cntx.dial_from_list == MMI_PHB_FROM_OTHER_APP) && is_mo_call
        && !g_phb_cntx.processing
    #ifdef __SYNCML_SUPPORT__
        && !(mmi_syncml_is_phb_sync_now())
    #endif /* __SYNCML_SUPPORT__ */
        )
    {
        g_phb_cntx.dial_from_list = MMI_PHB_NONE;
        flag = 1;
        store_index = g_phb_cntx.store_index;
        phbDetails.dialInList = MMI_PHB_PHONEBOOK;
    }

    /* Map Number with one enrtry. */
    if (flag)
    {
        mmi_ucs2cpy((PS8) phbDetails.name, (PS8) PhoneBook[store_index].alpha_id.name);
        phbDetails.name_dcs = PhoneBook[store_index].alpha_id.name_dcs;

        /* Caller Group Setup */
    #if !defined(__MMI_PHB_CALLERGROUP_IN_SIM__)    /* Associate caller group in SIM card entry */
        if (store_index < MAX_PB_PHONE_ENTRIES)
    #endif 
        {
            callerGroups = (PHB_CALLER_GROUP_STRUCT*) g_phb_cntx.caller_group;

            mmi_phb_read_optional_ids(store_index); /* i is store index */
            opt_ids = (PHB_OPTIONAL_IDS_STRUCT*) g_phb_cntx.optional_ids;

            grp_id = opt_ids->callerGroupID;
            if (grp_id)
            {
            #if defined(__MMI_CALLERGROUP_NO_ALERT__)
                phbDetails.alertType = MMI_ALERT_NONE;
            #else
                phbDetails.alertType = callerGroups[grp_id - 1].alertType;
            #endif
                phbDetails.backlightId = callerGroups[grp_id - 1].LEDPatternId;
                phbDetails.ringtoneId = callerGroups[grp_id - 1].ringToneID;
                if (callerGroups[grp_id - 1].pictureTagID == 1) /* Associate Picture is in the file system. */
                {
                #if defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__)
                    phbDetails.pictureId = 1;
                    phbDetails.record_index = 5000 + grp_id;
                #endif /* defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) */ 
                }
                else if (callerGroups[grp_id - 1].pictureTagID != 0)   /* 0 means default image */
                {
                    phbDetails.pictureId = callerGroups[grp_id - 1].pictureTagID;
                }

            #if defined(__MMI_INCOMING_CALL_VIDEO__)
                if (callerGroups[grp_id - 1].VideoID)
                {
                    phbDetails.videoId = callerGroups[grp_id - 1].VideoID;
                    phbDetails.video_record_index = (U16) (MAX_PB_PHONE_ENTRIES + grp_id);      /* MAX_PB_PHONE_ENTRIES for group 1 and so on. */
                }
            #endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 
            }
        }

        /* Personal Entry Setup, these will overwrite caller group setting. */
        if (store_index < MAX_PB_PHONE_ENTRIES)
        {
            /* Associate Pictures */
            if (opt_ids->pictureTagID == 1)
            {
            #if defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__)
                phbDetails.pictureId = 1;
                phbDetails.record_index = store_index + 1;  /* Record Must in NVRAM, so the record index is store_index + 1 */
            #endif /* defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) */ 
            #if defined(__MMI_INCOMING_CALL_VIDEO__)
                phbDetails.videoId = 0;    /* If Image Selected, should not play caller group's video */
            #endif 
            }
            else if ((opt_ids->pictureTagID != IMG_PHB_DEFAULT) && (opt_ids->pictureTagID != 0x0000))
            {
                phbDetails.pictureId = opt_ids->pictureTagID;
            #if defined(__MMI_INCOMING_CALL_VIDEO__)
                phbDetails.videoId = 0; /* If Image Selected, should not play caller group's video */
            #endif 
            }

            /* Associate Ring Tone */
            if (opt_ids->ringToneID)
            {
                phbDetails.ringtoneId = opt_ids->ringToneID;
            }

            /* For Incoming Call Video */
        #if defined(__MMI_INCOMING_CALL_VIDEO__)
            if ((video_id = mmi_phb_video_get_id_by_index(store_index)) != 0)
            {
                phbDetails.videoId = video_id;
                phbDetails.video_record_index = store_index + 1;    /* Record Must in NVRAM, so the record index is store_index + 1 */
            }
        #endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 
        }
    }
    return phbDetails;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_save_entry_for_service_field
 * DESCRIPTION
 *  Saves number from idle screen
 * PARAMETERS
 *  uri             [IN]        uri to be saved
 *  enter           [IN]        Enter location
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_save_entry_for_service_field(PS8 name, PS8 uri, U8 enter)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<mmi_phb_save_entry_for_service_field.>\n", __FILE__, __LINE__);

    /* Check uri length first */
    if (enter == MMI_PHB_ENTER_FROM_VOIP &&  mmi_ucs2strlen((PS8)uri) >= VOIP_URI_LEN)
    {
        DisplayPopup((PU8) GetString(STR_GLOBAL_ERROR), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
    }
    /* Avoid add entry while copy all and delete all */
#ifdef __MMI_DUAL_SIM_MASTER__
     if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
     if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __MMI_PHB_USIM_FIELD__
    else if (g_phb_cntx.is_usim && g_phb_cntx.usim_ready_stage != MMI_PHB_USIM_READY)
    {
        mmi_phb_entry_not_ready(STR_ID_PHB_PROCESSING_USIM);
    }
#endif /* __MMI_PHB_USIM_FIELD__ */
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
    else if (g_phb_cntx.phone_total == g_phb_cntx.phone_used)
    {
        DisplayPopup((PU8) GetString(STR_PHONE_FULL_MSG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
    }
    else
    {
        g_phb_cntx.set_done_flag = 1;
        g_phb_enter_from = MMI_PHB_ENTER_FROM_VOIP;
        mmi_phb_clear_old_history();
        mmi_phb_util_clear_buffer(TRUE);
        if (name)
        {
            mmi_ucs2cpy(pbName, name);
            mmi_phb_truncate_pbname_buffer(MMI_NVRAM);
        }
        if (uri)
        {
            mmi_ucs2cpy(pbVoip, uri);
        }
        //mmi_phb_entry_op_add_choose_storage();
        g_phb_cntx.selected_storage = MMI_NVRAM;
        mmi_phb_entry_op_add_entry();
    }
}
#endif /* __MMI_VOIP__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_sim_entry_by_location
 * DESCRIPTION
 *  Return the number to idle screen for quick access
 * PARAMETERS
 *  entryNum        [IN]        Location to be search
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_get_sim_entry_by_location(U16 entryNum)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U16 record_index;
    U8 hasEntry = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
    else if (entryNum == 0 || entryNum > g_phb_cntx.sim_total)
    {
        IdleShowScrInvalidLocation();
    }
    else
    {
        for (i = 0; i < PhoneBookEntryCount; i++)
        {
            record_index = g_phb_name_index[i] - MAX_PB_PHONE_ENTRIES + 1;
            if (record_index == entryNum)
            {
                g_phb_cntx.active_index = i;
                hasEntry = 1;
                mmi_phb_entry_op_view_entry();
            }
        }

        if (!hasEntry)
        {
            IdleShowScrNoPhoneNumEntry();
        }

    }
}


#define MMI_PHB_INTERFACE_FOR_CALL
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_get_data_for_call_mgnt
 * DESCRIPTION
 *  Returns the names/ringtone/image tag/caller group details for the incoming
 *  call number if it is present in PHB
 * PARAMETERS
 *  number      [IN]        Number string to be matched
 *  is_mo_call  [IN]        dial_from_list only for mo call
 * RETURNS
 *  PHB_CM_INTERFACE  a interface structure
 *****************************************************************************/
#ifdef __MMI_DUAL_SIM_MASTER__
PHB_CM_INTERFACE mmi_phb_call_get_data_for_call_mgnt(PU8 number, BOOL is_mo_call, U8 simInterface)
#else /* __MMI_DUAL_SIM_MASTER__ */
PHB_CM_INTERFACE mmi_phb_call_get_data_for_call_mgnt(PU8 number, BOOL is_mo_call)
#endif /* __MMI_DUAL_SIM_MASTER__ */
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index = 0xffff, grp_id;
    PHB_CM_INTERFACE phbDetails;
    U8 flag = 0;
    U32 num;
    U8 number_ASCII[MAX_PB_NUMBER_LENGTH + 1 + 1];
    U8 *number_ptr;
    PHB_OPTIONAL_IDS_STRUCT *opt_ids = NULL;
    PHB_CALLER_GROUP_STRUCT *callerGroups;
    S8 *str_P = NULL;

#if defined(__MMI_INCOMING_CALL_VIDEO__)
    U16 video_id;
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_FUNC_GetPHBDataForCM); */

    memset(number_ASCII, 0, ENCODING_LENGTH);
    memset((void*)&phbDetails, 0, sizeof(phbDetails));

    phbDetails.pictureId = IMG_PHB_DEFAULT;
    phbDetails.dialInList = MMI_PHB_NONE;
    mmi_ucs2_to_asc((PS8) number_ASCII, (PS8) number);

    PRINT_INFORMATION("---[PhonebookStubsToOthers.c] mmi_phb_call_get_data_for_call_mgnt() => number: [%s] dial list:[%d] \n", number_ASCII, g_phb_cntx.dial_from_list);

    /* convert P to p */
    str_P = strstr((S8*)number_ASCII, "P");
    if (str_P)
    {
        str_P[0] = 'p'; 
    }

    number_ptr = number_ASCII;
    /* Ignore  *31# and #31# case */
    while (((number_ptr[0] == '*') && (number_ptr[1] == '3') && (number_ptr[2] == '1') && (number_ptr[3] == '#')) ||
           ((number_ptr[0] == '#') && (number_ptr[1] == '3') && (number_ptr[2] == '1') && (number_ptr[3] == '#')))
    {
        number_ptr += 4;
    }

    if (is_mo_call == TRUE)
    {
        /*  Display as Emergency Number */
    #ifdef __MMI_DUAL_SIM_MASTER__
        if ((CheckValidEmergencyNo1((S8*) number, SIM1) && simInterface == SIM1) || (CheckValidEmergencyNo1((S8*) number, SIM2) && simInterface == SIM2))
    #else
        if (CheckValidEmergencyNo1((S8*) number))
    #endif
        {
            mmi_asc_to_ucs2((PS8) phbDetails.number, (S8*) number_ptr);
            g_phb_cntx.dial_from_list = MMI_PHB_NONE;   /* Clear dial from list flag */
    
            mmi_ucs2ncpy((PS8) phbDetails.name, GetString(STR_EMERGENCY_NUMBER), MAX_PB_NAME_LENGTH);
            if (GetUCS2Flag((PS8) phbDetails.name))
            {
                phbDetails.name_dcs = MMI_PHB_UCS2;
            }
            else
            {
                phbDetails.name_dcs = MMI_PHB_ASCII;
            }

            return phbDetails;
        }
    }
    /* Check if dial out from phonebook list */
    if (g_phb_cntx.dial_from_list == MMI_PHB_PHONEBOOK && is_mo_call)
    {
        g_phb_cntx.dial_from_list = MMI_PHB_NONE;
        flag = 1;
        store_index = g_phb_name_index[g_phb_cntx.active_index];
        phbDetails.dialInList = MMI_PHB_PHONEBOOK;
    }
    /* For example, from birthday */
    else if ((g_phb_cntx.dial_from_list == MMI_PHB_FROM_OTHER_APP) && is_mo_call
        && !g_phb_cntx.processing
    #ifdef __SYNCML_SUPPORT__
        && !(mmi_syncml_is_phb_sync_now())
    #endif /* __SYNCML_SUPPORT__ */
        )
    {
        g_phb_cntx.dial_from_list = MMI_PHB_NONE;
        flag = 1;
        store_index = g_phb_cntx.store_index;
        phbDetails.dialInList = MMI_PHB_FROM_OTHER_APP;
    }
    /*
     *  Check if dial out from FDN list,
     *  note that should enter here only from FDN list screen
     */
    else if (g_phb_cntx.dial_from_list == MMI_PHB_FDN && is_mo_call)
    {
        g_phb_cntx.dial_from_list = MMI_PHB_NONE;

        /* Fill up structure and return FDN data directly here */
        mmi_ucs2cpy(
            (S8*) phbDetails.name,
            (S8*) gFDLBDLContext.FDLBDLEntries[gFDLBDLContext.HighlightedFDN].alpha_id.name);
        phbDetails.name_dcs = gFDLBDLContext.FDLBDLEntries[gFDLBDLContext.HighlightedFDN].alpha_id.name_dcs;

        mmi_ucs2cpy(
            (S8*) phbDetails.number,
            (S8*) gFDLBDLContext.FDLBDLEntries[gFDLBDLContext.HighlightedFDN].tel.number);

        phbDetails.dialInList = MMI_PHB_FDN;
        return phbDetails;
    }
    /*
     *  Check if dial out from SDN list,
     *  note that should enter here only from SDN list screen
     */
    else if (g_phb_cntx.dial_from_list == MMI_PHB_SDN && is_mo_call)
    {
        MMI_PHB_ENTRY_STRUCT *sdn_entry;
    #ifdef __MMI_DUAL_SIM_MASTER__
        if (simInterface == SIM2)
        {
        #ifndef WIN32
            sdn_entry = mmi_phb_get_slave_sim_entry();
		#endif
        }
        else
    #endif /* __MMI_DUAL_SIM_MASTER__ */
        {
            sdn_entry = mmi_phb_get_sim_entry();
        }

        g_phb_cntx.dial_from_list = MMI_PHB_NONE;

        /* Fill up structure and return SDN data directly here */
        mmi_ucs2cpy((S8*) phbDetails.name, (S8*) sdn_entry->alpha_id.name);
        phbDetails.name_dcs = sdn_entry->alpha_id.name_dcs;
        mmi_ucs2cpy((S8*) phbDetails.number, (S8*) sdn_entry->tel.number);

        phbDetails.dialInList = MMI_PHB_SDN;
        return phbDetails;
    }
    else /* Not dial from list. */
    {
        /* Lookup into table when (1)  lookup table not empty (2) Not Processing (3) All Entries populated and sorted */
        if (g_phb_cntx.lookup_table_count && !g_phb_cntx.processing && (g_phb_cntx.populate_count == 0xffff)
        #ifdef __SYNCML_SUPPORT__
            && !(mmi_syncml_is_phb_sync_now())
        #endif /* __SYNCML_SUPPORT__ */
        )
        {
            num = mmi_phb_util_convert_number_to_int(number_ASCII);
            if (num < INVALID_NUMBER)
            {
                g_phb_cntx.searched_number_type = 0;
                store_index = mmi_phb_lookup_table_search(num, 0, (U16)(g_phb_cntx.lookup_table_count - 1), 
                    (S8*) number_ptr, MMI_STORAGE_BOTH);

                if (store_index < 0xffff)   /* i is storage location in array, begin from 0. */
                {
                    flag = 1;
                }
            }
        }
    }

    /* Map Number with one enrtry. */
    if (flag)
    {
        mmi_ucs2cpy((PS8) phbDetails.name, (PS8) PhoneBook[store_index].alpha_id.name);
        phbDetails.name_dcs = PhoneBook[store_index].alpha_id.name_dcs;
        if (phbDetails.dialInList != MMI_PHB_PHONEBOOK && phbDetails.dialInList != MMI_PHB_FROM_OTHER_APP) /* CM should use its number if dial from Phonebook list */
        {
        #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
            if ((store_index < MAX_PB_PHONE_ENTRIES) && g_phb_cntx.searched_number_type != 0)
            {
                switch (g_phb_cntx.searched_number_type)
                {
                    case MMI_PHB_ENTRY_FIELD_HOME:
                        mmi_asc_to_ucs2((PS8) phbDetails.number, (S8*) PhoneBookOptionalFields.homeNumber);
                        break;
                    case MMI_PHB_ENTRY_FIELD_OFFICE:
                        mmi_asc_to_ucs2((PS8) phbDetails.number, (S8*) PhoneBookOptionalFields.officeNumber);
                        break;
                    case MMI_PHB_ENTRY_FIELD_FAX:
                        mmi_asc_to_ucs2((PS8) phbDetails.number, (S8*) PhoneBookOptionalFields.faxNumber);
                        break;
                    default:
                        MMI_ASSERT(0);
                        break;
                }
            }
            else
        #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 
            {
                mmi_phb_convert_get_ucs2_number((S8*) phbDetails.number, store_index);
            }
        }

        /* Caller Group Setup */
    #if !defined(__MMI_PHB_CALLERGROUP_IN_SIM__)    /* Associate caller group in SIM card entry */
        if (store_index < MAX_PB_PHONE_ENTRIES)
    #endif 
        {
            callerGroups = (PHB_CALLER_GROUP_STRUCT*) g_phb_cntx.caller_group;

            mmi_phb_read_optional_ids(store_index); /* i is store index */
            opt_ids = (PHB_OPTIONAL_IDS_STRUCT*) g_phb_cntx.optional_ids;

            grp_id = opt_ids->callerGroupID;
            if (grp_id)
            {
            #if defined(__MMI_CALLERGROUP_NO_ALERT__)
                phbDetails.alertType = MMI_ALERT_NONE;
            #else
                phbDetails.alertType = callerGroups[grp_id - 1].alertType;
            #endif
                phbDetails.backlightId = callerGroups[grp_id - 1].LEDPatternId;
                phbDetails.ringtoneId = callerGroups[grp_id - 1].ringToneID;
                if (callerGroups[grp_id - 1].pictureTagID == 1 /* Associate Picture is in the file system. */
                #if defined(__MMI_AVATAR__)
                    || callerGroups[grp_id - 1].pictureTagID == 2 /* Associate Picture is from avatar. */
                #endif
                    )
                {
                #if defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__)
                    phbDetails.pictureId = 1;
                    phbDetails.record_index = 5000 + grp_id;
                #endif /* defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) */ 
                }
                else if (callerGroups[grp_id - 1].pictureTagID != 0)    /* 0 means default image */
                {
                    phbDetails.pictureId = callerGroups[grp_id - 1].pictureTagID;
                }

            #if defined(__MMI_INCOMING_CALL_VIDEO__)
                if (callerGroups[grp_id - 1].VideoID)
                {
                    phbDetails.videoId = callerGroups[grp_id - 1].VideoID;
                    phbDetails.video_record_index = (U16) (MAX_PB_PHONE_ENTRIES + grp_id);      /* MAX_PB_PHONE_ENTRIES for group 1 and so on. */
                }
            #endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 
            }
        }

        /*  Personal Entry Setup, these will overwrite caller group setting. */
        if (store_index < MAX_PB_PHONE_ENTRIES)
        {
            /* Associate Pictures */
            if (opt_ids->pictureTagID == 1 
            #ifdef __MMI_AVATAR__
                || opt_ids->pictureTagID == 2
            #endif
                )
            {
            #if defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__)
                phbDetails.pictureId = 1;
                phbDetails.record_index = store_index + 1;  /* Record Must in NVRAM, so the record index is store_index + 1 */
            #endif /* defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) */ 
            #if defined(__MMI_INCOMING_CALL_VIDEO__)
                phbDetails.videoId = 0;                     /* If Image Selected, should not play caller group's video */
            #endif 
            }
            else if ((opt_ids->pictureTagID != IMG_PHB_DEFAULT) && (opt_ids->pictureTagID != 0x0000))
            {
                phbDetails.pictureId = opt_ids->pictureTagID;
            #if defined(__MMI_INCOMING_CALL_VIDEO__)
                phbDetails.videoId = 0; /* If Image Selected, should not play caller group's video */
            #endif 
            }

            /* Associate Ring Tone */
            if (opt_ids->ringToneID)
            {
                phbDetails.ringtoneId = opt_ids->ringToneID;
            }

            /* For Incoming Call Video */
        #if defined(__MMI_INCOMING_CALL_VIDEO__)
            if ((video_id = mmi_phb_video_get_id_by_index(store_index)) != 0)
            {
                phbDetails.videoId = video_id;
                phbDetails.video_record_index = store_index + 1;        /* Record Must in NVRAM, so the record index is store_index + 1 */
            }
        #endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 
        }
    }
    /*
     *   If entry is not found, try to search in FDN list to see if number can be match and dial out.
     *   This should be search when FDN is enable.
     *   Note: FDN list is stored in ADN storage when FDN is enable.
     */
#ifdef __MMI_DUAL_SIM_MASTER__
    else if (gSecuritySetupContext.FdlStatus && simInterface == SIM1)
#else /* __MMI_DUAL_SIM_MASTER__ */
    else if (gSecuritySetupContext.FdlStatus)
#endif /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_ucs2_to_asc((PS8) number_ASCII, (PS8) number);
        store_index = mmi_phb_fdn_search_by_number((S8*) number_ASCII);
        if (store_index < 0xffff)
        {
            mmi_ucs2cpy((PS8) phbDetails.name, (PS8) PhoneBook[store_index].alpha_id.name);
            phbDetails.name_dcs = PhoneBook[store_index].alpha_id.name_dcs;

            mmi_phb_convert_get_ucs2_number((S8*) phbDetails.number, store_index);
        }
    }
#ifdef __MMI_DUAL_SIM_MASTER__
    else if (MTPNP_AD_FDN_GetStatus() && simInterface == SIM2)
    {
        mmi_ucs2_to_asc((PS8) number_ASCII, (PS8) number);
        store_index = MTPNP_PFAL_ADN_phb_fdn_search_by_number((S8*) number_ASCII);
        if (store_index < 0xffff)
        {
            mmi_ucs2cpy((PS8) phbDetails.name, (PS8) PhoneBook[store_index].alpha_id.name);
            phbDetails.name_dcs = PhoneBook[store_index].alpha_id.name_dcs;

            mmi_phb_convert_get_ucs2_number((S8*) phbDetails.number, store_index);
        }
    }
#endif /* __MMI_DUAL_SIM_MASTER__*/
    return phbDetails;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_set_dial_from_list
 * DESCRIPTION
 *  Let call management to set dial from list flag.
 * PARAMETERS
 *  value       [IN]        TRUE/FALSE value
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_call_set_dial_from_list(U8 value)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.dial_from_list = value;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_num_by_sim_index
 * DESCRIPTION
 *  Return the number to call mgnt for BT to call
 * PARAMETERS
 *  sim_location        [IN]        SIM1 or SIM2
 *  index               [IN]        physical location in SIM
 *  ucs2_num            [IN]        num buffer to write
 *  ucs2_len            [IN]        max usc2_strlen that can be written 
 *                             in ucs2_num buff (doesn't include null terminate)
 * RETURNS
 *  void
 *****************************************************************************/
MMI_BOOL mmi_phb_get_num_by_sim_index(U8 sim_location, U16 index, S8* ucs2_num, U16 ucs2_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U16 record_index;
    U8 hasEntry = 0;
    U16 phb_min_index, phb_max_index;    
    S8* num_buff;
    U16 num_max_len;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __MMI_DUAL_SIM_MASTER__
    ASSERT(sim_location == SIM1);
#endif
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() != MTPNP_TRUE)
#else /* __MMI_DUAL_SIM_MASTER__ */
    if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif
    {
        return MMI_FALSE;
    }
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        return MMI_FALSE;
    }
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    else if (index == 0 || (sim_location == SIM1 && g_phb_cntx.sim_total == 0) || (sim_location == SIM2 && MTPNP_AD_ADN_SIM2GetUsedNumber() == 0))
#else
    else if (index == 0 || g_phb_cntx.sim_total == 0)
#endif
    {
        return MMI_FALSE;
    }
    else
    {
    #ifdef __MMI_DUAL_SIM_MASTER__
        if (sim_location == SIM2)
        {
            phb_min_index = MAX_PB_PHONE_ENTRIES + MAX_PB_SIM_ENTRIES;
            phb_max_index = MAX_PB_PHONE_ENTRIES + MAX_PB_SIM_ENTRIES + MAX_PB_SIM2_ENTRIES;
        }
        else
    #endif /* __MMI_DUAL_SIM_MASTER__ */
        {
            phb_min_index = MAX_PB_PHONE_ENTRIES;
            phb_max_index = MAX_PB_PHONE_ENTRIES + MAX_PB_SIM_ENTRIES;
        }

        for (i = 0; i < PhoneBookEntryCount; i++)
        {
            if (g_phb_name_index[i] >= phb_min_index && g_phb_name_index[i] < phb_max_index)
            {
                record_index = g_phb_name_index[i] - phb_min_index + 1;

                if (record_index == index)
                {
                    hasEntry = 1;
                    num_buff = OslMalloc((MAX_PB_NUMBER_LENGTH + 1 + 1) * ENCODING_LENGTH);
                    memset(num_buff, 0, ((MAX_PB_NUMBER_LENGTH + 1 + 1) * ENCODING_LENGTH));
                    mmi_phb_convert_get_ucs2_number(num_buff, g_phb_name_index[i]);
                    num_max_len = ((mmi_ucs2strlen(num_buff) >= ucs2_len) ? ucs2_len : mmi_ucs2strlen(num_buff));
                    mmi_ucs2ncpy(ucs2_num, num_buff, num_max_len);
                    *(ucs2_num + num_max_len * ENCODING_LENGTH) = NULL;
                    *(ucs2_num + num_max_len * ENCODING_LENGTH + 1) = NULL;
                    OslMfree(num_buff);
                    break;
                }
            }
        }

        if (hasEntry)
        {
            return MMI_TRUE;
        }
        else
        {
            return MMI_FALSE;
        }

    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_set_global_store_index
 * DESCRIPTION
 *  Let other ap to set g_phb_cntx.store_index.
 * PARAMETERS
 *  value       [IN]        TRUE/FALSE value
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_set_global_store_index(U16 store_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.store_index = store_index;
}

#if defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) || defined(__MMI_FILE_MANAGER__)


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_image_get_path_from_id
 * DESCRIPTION
 *  This function returns the phonebook associate picture image path by index.
 * PARAMETERS
 *  record_index        [IN]        Index of a phonebook record. (if >5000, it is a caller group image)
 * RETURNS
 *  full path of image
 *****************************************************************************/
S8 *mmi_phb_image_get_path_from_id(U16 record_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 drive;
    S8 *path;
    FS_HANDLE fh;
    S32 width, height;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_IMAGE_GET_PATH_FROM_ID_1, record_index);

    drive = MMI_PHB_DRV;

    if (drive > 0)
    {
        path = (S8*) phb_caller_pic_file_path;  /* Use global static buffer to store path */

        mmi_phb_image_get_full_path_by_index(record_index, path);

        /* Try to open file and check image format. If can't open, use default picture to display. */
        if (mmi_ucs2strlen(path) > 0)
        {
            fh = FS_Open((U16*) path, FS_READ_ONLY);

            MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_IMAGE_GET_PATH_FROM_ID_2, fh);
            if (fh)
            {
                FS_Close(fh);
                if (gdi_image_get_dimension_file((S8*) path, &width, &height) >= 0)
                {
                    MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_IMAGE_GET_PATH_FROM_ID_3);
                    return path;
                }
            }
        }
    }

    return NULL;

}
#endif /* defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) || defined(__MMI_FILE_MANAGER__) */ 

#if defined(__MMI_INCOMING_CALL_VIDEO__)


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_video_get_path_from_id
 * DESCRIPTION
 *  This function returns the phonebook associate video path by index.
 * PARAMETERS
 *  record_index        [IN]        Index of a phonebook record.
 * RETURNS
 *  full path of image
 *****************************************************************************/
S8 *mmi_phb_video_get_path_from_id(U16 record_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index = record_index - 1;
    U16 video_id = 0;

    PHB_CALLER_GROUP_STRUCT *callerGroups;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* In phonebook entry */
    if (store_index < MAX_PB_PHONE_ENTRIES)
    {
        video_id = mmi_phb_video_get_id_by_index(store_index);
    }
    /* In caller group */
    else if ((store_index < (MAX_PB_PHONE_ENTRIES + MAX_PB_CALLER_GROUPS)) && (store_index >= MAX_PB_PHONE_ENTRIES))
    {
        callerGroups = (PHB_CALLER_GROUP_STRUCT*) g_phb_cntx.caller_group;
        video_id = callerGroups[(store_index - MAX_PB_PHONE_ENTRIES)].VideoID;
    }
    return mmi_phb_caller_video_get_path_by_index(video_id);
}
#endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_enter_from_divert
 * DESCRIPTION
 *  Displays the PHB list for call divert
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_call_enter_from_divert(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_list_pre_entry_for_number_and_email(MMI_PHB_ENTRY_FIELD_ALL_NUMBER, SendPhbEntryForDivert);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_enter_from_active_call
 * DESCRIPTION
 *  Displays PHB main menu from active call options
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_call_enter_from_active_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_phb_cntx.processing)
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
    else
    {
    	g_phb_enter_from = MMI_PHB_ENTER_NONE;
        mmi_phb_clear_old_history();
        mmi_phb_util_clear_buffer(TRUE);
        mmi_phb_entry_main_menu();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_enter_from_deflect_option
 * DESCRIPTION
 *  Displays PHB list from incoming call deflect option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_call_enter_from_deflect_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_phb_cntx.processing)
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
    else
    {
        phbListView = MMI_PHB_LIST_FOR_CM;
        /* mmi_phb_list_pre_entry_second_level(); */
        g_phb_cntx.highlight_entry = 0;

        mmi_phb_entry_list(
            PhoneBookEntryCount,                    /* Total Entry */
            STR_SCR_PBOOK_VIEW_CAPTION,             /* Title String */
            IMG_SCR_PBOOK_CAPTION,                  /* Title Image */
            STR_GLOBAL_OK,                          /* LSK */
            IMG_GLOBAL_OK,                          /* LSK */
            mmi_phb_get_index_second_level,         /* Highlight Callback */
            mmi_phb_call_send_data_for_deflect,     /* LSK Callback */
            mmi_phb_call_send_data_for_deflect,     /* SEND Key Callback */
            mmi_phb_list_get_item,                  /* List Callback */
            mmi_phb_list_get_hint,                  /* Hint Callback */
            mmi_phb_call_enter_from_deflect_option, /* Re-Entry Callback */
            TRUE,                                   /* Alpha Index */
            TRUE);                                  /* Right Arrow Key */

    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_call_send_data_for_deflect
 * DESCRIPTION
 *  Sends the numbers info of the selected
 *  entry for Call deflect
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_call_send_data_for_deflect(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8* phb_deflect_num;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_deflect_num = OslMalloc((MAX_PB_NUMBER_LENGTH+1+1)*ENCODING_LENGTH);
    mmi_phb_convert_get_ucs2_number(phb_deflect_num, g_phb_name_index[g_phb_cntx.active_index_second]);        /* BCD number format. */
    CBackCallDeflectNumberFromPB(phb_deflect_num);
    DeleteScreenIfPresent(SCR_PBOOK_LIST);
    OslMfree(phb_deflect_num);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_list_enter_first_from_active_call
 * DESCRIPTION
 *  Enter phonebook list from active call to first item.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_list_enter_first_from_active_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_list_enter_from_active_call(0);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_list_enter_last_from_active_call
 * DESCRIPTION
 *  Enter phonebook list from active call to last item.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_list_enter_last_from_active_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_list_enter_from_active_call((U16) (PhoneBookEntryCount - 1));
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_list_enter_from_active_call
 * DESCRIPTION
 *  enter phonebook list from active call, highlight on specific entry.
 *  (Note this function call will clear all phonebook history if exists)
 * PARAMETERS
 *  highlight_pos       [IN]        Highlight entry position.
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_list_enter_from_active_call(U16 highlight_pos)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif /* __MMI_DUAL_SIM_MASTER__ */
    {
        if (PhoneBookEntryCount)
        {
            phbListView = MMI_PHB_LIST_FOR_PHB;
            g_phb_cntx.highlight_entry = highlight_pos;

            mmi_phb_clear_old_history();    /* Clear old phb history */
            mmi_phb_list_pre_entry();
        }
        else
        {
            DisplayPopup(
                (PU8) GetString(STR_NO_ENTRIES_MESSAGE),
                IMG_GLOBAL_EMPTY,
                TRUE,
                PHB_NOTIFY_TIMEOUT,
                EMPTY_LIST_TONE);
        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
}

#define MMI_PHB_INTERFACE_FOR_SMS
#if defined(__MMI_PHB_GENERIC_MULTI_SELECT__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_generic_multi_select_list_pre_entry
 * DESCRIPTION
 *  Pre-entry function of multi select list used for other AP (SMS, MMS...)
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_generic_multi_select_list_pre_entry(U8 filter_type, U16 select_limit, mmi_phb_get_index_from_group_callback_type list_view_call_back, mmi_phb_check_selected_index_callback_type list_check_call_back)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_list_view_type = filter_type;
    phb_generic_multi_select_list_call_back = list_view_call_back;
    phb_generic_multi_select_check_call_back = list_check_call_back;
    g_phb_multi_select_limit = select_limit;
    DeleteScreenIfPresent(SCR_ID_PHB_GENERIC_MULTI_SELECT);
    mmi_phb_entry_generic_multi_select_list();    	
}
#endif /* defined(__MMI_PHB_GENERIC_MULTI_SELECT__) */


#if defined(__MMI_MESSAGES_SEND_BY_GROUP__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sms_enter_send_by_group
 * DESCRIPTION
 *  Displays the Caller Groups list for SMS to send message
 *  to all numbers belonging to this group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_sms_enter_send_by_group(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_get_address_from_caller_group((U8)MMI_PHB_ENTRY_FIELD_NUMBER, mmi_msg_send_msg_to_group);
}
#endif /* defined(__MMI_MESSAGES_SEND_BY_GROUP__) */ 

#if defined(__MMI_MESSAGES_SEND_BY_GROUP__) || defined(__UNIFIED_COMPOSER_SUPPORT__) || defined(__MMI_JATAAYU_MMS_ADD_NUMBER_BY_GROUP__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sms_send_data_for_group
 * DESCRIPTION
 *  Sends the names & numbers info of the selected
 *  caller group to SMS
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_sms_send_data_for_group(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 *indices;
    U16 i, j = 0;
    S16 pError;
    U16 store_index;
    U8 optid_record, optid_index, current_record = 0;
    PHB_OPTIONAL_IDS_STRUCT PhbOptIDs[OPTIONAL_IDS_RECORD_TOTAL];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Clear key immediately to avoid user press twice. */
    ClearKeyHandler(KEY_LSK, KEY_EVENT_UP);

#ifdef __MMI_PHB_USIM_FIELD__
    if (g_phb_cntx.active_index >= MAX_PB_CALLER_GROUPS)
    {
#if (MAX_PB_ENTRIES >= 1000)
        indices = (U16*)g_phb_list_filter;
#else
        indices = OslMalloc(MAX_PB_SIM_ENTRIES*sizeof(U16));
#endif /* MAX_PB_ENTRIES >= 1000 */
        for (i = 0; i < PhoneBookEntryCount ; ++i)
        {
            store_index = g_phb_name_index[i];
            if (store_index >= MAX_PB_PHONE_ENTRIES)
            {
                /* Compare caller group ID */
                if (g_phb_cntx.group_type[store_index-MAX_PB_PHONE_ENTRIES] == 
                    (g_phb_cntx.active_index_second+1-MAX_PB_CALLER_GROUPS) && 
                    PhoneBook[store_index].field & phb_list_view_type)
                {         
                    indices[j++] = store_index;
                }
            }
        }
        MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_FUNC_SendDataForCallerGrp, j );
        phb_group_view_call_back(j, indices);
#if (MAX_PB_ENTRIES < 1000)
        OslMfree(indices);
#endif /* MAX_PB_ENTRIES < 1000 */
        return;
    }
#endif /* __MMI_PHB_USIM_FIELD__ */

#if (MAX_PB_ENTRIES >= 1000)
    indices = (U16*) g_phb_list_filter;
#else /* (MAX_PB_ENTRIES >= 1000) */ 
#if defined(__MMI_PHB_CALLERGROUP_IN_SIM__)     /* Associate caller group in SIM card entry */
    indices = OslMalloc(MAX_PB_ENTRIES * sizeof(U16));
#else 
    indices = OslMalloc(MAX_PB_PHONE_ENTRIES * sizeof(U16));
#endif 
#endif /* MAX_PB_ENTRIES >= 1000 */

    for (i = 0; i < PhoneBookEntryCount; ++i)
    {
        store_index = g_phb_name_index[i];

    #if !defined(__MMI_PHB_CALLERGROUP_IN_SIM__)    /* Associate caller group in SIM card entry */
        if (store_index < MAX_PB_PHONE_ENTRIES)
    #endif 
        {
            /* Get optional IDs record. */
            optid_record = (store_index / OPTIONAL_IDS_RECORD_TOTAL) + 1;
            optid_index = store_index - (optid_record - 1) * OPTIONAL_IDS_RECORD_TOTAL;

            if (optid_record != current_record)
            {
                ReadRecord(NVRAM_EF_PHB_IDS_LID, optid_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
                current_record = optid_record;
            }
            /* Compare caller group ID */
            if (PhbOptIDs[optid_index].callerGroupID == (g_phb_cntx.active_index_second + 1) &&
                PhoneBook[store_index].field & phb_list_view_type)
            {
                indices[j++] = store_index;
            }
        }
    }

    MMI_TRACE(MMI_TRACE_G4_PHB, MMI_PHB_FUNC_SendDataForCallerGrp, j);

    phb_group_view_call_back(j, indices);
#if (MAX_PB_ENTRIES < 1000)
    OslMfree(indices);
#endif /* MAX_PB_ENTRIES < 1000 */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_caller_group_data
 * DESCRIPTION
 *  Get the all numbers belonging to this group for UM to send message
 * PARAMETERS
 *  address_type                 [IN]        address type: number or e-mail
 *  get_address_call_back        [IN]        call back function after user chooses a group
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_get_address_from_caller_group(U8 address_type, mmi_phb_get_index_from_group_callback_type get_address_call_back)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        if (PhoneBookEntryCount)
        {
            phbListView = MMI_PHB_LIST_FOR_GET_ADDRESS_FROM_GROUP;
            phb_list_view_type = address_type;
            phb_group_view_call_back = get_address_call_back;
            mmi_phb_entry_callergroup();    /* Entry caller group main screen. */
        }
        else
        {
            DisplayPopup(
                (PU8) GetString(STR_NO_ENTRIES_MESSAGE),
                IMG_GLOBAL_EMPTY,
                TRUE,
                PHB_NOTIFY_TIMEOUT,
                EMPTY_LIST_TONE);
        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
}
#endif /* defined(__MMI_MESSAGES_SEND_BY_GROUP__) || defined(__UNIFIED_COMPOSER_SUPPORT__) || defined(__MMI_JATAAYU_MMS_ADD_NUMBER_BY_GROUP__) */ 


#if defined(__UNIFIED_COMPOSER_SUPPORT__) || defined(__MMI_JATAAYU_MMS_ADD_NUMBER_BY_GROUP__) 
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_email_p
 * DESCRIPTION
 *  Get the all numbers belonging to this group for UM to send message
 * PARAMETERS
 *  store_index                 [IN]        store index of the phonebook entry
 *  address_length              [OUT]       email address length
 * RETURNS
 *  email address pointer
 *****************************************************************************/
U8* mmi_phb_get_email_p(U16 store_index, U8* address_length)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 pError;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    if (store_index < MAX_PB_PHONE_ENTRIES) /* in NVRAM */
    {
        ReadRecord(
            NVRAM_EF_PHB_FIELDS_LID,
            (U16) (store_index + 1),
            (void*)&PhoneBookOptionalFields,
            OPTIONAL_FIELDS_RECORD_SIZE,
            &pError);
        *address_length = strlen((PS8)PhoneBookOptionalFields.emailAddress);
        return (U8*)PhoneBookOptionalFields.emailAddress;
    }
#endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 
#ifdef __MMI_PHB_USIM_FIELD__
    if (store_index >= MAX_PB_PHONE_ENTRIES)    /* in USIM */
    {
        *address_length = phb_email[store_index - MAX_PB_PHONE_ENTRIES].email_length;
        return (U8*) phb_email[store_index - MAX_PB_PHONE_ENTRIES].email_address;
    }
#endif /* __MMI_PHB_USIM_FIELD__ */
    *address_length = 0;
    return NULL;
}
#endif /* defined(__UNIFIED_COMPOSER_SUPPORT__) || defined(__MMI_JATAAYU_MMS_ADD_NUMBER_BY_GROUP__) */

/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sms_send_data_choose_entry
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_sms_send_data_choose_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_entry_list_choose_number(
        g_phb_name_index[g_phb_cntx.active_index_second],
        mmi_phb_sms_send_data_choose_entry,
        mmi_phb_sms_send_data_for_entry_list,
        mmi_phb_sms_send_data_for_entry,
        NULL,
        STR_SMS_NUM_CANNOT_BE_EMPTY,
        FALSE);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sms_send_data_for_entry_name_only
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_sms_send_data_for_entry_name_only(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_sms_send_data_for_entry(NULL);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sms_send_data_for_entry_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_sms_send_data_for_entry_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* DeleteNScrId(SCR_PBOOK_LIST); */
    mmi_phb_sms_send_data_for_entry((PS8) g_phb_cntx.number_to_dial[g_phb_cntx.active_index_third]);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sms_send_data_for_entry
 * DESCRIPTION
 *  Sends the name & number info of the selected PHB entry to SMS
 * PARAMETERS
 *  number      [IN]        Input number string
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_sms_send_data_for_entry(S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index;
    S8 ascii_number[MAX_PB_NUMBER_LENGTH + 1 + 1];
    mmi_frm_sms_api_entry_write_struct sendData;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    store_index = g_phb_name_index[g_phb_cntx.active_index_second];

    if (mmi_ucs2strlen((PS8) number) == 0)
    {
        DisplayPopup(
            (PU8) GetString(STR_SMS_NUM_CANNOT_BE_EMPTY),
            IMG_GLOBAL_UNFINISHED,
            1,
            PHB_NOTIFY_TIMEOUT,
            (U8) ERROR_TONE);
    }
    else
    {
        memset(ascii_number, 0, sizeof(ascii_number));
        memset(&sendData, 0, sizeof(mmi_frm_sms_api_entry_write_struct));

        mmi_ucs2_n_to_asc((PS8)ascii_number, (PS8)number, MAX_PB_NUMBER_LENGTH + 1);
        sendData.string = NULL;
        sendData.stringlength = 0;
        sendData.dcs = 0;
        sendData.flag = MMI_FRM_SMS_ENTRY_WRITE_REPLY;
        sendData.ascii_addr = (U8*) ascii_number;

        mmi_frm_sms_api_entry_write_msg(&sendData);
    }
}

#ifdef __MMI_PHB_SEND_MMS_FROM_PHB__


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_send_data_for_entry
 * DESCRIPTION
 *  Sends the name & number info of the selected PHB entry to SMS
 * PARAMETERS
 *  number      [IN]        Input number string
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_mms_send_data_for_entry(S8 *number)
{
#ifdef WAP_SUPPORT
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((PS8) number) <= MAX_PB_NUMBER_LENGTH)
    {
        if (mmi_ucs2strlen((PS8) number) == 0)
        {
            DisplayPopup(
                (PU8) GetString(STR_SMS_NUM_CANNOT_BE_EMPTY),
                IMG_GLOBAL_UNFINISHED,
                1,
                PHB_NOTIFY_TIMEOUT,
                (U8) ERROR_TONE);
        }
        else
        {
            mms_address_insert_hdlr((char*)number);
        }
    }
    else
#endif /* WAP_SUPPORT */ /* WAP_SUPOPRT */
    {
        DisplayPopup(
            (PU8) GetString(STR_SMS_NUM_LEN_EXCEEDED),
            IMG_GLOBAL_UNFINISHED,
            1,
            PHB_NOTIFY_TIMEOUT,
            (U8) ERROR_TONE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_send_data_for_entry_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_mms_send_data_for_entry_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_mms_send_data_for_entry((PS8) g_phb_cntx.number_to_dial[g_phb_cntx.active_index_third]);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_send_data_choose_entry
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_mms_send_data_choose_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_entry_list_choose_number(
        g_phb_name_index[g_phb_cntx.active_index_second],
        mmi_phb_mms_send_data_choose_entry,
        mmi_phb_mms_send_data_for_entry_list,
        mmi_phb_mms_send_data_for_entry,
        NULL,
        STR_SMS_NUM_CANNOT_BE_EMPTY,
        FALSE);
}
#endif /* __MMI_PHB_SEND_MMS_FROM_PHB__ */ 


#define MMI_PHB_UPDATE_INLINE_LIST
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_update_delete_image
 * DESCRIPTION
 *  Deletes the image id from PHB records if
 *  one of the downloaded/factory/system images
 *  are deleted.
 * PARAMETERS
 *  imageId     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_update_delete_image(U16 imageId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U8 flag = 0;
    S16 pError;
    U8 optid_record = 0, optid_index, current_record = 0;
    PHB_OPTIONAL_IDS_STRUCT PhbOptIDs[OPTIONAL_IDS_RECORD_TOTAL];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < MAX_PB_PHONE_ENTRIES; ++i)
    {
        /* Get optional IDs record. */
        optid_record = (i / OPTIONAL_IDS_RECORD_TOTAL) + 1;
        optid_index = i - (optid_record - 1) * OPTIONAL_IDS_RECORD_TOTAL;

        if (optid_record != current_record)
        {
            if (current_record != 0 && flag == 1)   /* Write result back for previous optional ID record. */
            {
                WriteRecord(NVRAM_EF_PHB_IDS_LID, current_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
                flag = 0;
            }

            /* Read out next record. */
            ReadRecord(NVRAM_EF_PHB_IDS_LID, optid_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
            current_record = optid_record;
        }

        if (PhbOptIDs[optid_index].pictureTagID == imageId)
        {
            PhbOptIDs[optid_index].pictureTagID = IMG_PHB_DEFAULT;
            flag = 1;
        }
    }

    /* Write back for last record. */
    if (flag)
    {
        WriteRecord(NVRAM_EF_PHB_IDS_LID, optid_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_update_delete_image_caller_group
 * DESCRIPTION
 *  Deletes the image id from caller group if
 *  one of the downloaded/factory/system images
 *  are deleted.
 * PARAMETERS
 *  imageId     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_update_delete_image_caller_group(U16 imageId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i;
    U8 flag = 0;
    S16 pError;
    PHB_CALLER_GROUP_STRUCT *callerGroups;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    callerGroups = (PHB_CALLER_GROUP_STRUCT*) g_phb_cntx.caller_group;

    for (i = 0; i < MAX_PB_CALLER_GROUPS; ++i)
    {
        if (callerGroups[i].pictureTagID == imageId)
        {
            callerGroups[i].pictureTagID = IMG_PHB_DEFAULT;
            flag = 1;
        }
    }

    if (flag)
    {
        WriteRecord(NVRAM_EF_PHB_CALLER_GROUPS_LID, 1, callerGroups, CALLER_GROUPS_RECORD_SIZE, &pError);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_update_delete_audio
 * DESCRIPTION
 *  Deletes the audio id from PHB records if
 *  one of the downloaded/factory/system/composed
 *  images are deleted.
 * PARAMETERS
 *  audioId     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_update_delete_audio(U16 audioId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U8 flag = 0;
    S16 pError;
    U8 optid_record = 0, optid_index, current_record = 0;
    PHB_OPTIONAL_IDS_STRUCT PhbOptIDs[OPTIONAL_IDS_RECORD_TOTAL];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < MAX_PB_PHONE_ENTRIES; ++i)
    {
        /* Get optional IDs record. */
        optid_record = (i / OPTIONAL_IDS_RECORD_TOTAL) + 1;
        optid_index = i - (optid_record - 1) * OPTIONAL_IDS_RECORD_TOTAL;

        if (optid_record != current_record)
        {
            if (current_record != 0 && flag == 1)   /* Write result back for previous optional ID record. */
            {
                WriteRecord(NVRAM_EF_PHB_IDS_LID, current_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
                flag = 0;
            }

            /* Read out next record. */
            ReadRecord(NVRAM_EF_PHB_IDS_LID, optid_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
            current_record = optid_record;
        }

        if (PhbOptIDs[optid_index].ringToneID == audioId)
        {
            PhbOptIDs[optid_index].ringToneID = 0;
            flag = 1;
        }
    }

    /* Write back for last record. */
    if (flag)
    {
        WriteRecord(NVRAM_EF_PHB_IDS_LID, optid_record, (void*)PhbOptIDs, OPTIONAL_IDS_RECORD_SIZE, &pError);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_update_delete_audio_caller_group
 * DESCRIPTION
 *  Deletes the audio id from CallerGroup records if
 *  one of the downloaded/factory/system/composed
 *  images are deleted.
 * PARAMETERS
 *  audioId     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_update_delete_audio_caller_group(U16 audioId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i, flag = 0;
    S16 pError;
    PHB_CALLER_GROUP_STRUCT *callerGroups;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    callerGroups = (PHB_CALLER_GROUP_STRUCT*) g_phb_cntx.caller_group;

    for (i = 0; i < MAX_PB_CALLER_GROUPS; ++i)
    {
        if (callerGroups[i].ringToneID == audioId)
        {
            callerGroups[i].ringToneID = 0;
            flag = 1;
        }
    }

    if (flag)
    {
        WriteRecord(NVRAM_EF_PHB_CALLER_GROUPS_LID, 1, callerGroups, CALLER_GROUPS_RECORD_SIZE, &pError);
    }
}

#define MMI_PHB_INTERFACE_FOR_SPEED_DIAL


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_speed_dial_enter_phb
 * DESCRIPTION
 *  Displays the PHB list for Speed key mapping
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_speed_dial_enter_phb(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phbListView = MMI_PHB_LIST_FOR_SPEED_DIAL;
    mmi_phb_list_pre_entry_second_level();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_pre_send_data
 * DESCRIPTION
 *  Send choosed number to MMS
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_pre_send_data(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phb_list_view_call_back(pbName, (S8*) g_phb_cntx.number_to_dial[g_phb_cntx.active_index_third]);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_entry_choose_number
 * DESCRIPTION
 *  Entry Choose entry screen if there are more then one entry with number field.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_entry_choose_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U8 *guiBuffer;
    U16 numberTypeImageList[5];
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)    
    S16 pError;
#endif
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (phbListView == MMI_PHB_LIST_FOR_MMS_ALL)
    {
        store_index = g_phb_name_index[g_phb_cntx.active_index_second];
    }
    else
    {
        store_index = g_phb_cntx.active_index_second;
    }

    mmi_ucs2cpy(pbName, (PS8) PhoneBook[store_index].alpha_id.name);
    /* For SMS insert phonebook name */
    if (phb_list_view_type == MMI_PHB_ENTRY_FIELD_NAME)
    {
        g_phb_cntx.number_to_dial[0] = NULL;
        g_phb_cntx.active_index_third = 0;
        mmi_phb_pre_send_data();
        return;
    }
    mmi_phb_convert_get_ucs2_number(pbNumber, store_index); /* BCD number format. */

#ifndef __MMI_PHB_USIM_FIELD__
    if ((phb_list_view_type & MMI_PHB_ENTRY_FIELD_ALL_NUMBER) && (store_index >= MAX_PB_PHONE_ENTRIES))   /* In SIM */
    {
        if (!mmi_ucs2strlen(pbNumber))
        {
            DisplayPopup(
                (PU8) GetString(STR_NO_NUMBER_TO_DIAL),
                IMG_GLOBAL_ERROR,
                FALSE,
                PHB_NOTIFY_TIMEOUT,
                ERROR_TONE);
        }
        else
        {
            g_phb_cntx.number_to_dial[0] = (U8*) pbNumber;
            g_phb_cntx.active_index_third = 0;
            mmi_phb_pre_send_data();
        }
    }
    else
#endif /* __MMI_PHB_USIM_FIELD__ */ 
    {
        i = 0;

        if ((phb_list_view_type& MMI_PHB_ENTRY_FIELD_ALL_NUMBER) && mmi_ucs2strlen(pbNumber))
        {
            g_phb_cntx.number_to_dial[i] = (U8*) pbNumber;
            numberTypeImageList[i++] = IMG_MOBILE_NUMBER;
        }
    #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    #ifdef __MMI_PHB_USIM_FIELD__
        if (store_index >= MAX_PB_PHONE_ENTRIES)
        {
            mmi_phb_op_set_option_data_by_usim_index((U16) store_index, &PhoneBookOptionalFields);
        }
        else
    #endif /* __MMI_PHB_USIM_FIELD__ */ 
        {
            ReadRecord(
                NVRAM_EF_PHB_FIELDS_LID,
                (U16) (store_index + 1),
                (void*)&PhoneBookOptionalFields,
                OPTIONAL_FIELDS_RECORD_SIZE,
                &pError);
        }
        if (phb_list_view_type & MMI_PHB_ENTRY_FIELD_ALL_NUMBER)
        {
            mmi_asc_to_ucs2(pbHomeNumber, (PS8) PhoneBookOptionalFields.homeNumber);
            if (mmi_ucs2strlen(pbHomeNumber))
            {
                g_phb_cntx.number_to_dial[i] = (PU8) pbHomeNumber;
                numberTypeImageList[i++] = IMG_HOME_NUMBER;
            }
            mmi_asc_to_ucs2(pbOfficeNumber, (PS8) PhoneBookOptionalFields.officeNumber);
            if (mmi_ucs2strlen(pbOfficeNumber))
            {
                g_phb_cntx.number_to_dial[i] = (PU8) pbOfficeNumber;
                numberTypeImageList[i++] = IMG_OFFICE_NUMBER;
            }
            mmi_asc_to_ucs2(pbFaxNumber, (PS8) PhoneBookOptionalFields.faxNumber);
            if (mmi_ucs2strlen(pbFaxNumber))
            {
                g_phb_cntx.number_to_dial[i] = (PU8) pbFaxNumber;
                numberTypeImageList[i++] = IMG_FAX_NUMBER;
            }
        }

        if (phb_list_view_type & MMI_PHB_ENTRY_FIELD_EMAIL)
        {
            mmi_asc_to_ucs2(pbEmailAddress, (PS8) PhoneBookOptionalFields.emailAddress);
            if (mmi_ucs2strlen(pbEmailAddress))
            {
                g_phb_cntx.number_to_dial[i] = (PU8) pbEmailAddress;
                numberTypeImageList[i++] = IMG_EMAIL_ADDRESS;
            }
        }
    #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 

        if (!i)
        {
            DisplayPopup(
                (PU8) GetString(STR_NO_NUMBER_TO_DIAL),
                IMG_GLOBAL_ERROR,
                FALSE,
                PHB_NOTIFY_TIMEOUT,
                ERROR_TONE);
        }
        else if (i == 1)
        {
            g_phb_cntx.active_index_third = 0;
            mmi_phb_pre_send_data();
        }
        else
        {
            EntryNewScreen(
                SCR_ID_PHB_MMS_CHOOSE_ENTRY,
                mmi_phb_exit_mms_choose_number,
                mmi_phb_entry_choose_number,
                NULL);
            guiBuffer = GetCurrGuiBuffer(SCR_ID_PHB_MMS_CHOOSE_ENTRY);
            RegisterHighlightHandler(mmi_phb_get_index_third_level);
            ShowCategory53Screen(
                STR_CHOOSE_NUMBER_CAPTION,
                IMG_SCR_PBOOK_CAPTION,
                STR_GLOBAL_OK,
                IMG_GLOBAL_OK,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                i,
                g_phb_cntx.number_to_dial,
                numberTypeImageList,
                NULL,
                0,
                0,
                guiBuffer);

            SetLeftSoftkeyFunction(mmi_phb_pre_send_data, KEY_EVENT_UP);
            SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_list_entry_for_number_and_email
 * DESCRIPTION
 *  This function provide call back function before enter phonebook list
 * PARAMETERS
 *  
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_list_entry_for_number_and_email(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U16 EntryCount = 0;
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB,
                         "File: [%s]  Line: [%d] <<mmi_phb_list_entry_for_number_and_email.>\n", __FILE__,
                         __LINE__);

#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        /* Allocate buffer for phonebook memeber list filter */
        mmi_phb_list_allocate_filter();

        /* Build list according to filter */
        for (i = 0; i < PhoneBookEntryCount; i++)
        {
            store_index = g_phb_name_index[i];
            if (phb_list_view_type == MMI_PHB_ENTRY_FIELD_NAME || 
                PhoneBook[store_index].field & phb_list_view_type)
            {
                g_phb_cntx.list_filter[EntryCount] = store_index;
                EntryCount++;
            }
        }

        if (EntryCount)
        {
            g_phb_cntx.highlight_entry = 0;
            phbListView = MMI_PHB_LIST_FOR_OTHER_APP;
            mmi_phb_entry_list(
                EntryCount,                                 /* Total Entry */
                STR_SCR_PBOOK_VIEW_CAPTION,                 /* Title String */
                IMG_SCR_PBOOK_CAPTION,                      /* Title Image */
                STR_GLOBAL_OK,                              /* LSK */
                IMG_GLOBAL_OK,                              /* LSK */
                mmi_phb_get_index_by_store_location_second, /* Highlight Callback */
                mmi_phb_entry_choose_number,            /* LSK Callback */
                mmi_phb_entry_choose_number,            /* SEND Key Callback */
                mmi_phb_mms_email_list_get_item,            /* List Callback */
                mmi_phb_mms_email_list_get_hint,            /* Hint Callback */
                mmi_phb_list_entry_for_number_and_email, /* Re-Entry Callback */
                TRUE,                                       /* Alpha Index */
                TRUE);                                      /* Right Arrow Key */

        }
        else
        {
            DisplayPopup(
                (PU8) GetString(STR_ID_PHB_NO_ENTRY_TO_SELECT),
                IMG_GLOBAL_EMPTY,
                TRUE,
                PHB_NOTIFY_TIMEOUT,
                EMPTY_LIST_TONE);
            mmi_phb_list_free_filter();
        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_list_pre_entry_for_number_and_email
 * DESCRIPTION
 *  This function provide call back function before enter phonebook list
 * PARAMETERS
 *  filter_type        [IN]        filter type
 *  list_view_call_back    [IN]        call back function after user chooses an entry
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_list_pre_entry_for_number_and_email(U8 filter_type, mmi_phb_get_data_callback_type list_view_call_back)
{
    phb_list_view_type = filter_type;
    phb_list_view_call_back = list_view_call_back;
#ifdef __MMI_PHB_QUICK_SEARCH__
    if (IsScreenPresent(SCR_ID_PHB_GENERIC_QUICK_SEARCH_LIST))
    {
        DeleteScreenIfPresent(SCR_ID_PHB_GENERIC_QUICK_SEARCH_LIST);
    }
    mmi_phb_entry_generic_quick_search_list();
#else
    mmi_phb_list_entry_for_number_and_email();
#endif
}


/*------------------------------------------------------  Interface for MMS  ------------------------------------------------------*/
#define MMI_PHB_INTERFACE_FOR_MMS
#if defined(MMS_SUPPORT)
/*****************************************************************************
 * FUNCTION
 *  EntryPhbFromMMSNumber
 * DESCRIPTION
 *  Entry phonebook list from MMS, list entry with number field only
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EntryPhbFromMMSNumber(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_list_pre_entry_for_number_and_email(MMI_PHB_ENTRY_FIELD_ALL_NUMBER, mmi_phb_mms_send_data_to_mms);
}


/*****************************************************************************
 * FUNCTION
 *  EntryPhbFromMMSEmail
 * DESCRIPTION
 *  Entry phonebook list from MMS, list entry with email field only
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EntryPhbFromMMSEmail(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_list_pre_entry_for_number_and_email(MMI_PHB_ENTRY_FIELD_EMAIL, mmi_phb_mms_send_data_to_mms);
}


/*****************************************************************************
 * FUNCTION
 *  EntryPhbFromMMSAll
 * DESCRIPTION
 *  Entry phonebook list from MMS, list all entry
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EntryPhbFromMMSAll(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phbListView = MMI_PHB_LIST_FOR_MMS_ALL;
    mmi_phb_list_pre_entry_second_level();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_entry_mms_choose_number
 * DESCRIPTION
 *  Entry Choose entry screen if there are more then one entry with number field.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_entry_mms_choose_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U8 *guiBuffer;
    U16 numberTypeImageList[5];
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)    
    S16 pError;
#endif
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    store_index = g_phb_name_index[g_phb_cntx.active_index_second];

    mmi_ucs2cpy(pbName, (PS8) PhoneBook[store_index].alpha_id.name);
    mmi_phb_convert_get_ucs2_number(pbNumber, store_index); /* BCD number format. */

#ifndef __MMI_PHB_USIM_FIELD__
    if (store_index >= MAX_PB_PHONE_ENTRIES)   /* In SIM */
    {
        if (!mmi_ucs2strlen(pbNumber))
        {
            DisplayPopup(
                (PU8) GetString(STR_NO_NUMBER_TO_DIAL),
                IMG_GLOBAL_ERROR,
                FALSE,
                PHB_NOTIFY_TIMEOUT,
                ERROR_TONE);
        }
        else
        {
            g_phb_cntx.number_to_dial[0] = (U8*) pbNumber;
            g_phb_cntx.active_index_third = 0;
            mmi_phb_mms_pre_send_data_to_mms();
        }
    }
    else
#endif /* __MMI_PHB_USIM_FIELD__ */ 
    {
        i = 0;

        if (mmi_ucs2strlen(pbNumber))
        {
            g_phb_cntx.number_to_dial[i] = (U8*) pbNumber;
            numberTypeImageList[i++] = IMG_MOBILE_NUMBER;
        }
    #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    #ifdef __MMI_PHB_USIM_FIELD__
        if (store_index >= MAX_PB_PHONE_ENTRIES)
        {
            mmi_phb_op_set_option_data_by_usim_index((U16) store_index, &PhoneBookOptionalFields);
        }
        else
    #endif /* __MMI_PHB_USIM_FIELD__ */ 
        {
            ReadRecord(
                NVRAM_EF_PHB_FIELDS_LID,
                (U16) (store_index + 1),
                (void*)&PhoneBookOptionalFields,
                OPTIONAL_FIELDS_RECORD_SIZE,
                &pError);
        }
        /* All Number */
        mmi_asc_to_ucs2(pbHomeNumber, (PS8) PhoneBookOptionalFields.homeNumber);
        if (mmi_ucs2strlen(pbHomeNumber))
        {
            g_phb_cntx.number_to_dial[i] = (PU8) pbHomeNumber;
            numberTypeImageList[i++] = IMG_HOME_NUMBER;
        }
        mmi_asc_to_ucs2(pbOfficeNumber, (PS8) PhoneBookOptionalFields.officeNumber);
        if (mmi_ucs2strlen(pbOfficeNumber))
        {
            g_phb_cntx.number_to_dial[i] = (PU8) pbOfficeNumber;
            numberTypeImageList[i++] = IMG_OFFICE_NUMBER;
        }
        mmi_asc_to_ucs2(pbFaxNumber, (PS8) PhoneBookOptionalFields.faxNumber);
        if (mmi_ucs2strlen(pbFaxNumber))
        {
            g_phb_cntx.number_to_dial[i] = (PU8) pbFaxNumber;
            numberTypeImageList[i++] = IMG_FAX_NUMBER;
        }

        /* Email */
        mmi_asc_to_ucs2(pbEmailAddress, (PS8) PhoneBookOptionalFields.emailAddress);
        if (mmi_ucs2strlen(pbEmailAddress))
        {
            g_phb_cntx.number_to_dial[i] = (PU8) pbEmailAddress;
            numberTypeImageList[i++] = IMG_EMAIL_ADDRESS;
        }
    #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 

        if (!i)
        {
            DisplayPopup(
                (PU8) GetString(STR_NO_NUMBER_TO_DIAL),
                IMG_GLOBAL_ERROR,
                FALSE,
                PHB_NOTIFY_TIMEOUT,
                ERROR_TONE);
        }
        else if (i == 1)
        {
            g_phb_cntx.active_index_third = 0;
            mmi_phb_mms_pre_send_data_to_mms();
        }
        else
        {
            EntryNewScreen(
                SCR_ID_PHB_MMS_CHOOSE_ENTRY,
                mmi_phb_exit_mms_choose_number,
                mmi_phb_entry_mms_choose_number,
                NULL);
            guiBuffer = GetCurrGuiBuffer(SCR_ID_PHB_MMS_CHOOSE_ENTRY);
            RegisterHighlightHandler(mmi_phb_get_index_third_level);
            ShowCategory53Screen(
                STR_CHOOSE_NUMBER_CAPTION,
                IMG_SCR_PBOOK_CAPTION,
                STR_GLOBAL_OK,
                IMG_GLOBAL_OK,
                STR_GLOBAL_BACK,
                IMG_GLOBAL_BACK,
                i,
                g_phb_cntx.number_to_dial,
                numberTypeImageList,
                NULL,
                0,
                0,
                guiBuffer);

            SetLeftSoftkeyFunction(mmi_phb_mms_pre_send_data_to_mms, KEY_EVENT_UP);
            SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
        }
    }
}



/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_pre_send_data_to_mms
 * DESCRIPTION
 *  Send choosed number to MMS
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_mms_pre_send_data_to_mms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_phb_mms_send_data_to_mms(pbName, (S8*) g_phb_cntx.number_to_dial[g_phb_cntx.active_index_third]);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_send_data_to_mms
 * DESCRIPTION
 *  send entry name and choosed number to MMS by sending primitives
 * PARAMETERS
 *  name        [IN]        Name field to be sent
 *  number      [IN]        Number field to be sent.
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_mms_send_data_to_mms(S8 *name, S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<SendDataForMMS>\n", __FILE__, __LINE__);
    ClearInputEventHandler(MMI_DEVICE_ALL); /* Clear Key Handler to avoid resend message. */
#if defined(OBIGO_Q03C)
    widget_MMI_fullscreen_editor_update_from_phonebook((kal_uint8*) number);
#endif 
#if defined (JATAAYU_SUPPORT)
    if (phb_list_view_type == MMI_PHB_ENTRY_FIELD_ALL_NUMBER)
    {
        update_mms_number_from_phonebook(number);
    }
    else if (phb_list_view_type == MMI_PHB_ENTRY_FIELD_EMAIL)
    {
        update_mms_email_from_phonebook(number);
    }
#endif /* JATAAYU_SUPPORT */ 
}
#endif /* defined(MMS_SUPPORT) */


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_exit_mms_choose_number
 * DESCRIPTION
 *  exit function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_exit_mms_choose_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.end_scr_id = SCR_ID_PHB_MMS_CHOOSE_ENTRY;
}
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_email_list_get_item
 * DESCRIPTION
 *  dynamic list call back function
 * PARAMETERS
 *  item_index          [IN]        
 *  str_buff            [IN]        
 *  img_buff_p          [?]         
 *  str_img_mask        [IN]        
 * RETURNS
 *  
 *****************************************************************************/
pBOOL mmi_phb_mms_email_list_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    i = g_phb_cntx.list_filter[item_index];

    if (mmi_ucs2strlen((S8*) PhoneBook[i].alpha_id.name))
    {
        mmi_ucs2cpy((S8*) str_buff, (S8*) PhoneBook[i].alpha_id.name);
    }
    else
    {
        mmi_phb_convert_get_ucs2_number((S8*) str_buff, i);
    }

#ifdef __MMI_DUAL_SIM_MASTER__
    if(i >= (MAX_PB_PHONE_ENTRIES+MAX_PB_SIM_ENTRIES))
    {
        *img_buff_p = get_image(IMG_ID_CARD2_PHB_STORAGE_SIM);
    }
    else if (i >= MAX_PB_PHONE_ENTRIES)
    {
        *img_buff_p = get_image(IMG_ID_CARD1_PHB_STORAGE_SIM);
    }
    else
    {
        *img_buff_p = get_image(IMG_STORAGE_HANDSET);
    }
#else /* __MMI_DUAL_SIM_MASTER__ */
    if (i >= MAX_PB_PHONE_ENTRIES)
    {
        *img_buff_p = get_image(IMG_STORAGE_SIM);
    }
    else
    {
        *img_buff_p = get_image(IMG_STORAGE_HANDSET);
    }
#endif /* __MMI_DUAL_SIM_MASTER__ */

    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_mms_email_list_get_hint
 * DESCRIPTION
 *  
 * PARAMETERS
 *  item_index      [IN]        
 *  hint_array      [?]         
 * RETURNS
 *  
 *****************************************************************************/
S32 mmi_phb_mms_email_list_get_hint(S32 item_index, UI_string_type *hint_array)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index;
    S8 temp_number[(MAX_PB_NUMBER_LENGTH + 1 + 1) * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    store_index = g_phb_cntx.list_filter[item_index];

    mmi_phb_convert_get_ucs2_number((S8*) temp_number, store_index);

    if (mmi_ucs2strlen((S8*) PhoneBook[store_index].alpha_id.name) && mmi_ucs2strlen((S8*) temp_number))
    {
        mmi_ucs2cpy((S8*) hint_array[0], (S8*) temp_number);
    }
    else
    {
        return 0;   /* No Hint Data */
    }
    return 1;   /* One hint data only, can be more hints. */
}
/*--------------------------------------------------END Interface for MMS  ------------------------------------------------------*/


/*------------------------------------------------------  Interface for File Manager Image---------------------------------------------------*/
#define MMI_PHB_INTERFACE_FOR_FMGR
#if defined(__MMI_FILE_MANAGER__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_select_image_done
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_phb_fmgr_select_image_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Clear Previous PHB screen, and set phb new entry point here. */
    mmi_phb_clear_old_history();
    g_phb_cntx.start_scr_id = SCR_ID_PHB_FMGR_SAVE_OPTION;
    mmi_phb_entry_fmgr_save_option();
    DeleteScreenIfPresent(SCR_ID_PHB_IMAGE_VIEW_IMAGE);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_image_preview
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_phb_fmgr_image_preview(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_PHB_IMAGE_VIEW_IMAGE, NULL, mmi_phb_fmgr_image_preview, NULL);

    /* entry cat222 to decode and display a image from file */

    ShowCategory222Screen(
        STR_ASSOCIATE_PICTURE,
        IMG_SCR_PBOOK_CAPTION,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        GDI_COLOR_BLACK,
        (PS8) NULL,
        (PS8) g_phb_file_path,
        FALSE,
        mmi_phb_image_preview_callback,
        GDI_IMAGE_SRC_FROM_FILE);

    SetLeftSoftkeyFunction(mmi_phb_fmgr_select_image_done, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
}


#if defined(__MMI_INCOMING_CALL_VIDEO__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_select_video_done
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_phb_fmgr_select_video_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Clear Previous PHB screen, and set phb new entry point here. */
    mmi_phb_clear_old_history();
    g_phb_cntx.start_scr_id = SCR_ID_PHB_FMGR_SAVE_OPTION;
    mmi_phb_entry_fmgr_save_option();
    DeleteScreenIfPresent(SCR_ID_PHB_VIDEO_PREVIEW);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_video_preview
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static void mmi_phb_fmgr_video_preview(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    PU8 gui_buffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (isInCall()) /* Can not preview video during call. */
    {
#ifdef __MMI_SWFLASH__
		if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_SWFLASH)
		{
			DisplayPopup((U8*)GetString(STR_ID_PHB_CANT_VIEW_SWFLASH_IN_CALL), IMG_GLOBAL_WARNING, FALSE, PHB_NOTIFY_TIMEOUT, WARNING_TONE);
		}
		else
#endif /* __MMI_SWFLASH__ */
        {
        DisplayPopup(
            (U8*) GetString(STR_ID_PHB_CANT_VIEW_VIDEO_IN_CALL),
            IMG_GLOBAL_WARNING,
            FALSE,
            PHB_NOTIFY_TIMEOUT,
            WARNING_TONE);
        }
        return;
    }
    EntryNewScreen(SCR_ID_PHB_VIDEO_PREVIEW, NULL, mmi_phb_fmgr_video_preview, NULL);
    gui_buffer = GetCurrGuiBuffer(SCR_ID_PHB_VIDEO_PREVIEW);

#ifdef __MMI_SWFLASH__    
if(g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_SWFLASH)
{
    ShowCategory229Screen(
        (U8*)GetString(STR_ID_PHB_ASSOCIATE_VIDEO),                 /* title_str */
        IMG_SCR_PBOOK_CAPTION,              /* title_icon */
        STR_GLOBAL_OK,                      /* lsk_str */
        IMG_GLOBAL_OK,                      /* lsk_icon */
        STR_GLOBAL_BACK,                    /* rsk_str */
        IMG_GLOBAL_BACK,                    /* rsk_icon */
        0,                                  /* video_id */
        (S8*) g_phb_video_file_path,      /* video_filename */
        1,                                  /* repeat_count */
        (BOOL) ! IsSilentModeActivated(),   /* is_play_audio */
        TRUE,                               /* is_vibrate_on */
        FALSE,                               /* is_interaction_on */
        TRUE,                               /* is_lcd_no_sleep */
        0,  							    /* is_full_screen */
        GDI_COLOR_WHITE,                    /* bg_color */
        mmi_phb_video_view_callback,
        gui_buffer);

}
else
#endif /* __MMI_SWFLASH__ */    
    ShowCategory225Screen(
        STR_ID_PHB_ASSOCIATE_VIDEO,                    /* title_str */
        IMG_SCR_PBOOK_CAPTION,              /* title_icon */
        STR_GLOBAL_OK,                      /* lsk_str */
        IMG_GLOBAL_OK,                      /* lsk_icon */
        STR_GLOBAL_BACK,                    /* rsk_str */
        IMG_GLOBAL_BACK,                    /* rsk_icon */
        0,                                  /* video_id */
        (S8*) g_phb_video_file_path,      /* video_filename */
        1,                                  /* repeat_count */
        TRUE,                               /* is_visual_update */
        (BOOL) ! IsSilentModeActivated(),   /* is_play_audio */
        TRUE,                               /* is_lcd_no_sleep */
        GDI_COLOR_WHITE,                    /* bg_color */
        mmi_phb_video_view_callback,
        gui_buffer);

    SetLeftSoftkeyFunction(mmi_phb_fmgr_select_video_done, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
}
#endif /* __MMI_INCOMING_CALL_VIDEO__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_from_file_mgr
 * DESCRIPTION
 *  forward function for file manager application
 * PARAMETERS
 *  path        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_fmgr_from_file_mgr(S8 *path)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if defined(__MMI_INCOMING_CALL_VIDEO__)
    FMGR_FILTER file_type;
#endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
        return;
    }
#endif /* __SYNCML_SUPPORT__ */
    if (path == NULL)
    {
        DisplayPopup(
            (U8*) GetString(STR_ID_PHB_FMGR_IMAGE_NO_SELECT),
            IMG_GLOBAL_ERROR,
            FALSE,
            PHB_NOTIFY_TIMEOUT,
            ERROR_TONE);
        return;
    }

#if defined(__MMI_INCOMING_CALL_VIDEO__)
    /* check video file type */
    mmi_fmgr_get_file_type((PS8) path, &file_type);
    if ((FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_3GP)) || (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_MP4)) ||
        (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_AVI)) || (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_3G2)) ||
        (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_MPG)))
    {
        if (mmi_phb_video_check_data_space(path))
        {
            mmi_ucs2cpy(g_phb_video_file_path, path);
            g_phb_cntx.recv_res_from = MMI_PHB_RECV_RES_VIDEO;
            mmi_phb_fmgr_video_preview();
        }
    }
#if defined(__MMI_SWFLASH__)
    else if ((FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_CMP)) || (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_VIS)) ||
        (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_IVIS)) || (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_KVIS)) ||
        (FMGR_FILTER_IS_SET(&file_type, FMGR_TYPE_MVIS)))
    {
        if (mmi_phb_video_check_data_space(path))
        {
            mmi_ucs2cpy(g_phb_video_file_path, path);
            g_phb_cntx.recv_res_from = MMI_PHB_RECV_RES_SWFLASH;
            mmi_phb_fmgr_video_preview();
        }
    }
#endif /* defined(__MMI_SWFLASH__) */ 
    /* Check image content */
    else if (mmi_phb_image_check_valid_image(path))
#else /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 

    /* Check image content */
    if (mmi_phb_image_check_valid_image(path))
#endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 
    {
        mmi_ucs2cpy(g_phb_file_path, path);
        /* Clear Previous PHB screen, and set phb new entry point here. */
        mmi_phb_clear_old_history();
        g_phb_cntx.start_scr_id = SCR_ID_PHB_FMGR_SAVE_OPTION;
        g_phb_cntx.recv_res_from = MMI_PHB_RECV_RES_IMAGE;
        mmi_phb_fmgr_image_preview();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_highlight_fmgr_add_entry
 * DESCRIPTION
 *  Highlight function to associate image from file manager to a new phonebook entry
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_highlight_fmgr_add_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetLeftSoftkeyFunction(mmi_phb_fmgr_pre_add_entry, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    SetKeyHandler(mmi_phb_fmgr_pre_add_entry, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_highlight_fmgr_edit_entry
 * DESCRIPTION
 *  Highlight function for associate image to a existing phonebook entry
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_highlight_fmgr_edit_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetLeftSoftkeyFunction(mmi_phb_list_pre_entry_for_fmgr_in_nvram, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    SetKeyHandler(mmi_phb_list_pre_entry_for_fmgr_in_nvram, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);

    phbListView = MMI_PHB_LIST_FOR_SAVE_FROM_FILE_MGR;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_highlight_edit_callergroup
 * DESCRIPTION
 *  Highlight function for associate image to a existing phonebook caller group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_highlight_edit_callergroup(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetLeftSoftkeyFunction(mmi_phb_entry_callergroup, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    SetKeyHandler(mmi_phb_entry_callergroup, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);

    phbListView = MMI_PHB_LIST_FOR_SAVE_FROM_FILE_MGR;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_entry_fmgr_save_option
 * DESCRIPTION
 *  Entry function for save image from file manager option menu
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_entry_fmgr_save_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    U16 nStrItemList[3];
    U16 nNumofItem;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_PHB_FMGR_SAVE_OPTION, mmi_phb_exit_fmgr_save_option, mmi_phb_entry_fmgr_save_option, NULL);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_PHB_FMGR_SAVE_OPTION);
    nNumofItem = GetNumOfChild(MENU_ID_PHB_FMGR_SAVE_OPTION);
    GetSequenceStringIds(MENU_ID_PHB_FMGR_SAVE_OPTION, nStrItemList);
    SetParentHandler(MENU_ID_PHB_FMGR_SAVE_OPTION);
    RegisterHighlightHandler(ExecuteCurrHiliteHandler);
    ShowCategory15Screen(
        STR_SCR_VIEW_OPTIONS_CAPTION,
        IMG_SCR_PBOOK_CAPTION,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        nNumofItem,
        nStrItemList,
        (U16*) gIndexIconsImageList,
        LIST_MENU,
        0,
        guiBuffer);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_exit_fmgr_save_option
 * DESCRIPTION
 *  Exit function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_exit_fmgr_save_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.end_scr_id = SCR_ID_PHB_FMGR_SAVE_OPTION;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_pre_add_entry
 * DESCRIPTION
 *  pre check for associate image from file manager to a new phonebook entry
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_fmgr_pre_add_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        if (g_phb_cntx.phone_used >= g_phb_cntx.phone_total)    /* No spcace in NVRAM */
        {
            DisplayPopup((PU8) GetString(STR_PBOOK_FULL_MSG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
        }
        else
        {
            mmi_phb_util_clear_buffer(TRUE);

            if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_IMAGE)
            {
                mmi_phb_build_image_list();
                g_phb_cntx.selected_pic_index = g_phb_cntx.total_image_id - 1;
                g_phb_cntx.image_location = MMI_PHB_IMAGE_SELECT_PATH;
            }
        #if defined(__MMI_AVATAR__)
            else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AVATAR_IMAGE)
            {
                mmi_phb_build_image_list();
                g_phb_cntx.selected_pic_index = g_phb_cntx.total_image_id - 2;
                g_phb_cntx.image_location = MMI_PHB_AVATAR_SELECT_PATH;
            }
        #endif /* defined(__MMI_AVATAR__) */			
            else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AUDIO)
            {
                mmi_phb_build_ring_tone_list();
                g_phb_cntx.selected_ring_index = mmi_phb_get_ring_tone_index(g_phb_cntx.recv_res_id);
            }
        #if defined(__MMI_INCOMING_CALL_VIDEO__)
            else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_VIDEO)
            {
                mmi_phb_build_video_list();
                g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - 1;
                g_phb_cntx.video_location = MMI_PHB_IMAGE_SELECT_PATH;
            }
        #ifdef __MMI_AVATAR__
            else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AVATAR_VIDEO)
            {
                mmi_phb_build_video_list();
                g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - g_phb_avatar_video_minus;
                g_phb_cntx.video_location = MMI_PHB_AVATAR_SELECT_PATH;
            }
        #endif /* __MMI_AVATAR__ */ 
        #ifdef __MMI_SWFLASH__
            else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_SWFLASH)
            {
                mmi_phb_build_video_list();
                g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - g_phb_swflash_video_minus;
                g_phb_cntx.video_location = MMI_PHB_SWFLASH_SELECT_PATH;
            }
        #endif /* __MMI_SWFLASH__ */ 
        #endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 

            g_phb_cntx.set_done_flag = 2;
            g_phb_cntx.selected_storage = MMI_NVRAM;
            mmi_phb_entry_op_add_entry();
        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_pre_edit_entry
 * DESCRIPTION
 *  pre check for associate image to a existing phonebook entry
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_fmgr_pre_edit_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    S16 pError;
#endif
    U16 i, store_index;
    PHB_OPTIONAL_IDS_STRUCT *opt_ids;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    store_index = g_phb_cntx.active_index;

    if (store_index >= MAX_PB_PHONE_ENTRIES)    /* ERROR!, Record in NVRAM only */
    {
        /* Print Error Log Here. */
        GoBackHistory();
        return;
    }

    /* set active index for edit entry */
    for (i = 0; i < PhoneBookEntryCount; i++)
    {
        if (g_phb_name_index[i] == store_index)
        {
            g_phb_cntx.active_index = i;
            break;
        }
    }

    /* Clear All Buffer First. */
    mmi_phb_util_clear_buffer(TRUE);

    /* Assign value for each field for update */
    mmi_ucs2cpy(pbName, (S8*) PhoneBook[store_index].alpha_id.name);
    mmi_phb_convert_get_ucs2_number(pbNumber, store_index);

#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    ReadRecord(
        NVRAM_EF_PHB_FIELDS_LID,
        (U16) (store_index + 1),
        (void*)&PhoneBookOptionalFields,
        OPTIONAL_FIELDS_RECORD_SIZE,
        &pError);

    mmi_asc_to_ucs2(pbHomeNumber, (PS8) PhoneBookOptionalFields.homeNumber);
    mmi_ucs2cpy(pbCompanyName, (PS8) PhoneBookOptionalFields.companyName);
    mmi_asc_to_ucs2(pbEmailAddress, (PS8) PhoneBookOptionalFields.emailAddress);
    mmi_asc_to_ucs2(pbOfficeNumber, (PS8) PhoneBookOptionalFields.officeNumber);
    mmi_asc_to_ucs2(pbFaxNumber, (PS8) PhoneBookOptionalFields.faxNumber);
#endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 

#if defined(__MMI_PHB_BIRTHDAY_FIELD__)
    mmi_phb_bday_read_data_to_buff(store_index);
#endif 

    mmi_phb_build_image_list();
    mmi_phb_build_ring_tone_list();

    mmi_phb_read_optional_ids(store_index);
    opt_ids = (PHB_OPTIONAL_IDS_STRUCT*) g_phb_cntx.optional_ids;

    /* Image setting */
    if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_IMAGE)
    {
        g_phb_cntx.selected_pic_index = g_phb_cntx.total_image_id - 1;
        g_phb_cntx.image_location = MMI_PHB_IMAGE_SELECT_PATH;
        g_phb_image_type_id = 1;
    }
#if defined(__MMI_AVATAR__)
    else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AVATAR_IMAGE)
    {
        g_phb_cntx.selected_pic_index = g_phb_cntx.total_image_id - 2;
        g_phb_cntx.image_location = MMI_PHB_AVATAR_SELECT_PATH;
        g_phb_image_type_id = 2;
    }
#endif /* defined(__MMI_AVATAR__) */	
    else    /* Keep original image */
    {
        g_phb_cntx.selected_pic_index = mmi_phb_get_image_index(opt_ids->pictureTagID);
        if (opt_ids->pictureTagID == 1
        #ifdef __MMI_AVATAR__
            || opt_ids->pictureTagID == 2
        #endif
            )
        {
            g_phb_cntx.image_location = MMI_PHB_IMAGE_FOR_ENTRY;
            g_phb_image_type_id = opt_ids->pictureTagID;
        }
        else
        {
            g_phb_cntx.image_location = MMI_PHB_IMAGE_NO_SELECT;
        }
    }

    /* Audio Setting */
    if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AUDIO)
    {
        g_phb_cntx.selected_ring_index = mmi_phb_get_ring_tone_index(g_phb_cntx.recv_res_id);
    }
    else    /* Keep original audio */
    {
        g_phb_cntx.selected_ring_index = mmi_phb_get_ring_tone_index(opt_ids->ringToneID);
    }

    /* Video Setting */
#if defined(__MMI_INCOMING_CALL_VIDEO__)
    mmi_phb_build_video_list();
    if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_VIDEO)
    {
        g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - 1;
        g_phb_cntx.video_location = MMI_PHB_IMAGE_SELECT_PATH;
        g_phb_cntx.video_audio = 1; /* Turn on video's audio by default */
    }
#ifdef __MMI_AVATAR__
    else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AVATAR_VIDEO)
    {
        g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - g_phb_avatar_video_minus;
        g_phb_cntx.video_location = MMI_PHB_AVATAR_SELECT_PATH;
        g_phb_cntx.video_audio = 1; /* Turn on video's audio by default */
    }
#endif /* __MMI_AVATAR__ */ 
#ifdef __MMI_SWFLASH__
    else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_SWFLASH)
    {
        g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - g_phb_swflash_video_minus;
        g_phb_cntx.video_location = MMI_PHB_SWFLASH_SELECT_PATH;
        g_phb_cntx.video_audio = 1; /* Turn on video's audio by default */
    }
#endif /* __MMI_SWFLASH__ */ 
    else    /* Keep original video */
    {
        U16 video_id = mmi_phb_video_get_id_by_index(store_index);
        g_phb_cntx.selected_video_index = mmi_phb_get_video_index(video_id);

        g_phb_cntx.video_audio = ((video_id == 0) || (video_id & 0x4000)) ? 1 : 0;

        if ((video_id & 0x8000) && mmi_phb_video_get_path_by_index(video_id))   /* Check if the video is a file */
        {
        #ifdef __MMI_AVATAR__
            if(video_id & 0x1000)
            {
                g_phb_cntx.video_location = MMI_PHB_AVATAR_SELECT_PATH;
            }
            else
        #endif /* __MMI_AVATAR__ */
        #ifdef __MMI_SWFLASH__
            if(video_id & 0x2000)
            {
                g_phb_cntx.video_location = MMI_PHB_SWFLASH_SELECT_PATH;
            }
            else
        #endif /* __MMI_SWFLASH__ */
            {
                g_phb_cntx.video_location = MMI_PHB_IMAGE_SELECT_PATH;
            }
        }
        else
        {
            g_phb_cntx.video_location = MMI_PHB_IMAGE_NO_SELECT;
        }
    }
#endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 

    /* Caller Group Setting, keep original caller group */
    g_phb_cntx.selected_grp_index = opt_ids->callerGroupID;

    mmi_phb_entry_op_edit_save_confirm();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_fmgr_pre_edit_callergrp
 * DESCRIPTION
 *  pre check for associate image to a existing phonebook caller group
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_fmgr_pre_edit_callergrp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    PHB_CALLER_GROUP_STRUCT *callerGroups;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    callerGroups = (PHB_CALLER_GROUP_STRUCT*) g_phb_cntx.caller_group;
    mmi_ucs2cpy(pbName, (PS8) callerGroups[g_phb_cntx.active_index].groupName);

    mmi_phb_build_led_and_alert_list();
    mmi_phb_build_ring_tone_list();
    mmi_phb_build_image_list();

    /* Image Setting */
    if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_IMAGE)
    {
        g_phb_cntx.selected_pic_index = g_phb_cntx.total_image_id - 1;
        g_phb_cntx.image_location = MMI_PHB_IMAGE_SELECT_PATH;
        g_phb_image_type_id = 1;
    }
#if defined(__MMI_AVATAR__)
    else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AVATAR_IMAGE)
    {
        g_phb_cntx.selected_pic_index = g_phb_cntx.total_image_id - 2;
        g_phb_cntx.image_location = MMI_PHB_AVATAR_SELECT_PATH;
        g_phb_image_type_id = 2;
    }
#endif /* defined(__MMI_AVATAR__) */	
    else    /* Keep original image */
    {
        g_phb_cntx.selected_pic_index = mmi_phb_get_image_index(callerGroups[g_phb_cntx.active_index].pictureTagID);
        if (callerGroups[g_phb_cntx.active_index].pictureTagID == 1
        #ifdef __MMI_AVATAR__
            || callerGroups[g_phb_cntx.active_index].pictureTagID == 2
        #endif /* def __MMI_AVATAR__ */
			)
        {
            g_phb_cntx.image_location = MMI_PHB_IMAGE_FOR_ENTRY;
            g_phb_image_type_id = callerGroups[g_phb_cntx.active_index].pictureTagID;
        }
        else
        {
            g_phb_cntx.image_location = MMI_PHB_IMAGE_NO_SELECT;
        }
    }

    /* Audio Setting */
    if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AUDIO)
    {
        g_phb_cntx.selected_ring_index = mmi_phb_get_ring_tone_index(g_phb_cntx.recv_res_id);
    }
    else    /* Keep original audio */
    {
        g_phb_cntx.selected_ring_index = mmi_phb_get_ring_tone_index(callerGroups[g_phb_cntx.active_index].ringToneID);
    }

    /* Video Setting */
#if defined(__MMI_INCOMING_CALL_VIDEO__)
    mmi_phb_build_video_list();
    if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_VIDEO)
    {
        g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - 1;
        g_phb_cntx.video_location = MMI_PHB_IMAGE_SELECT_PATH;
        g_phb_cntx.video_audio = 1; /* Turn on video's audio by default */
    }
#ifdef __MMI_AVATAR__
    else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_AVATAR_VIDEO)
    {
        g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - g_phb_avatar_video_minus;
        g_phb_cntx.video_location = MMI_PHB_AVATAR_SELECT_PATH;
        g_phb_cntx.video_audio = 1; /* Turn on video's audio by default */
    }
#endif /* __MMI_AVATAR__ */ 
#ifdef __MMI_SWFLASH__
    else if (g_phb_cntx.recv_res_from == MMI_PHB_RECV_RES_SWFLASH)
    {
        g_phb_cntx.selected_video_index = g_phb_cntx.total_video_id - g_phb_swflash_video_minus;
        g_phb_cntx.video_location = MMI_PHB_SWFLASH_SELECT_PATH;
        g_phb_cntx.video_audio = 1; /* Turn on video's audio by default */
    }
#endif /* __MMI_SWFLASH__ */ 
    else    /* Keep original video */
    {
        U16 video_id = callerGroups[g_phb_cntx.active_index].VideoID;

        g_phb_cntx.selected_video_index = mmi_phb_get_video_index(video_id);

        g_phb_cntx.video_audio = ((video_id == 0) || (video_id & 0x4000)) ? 1 : 0;

        if ((video_id & 0x8000) &&
            mmi_phb_video_get_path_by_index(video_id))
        {
        #ifdef __MMI_AVATAR__
            if(video_id & 0x1000)
            {
                g_phb_cntx.video_location = MMI_PHB_AVATAR_SELECT_PATH;
            }
            else
        #endif /* __MMI_AVATAR__ */
        #ifdef __MMI_SWFLASH__
            if(video_id & 0x2000)
            {
                g_phb_cntx.video_location = MMI_PHB_SWFLASH_SELECT_PATH;
            }
            else
        #endif /* __MMI_SWFLASH__ */
            {
			    g_phb_cntx.video_location = MMI_PHB_IMAGE_SELECT_PATH;
            }
        }
        else
        {
            g_phb_cntx.video_location = MMI_PHB_IMAGE_NO_SELECT;
        }
    }
#endif /* defined(__MMI_INCOMING_CALL_VIDEO__) */ 

    /* Keep other settings */
    g_phb_cntx.selected_alert_index = callerGroups[g_phb_cntx.active_index].alertType;
    g_phb_cntx.selected_pattern_index = callerGroups[g_phb_cntx.active_index].LEDPatternId;

    mmi_phb_callergroup_detail_pre_save();
}
/*------------------------------------------------------  END Interface for File Manager Image------------------------------------------------*/
#endif /* defined(__MMI_FILE_MANAGER__) */ 


#define MMI_PHB_INTERFACE_FOR_EMAIL
#if defined(__MMI_EMAIL__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_email_enter_list
 * DESCRIPTION
 *  Phonebook list interface for email application.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_email_enter_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    phbListView = MMI_PHB_LIST_FOR_EMAIL_APP;
    mmi_phb_list_pre_entry_second_level();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_email_choose_entry
 * DESCRIPTION
 *  choose entry result, send result back to email app.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_email_choose_entry(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 pError;
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    store_index = g_phb_cntx.active_index_second;

    /* Clear buffer */
    memset(pbEmailAddress, 0, 2);

#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    if (store_index < MAX_PB_PHONE_ENTRIES) /* in NVRAM */
    {
        ReadRecord(
            NVRAM_EF_PHB_FIELDS_LID,
            (U16) (store_index + 1),
            (void*)&PhoneBookOptionalFields,
            OPTIONAL_FIELDS_RECORD_SIZE,
            &pError);
        mmi_asc_to_ucs2(pbEmailAddress, (S8*) PhoneBookOptionalFields.emailAddress);
    }
#endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 
#ifdef __MMI_PHB_USIM_FIELD__
    if (store_index >= MAX_PB_PHONE_ENTRIES)    /* in USIM */
    {
        mmi_asc_to_ucs2((S8*) pbEmailAddress, (S8*) phb_email[store_index - MAX_PB_PHONE_ENTRIES].email_address);
    }
#endif /* __MMI_PHB_USIM_FIELD__ */ 

    /* Send back to email app. */
    mmi_email_phb_get_addr_callback((S8*) PhoneBook[store_index].alpha_id.name, (S8*) pbEmailAddress);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_email_save_entry_to_phb
 * DESCRIPTION
 *  save name and email to phonebook as a new entry
 * PARAMETERS
 *  ucs2_name       [IN]         Input email string pointer
 *  ucs2_email      [IN]         Input name string pointer
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_email_save_entry_to_phb(S8 *ucs2_name, S8 *ucs2_email)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<mmi_phb_email_save_entry_to_phb.>\n", __FILE__,
                         __LINE__);

#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif /* __MMI_DUAL_SIM_MASTER__ */
    {
        if (g_phb_cntx.phone_total == g_phb_cntx.phone_used)
        {
            DisplayPopup((PU8) GetString(STR_PHONE_FULL_MSG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
        }
        else
        {
            g_phb_cntx.selected_storage = MMI_NVRAM;

            /* Clear other field */
            mmi_phb_util_clear_buffer(TRUE);

            /* Bring in data and enter save entry screen. */
            g_phb_cntx.set_done_flag = 1;
            if (ucs2_name)
            {
                mmi_ucs2ncpy(pbName, ucs2_name, MAX_PB_NAME_LENGTH);        	
                mmi_phb_truncate_pbname_buffer(MMI_NVRAM);
            }
        #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)            
            if (mmi_ucs2strlen(ucs2_email) < MAX_PB_EMAIL_LENGTH)
            {
                mmi_ucs2ncpy(pbEmailAddress, ucs2_email, mmi_ucs2strlen(ucs2_email));
            }
            else
            {
                mmi_ucs2ncpy(pbEmailAddress, ucs2_email, MAX_PB_EMAIL_LENGTH);            	
            }
        #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */            
            mmi_phb_clear_old_history();
            mmi_phb_entry_op_add_entry();
        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
}
#endif /* defined(__MMI_EMAIL__) */ 


#if defined(MMS_SUPPORT)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_entry_dummy_screen
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_entry_dummy_screen(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_email_save_entry_to_phb_from_jmms
 * DESCRIPTION
 *  save the email entry from JMMS
 * PARAMETERS
 *  ucs2_email      [IN]         Input email string pointer
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_email_save_entry_to_phb_from_jmms(S8 *ucs2_email)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<mmi_phb_email_save_entry_to_phb.>\n", __FILE__,
                         __LINE__);

#ifdef __MMI_DUAL_SIM_MASTER__
     if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }
#ifdef __MMI_PHB_USIM_FIELD__
    else if (g_phb_cntx.is_usim && g_phb_cntx.usim_ready_stage != MMI_PHB_USIM_READY)
    {
        mmi_phb_entry_not_ready(STR_ID_PHB_PROCESSING_USIM);
    }
#endif /* __MMI_PHB_USIM_FIELD__ */
#ifdef __SYNCML_SUPPORT__
    else if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
#endif /* __SYNCML_SUPPORT__ */
    else
    {
    #ifdef __MMI_DUAL_SIM_MASTER__
        if (PhoneBookEntryCount == g_phb_cntx.sim_total + g_phb_cntx.phone_total+MTPNP_AD_ADN_SIM2GetCapacity())
    #else /* __MMI_DUAL_SIM_MASTER__ */
        if (PhoneBookEntryCount == g_phb_cntx.sim_total + g_phb_cntx.phone_total)
    #endif /* __MMI_DUAL_SIM_MASTER__ */
        {
            DisplayPopup((PU8) GetString(STR_PBOOK_FULL_MSG), IMG_GLOBAL_ERROR, FALSE, PHB_NOTIFY_TIMEOUT, ERROR_TONE);
        }
        else
        {
            /* Ensure the length will not exceed phonebook buffer. */
            if(mmi_ucs2strlen((S8*)ucs2_email) > MAX_PB_EMAIL_LENGTH)
            {
                memset((ucs2_email + MAX_PB_EMAIL_LENGTH * ENCODING_LENGTH), 0, 2);
            }

            /* Clear other field */
            mmi_phb_util_clear_buffer(TRUE);

            /* Bring in data and enter save entry screen. */
            g_phb_cntx.set_done_flag = 1;
        #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)            
            mmi_ucs2cpy(pbEmailAddress, ucs2_email);
        #endif            

            mmi_phb_clear_old_history();

            /* adding here */
            g_phb_cntx.selected_storage = MMI_NVRAM;

            if (g_phb_cntx.phone_used >= g_phb_cntx.phone_total)
            {
                DisplayPopup(
                    (PU8) GetString(STR_PBOOK_FULL_MSG),
                    IMG_GLOBAL_ERROR,
                    FALSE,
                    PHB_NOTIFY_TIMEOUT,
                    ERROR_TONE);
            }
            else
            {

                EntryNewScreen(SCR_STORAGE_LOCATION_MENU, NULL, mmi_phb_entry_dummy_screen, NULL);
                mmi_phb_entry_op_add_entry();
            }
        }
    }
}
#endif /* defined(MMS_SUPPORT) */ 


#define MMI_PHB_INTERFACE_FOR_VRSD_DIAL
#if defined(__MMI_VRSD_DIAL__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsddial_enter_tag_list
 * DESCRIPTION
 *  Phonebook list interface for voice dial application.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsddial_enter_tag_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i, j;
    U16 EntryCount = 0;
    U16 store_index;
    vrsd_tag_struct tag_list[MMI_VRSD_MAX_TAG];
    S16 pError;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        /* Allocate buffer for phonebook memeber list filter */
        mmi_phb_list_allocate_filter();

        /* Read voice tag list from NVRAM */
        ReadRecord(
            NVRAM_EF_VRSD_TAG_LID,
            MMI_VRSD_GROUP_ALL,
            (void*)tag_list,
            MMI_VRSD_MAX_TAG * sizeof(vrsd_tag_struct),
            &pError);

        /* Find out entry with tag and put it into filter list */
        for (i = 0; i < PhoneBookEntryCount; i++)
        {
            store_index = g_phb_name_index[i];

            for (j = 0; j < MMI_VRSD_MAX_TAG; j++)
            {
                if ((tag_list[j].appref_id < 0xffff) && (tag_list[j].app_id == MMI_VRSD_APP_DIAL) &&
                    (tag_list[j].appref_id == store_index))
                {
                    g_phb_cntx.list_filter[EntryCount] = store_index;
                    EntryCount++;
                    break;
                }
            }
        }

        /* If voice tag exists, enter phonebook list */
        if (EntryCount)
        {
            g_phb_cntx.highlight_entry = 0;
            phbListView = MMI_PHB_LIST_FOR_VR;
            mmi_phb_entry_list(
                EntryCount,                             /* Total Entry */
                STR_ID_VRSD_DIAL,                       /* Title String */
                IMG_ID_VRSD_APP,                        /* Title Image */
                STR_GLOBAL_OPTIONS,                     /* LSK */
                IMG_GLOBAL_OPTIONS,                     /* LSK */
                mmi_phb_vrsddial_get_tag_list_index,    /* Highlight Callback */
                mmi_vrsddial_main_menu_all_option,      /* LSK Callback */
                NULL,                                   /* SEND Key Callback */
                mmi_phb_filter_list_get_item,           /* List Callback */
                mmi_phb_filter_list_get_hint,           /* Hint Callback */
                mmi_phb_vrsddial_enter_tag_list,        /* Re-Entry Callback */
                FALSE,                                  /* Alpha Index */
                TRUE);                                  /* Right Arrow Key */

        }
        else    /* No voice Tag exists, Go to menu directly. */
        {
            mmi_vrsddial_entry_empty_list();
            mmi_phb_list_free_filter();
        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsddial_get_tag_list_index
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  nIndex      [IN]            
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsddial_get_tag_list_index(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.active_index = g_phb_cntx.list_filter[nIndex];   /* This is store_index in filter list */

    StopTimer(VRSD_DIAL_PLAYBACK_TIMER);
    StartTimer(VRSD_DIAL_PLAYBACK_TIMER, MMI_VRSD_PLAY_TAG_DELAY, mmi_phb_vrsddial_playback_by_store_index);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsddial_playback_by_store_index
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsddial_playback_by_store_index(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 tag_id;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    tag_id = mmi_vrsd_util_get_tag_id(MMI_VRSD_APP_DIAL, g_phb_cntx.active_index);
    mmi_vrsd_playback_req(tag_id, NULL);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsddial_enter_no_tag_list
 * DESCRIPTION
 *  Phonebook list interface for voice dial application.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsddial_enter_no_tag_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i, j;
    U16 EntryCount = 0;
    U16 store_index;
    vrsd_tag_struct tag_list[MMI_VRSD_MAX_TAG];
    S16 pError;
    BOOL has_tag;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        mmi_phb_entry_not_ready(STR_ID_SYNC_PLEASE_WAIT);
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_TRUE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (g_phb_cntx.phb_ready && !g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        /* Allocate buffer for phonebook memeber list filter */
        mmi_phb_list_allocate_filter();

        /* Read voice tag list from NVRAM */
        ReadRecord(
            NVRAM_EF_VRSD_TAG_LID,
            MMI_VRSD_GROUP_ALL,
            (void*)tag_list,
            MMI_VRSD_MAX_TAG * sizeof(vrsd_tag_struct),
            &pError);

        /* Find out entry without voice tag and put it into filter list */
        for (i = 0; i < PhoneBookEntryCount; i++)
        {
            store_index = g_phb_name_index[i];

            has_tag = FALSE;
            for (j = 0; j < MMI_VRSD_MAX_TAG; j++)
            {
                if ((tag_list[j].app_id == MMI_VRSD_APP_DIAL) && (tag_list[j].appref_id == store_index))
                {
                    has_tag = TRUE;
                    break;
                }
            }

            /* Add to list if the entry has no tag. */
            if (!has_tag)
            {
                g_phb_cntx.list_filter[EntryCount] = store_index;
                EntryCount++;
            }
        }

        /* If voice tag exists, enter phonebook list */
        if (EntryCount)
        {
            g_phb_cntx.highlight_entry = 0;
            phbListView = MMI_PHB_LIST_FOR_VR;
            mmi_phb_entry_list(
                EntryCount,                                 /* Total Entry */
                STR_ID_VRSD_DIAL,                           /* Title String */
                IMG_ID_VRSD_APP,                            /* Title Image */
                STR_GLOBAL_OK,                              /* LSK */
                IMG_GLOBAL_OK,                              /* LSK */
                mmi_phb_get_index_by_store_location_second, /* Highlight Callback */
                mmi_vrsddial_add_tag_from_list,             /* LSK Callback */
                NULL,                                       /* SEND Key Callback */
                mmi_phb_filter_list_get_item,               /* List Callback */
                mmi_phb_filter_list_get_hint,               /* Hint Callback */
                mmi_phb_vrsddial_enter_no_tag_list,         /* Re-Entry Callback */
                FALSE,                                      /* Alpha Index */
                TRUE);                                      /* Right Arrow Key */

        }
        else    /* All Entries has voice tag. */
        {
            DisplayPopup(
                (PU8) GetString(STR_ID_PHB_NO_ENTRY_TO_SELECT),
                IMG_GLOBAL_EMPTY,
                TRUE,
                PHB_NOTIFY_TIMEOUT,
                EMPTY_LIST_TONE);
            mmi_phb_list_free_filter();

        }
    }
    else
    {
        mmi_phb_entry_not_ready(STR_PROCESSING_PHONEBOOK);
    }

}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_highlight_op_voice_dial
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  void
 * RETURNS
 *  viod
 *****************************************************************************/
void mmi_phb_highlight_op_voice_dial(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetLeftSoftkeyFunction(mmi_vrsddial_phb_main_menu_pre_entry, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);

    SetKeyHandler(mmi_vrsddial_phb_main_menu_pre_entry, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsddial_auto_dial
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  store_index     [IN]            
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsddial_auto_dial(U16 store_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.active_index = 0;

    for (i = 0; i < PhoneBookEntryCount; i++)
    {
        if (g_phb_name_index[i] == store_index)
        {
            g_phb_cntx.active_index = i;
            break;
        }
    }

    mmi_phb_choose_number_normal();
}

#endif /* defined(__MMI_VRSD_DIAL__) */ 


#define MMI_PHB_INTERFACE_FOR_VRSI
#if defined(__MMI_VRSI__) && defined(__MMI_VRSI_TRAIN_TAG__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsi_list_get_item
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
pBOOL mmi_phb_vrsi_list_get_item(S32 item_index, UI_string_type str_buff, PU8 *img_buff_p, U8 str_img_mask)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((item_index < 0) || (item_index >= PhoneBookEntryCount))
    {
        return FALSE;
    }

    store_index = g_phb_name_index[item_index];

    if (mmi_ucs2strlen((S8*) PhoneBook[store_index].alpha_id.name))
    {
        mmi_ucs2cpy((S8*) str_buff, (S8*) PhoneBook[store_index].alpha_id.name);
    }
    else
    {
        mmi_phb_convert_get_ucs2_number((S8*) str_buff, store_index);
    }

    /* Check if phonebook item has VRSD tag */
    if (mmi_vrsi_train_util_get_loc_in_list(MMI_VRSI_APP_DIAL, store_index, g_phb_vrsi_tag_list) != 0xff)
    {
        *img_buff_p = get_image(IMG_ID_VRSI_APP);
    }
    else
    {
    #ifdef __MMI_DUAL_SIM_MASTER__
    	if(store_index >= (MAX_PB_PHONE_ENTRIES+MAX_PB_SIM_ENTRIES))
    	{
            *img_buff_p = get_image(IMG_ID_CARD2_PHB_STORAGE_SIM);
    	}
    	else if (store_index >= MAX_PB_PHONE_ENTRIES)
    	{
       	 *img_buff_p = get_image(IMG_ID_CARD1_PHB_STORAGE_SIM);
    	}
    	else
    	{
       	 *img_buff_p = get_image(IMG_STORAGE_HANDSET);
    	}
    #else /* __MMI_DUAL_SIM_MASTER__ */
        if (store_index >= MAX_PB_PHONE_ENTRIES)
        {
            *img_buff_p = get_image(IMG_STORAGE_SIM);
        }
        else
        {
            *img_buff_p = get_image(IMG_STORAGE_HANDSET);
        }
    #endif /* __MMI_DUAL_SIM_MASTER__ */
    }

    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsi_pre_entry_list
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsi_pre_entry_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 pError;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_phb_cntx.highlight_entry = 0;
    phbListView = MMI_PHB_LIST_FOR_VR;

    /* Allocate memory for list to temporarily store vrsi tag list */
    g_phb_vrsi_tag_list = OslMalloc(MMI_VRSI_MAX_SD_TAG * sizeof(vrsi_sd_tag_struct));
    ReadRecord(NVRAM_EF_VRSI_TAG_LID, 1, (void*)g_phb_vrsi_tag_list, MMI_VRSI_MAX_SD_TAG * sizeof(vrsi_sd_tag_struct), &pError);

    mmi_phb_entry_list(
        PhoneBookEntryCount,                /* Total Entry */
        STR_ID_VRSI_NAME_LIST,              /* Title String */
        MAIN_MENU_TITLE_MULTIMEDIA_ICON,    /* Title Image */
        STR_GLOBAL_OPTIONS,                 /* LSK */
        IMG_GLOBAL_OPTIONS,                 /* LSK */
        mmi_phb_get_index_second_level,     /* Highlight Callback */
        mmi_phb_vrsi_entry_list_callback,   /* LSK Callback */
        NULL,                               /* SEND Key Callback */
        mmi_phb_vrsi_list_get_item,         /* List Callback */
        mmi_phb_list_get_hint,              /* Hint Callback */
        mmi_phb_vrsi_pre_entry_list,        /* Re-Entry Callback */
        TRUE,                               /* Alpha Index */
        TRUE);                              /* Right Arrow Key */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsi_exit_entry_list
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsi_exit_entry_list(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if(g_phb_vrsi_tag_list)
    {
        OslMfree(g_phb_vrsi_tag_list);
        g_phb_vrsi_tag_list = NULL;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_vrsi_entry_list_callback
 * DESCRIPTION
 *  This function is just for template.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_vrsi_entry_list_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 store_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    store_index = g_phb_name_index[g_phb_cntx.active_index_second];
    mmi_vrsi_ndial_train_list_callback(store_index);
}
#endif /* defined(__MMI_VRSI__) && defined(__MMI_VRSI_TRAIN_TAG__) */ 


#ifdef __SYNCML_SUPPORT__
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_phone_index_arrary
 * DESCRIPTION
 *  
 * PARAMETERS
 *  index_array       [OUT]        
 * RETURNS
 *  U16
 *****************************************************************************/
U16 mmi_phb_get_phone_index_arrary(U16* index_array)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;
    U16 array_count = 0;
    U16 store_index;
    
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_DUAL_SIM_MASTER__
     if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else /* __MMI_DUAL_SIM_MASTER__ */
    if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif /* __MMI_DUAL_SIM_MASTER__ */
    {
        return 0xFFFF;
    }

    if (index_array != NULL)
    {
        for (i = 0; i < PhoneBookEntryCount; i++)
        {
            store_index = g_phb_name_index[i];
            if (store_index < MAX_PB_PHONE_ENTRIES)
            {
                index_array[array_count] = store_index;
                array_count++;
            }
        }
    }
    return g_phb_cntx.phone_used;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sync_vcard
 * DESCRIPTION
 *  
 * PARAMETERS
 *  path        [IN]         
 *  index       [IN]        
 * RETURNS
 *  
 *****************************************************************************/
void mmi_phb_sync_vcard(U8 action, S8 *path, U16 index, U8 sync_charset)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    FS_HANDLE fh;
    U8 error_code = VCARD_PARSE_NO_ERROR;
    S16 pError;
    S8 number_buff[(MAX_PB_NUMBER_LENGTH + 1 + 1) * ENCODING_LENGTH];
    S8 b_day[9];    /* Format: yyyymmdd */
    S32 get_result;
    

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    if (action != MMI_PHB_VCARD_DELETE && path == NULL)
    {
        mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_ERROR, index);
        return;
    }    
    if ((action != MMI_PHB_VCARD_ADD) && index >= MAX_PB_PHONE_ENTRIES)
    {
        mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_OUT_OF_INDEX, index);        
        return;
    }
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == MTPNP_FALSE)
#else   /* __MMI_DUAL_SIM_MASTER__ */
    if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif  /* __MMI_DUAL_SIM_MASTER__ */
    {
        mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_NOT_READY, index);
        return;
    }
#ifdef __MMI_PHB_USIM_FIELD__
    if (g_phb_cntx.is_usim && g_phb_cntx.usim_ready_stage != MMI_PHB_USIM_READY)
    {
        mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_NOT_READY, index);
        return;
    }
#endif /* __MMI_PHB_USIM_FIELD__ */    
    if (action == MMI_PHB_VCARD_READ)
    {
        /* Mobile Number */
        if (((PhoneBook[index].tel.type & 0x90) == 0x90) && (PhoneBook[index].tel.type != 0xFF))
        {
            number_buff[0] = '+';
            mmi_phb_convert_to_digit((U8*) number_buff + 1, PhoneBook[index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
        }
        else
        {
            mmi_phb_convert_to_digit((U8*) number_buff, PhoneBook[index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
        }

    #if defined(__MMI_PHB_BIRTHDAY_FIELD__)
        mmi_vcard_get_bday_to_buff(index, (S8*) b_day);
    #endif /* defined(__MMI_PHB_BIRTHDAY_FIELD__) */ 
    #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
        ReadRecord(
            NVRAM_EF_PHB_FIELDS_LID,
            (U16) (index + 1),
            (void*)&PhoneBookOptionalFields,
            OPTIONAL_FIELDS_RECORD_SIZE,
            &pError);
    #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 
    #if defined(__MMI_PHB_INFO_FIELD__)
        ReadRecord(
            NVRAM_EF_PHB_INFO_LID,
            (U16) (index + 1),
            (void*)&PhoneBookInfoFields,
            MMI_PHB_INFO_RECORD_SIZE,
            &pError);
    #endif /* defined(__MMI_PHB_INFO_FIELD__) */

        get_result = mmi_vcard_writer_v21_to_file(path,
                                            (S8*) PhoneBook[index].alpha_id.name,
                                            (S8*) number_buff,
                                #if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
                                            (S8*) PhoneBookOptionalFields.homeNumber,
                                            (S8*) PhoneBookOptionalFields.officeNumber,
                                            (S8*) PhoneBookOptionalFields.faxNumber,
                                            (S8*) PhoneBookOptionalFields.emailAddress,
                                            (S8*) PhoneBookOptionalFields.companyName,
                                #else /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 
                                            NULL, NULL, NULL, NULL, NULL,
                                #endif /* !defined(__MMI_PHB_NO_OPTIONAL_FIELD__) */ 
                                #if defined(__MMI_PHB_BIRTHDAY_FIELD__)
                                            b_day,
                                #else 
                                            NULL,
                                #endif 
                                #if defined(__MMI_PHB_INFO_FIELD__)
                                            &PhoneBookInfoFields,
                                #else
                                            NULL,
                                #endif /* defined(__MMI_PHB_INFO_FIELD__) */
                                            NULL);
        if (get_result != VOBJ_ERR_NO_ERROR)
        {
            mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_ERROR, index);
        }
        else
        {
            mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_SUCCESS, index);
        }
        return;
    }
    else if (action == MMI_PHB_VCARD_ADD || action == MMI_PHB_VCARD_UPDATE)
    {
        if (action == MMI_PHB_VCARD_ADD)
        {
            if (g_phb_cntx.phone_used >= g_phb_cntx.phone_total) /* NVRAM Only */
            {
                mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_STORAGE_FULL, index);
                return;
            }
            g_phb_cntx.selected_storage = MMI_NVRAM;
        }

        fh = FS_Open((U16*) path, FS_READ_ONLY);
        if (fh <= 0)
        {
            mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_OPEN_FILE_ERROR, index);
            return;
        }
        mmi_phb_util_clear_buffer(TRUE);  /* Clear all phonebook vcard temp buffer before parsing */
        g_vcard_cntx.CharSet = (mmi_chset_enum) sync_charset;
        error_code = mmi_vcard_reader_parse_line(fh);
        FS_Close(fh);
    }
    
    if (action == MMI_PHB_VCARD_DELETE)
    {
        if (mmi_phb_util_check_entry_exist(index))
        {
            g_phb_enter_from = MMI_PHB_ENTER_FROM_SYNCML;
            g_phb_cntx.active_index = index;
            mmi_phb_op_delete_entry_req();
        }
        else /* Entry already deleted by handset user (Client) */
        {
            mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_SUCCESS, index);
        }
        return;
    }
    
    PRINT_INFORMATION_2(MMI_TRACE_G4_PHB, "File: [%s]  Line: [%d] <<mmi_phb_sync_vcard. error_code: %d>\n",
                         __FILE__, __LINE__, error_code);
	
    g_phb_enter_from = MMI_PHB_ENTER_FROM_SYNCML;

    /*  Check if parse and validation ok. */
    if (error_code != VCARD_PARSE_NO_ERROR || !mmi_phb_op_check_pre_save(FALSE))
    {
		g_phb_enter_from = MMI_PHB_ENTER_NONE;

        mmi_syncml_phb_sync_rsp(MMI_PHB_SYNC_ERROR, index);
        return;
    }

    if (action == MMI_PHB_VCARD_ADD)
    {
        mmi_phb_op_add_entry_req();
    }
    else if (action == MMI_PHB_VCARD_UPDATE)
    {
        g_phb_cntx.active_index = index;
        mmi_phb_op_edit_entry_req();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_sync_get_record_size
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  U16 record_size
 *
 *****************************************************************************/
U16 mmi_phb_sync_get_record_size(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 record_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    record_size += ((MAX_PB_NAME_LENGTH + 1) + (MAX_PB_NUMBER_LENGTH + 1 + 1));
#if !defined(__MMI_PHB_NO_OPTIONAL_FIELD__)
    record_size += NVRAM_PHB_FIELDS_SIZE;
#endif
#if defined(__MMI_PHB_BIRTHDAY_FIELD__)
    record_size += (NVRAM_EF_PHB_BIRTHDAY_SIZE / NVRAM_EF_PHB_BIRTHDAY_COUNT);
#endif
#if defined(__MMI_PHB_INFO_FIELD__)
    record_size += NVRAM_EF_PHB_INFO_SIZE;
#endif
    return record_size;
}
#endif /* __SYNCML_SUPPORT__ */


#ifdef __MMI_BIRTHDAY_REMINDER__
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_name_number
 * DESCRIPTION
 *  check if an entry exists
 * PARAMETERS
 *  store_index     [IN]        The store location id of the entry
 *  out_name        [OUT]       The name of the phonebook entry (UCS2)
 *  out_number      [OUT]       The default mobile number of the entry (ASCII)
 * RETURNS
 *  TRUE if the location has the entry, else FALSE
 *****************************************************************************/
MMI_BOOL mmi_phb_get_name_number(U16 store_index, U8* out_name, U8* out_number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __SYNCML_SUPPORT__
    if (mmi_syncml_is_phb_sync_now())
    {
        return MMI_FALSE;
    }
    else
#endif /* __SYNCML_SUPPORT__ */
#ifdef __MMI_DUAL_SIM_MASTER__
    if (MTPNP_PFAL_Phb_IsReady() == !MTPNP_TRUE)
#else/* __MMI_DUAL_SIM_MASTER__ */
    if (!g_phb_cntx.phb_ready || g_phb_cntx.processing)
#endif/* __MMI_DUAL_SIM_MASTER__ */
    {
        return MMI_FALSE;
    }

    mmi_ucs2cpy((S8*)out_name, (PS8) PhoneBook[store_index].alpha_id.name);
    if (((PhoneBook[store_index].tel.type & 0x90) == 0x90) && (PhoneBook[store_index].tel.type != 0xFF))
    {
        out_number[0] = '+';
        mmi_phb_convert_to_digit((U8*) (out_number + 1), PhoneBook[store_index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit(out_number, PhoneBook[store_index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
    }
    return MMI_TRUE;
}
#endif /* __MMI_BIRTHDAY_REMINDER__ */


/* Convert function for phonebook numbers between BCD and ASCII format. */
#define MMI_PHB_GENERAL_UTIL
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_util_check_entry_exist
 * DESCRIPTION
 *  check if an entry exists
 * PARAMETERS
 *  store_index     [IN]        The store location id of the entry
 * RETURNS
 *  TRUE if the location has the entry, else FALSE
 *****************************************************************************/
BOOL mmi_phb_util_check_entry_exist(U16 store_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < PhoneBookEntryCount; i++)
    {
        if (g_phb_name_index[i] == store_index)
        {
            return TRUE;
        }
    }
    return FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_util_check_additional_number_exist
 * DESCRIPTION
 *  check if any additional number exists
 * PARAMETERS
 *  store_index     [IN]        The store location id of the entry
 * RETURNS
 *  TRUE if the location has any additional number, else FALSE
 *****************************************************************************/
BOOL mmi_phb_util_check_additional_number_exist(U16 store_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return ((PhoneBook[store_index].field & MMI_PHB_ENTRY_FIELD_HOME) ||
            (PhoneBook[store_index].field & MMI_PHB_ENTRY_FIELD_OFFICE) ||
            (PhoneBook[store_index].field & MMI_PHB_ENTRY_FIELD_FAX));
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_bcd_get_byte
 * DESCRIPTION
 *  convert ASCII character to BCD
 * PARAMETERS
 *  digit       [IN]        Ascii character
 * RETURNS
 *  bcd character
 *****************************************************************************/
U8 mmi_phb_convert_to_bcd_get_byte(U8 digit)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 half_byte;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (digit <= '9' && digit >= '0')
    {
        half_byte = digit - '0';
    }
    else
    {
        switch (digit)
        {
            case '*':
                half_byte = 0x0a;
                break;

            case '#':
                half_byte = 0x0b;
                break;

            case 'p':
            case 'P':
                half_byte = 0x0c;
                break;

            case 'w':
            case 'W':
                half_byte = 0x0d;
                break;

            case '+':
                half_byte = 0x0e;
                break;

            default:
                half_byte = 0x0f;
                break;
        }
    }
    return half_byte;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_bcd
 * DESCRIPTION
 *  convert ASCII string to BCD. (If reaches max length, there will be no terminate '0x0f')
 * PARAMETERS
 *  dest                [IN/OUT]        An BCD encoding string.
 *  source              [IN]            An ASCII encoding string.
 *  max_dest_len        [IN]            The byte size of dest array.
 * RETURNS
 *  byte number after convert.
 *****************************************************************************/
U8 mmi_phb_convert_to_bcd(U8 *dest, U8 *source, U8 max_dest_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    U8 lower_byte, upper_byte;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while (source[i] != '\0')
    {

        lower_byte = mmi_phb_convert_to_bcd_get_byte(source[i]);
        upper_byte = mmi_phb_convert_to_bcd_get_byte(source[i + 1]);

        if ((i >> 1) >= max_dest_len)
        {
            return (i >> 1);
        }

        *((U8*) dest + (i >> 1)) = (upper_byte << 4) + lower_byte;

        if (source[i + 1] == '\0')
        {
            if ((i >> 1) >= max_dest_len)
            {
                return (i >> 1) + 1;
            }

            *((U8*) dest + (i >> 1)) |= 0xf0;
            return (i >> 1) + 1;
        }

        i += 2;
    }

    if ((i >> 1) >= max_dest_len)
    {
        return (i >> 1);
    }

    *((U8*) dest + (i >> 1)) = 0xff;
    return (i >> 1);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_digit_get_byte
 * DESCRIPTION
 *  convert BCD character to ASCII
 * PARAMETERS
 *  bcd     [IN]        Bcd character
 * RETURNS
 *  ascii character
 *****************************************************************************/
U8 mmi_phb_convert_to_digit_get_byte(U8 bcd)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 digit;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (bcd <= 9)
    {
        digit = bcd + '0';
    }
    else
    {
        switch (bcd)
        {
            case 0x0a:
                digit = '*';
                break;

            case 0x0b:
                digit = '#';
                break;

            case 0x0c:
                digit = 'p';
                break;

            case 0x0d:
                digit = 'w';
                break;

            case 0x0e:
                digit = '+';
                break;

            default:
                digit = '\0';
                break;
        }
    }
    return digit;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_digit
 * DESCRIPTION
 *  convert BCD string to ASCII
 * PARAMETERS
 *  dest                [IN/OUT]        An ASCII encoding string.
 *  source              [IN]            An BCD encoding string.
 *  max_dest_len        [IN]            The byte size of dest array.(include null terminate '\0')
 * RETURNS
 *  byte number after convert.
 *****************************************************************************/
U8 mmi_phb_convert_to_digit(U8 *dest, U8 *source, U8 max_dest_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 ch1, ch2;
    U8 i = 0, j = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while ((source[i] != 0xff) && (j < max_dest_len - 1))
    {
        ch1 = source[i] & 0x0f;
        ch2 = (source[i] & 0xf0) >> 4;

        *((U8*) dest + j) = mmi_phb_convert_to_digit_get_byte(ch1);

        if (ch2 == 0x0f)
        {
            *((U8*) dest + j + 1) = '\0';
            return j + 1;
        }
        else
        {
            *((U8*) dest + j + 1) = mmi_phb_convert_to_digit_get_byte(ch2);
        }
        i++;
        j += 2;
    }

    *((U8*) dest + j) = '\0';
    return j;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_get_ucs2_number
 * DESCRIPTION
 *  This function returns the UCS2 number string by specifying store_index
 * PARAMETERS
 *  pString     [IN/OUT]        Buffter to store convert result
 *  index       [IN]            Store index of the phonebook entry to be converted.
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_convert_get_ucs2_number(S8 *pString, U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 tempNumber[MAX_PB_NUMBER_LENGTH + 1 + 1];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (((PhoneBook[index].tel.type & 0x90) == 0x90) && (PhoneBook[index].tel.type != 0xFF))
    {
        tempNumber[0] = '+';
        mmi_phb_convert_to_digit((U8*) (tempNumber + 1), PhoneBook[index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit(tempNumber, PhoneBook[index].tel.number, MAX_PB_NUMBER_LENGTH + 1);
    }

    mmi_asc_to_ucs2(pString, (S8*) tempNumber);
}


#ifdef __MMI_PHB_USIM_FIELD__
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_get_ucs2_anr
 * DESCRIPTION
 *  This function returns the UCS2 number string by specifying store_index
 * PARAMETERS
 *  anra            [?]             
 *  anrb            [?]             
 *  anrc            [?]             
 *  index           [IN]            Store index of the phonebook entry to be converted.
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_convert_get_ucs2_anr(S8 *anra, S8 *anrb, S8 *anrc, U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 tempNumber[MAX_PB_NUMBER_LENGTH + 1 + 1];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(index >= MAX_PB_PHONE_ENTRIES);
    index -= MAX_PB_PHONE_ENTRIES;

    if (((phb_anr[index][0].type & 0x90) == 0x90) && (phb_anr[index][0].type != 0xFF))
    {
        tempNumber[0] = '+';
        mmi_phb_convert_to_digit((U8*) (tempNumber + 1), phb_anr[index][0].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit((U8*) tempNumber, phb_anr[index][0].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    mmi_asc_to_ucs2(anra, (S8*) tempNumber);
    if (((phb_anr[index][1].type & 0x90) == 0x90) && (phb_anr[index][1].type != 0xFF))
    {
        tempNumber[0] = '+';
        mmi_phb_convert_to_digit((U8*) (tempNumber + 1), phb_anr[index][1].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit((U8*) tempNumber, phb_anr[index][1].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    mmi_asc_to_ucs2(anrb, (S8*) tempNumber);
    if (((phb_anr[index][2].type & 0x90) == 0x90) && (phb_anr[index][2].type != 0xFF))
    {
        tempNumber[0] = '+';
        mmi_phb_convert_to_digit((U8*) (tempNumber + 1), phb_anr[index][2].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit((U8*) tempNumber, phb_anr[index][2].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    mmi_asc_to_ucs2(anrb, (S8*) tempNumber);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_get_ansii_anr
 * DESCRIPTION
 *  This function returns the ansii number string by specifying store_index
 * PARAMETERS
 *  anra            [?]             
 *  anrb            [?]             
 *  anrc            [?]             
 *  index           [IN]            Store index of the phonebook entry to be converted.
 *  pString(?)      [IN/OUT]        Buffter to store convert result
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_convert_get_ansii_anr(S8 *anra, S8 *anrb, S8 *anrc, U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    ASSERT(index >= MAX_PB_PHONE_ENTRIES);
    index -= MAX_PB_PHONE_ENTRIES;

    if (((phb_anr[index][0].type & 0x90) == 0x90) && (phb_anr[index][0].type != 0xFF))
    {
        anra[0] = '+';
        mmi_phb_convert_to_digit((U8*) (anra + 1), phb_anr[index][0].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit((U8*) anra, phb_anr[index][0].number, MAX_PB_NUMBER_LENGTH + 1);
    }

    if (((phb_anr[index][1].type & 0x90) == 0x90) && (phb_anr[index][1].type != 0xFF))
    {
        anrb[0] = '+';
        mmi_phb_convert_to_digit((U8*) (anrb + 1), phb_anr[index][1].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit((U8*) anrb, phb_anr[index][1].number, MAX_PB_NUMBER_LENGTH + 1);
    }

    if (((phb_anr[index][2].type & 0x90) == 0x90) && (phb_anr[index][2].type != 0xFF))
    {
        anrc[0] = '+';
        mmi_phb_convert_to_digit((U8*) (anrc + 1), phb_anr[index][2].number, MAX_PB_NUMBER_LENGTH + 1);
    }
    else
    {
        mmi_phb_convert_to_digit((U8*) anrc, phb_anr[index][2].number, MAX_PB_NUMBER_LENGTH + 1);
    }
}

#endif /* __MMI_PHB_USIM_FIELD__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_0x81_get_offset
 * DESCRIPTION
 *  This function get the offset according to the base for a two bytes UCS2 character.
 * PARAMETERS
 *  base        [IN]        Base of the character.
 *  code        [IN]        Character for getting offset
 * RETURNS
 *  offset
 *****************************************************************************/
U8 mmi_phb_convert_to_0x81_get_offset(U16 base, U16 code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (code < 0x80)
    {
        return (U8) code;
    }
    else
    {
        return (U8) (code - base + 0x80);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_0x81_get_base
 * DESCRIPTION
 *  This function get the base for a two bytes UCS2 chatacters.(For Thai only now.)
 * PARAMETERS
 *  code        [IN]        Input character
 * RETURNS
 *  the offset base
 *****************************************************************************/
U16 mmi_phb_convert_to_0x81_get_base(U16 code)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if ((code >= 0x0E00) && (code <= 0x0E5F))   /* Thai 0E00 ~ 0E5F */
    {
        return 0x0E00;
    }
    if ((code >= 0x0080) && (code <= 0x00FF))   /* C1 Controls and Latin-1 Supplement */
    {
        return 0x0080;
    }
    if ((code >= 0x0100) && (code <= 0x017F))   /* Latin Extended - A */
    {
        return 0x0100;
    }
    if ((code >= 0x0180) && (code <= 0x01FF))   /* Latin Extended - B (Partial) */
    {
        return 0x0180;
    }
    if ((code >= 0x0400) && (code <= 0x047F))   /* Russian 0400 ~ 04FF */
    {
        return 0x0400;
    }
    if ((code >= 0x0600) && (code <= 0x067F))   /* Arabic 0600 ~ 06FF */
    {
        return 0x0600;
    }
    if ((code >= 0x0980) && (code <= 0x09FF))   /* Bengali 0980 ~ 09FF */
    {
        return 0x0980;
    }
    if ((code >= 0x0A00) && (code <= 0x0A7F))   /* Punjabi 0A00 ~ 0A7F */
    {
        return 0x0A00;
    }
    if ((code >= 0x0B00) && (code <= 0x0B7F))   /* Oriya 0B00 ~ 0B7F */
    {
        return 0x0B00;
    }
    if ((code >= 0x0B80) && (code <= 0x0BFF))   /* Tamil 0B80 ~ 0BFF */
    {
        return 0x0B80;
    }
    if ((code >= 0x0C00) && (code <= 0x0C7F))   /* Telugu 0C00 ~ 0C7F */
    {
        return 0x0C00;
    }

    return 0x0000;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_convert_to_0x81
 * DESCRIPTION
 *  This convert a 0x80 UCS2 string to 0x81 format. (Only for Thai Language right now.)
 * PARAMETERS
 *  input_name      [IN]        The input string.(Assume the input name is in high byte - low byte order)
 *  is_convert      [IN]        
 * RETURNS
 *  converted result length(in byte) for input string.
 *****************************************************************************/
U8 mmi_phb_convert_to_0x81(S8 *input_name, BOOL is_convert)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 code;
    U16 base = 0;
    BOOL flag = TRUE;
    S8 result_name[(MAX_PB_NAME_LENGTH + 1) * ENCODING_LENGTH];
    S8 *temp_name;
    U8 i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    temp_name = input_name;

    /* Find first UCS2 character as base */
    while (!((*temp_name == 0) && (*(temp_name + 1) == 0)))
    {
        memcpy(&code, temp_name, 2);

        /* Already GSM Encoding, need to exchange byte order */
        /*
         * if(is_convert)
         * {
         * code = (code << 8) | (code >> 8);
         * }
         */

        if (code >= 0x80 && !UI_TEST_8895_1_CHAR_IN_GSM_DEF_CHAR(code))
        {
            base = mmi_phb_convert_to_0x81_get_base(code);
            break;
        }
        temp_name += 2;
    }

    /* Check if whole string can be encoded as 0x81. */
    temp_name = input_name;
    if (base > 0)
    {
        memset(result_name, 0xFF, (MAX_PB_NAME_LENGTH + 1) * ENCODING_LENGTH);
        result_name[0] = (U8) 0x81;
        result_name[1] = (U8) mmi_ucs2strlen(input_name);
        result_name[2] = (U8) (base >> 7);

        i = 3;
        while (!((*temp_name == 0) && (*(temp_name + 1) == 0)))
        {
            memcpy(&code, temp_name, 2);

            /* Already GSM Encoding, need to exchange byte order */
            /*
             * if(is_convert)
             * {
             * code = (code << 8) | (code >> 8);
             * }
             */
            if ((code >= 0x80) && (mmi_phb_convert_to_0x81_get_base(code) != base))
            {
                flag = FALSE;
                break;
            }

            if (UI_TEST_8895_1_CHAR_IN_GSM_DEF_CHAR(code))
            {
                if (UI_TEST_GSM_EXTENDED(code))
                {
                    flag = FALSE;
                    break;
                }
                else
                {
                    code = AsciiToDefaultArray[code];
                    result_name[i] = code;
                }
            }
            else
            {
                result_name[i] = mmi_phb_convert_to_0x81_get_offset(base, code);
            }
            temp_name += 2;
            i++;
        }

        if (flag)
        {
            /* Wrtie result to the same buffer */
            if (is_convert)
            {
                memcpy(input_name, result_name, (MAX_PB_NAME_LENGTH + 1) * ENCODING_LENGTH);
            }
            return i;
        }
    }

    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  PhbAsciiToGSM7Bit
 * DESCRIPTION
 *  Converts Ascii to GSM 7-Bit encoding
 * PARAMETERS
 *  buffer      [IN/OUT]        Result buffer
 * RETURNS
 *  void
 *****************************************************************************/
void PhbAsciiToGSM7Bit(PU8 buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i, length;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    length = strlen((PS8) buffer);
    for (i = 0; i < length; ++i)
    {
        buffer[i] = AsciiToDefaultArray[buffer[i]];
    }
}


/*****************************************************************************
 * FUNCTION
 *  PhbGSM7BitToAscii
 * DESCRIPTION
 *  Converts GSM 7-Bit to Ascii encoding
 * PARAMETERS
 *  buffer      [IN/OUT]        Result buffer
 *  length      [IN]            Result buffer size
 * RETURNS
 *  void
 *****************************************************************************/
void PhbGSM7BitToAscii(PU8 buffer, U8 length)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < length; ++i)
    {
        if (buffer[i] == 27)    /* treat escape char as a space */
        {
            buffer[i] = 32;
        }
        else
        {
            buffer[i] = DefaultToAsciiArray[buffer[i]];
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  GetUCS2Flag
 * DESCRIPTION
 *  Checks if the buffer contains Chinese character
 * PARAMETERS
 *  buffer      [IN]        String to be checked
 * RETURNS
 *  TRUE is a UCS2 two bytes string
 *****************************************************************************/
pBOOL GetUCS2Flag(PS8 buffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    pBOOL UCS2Flag = FALSE;
    U8 i, bufferLen;
    UI_character_type ch;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    bufferLen = mmi_ucs2strlen(buffer) * ENCODING_LENGTH;
    for (i = 1; i < bufferLen; i += 2)
    {
        if (buffer[i] || (buffer[i - 1] & 0x80))
        {
            ch = ((UI_character_type) buffer[i] << 8) | ((UI_character_type) buffer[i - 1]);
            if (!UI_TEST_8895_1_CHAR_IN_GSM_DEF_CHAR(ch))
            {
                UCS2Flag = TRUE;
                break;
            }
        }
    }
    return UCS2Flag;
}


/*****************************************************************************
 * FUNCTION
 *  GetUCS2ExtendedNum
 * DESCRIPTION
 *  Checks if the buffer contains Chinese character
 * PARAMETERS
 *  buffer      [IN]        String to be checked
 * RETURNS
 *  TRUE is a UCS2 two bytes string
 *****************************************************************************/
U8 GetUCS2ExtendedNum(PS8 buffer, U8 max_buffer_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 extend_num = 0;
    UI_character_type ch;
    U8 ex_count = 0;
    U8 ex_len = 1; /* need second bytes */
    U8 buffer_len = mmi_ucs2strlen(buffer) * ENCODING_LENGTH;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while (ex_count < max_buffer_len && ex_len < buffer_len)
    {
        ch = ((UI_character_type) buffer[ex_len] << 8) | ((UI_character_type) buffer[ex_len - 1]);
        if (UI_TEST_GSM_EXTENDED(ch))
        {
            ex_count++;
            extend_num++;
        }
        ex_count++;
        ex_len += 2;
    }
    return extend_num;
}


/*****************************************************************************
 * FUNCTION
 *  BigEndianToLittleEndian
 * DESCRIPTION
 *  Changes big endian to be little endian and vice versa
 * PARAMETERS
 *  dstBuffer       [IN]        Destination buffer
 *  srcBuffer       [IN]        Source buffer
 * RETURNS
 *  result string
 *****************************************************************************/
PS8 BigEndianToLittleEndian(PS8 dstBuffer, PS8 srcBuffer)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    U8 len;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    len = mmi_ucs2strlen(srcBuffer) * ENCODING_LENGTH;
    while (i != len)
    {
        dstBuffer[i] = srcBuffer[i + 1];
        dstBuffer[i + 1] = srcBuffer[i];
        i += 2;
    }
    dstBuffer[i] = '\0';
    dstBuffer[i + 1] = '\0';

    return dstBuffer;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_check_is_phonebook_full
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  
 *****************************************************************************/
U8 mmi_phb_check_is_phonebook_full(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifdef __MMI_DUAL_SIM_MASTER__
    if (PhoneBookEntryCount == g_phb_cntx.sim_total + g_phb_cntx.phone_total+MTPNP_AD_ADN_SIM2GetCapacity())
#else /* __MMI_DUAL_SIM_MASTER__ */
    if(PhoneBookEntryCount == (g_phb_cntx.sim_total + g_phb_cntx.phone_total))
#endif /* __MMI_DUAL_SIM_MASTER__ */
    {
        return TRUE;
    }
    else
    {
        return FALSE;
    }
}


#if defined(__MMI_UCM__)
/*****************************************************************************
 * FUNCTION
 *  mmi_phb_get_caller_image_info
 * DESCRIPTION
 *  Phonebook list interface for other application.
 * PARAMETERS
 *  func_list       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_phb_get_caller_image_info(const mmi_phb_caller_image_input_struct* img_input, mmi_phb_caller_image_info_struct* image_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 *path;
    FS_HANDLE fh;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* reset the image_info struct */
#if defined(__MMI_VIDEO_TELEPHONY__)
    if (img_input->call_type == MMI_PHB_VIDEO_CALL_TYPE)
    {
        image_info->new_image_id = IMG_PHB_VIDEO_DEFAULT;
    }
    else
#endif
    {
        image_info->new_image_id = IMG_PHB_DEFAULT;
    }
    image_info->image_type = 0;
    image_info->is_video_sound = MMI_FALSE;
	memset(image_info->image_path, 2, 0);
  
#ifdef __MMI_INCOMING_CALL_VIDEO__
    if ((img_input->video_id & 0x8000) || ((img_input->video_id & 0xfff) >= VDO_ID_PHB_MTCALL_1))
    {
        /* use video for display */
        /* user defined video file or system default video resource */

        if (img_input->video_id & 0x4000)
        {
            image_info->is_video_sound = MMI_TRUE;
        }
        if (img_input->video_id & 0x8000) /* video file, including file, swflash and avatar */
        {
            if (img_input->video_record_index != 0)
            {
                path = mmi_phb_video_get_path_from_id(img_input->video_record_index);
                if (path == NULL)
                {
                    image_info->is_video_sound = MMI_FALSE;
                    /* play default pic */
                    return;
                }
                else
                {
                #ifdef __MMI_AVATAR__
                    if (img_input->video_id & 0x1000)
                    {
                        image_info->image_type = WGUI_CATE_MOMT_RES_TYPE_AVATAR_FILE;
                        image_info->new_image_id = 0;
                        image_info->is_video_sound = MMI_FALSE; /* avatar has no sound */
                        return;
                    }
                    else
                #endif                    
                    {                
                        fh = FS_Open((PU16) path, FS_READ_ONLY);
                    
                        if (fh > FS_NO_ERROR)
                        {  
                            FS_Close(fh);
                            mmi_ucs2ncpy(image_info->image_path, path, FMGR_MAX_PATH_LEN);
                        #ifdef __MMI_SWFLASH__
                            if (img_input->video_id & 0x2000)
                            {
                                image_info->image_type = WGUI_CATE_MOMT_RES_TYPE_SWFLASH_FILE;
                                image_info->new_image_id = 0;
                                return;
                            }
                            else
                        #endif
                            {
                                image_info->image_type = WGUI_CATE_MOMT_RES_TYPE_VIDEO_FILE;
                                image_info->new_image_id = 0;
                                return;
                            }
                                                   
                        }
                        else
                        {
                            image_info->is_video_sound = MMI_FALSE;
                            return;
                        }
                    }
                }
            }
            else
            {
                image_info->is_video_sound = MMI_FALSE;
                return;                
            }
        }
        else /* video 1, swflash 1 */
        {
            /* resource */
            image_info->new_image_id = img_input->video_id & 0xfff;
        #ifdef __MMI_SWFLASH__ /* Check it's default sw flash or video */
            if (image_info->new_image_id >= MFH_ID_PHB_MTCALL_1)
            {
                image_info->image_type = WGUI_CATE_MOMT_RES_TYPE_SWFLASH_ID;
                return;
            }
            else
        #endif /* __MMI_SWFLASH__ */
            {
                image_info->image_type = WGUI_CATE_MOMT_RES_TYPE_VIDEO_ID;
                return;
            }        
        }
    }
    else
#endif /* def __MMI_INCOMING_CALL_VIDEO__ */    
#if defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__)
    if (img_input->image_id == 1) // image from file
    {
        if (img_input->record_index != 0)
        {
            path = mmi_phb_image_get_path_from_id(img_input->record_index);
            if (path != NULL)
            {
                fh = FS_Open((PU16) path, FS_READ_ONLY);

                if (fh > FS_NO_ERROR)
                {  
                    FS_Close(fh);
                    mmi_ucs2ncpy(image_info->image_path, path, FMGR_MAX_PATH_LEN);
                    image_info->image_type = WGUI_CATE_MOMT_RES_TYPE_IMAGE_FILE;
                    image_info->new_image_id = 0;
                }
            }
            return;
        }
        return;
    }
    else
#endif /* defined(__MMI_PHB_CALL_SHOW_PICTURE_FROM_FILE__) */
    {
        if (img_input->image_id == IMG_PHB_DEFAULT || img_input->image_id == 0)
        {
            return;
        }
        else
        {
            image_info->new_image_id = img_input->image_id;
            return;
        }
    }
}
#endif /* defined(__MMI_UCM__) */


/*****************************************************************************
 * FUNCTION
 *  mmi_phb_compare_numbers
 * DESCRIPTION
 *  check two phonebook number equals
 * PARAMETERS
 *  number1       [IN]
 *  number2		  [IN]
 * RETURNS
 *  MMI_BOOL
 *****************************************************************************/
MMI_BOOL mmi_phb_compare_numbers(S8 *number1, S8 *number2)
{
	/*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
	MMI_BOOL result = FALSE;
#if !defined(__MMI_PHB_ADV_NUM_MATCH_MOBILE__)
	U8 number_ASCII1[MAX_PB_NUMBER_LENGTH + 1 + 1];
	U8 number_ASCII2[MAX_PB_NUMBER_LENGTH + 1 + 1];
	U32 num1, num2;
#endif /* !defined(__MMI_PHB_ADV_NUM_MATCH_MOBILE__) */ 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_PHB_ADV_NUM_MATCH_MOBILE__)
	result = mmi_phb_number_compare_before_extension(number1, number2);

	if (result)
	{
		result = mmi_phb_number_compare_extension(number1, number2);
	}
#else
	memset(number_ASCII1, 0, ENCODING_LENGTH);
    mmi_ucs2_to_asc((PS8) number_ASCII1, (PS8) number1);
	
    memset(number_ASCII2, 0, ENCODING_LENGTH);
    mmi_ucs2_to_asc((PS8) number_ASCII2, (PS8) number2);
	
	num1 = mmi_phb_util_convert_number_to_int(number_ASCII1);
	num2 = mmi_phb_util_convert_number_to_int(number_ASCII2);
	
	if (num1 == num2)
	{
		result = TRUE;
	}		
#endif /* defined(__MMI_PHB_ADV_NUM_MATCH_MOBILE__) */ 

	return result;
}

#endif /* _PHONEBOOKSTUBSTOOTHERS_C */ 

