/*****************************************************************************
*  Copyright Statement:
*  --------------------
*  This software is protected by Copyright and the information contained
*  herein is confidential. The software may not be copied and the information
*  contained herein may not be used or disclosed except with the written
*  permission of MediaTek Inc. (C) 2005
*
*  BY OPENING THIS FILE, BUYER HEREBY UNEQUIVOCALLY ACKNOWLEDGES AND AGREES
*  THAT THE SOFTWARE/FIRMWARE AND ITS DOCUMENTATIONS ("MEDIATEK SOFTWARE")
*  RECEIVED FROM MEDIATEK AND/OR ITS REPRESENTATIVES ARE PROVIDED TO BUYER ON
*  AN "AS-IS" BASIS ONLY. MEDIATEK EXPRESSLY DISCLAIMS ANY AND ALL WARRANTIES,
*  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF
*  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR NONINFRINGEMENT.
*  NEITHER DOES MEDIATEK PROVIDE ANY WARRANTY WHATSOEVER WITH RESPECT TO THE
*  SOFTWARE OF ANY THIRD PARTY WHICH MAY BE USED BY, INCORPORATED IN, OR
*  SUPPLIED WITH THE MEDIATEK SOFTWARE, AND BUYER AGREES TO LOOK ONLY TO SUCH
*  THIRD PARTY FOR ANY WARRANTY CLAIM RELATING THERETO. MEDIATEK SHALL ALSO
*  NOT BE RESPONSIBLE FOR ANY MEDIATEK SOFTWARE RELEASES MADE TO BUYER'S
*  SPECIFICATION OR TO CONFORM TO A PARTICULAR STANDARD OR OPEN FORUM.
*
*  BUYER'S SOLE AND EXCLUSIVE REMEDY AND MEDIATEK'S ENTIRE AND CUMULATIVE
*  LIABILITY WITH RESPECT TO THE MEDIATEK SOFTWARE RELEASED HEREUNDER WILL BE,
*  AT MEDIATEK'S OPTION, TO REVISE OR REPLACE THE MEDIATEK SOFTWARE AT ISSUE,
*  OR REFUND ANY SOFTWARE LICENSE FEES OR SERVICE CHARGE PAID BY BUYER TO
*  MEDIATEK FOR SUCH MEDIATEK SOFTWARE AT ISSUE. 
*
*  THE TRANSACTION CONTEMPLATED HEREUNDER SHALL BE CONSTRUED IN ACCORDANCE
*  WITH THE LAWS OF THE STATE OF CALIFORNIA, USA, EXCLUDING ITS CONFLICT OF
*  LAWS PRINCIPLES.  ANY DISPUTES, CONTROVERSIES OR CLAIMS ARISING THEREOF AND
*  RELATED THERETO SHALL BE SETTLED BY ARBITRATION IN SAN FRANCISCO, CA, UNDER
*  THE RULES OF THE INTERNATIONAL CHAMBER OF COMMERCE (ICC).
*
*****************************************************************************/

/*****************************************************************************
 *
 * Filename:
 * ---------
 * MessagesMiscell.c
 *
 * Project:
 * --------
 *   MAUI
 *
 * Description:
 * ------------
 *   This file is intends for MMI SMS APP.
 *
 * Author:
 * -------
 * -------
 *
 *============================================================================
 *             HISTORY
 * Below this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *------------------------------------------------------------------------------
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 *
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 * removed!
 * removed!
 * removed!
 *
 *------------------------------------------------------------------------------
 * Upper this line, this part is controlled by PVCS VM. DO NOT MODIFY!!
 *============================================================================
 ****************************************************************************/
/**
 * Copyright Notice
 * ?2002 - 2003, Pixtel Communications, Inc., 1489 43rd Ave. W.,
 * Vancouver, B.C. V6M 4K8 Canada. All Rights Reserved.
 *  (It is illegal to remove this copyright notice from this software or any
 *  portion of it)
 */
/******************************************************************************

   FILENAME : MessagesMiscell.c

   PURPOSE     : 

   REMARKS     : nil

   AUTHOR      : Magesh k 

   DATE     : 01-01-2003

******************************************************************************/

#include "MMI_include.h"
#ifdef __MOD_SMSAL__
/*  Include: MMI header file */

/* ... Add More MMI header */
#include "CommonScreens.h"
#include "ProtocolEvents.h"

/* ...Add MSG header */
#include "customer_ps_inc.h"
#include "mmi_msg_context.h"
#include "MessagesL4Def.h"
#include "MessagesResourceData.h"
#include "MessagesMiscell.h"
#include "MessagesExDcl.h"
#include "SmsGuiInterfaceProt.h"
#include "SmsGuiInterfaceType.h"
#include "SmsPsHandler.h"
#include "CellBroadcastType.h"

#include "Gui_ems.h"
#include "wgui_ems.h"
#include "GSM7BitDefaultAlphabet.h"
#include "SimDetectionGProt.h"
/*  */
#include "CSP.h"
#include "IdleAppDef.h"
#include "CallManagementGprot.h"
#include "CallStructureManagementProt.h"
#include "PhoneBookGprot.h"
#include "SSCStringHandle.h"
#include "AlarmFrameworkProt.h"
#include "ProfileGprots.h"

#include "gpioInc.h"
#include "NetworkSetupDefs.h"
/*  */
#ifdef __MMI_MESSAGES_CLUB__
#include "mmiapi_res.h"
#endif 

#if defined(OBIGO_Q03C) && defined(MMS_SUPPORT)
#include "WapResDef.h"
#endif 

#ifdef __MMI_MESSAGES_CHAT__
#include "ChatAppGprot.h"
#include "ChatAppResDef.h"
#include "ChatGtype.h"
#endif /* __MMI_MESSAGES_CHAT__ */ 
#if defined(__MMI_MESSAGES_TEMPLATE__)
#if defined(_MUTILANG_TEMPLATE_) || defined(__MMI_MESSAGES_SIMCHINESE_TEMPLATE__)
#include "SSCStringHandle.h"
#endif /* defined(_MUTILANG_TEMPLATE_) || defined(__MMI_MESSAGES_SIMCHINESE_TEMPLATE__) */ 
#endif /* defined(__MMI_MESSAGES_TEMPLATE__) */ 
#include "nvram_user_defs.h"

#include "SMSApi.h"
#include "SMSStruct.h"
#include "SMSFunc.h"

#ifdef __MMI_UNIFIED_MESSAGE__
#include "UnifiedMessageResDef.h"
#include "UnifiedMessageGProt.h"
#include "DateTimeGprot.h"
#endif /* __MMI_UNIFIED_MESSAGE__ */ 

#ifdef __MMI_UNIFIED_COMPOSER__
#include "UnifiedComposerResDef.h"
#include "UnifiedComposerGProt.h"
#endif /* __MMI_UNIFIED_COMPOSER__ */ 

#if defined(__MMI_WLAN_FEATURES__) && defined(__MMI_VOIP__)
#include "NetworkSetupDefs.h"
#include "VoIPGProt.h"
#endif /* defined(__MMI_WLAN_FEATURES__) && defined(__MMI_VOIP__) */

#ifdef __MMI_DUAL_SIM_MASTER__
#include "MTPNP_AD_master_header.h"
#include "MTPNP_PFAL_CC.h"
#include "MTPNP_PFAL_MessageSetup.h"
#include "MTPNP_PFAL_master_msgs.h"
#include "MTPNP_AD_resdef.h"
#endif /* __MMI_DUAL_SIM_MASTER__ */
#if defined(__MMI_EMAIL__)
#include "EmailAppGProt.h"
#endif /* defined(__MMI_EMAIL__) */ 

#if defined(__MMI_MESSAGES_TEMPLATE__)
#ifndef NVRAM_SMS_TEMPL_RECORD_SIZE
#define NVRAM_SMS_TEMPL_RECORD_SIZE      84
#endif 
#ifndef NVRAM_SMS_RECORD_TOTAL
#define NVRAM_SMS_RECORD_TOTAL         31
#endif 
const U16 templateStrings[] = 
{
    STR_SMS_TEMPLATE_1,
    STR_SMS_TEMPLATE_2,
    STR_SMS_TEMPLATE_3,
    STR_SMS_TEMPLATE_4,
    STR_SMS_TEMPLATE_5,
    STR_SMS_TEMPLATE_6,
    STR_SMS_TEMPLATE_7,
    STR_SMS_TEMPLATE_8,
    STR_SMS_TEMPLATE_9,
    STR_SMS_TEMPLATE_10
};

#ifdef _MUTILANG_TEMPLATE_
#define TOTAL_TEMPLATE_LANGUAGE        3
extern pBOOL IsTrChineseSet(void);
extern pBOOL IsSmChineseSet(void);
#endif /* _MUTILANG_TEMPLATE_ */ 
#if defined(_MUTILANG_TEMPLATE_) || defined(__MMI_MESSAGES_SIMCHINESE_TEMPLATE__)
static U8 currLang[SSC_SIZE];
extern sLanguageDetails *gLanguageArray;
extern U16 gCurrLangIndex;
#endif /* defined(_MUTILANG_TEMPLATE_) || defined(__MMI_MESSAGES_SIMCHINESE_TEMPLATE__) */ /* _MUTILANG_TEMPLATE_, __MMI_MESSAGES_SIMCHINESE_TEMPLATE__ */
#endif /* defined(__MMI_MESSAGES_TEMPLATE__) */ 
#ifdef __MMI_MESSAGES_CHAT__
static U8 NewChatMessageFromXxxStr[(MAX_PHONE_NUMBER_OR_NAME_LENGTH + 1) * ENCODING_LENGTH];
U16 gChatMsgFlag;   /* Added By Alok */
void GetNewChatMsgIndDisplayString(U8 *number, U8 length, U8 type);
PU8 GetNewChatSmsIndDisplayStr(void);
#endif /* __MMI_MESSAGES_CHAT__ */ 
static FuncPtr endKeyDownFuncPtr = NULL;
static U16 messagesCurrScrnID;
static U8 *strBuff = NULL;

extern msg_msgbox_info_struct msgbox_info;
extern PendingSaveSendDataStruct PendingSaveSendData;
extern U16 GetCmMarkerScrnID(void);
extern EMSData *GetEMSDataForView(EMSData **p, U8 force);
extern MMI_ALERT_TYPE GetMtCallAlertTypeEnum(void);
extern kal_uint16 wap_get_screen_id(void);


#include "gui_config.h"

extern const U8 AsciiToDefaultArray[];
extern const U8 ExtendedAsciiToDefaultArray[];
extern const U8 DefaultToExtendedAsciiArray[];
extern const U8 DefaultToAsciiArray[];

/*****************************************************************************
 * FUNCTION
 *  IsMMIInIdleState
 * DESCRIPTION
 *  Check if MMI is in idle state (idle screen or screen saver)
 * PARAMETERS
 *  void
 * RETURNS
 *  1: idle, 0: non-idle
 *****************************************************************************/
U16 IsMMIInIdleState(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                         "* [MessagesMiscell.c] IsMMIInIdleState IsOnIdleScreen=%d,ScreenSaverRunFlag=%d*\n",
                         g_idle_context.IsOnIdleScreen, g_idle_context.ScreenSaverRunFlag);

    if (g_idle_context.IsOnIdleScreen || g_idle_context.ScreenSaverRunFlag)
    {
        return 1;
    }
    else
    {
        return 0;
    }
}


/*****************************************************************************
 * FUNCTION
 *  IsKeyPadLockState
 * DESCRIPTION
 *  Check if MMI is in keypad lock state
 * PARAMETERS
 *  void
 * RETURNS
 *  keypad lock flag (1: lock, 0: unlock)
 *****************************************************************************/
U8 IsKeyPadLockState(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_keylock_context.gKeyPadLockFlag;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_set_phb_send_case
 * DESCRIPTION
 *  Set PhbSmsInterfaceState
 * PARAMETERS
 *  PhbSmsInterfaceState        [IN]        
 *  a(?)                        [IN]        PhbSmsInterfaceState
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_set_phb_send_case(U8 PhbSmsInterfaceState)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.PhbSmsInterfaceState = PhbSmsInterfaceState;
}


/*****************************************************************************
 * FUNCTION
 *  GetCurrEndKeyDownHandler
 * DESCRIPTION
 *  Get current end key down handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void GetCurrEndKeyDownHandler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] GetCurrEndKeyDownHandler -------*\n");
    endKeyDownFuncPtr = NULL;
    endKeyDownFuncPtr = GetKeyHandler(KEY_END, KEY_EVENT_DOWN);
}


/*****************************************************************************
 * FUNCTION
 *  ExecCurrEndKeyDownHandler
 * DESCRIPTION
 *  Execute current end key down handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void ExecCurrEndKeyDownHandler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] ExecCurrEndKeyDownHandler -------*\n");
    if (endKeyDownFuncPtr != NULL)
    {
        (*endKeyDownFuncPtr) ();
    }
}


/*****************************************************************************
 * FUNCTION
 *  GetMessagesCurrScrnID
 * DESCRIPTION
 *  Get MSG current screen ID
 * PARAMETERS
 *  void
 * RETURNS
 *  messagesCurrScrnID
 *****************************************************************************/
U16 GetMessagesCurrScrnID(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[MessagesMiscell.c] GetMessagesCurrScrnID = %d", messagesCurrScrnID);
    return messagesCurrScrnID;
}


/*****************************************************************************
 * FUNCTION
 *  SetMessagesCurrScrnID
 * DESCRIPTION
 *  Set MSG current screen ID
 * PARAMETERS
 *  scrnID      [IN]        
 *  a(?)        [IN]        Screen ID
 * RETURNS
 *  void
 *****************************************************************************/
void SetMessagesCurrScrnID(U16 scrnID)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[MessagesMiscell.c] SetMessagesCurrScrnID= %d", messagesCurrScrnID);
    messagesCurrScrnID = scrnID;
}


/*****************************************************************************
 * FUNCTION
 *  SetMessagesScrnIdToDelHistoryNodes
 * DESCRIPTION
 *  Set MSG screen ID for delete start
 * PARAMETERS
 *  StartScrnId     [IN]        
 *  a(?)            [IN]        Start screen ID
 * RETURNS
 *  void
 *****************************************************************************/
void SetMessagesScrnIdToDelHistoryNodes(U16 StartScrnId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                         "*-------[MessagesMiscell.c] SetMessagesScrnIdToDelHistoryNodes -------*\n");
    g_msg_cntx.MessagesScrnIdToDelHistoryNodes = StartScrnId;
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] screen id = %d -------*\n",
                         g_msg_cntx.MessagesScrnIdToDelHistoryNodes);
}


/*****************************************************************************
 * FUNCTION
 *  SetMessagesScrnIdDelUpToHistoryNodes
 * DESCRIPTION
 *  Set MSG screen ID for delete start
 * PARAMETERS
 *  StartScrnId     [IN]        
 *  a(?)            [IN]        Start screen ID
 * RETURNS
 *  void
 *****************************************************************************/
void SetMessagesScrnIdDelUpToHistoryNodes(U16 StartScrnId)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                         "*-------[MessagesMiscell.c] SetMessagesScrnIdDelUpToHistoryNodes -------*\n");
    g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes = StartScrnId;
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] screen id = %d -------*\n",
                         g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes);
}


/*****************************************************************************
 * FUNCTION
 *  DeleteMessagesHistoryNodes
 * DESCRIPTION
 *  Delete between MSG screens
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DeleteMessagesHistoryNodes(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] DeleteMessagesHistoryNodes -------*\n");
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] Deleteted from %d -------*\n",
                         g_msg_cntx.MessagesScrnIdToDelHistoryNodes);
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] Deleteted upto %d -------*\n",
                         g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes);

    if (IsScreenPresent(g_msg_cntx.MessagesScrnIdToDelHistoryNodes) &&
        IsScreenPresent(g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes))
    {
        if (DeleteBetweenScreen
            (g_msg_cntx.MessagesScrnIdToDelHistoryNodes, g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes))
        {
            PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*---[MessagesMiscell.c] Deleteted scrn id from %d to %d ---*\n",
                                 g_msg_cntx.MessagesScrnIdToDelHistoryNodes,
                                 g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes);
            g_msg_cntx.MessagesScrnIdToDelHistoryNodes = MESSAGES_SCR_ID_DEFINES_MAX;
            g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes = MESSAGES_SCR_ID_DEFINES_MAX;
            return;
        }
    }
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*---[MessagesMiscell.c] Not deleteted scrn id from %d to %d ---*\n",
                         g_msg_cntx.MessagesScrnIdToDelHistoryNodes, g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes);
}


/*****************************************************************************
 * FUNCTION
 *  Messages2GoBackHistory
 * DESCRIPTION
 *  Go back two screen history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void Messages2GoBackHistory(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] Messages2GoBackHistory -------*\n");
    GoBacknHistory(1);
}


/*****************************************************************************
 * FUNCTION
 *  Messages4GoBackHistory
 * DESCRIPTION
 *  Go back four screen history
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void Messages4GoBackHistory(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] Messages4GoBackHistory -------*\n");
    GoBacknHistory(3);
}


/*****************************************************************************
 * FUNCTION
 *  GetHiliteIndex
 * DESCRIPTION
 *  Get current highlight index
 * PARAMETERS
 *  nIndex      [IN]        
 *  a(?)        [IN]        Current highlight index
 * RETURNS
 *  void
 *****************************************************************************/
void GetHiliteIndex(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] GetHiliteIndex -------*\n");
    g_msg_cntx.currHiliteIndex = nIndex;
}


/*****************************************************************************
 * FUNCTION
 *  GetMsgIndex
 * DESCRIPTION
 *  Get current highlight message box index
 * PARAMETERS
 *  nIndex      [IN]        
 *  a(?)        [IN]        Current highlight index
 * RETURNS
 *  void
 *****************************************************************************/
void GetMsgIndex(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.currBoxIndex = nIndex;
#ifdef __MMI_DUAL_SIM_MASTER__
    MTPNP_PFAL_SMS_Set_Current_Index(nIndex);
#endif /* __MMI_DUAL_SIM_MASTER__ */
}


/*****************************************************************************
 * FUNCTION
 *  GetTemplateIndex
 * DESCRIPTION
 *  Get current highlight index in template list
 * PARAMETERS
 *  nIndex      [IN]        
 *  a(?)        [IN]        Current highlight index
 * RETURNS
 *  void
 *****************************************************************************/
void GetTemplateIndex(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] GetTemplateIndex -------*\n");
    g_msg_cntx.currTemplateIndex = nIndex;
}


/*****************************************************************************
 * FUNCTION
 *  GetSendNumIndex
 * DESCRIPTION
 *  Get current highlight index in send number list
 * PARAMETERS
 *  nIndex      [IN]        
 *  a(?)        [IN]        Current highlight index
 * RETURNS
 *  void
 *****************************************************************************/
void GetSendNumIndex(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] GetSendNumIndex -------*\n");
    g_msg_cntx.currSendNumIndex = nIndex;
}


#if defined(__MMI_MESSAGES_EMS__)


/*****************************************************************************
 * FUNCTION
 *  EnableDisableAudioPlayback
 * DESCRIPTION
 *  Decide to enable/disable audio playback
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EnableDisableAudioPlayback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_ALERT_TYPE alertType;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    alertType = GetMtCallAlertTypeEnum();

    if ((!isInCall()) &&
        (alertType == MMI_RING || alertType == MMI_VIBRATION_AND_RING || alertType == MMI_VIBRATION_THEN_RING))
    {
        EMS_enable_audio_playback();
    }
    else
    {
        EMS_disable_audio_playback();
    }
}
#endif /* defined(__MMI_MESSAGES_EMS__) */ 


/*****************************************************************************
 * FUNCTION
 *  PlayMessageArrivalTone
 * DESCRIPTION
 *  Play message arrival tone
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void PlayMessageArrivalTone(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    MMI_ALERT_TYPE alertType;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    alertType = GetMtCallAlertTypeEnum();

    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] PlayMessageArrivalTone -------*\n");

    if (alertType == MMI_VIBRATION_AND_RING || alertType == MMI_VIBRATION_THEN_RING || alertType == MMI_RING)
    {
        if ((!isInCall()) || (isInCall() && (GetWapCallPresent())))
        {
        #ifndef __MMI_DUAL_PROFILE_SUPPORT__
            playRequestedTone(MESSAGE_TONE);
	    #else	/* __MMI_DUAL_PROFILE_SUPPORT__ */
		    if (g_msg_cntx.isSlave == FALSE)
		    {
			    playRequestedTone(MESSAGE_TONE);
		    }
		    else
		    {
			    playRequestedTone(CARD2_MESSAGE_TONE);
		    }
	    #endif	/* __MMI_DUAL_PROFILE_SUPPORT__ */
        }
        else
        {
            playRequestedTone(SMS_IN_CALL_TONE);
        }
    }
    if ((alertType == MMI_VIBRATION_ONLY) || (alertType == MMI_VIBRATION_AND_RING) ||
        (alertType == MMI_VIBRATION_THEN_RING))
    {
        if ((!g_alm_frm_cntx.IsAlmTonePlaying) && ((!isInCall()) || (isInCall() && (GetWapCallPresent()))))
        {
            PlaySmsVibratorOnce();
        }
    }
#ifdef __MMI_DUAL_SIM_MASTER__
	g_msg_cntx.isSlave = FALSE;
#endif
}


/*****************************************************************************
 * FUNCTION
 *  InitMessageProtocolEventHandlers
 * DESCRIPTION
 *  Init MSG protocol event handler when boot up
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void InitMessageProtocolEventHandlers(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_init_msg_data();
    ResetCBInfoStructs();
    mmi_msg_set_protocol_event_handler();
    InitCellBroadcastProtocolEventHanler(); /* danger!! receiving new CB might cause reading nvram */
}


/*****************************************************************************
 * FUNCTION
 *  InitMessagesApp
 * DESCRIPTION
 *  Init MSG application when go to opening screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void InitMessagesApp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    InitEMSDataStruct();
    mmi_msg_set_highlight_handler();
    /* mmi_msg_set_protocol_event_handler_after_init (); */
    InitCellBroadcastApp();
}


/*****************************************************************************
 * FUNCTION
 *  DeInitMessagesApp
 * DESCRIPTION
 *  Deinit MSG application
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DeInitMessagesApp(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_MESSAGES_TEMPLATE__)
    DeInitTemplates();
#endif 
    mmi_msg_deinit_msg_data();
    DeInitCellBroadcastApp();
    DeInitVoiceMailApp();
    DeInitEMSDataStruct();
}


/*****************************************************************************
 * FUNCTION
 *  RestoreMessagesSettings
 * DESCRIPTION
 *  Restore MSG settings
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void RestoreMessagesSettings(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[MessagesMiscell.c] RestoreMessagesSettings -------*\n");
    mmi_msg_restore_cb();
}


/*****************************************************************************
 * FUNCTION
 *  IsMessagesReEntering
 * DESCRIPTION
 *  Check if MSG application is reentered
 * PARAMETERS
 *  void
 * RETURNS
 *  TRUE: MSG application is reentered, FALSE: MSG application is not reentered
 *****************************************************************************/
U8 IsMessagesReEntering(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] IsMessagesReEntering -------*\n");
    if (!mmi_frm_sms_check_action_pending())
    {
        U16 startScrnId = 0;
        U16 endScrnId = 0;

        PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] Messages not Busy  -------*\n");

    #if defined(MMS_SUPPORT)
    #ifdef OBIGO_Q03C
        if (IsScreenPresent(wap_get_screen_id()))
    #else
        if ((IsScreenPresent(wap_get_screen_id())) && (!IsScreenPresent(SCR_ID_MSG_MAIN_MENU_NO_MMS)))
    #endif 
        {
            U16 ScrnId = 0;

            PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                                 "*---[SmsMoMtGuiInterface.c] WAP screen exists and SCR_ID_MSG_MAIN_MENU_NO_MMS not exists   ---*\n");

            if (IsScreenPresent(SCR_ID_MSG_SMS_MAIN_MENU))
            {
                ScrnId = SCR_ID_MSG_SMS_MAIN_MENU;
            }
        #ifdef __MMI_UNIFIED_MESSAGE__
            else if (IsScreenPresent(SCR_ID_UM_MAIN))
            {
                ScrnId = SCR_ID_UM_MAIN;
            }
            else if (IsScreenPresent(SCR_ID_UM_INBOX))
            {
                ScrnId = SCR_ID_UM_INBOX;
            }
            else if (IsScreenPresent(SCR_ID_UM_UNSENT))
            {
                ScrnId = SCR_ID_UM_UNSENT;
            }
            else if (IsScreenPresent(SCR_ID_UM_SENT))
            {
                ScrnId = SCR_ID_UM_SENT;
            }
            else if (IsScreenPresent(SCR_ID_UM_DRAFT))
            {
                ScrnId = SCR_ID_UM_DRAFT;
            }
        #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
            else if (IsScreenPresent(SCR_ID_UM_ARCHIVE))
            {
                ScrnId = SCR_ID_UM_ARCHIVE;
            }
        #endif /* __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__ */
        #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
            else if (IsScreenPresent(SCR_ID_UM_SIM))
            {
                ScrnId = SCR_ID_UM_SIM;
            }
        #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        #ifdef __MMI_UNIFIED_COMPOSER__
            else if (IsScreenPresent(SCR_ID_UC_EDITOR))
            {
                ScrnId = SCR_ID_UC_EDITOR;
            }
        #else /* __MMI_UNIFIED_COMPOSER__ */
            else if (IsScreenPresent(SCR_ID_UM_WRITE_MSG))
            {
                ScrnId = SCR_ID_UM_WRITE_MSG;
            }
        #endif /* __MMI_UNIFIED_COMPOSER__ */
        #else /* __MMI_UNIFIED_MESSAGE__ */             
            else if (IsScreenPresent(SCR_ID_MSG_INBOX_LIST))
            {
                ScrnId = SCR_ID_MSG_INBOX_LIST;
            }
            else if (IsScreenPresent(SCR_ID_MSG_OUTBOX_LIST))
            {
                ScrnId = SCR_ID_MSG_OUTBOX_LIST;
            }
        #endif /* __MMI_UNIFIED_MESSAGE__ */             
            else if (IsScreenPresent(SCR_ID_MSG_VOICE_MAIL_LIST))
            {
                ScrnId = SCR_ID_MSG_VOICE_MAIL_LIST;
            }
            else if (IsScreenPresent(SCR_ID_MSG_WRITE))
            {
                ScrnId = SCR_ID_MSG_WRITE;
            }
            else if (IsScreenPresent(SCR_ID_MSG_INBOX_MSG))
            {
                ScrnId = SCR_ID_MSG_INBOX_MSG;
            }
            else if (IsScreenPresent(SCR_ID_MSG_DEFAULT_MSG))
            {
                ScrnId = SCR_ID_MSG_DEFAULT_MSG;
            }
        #ifdef __MMI_MESSAGES_CHAT__
            else if (IsScreenPresent(CHAT_SCREEN_ROOM_ID))
            {
                ScrnId = CHAT_SCREEN_ROOM_ID;
            }
        #endif /* __MMI_MESSAGES_CHAT__ */ 
            if (ScrnId)
            {
                PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*---[SmsMoMtGuiInterface.c] sms screen exists   ---*\n");
                return TRUE;
            }
            return FALSE;
        }
        else
    #endif /* defined(MMS_SUPPORT) */ 
        {
            /* get start screen id */
            if (IsScreenPresent(SCR_ID_MSG_MAIN_MENU_NO_MMS))
            {
                startScrnId = SCR_ID_MSG_MAIN_MENU_NO_MMS;
            }
            else if (IsScreenPresent(SCR_ID_MSG_MAIN_MENU))
            {
                startScrnId = SCR_ID_MSG_MAIN_MENU;
            }
        #ifdef __MMI_UNIFIED_MESSAGE__
            else if (IsScreenPresent(SCR_ID_UM_MAIN))
            {
                startScrnId = SCR_ID_UM_MAIN;
            }
            else if (IsScreenPresent(SCR_ID_UM_INBOX))
            {
                startScrnId = SCR_ID_UM_INBOX;
            }
            else if (IsScreenPresent(SCR_ID_UM_UNSENT))
            {
                startScrnId = SCR_ID_UM_UNSENT;
            }
            else if (IsScreenPresent(SCR_ID_UM_SENT))
            {
                startScrnId = SCR_ID_UM_SENT;
            }
            else if (IsScreenPresent(SCR_ID_UM_DRAFT))
            {
                startScrnId = SCR_ID_UM_DRAFT;
            }
        #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
            else if (IsScreenPresent(SCR_ID_UM_ARCHIVE))
            {
                startScrnId = SCR_ID_UM_ARCHIVE;
            }
        #endif /* __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__ */
        #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
            else if (IsScreenPresent(SCR_ID_UM_SIM))
            {
                startScrnId = SCR_ID_UM_SIM;
            }
        #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        #ifdef __MMI_UNIFIED_COMPOSER__
            else if (IsScreenPresent(SCR_ID_UC_EDITOR))
            {
                startScrnId = SCR_ID_UC_EDITOR;
            }
        #else /* __MMI_UNIFIED_COMPOSER__ */
            else if (IsScreenPresent(SCR_ID_UM_WRITE_MSG))
            {
                startScrnId = SCR_ID_UM_WRITE_MSG;
            }
        #endif /* __MMI_UNIFIED_COMPOSER__ */
        #else /* __MMI_UNIFIED_MESSAGE__ */ 
            else if (IsScreenPresent(SCR_ID_MSG_INBOX_LIST))
            {
                startScrnId = SCR_ID_MSG_INBOX_LIST;
            }
            else if (IsScreenPresent(SCR_ID_MSG_OUTBOX_LIST))
            {
                startScrnId = SCR_ID_MSG_OUTBOX_LIST;
            }
        #endif /* __MMI_UNIFIED_MESSAGE__ */ 
            else if (IsScreenPresent(SCR_ID_MSG_WRITE))
            {
                startScrnId = SCR_ID_MSG_WRITE;
            }            
            else if (IsScreenPresent(SCR_ID_MSG_VOICE_MAIL_LIST))
            {
                startScrnId = SCR_ID_MSG_VOICE_MAIL_LIST;
            }
            else if (IsScreenPresent(SCR_ID_MSG_INBOX_MSG))
            {
                startScrnId = SCR_ID_MSG_INBOX_MSG;
            }
            else if (IsScreenPresent(SCR_ID_MSG_DEFAULT_MSG))
            {
                startScrnId = SCR_ID_MSG_DEFAULT_MSG;
            }
        #ifdef __MMI_MESSAGES_CHAT__
            else if (IsScreenPresent(CHAT_SCREEN_ROOM_ID))
            {
                startScrnId = CHAT_SCREEN_ROOM_ID;
            }
        #endif /* __MMI_MESSAGES_CHAT__ */ 
            if (startScrnId)
            {
                PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                                     "*---[MessagesMiscell.c] Start scrn id to be deleteted %d ---*\n", startScrnId);
                GetPreviousScrnIdOf(GetCmMarkerScrnID(), &endScrnId);
                if (endScrnId)
                {
                    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                                         "*---[MessagesMiscell.c] End scrn id to be deleteted %d ---*\n", endScrnId);
                    if (DeleteBetweenScreen(startScrnId, endScrnId))
                    {
                        g_msg_cntx.toDisplayMessageList = TO_DISPLAY_MESSAGE_LIST_NONE;
                        mmi_frm_sms_delete_action_pending();
                        PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                                             "*---[MessagesMiscell.c] Deleteted scrn id from %d to %d and action---*\n",
                                             startScrnId, endScrnId);
                        return FALSE;
                    }
                }
            }
            PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*---[MessagesMiscell.c] Not deleteted scrn id from %d to %d ---*\n",
                                 startScrnId, endScrnId);
            return FALSE;
        }
    }
    else
    {
        PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[SmsMoMtGuiInterface.c] Messages state = %d", g_msg_cntx.msg_status);
        return TRUE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  PreEntryScrMessagesMenuList
 * DESCRIPTION
 *  Before entry messages main menu, check if MSG application is reentered.
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void PreEntryScrMessagesMenuList(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] PreEntryScrMessagesMenuList -------*\n");

#ifdef __MMI_UNIFIED_MESSAGE__
    if (!mmi_um_is_available())
    {
        DisplayPopup(
            (PU8) GetString(mmi_um_get_not_available_string_id()),
            IMG_GLOBAL_ERROR,
            1,
            MESSAGES_POPUP_TIME_OUT,
            (U8) ERROR_TONE);
    }
#else /* __MMI_UNIFIED_MESSAGE__ */ 
    if (IsMessagesReEntering())
    {
        DisplayPopup(
            (PU8) GetString(STR_SMS_MSG_NOT_READY_YET),
            IMG_GLOBAL_UNFINISHED,
            1,
            MESSAGES_POPUP_TIME_OUT,
            (U8) ERROR_TONE);
    }
#endif /* __MMI_UNIFIED_MESSAGE__ */ 
    else
    {
        EntryScrMessagesMenuList();
    }

}


/*****************************************************************************
 * FUNCTION
 *  EntryScrMessagesMenuList
 * DESCRIPTION
 *  Entry messages main menu screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EntryScrMessagesMenuList(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    U16 numItems = 0;
    U16 nStrItemList[MAX_SUB_MENUS];
    U16 itemIcons[MAX_SUB_MENUS];
    U16 screenId = SCR_ID_MSG_MAIN_MENU;
    U16 left_softkey = STR_GLOBAL_OK;

#ifdef __MMI_MESSAGES_MULTI_APP__
    /* S32 menuItemId=-1; */
#else /* __MMI_MESSAGES_MULTI_APP__ */ 
    U8 *popUpList[MAX_SUB_MENUS];

    //S32 menuItemId=-1;
    //S32 menuItemId1=-1;
#endif /* __MMI_MESSAGES_MULTI_APP__ */ 
    /* S32 maskingByte=-1; */
    U8 **pPopUpList = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#if defined(__MMI_SMART_MESSAGE_MT__)
    mmi_nsm_set_msg_type(NORMAL_MESSAGE);
#endif 

    AlmEnableSPOF();

#if defined(MMS_SUPPORT)
    if (((isInCall() && !GetWapCallPresent())) || (IsScreenPresent(wap_get_screen_id())))
    {
        screenId = SCR_ID_MSG_MAIN_MENU_NO_MMS;
    }
#endif /* defined(MMS_SUPPORT) */ 

    EntryNewScreen(screenId, mmi_msg_exit_generic, EntryScrMessagesMenuList, NULL);
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] EntryScrMessagesMenuList %d-------*\n",
                         screenId);
    SetParentHandler(MAIN_MENU_MESSAGES_MENUID);
    RegisterHighlightHandler(ExecuteCurrHiliteHandler);

    mmi_msg_set_msg_menu_highlight_handler();
#ifdef __MMI_DUAL_SIM_MASTER__
	mmi_cphs_rearrange_message_main_menu(SIM1);
	mmi_cphs_rearrange_message_main_menu(SIM2);
#endif /* __MMI_DUAL_SIM_MASTER__ */
#ifdef __MMI_MESSAGES_MULTI_APP__
#if defined(MMS_SUPPORT)
    //menuItemId=GetChildMenuIDIndexByParentMenuID(MAIN_MENU_MESSAGES_MENUID, MESSAGES_MENU_MMS_MENUID);
    //if(menuItemId!=-1)
    //{
    if (((isInCall() && !GetWapCallPresent())) || (IsScreenPresent(wap_get_screen_id())))
        /* ResetBit(maskingByte,menuItemId); */
    {
        mmi_frm_hide_menu_item(MESSAGES_MENU_MMS_MENUID);
    }
    else
    {
        if (mmi_bootup_is_sim_valid()
		#ifdef __MMI_DUAL_SIM_MASTER__
			|| (mmi_bootup_is_sim2_valid())
		#endif /* __MMI_DUAL_SIM_MASTER__ */
    #ifdef __MMI_WLAN_FEATURES__
        && mmi_netset_get_active_preferred_mode() != P_WLAN_ONLY /* not WLAN only */ 
    #endif
        )
        {
            /* Message menu is shown if WLAN is on, not unhide the MMS menu if there is no SIM */
            mmi_frm_unhide_menu_item(MESSAGES_MENU_MMS_MENUID);
        }
    }
    /* } */
#endif /* defined(MMS_SUPPORT) */ 

#if defined(__MMI_EMAIL__)
    //menuItemId=GetChildMenuIDIndexByParentMenuID(MAIN_MENU_MESSAGES_MENUID, MENU_ID_EMAIL_MAIN);
    //if(menuItemId!=-1)
    //{

    if (isInCall() && (!GetWapCallPresent()))  /* CSD call */
        /* ResetBit(maskingByte,menuItemId); */
    {
        mmi_frm_hide_menu_item(MENU_ID_EMAIL_MAIN);
    }
    else
    {
        if (mmi_email_bearer_status_show_icon())
        {
            mmi_frm_unhide_menu_item(MENU_ID_EMAIL_MAIN);
        }
        else
        {
            mmi_frm_hide_menu_item(MENU_ID_EMAIL_MAIN);
        }
    }
    /* } */
#endif /* defined(__MMI_EMAIL__) */ 

#if defined(__MMI_IMPS__)
    //menuItemId=GetChildMenuIDIndexByParentMenuID(MAIN_MENU_MESSAGES_MENUID, MENU_ID_IMPS_MAIN);
    //if(menuItemId!=-1)
    //{
    if (isInCall() && (!GetWapCallPresent()))  /* CSD call */
        /* ResetBit(maskingByte,menuItemId); */
    {
        mmi_frm_hide_menu_item(MENU_ID_IMPS_MAIN);
    }
    else
    {
        mmi_frm_unhide_menu_item(MENU_ID_IMPS_MAIN);
    }
    /* } */
#endif /* defined(__MMI_IMPS__) */ 

#else /* __MMI_MESSAGES_MULTI_APP__ */ 
    /* hint updation */
    if (mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_NOBOX) != MMI_FRM_SMS_INVALID_INDEX)
    {
        msgbox_info.totalinbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX);
        msgbox_info.totaloutbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_OUTBOX);
        msgbox_info.totaldraftbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_DRAFTS);
        mmi_msg_set_msg_num_hint(msgbox_info.totalinbox, msgbox_info.totaloutbox, msgbox_info.totaldraftbox);
        RefreshMessagesMenuList();
    }
    ConstructHintsList(MAIN_MENU_MESSAGES_MENUID, popUpList);

    if (mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_NOBOX) != MMI_FRM_SMS_INVALID_INDEX)
    {
        pPopUpList = popUpList;
    }
    else
    {
        pPopUpList = NULL;
    }

    /* diamond, 2005/07/01 removed for new menu item architecture to CPHS */
#if 0
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
/* under construction !*/
#endif /* 0 */ 

#endif /* __MMI_MESSAGES_MULTI_APP__ */ /* MMS_SUPPORT */

    //MaskItems(itemIcons,(U8)numItems,maskingByte);
    //MaskHiliteItems(MAIN_MENU_MESSAGES_MENUID, maskingByte);
    //numItems=MaskItems(nStrItemList,(U8)numItems,maskingByte);

    /* diamond, 2005/07/01 add _Ext to menu item functions */
    numItems = GetNumOfChild_Ext(MAIN_MENU_MESSAGES_MENUID);
    GetSequenceStringIds_Ext(MAIN_MENU_MESSAGES_MENUID, nStrItemList);
    GetSequenceImageIds_Ext(MAIN_MENU_MESSAGES_MENUID, itemIcons);

    /* If the number of menu is 0, left softkey will is empty*/
    if (numItems == 0)
    {
        left_softkey = 0;
    }
    g_msg_cntx.currBoxIndex = 0;
    g_msg_cntx.sendMessageCase = SEND_CASE_SEND_ONLY;
    g_msg_cntx.PhbSmsInterfaceState = MMI_SEND_ONLY;
    SetMessagesCurrScrnID(screenId);
    guiBuffer = GetCurrGuiBuffer(screenId);
    /* MTK Leo add, mini_tab_bar */
#ifdef __MMI_WGUI_MINI_TAB_BAR__
    wgui_enable_mini_tab_bar(MAIN_MENU_MESSAGES_MENUID);
#endif 
    /* MTK Leo end */

#ifdef __MMI_UNIFIED_MESSAGE__
    ShowCategory52Screen(
        STR_UM_MAIN_MENU_TITLE_ID,
        IMG_SMS_ENTRY_SCRN_CAPTION,
        left_softkey,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        numItems,
        nStrItemList,
        itemIcons,
        (U8 **) pPopUpList,
        0,
        0,
        guiBuffer);
#else /* __MMI_UNIFIED_MESSAGE__ */ 
    ShowCategory52Screen(
        STR_MESSAGE_MAIN_MENU_CAPTION,
        IMG_SMS_ENTRY_SCRN_CAPTION,
        left_softkey,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        numItems,
        nStrItemList,
        itemIcons,
        (U8 **) pPopUpList,
        0,
        0,
        guiBuffer);
#endif /* __MMI_UNIFIED_MESSAGE__ */ 

    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
}

/* SMS use number       // */
static BOOL IsValidPhnumChar(S32 ch);


/*****************************************************************************
 * FUNCTION
 *  IsAPhoneNumber
 * DESCRIPTION
 *  Check if input is a number string
 * PARAMETERS
 *  number      [?]         
 *  a(?)        [IN]        String
 * RETURNS
 *  1: input is a number string, 0: input is not a number string
 *****************************************************************************/
int IsAPhoneNumber(S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    int c = *number;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] IsAPhoneNumber -------*\n");
    if (c != '*' && c != '#' && c != '+' && !IS_NUM(c))
    {
        return 0;
    }
    do
    {
        number += ENCODING_LENGTH;
        c = *number;
        if (c && !IS_NUM(c) && !IsValidPhnumChar(c))
        {
            return 0;
        }
    }
    while (c);
    return 1;
}


/*****************************************************************************
 * FUNCTION
 *  IsValidPhnumChar
 * DESCRIPTION
 *  Some special characters should be in use number list as well
 * PARAMETERS
 *  ch          [IN]        
 *  a(?)        [IN]        Character
 * RETURNS
 *  1: input is a number string, 0: input is not a number string
 *****************************************************************************/
static BOOL IsValidPhnumChar(S32 ch)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    BOOL ret_value;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (ch)
    {
        case '+':
        case '*':
        case '#':
        case 'p':
        case 'P':
        case 'w':
        case 'W':
            ret_value = TRUE;
            break;
        default:
            ret_value = FALSE;
            break;
    }
    return ret_value;
}


/*****************************************************************************
 * FUNCTION
 *  GetPhoneNumber
 * DESCRIPTION
 *  Get phone number if input is not a number string
 * PARAMETERS
 *  number      [?]         
 *  a(?)        [IN]        String
 * RETURNS
 *  number string
 *****************************************************************************/
S8 *GetPhoneNumber(S8 *number)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*-------[SmsMoMtGuiInterface.c] GetPhoneNumber -------*\n");
    if (number && !IsAPhoneNumber(number))
    {
        number = lookUpName(number);
    }
    return number;
}


/*****************************************************************************
 * FUNCTION
 *  AlreadyExists
 * DESCRIPTION
 *  Check if input number string already exists in use number list
 * PARAMETERS
 *  thisNum     [?]         
 *  n           [IN]        
 *  a(?)        [IN]        Number string
 *  b(?)        [IN]        Current use number amount
 * RETURNS
 *  1: input string exists in use number list, 0: input string doesn't exist in use number list
 *****************************************************************************/
int AlreadyExists(S8 *thisNum, int n)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    n--;
    for (; n >= 0; n--)
    {
        if (!mmi_ucs2cmp(thisNum, g_msg_cntx.numbersList[n]))
        {
            return 1;
        }
    }
    return 0;
}


/*****************************************************************************
 * FUNCTION
 *  GetAsciiOrUCS2Char
 * DESCRIPTION
 *  Get Ascii or UCS2 character
 * PARAMETERS
 *  buf         [?]         
 *  a(?)        [IN]        Address of string
 * RETURNS
 *  the description of return value, if any.
 *****************************************************************************/
S16 GetAsciiOrUCS2Char(S8 *buf)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (*buf + ((*(buf + 1)) << 8));
}


/*****************************************************************************
 * FUNCTION
 *  GetAsciiOrUCS2Char_RV
 * DESCRIPTION
 *  Get Ascii or UCS2 character
 * PARAMETERS
 *  buf         [?]         
 *  a(?)        [IN]        Address of string
 * RETURNS
 *  the description of return value, if any.
 *****************************************************************************/
S16 GetAsciiOrUCS2Char_RV(U8 *buf)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return (*(buf + 1) + ((*buf) << 8));
}


/*****************************************************************************
 * FUNCTION
 *  PutAsciiOrUCS2Char
 * DESCRIPTION
 *  Put Ascii or UCS2 chatacter
 * PARAMETERS
 *  buf         [?]             
 *  c           [IN]            
 *  a(?)        [IN/OUT]        Address of string
 *  b(?)        [IN]            Input character
 * RETURNS
 *  the description of return value, if any.(?)
 *****************************************************************************/
void PutAsciiOrUCS2Char(S8 *buf, S16 c)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *buf++ = c & 0xff;
    *buf = c >> 8;
}


/*****************************************************************************
 * FUNCTION
 *  IsSymbolValid
 * DESCRIPTION
 *  Check if symbol is valid to insert use number
 * PARAMETERS
 *  c               [IN]        Current use number record length
 *  inBracket       [IN]        
 *  numIndex        [IN]        
 *  a(?)            [IN]        Input character
 *  b(?)            [IN]        Bracket waiting flag
 * RETURNS
 *  1: symbol is valid, 0: symbol is not valid
 *****************************************************************************/
static U8 IsSymbolValid(int c, U8 inBracket, U8 numIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 status = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (IS_NUM(c))
    {
        return 1;
    }

    numIndex = numIndex / ENCODING_LENGTH;

    switch (c)
    {
        case '+':
            if (numIndex == 0)
            {
                status = 1;
            }
            break;
        case '(':
            status = 1;
            break;
        case ')':
            if (inBracket)
            {
                status = 1;
            }
            break;
        case 'p':
        case 'w':
        case '-':
            if (numIndex >= USE_NUM_MIN_LENGTH)
            {
                status = 1;
            }
            break;
        default:
            status = 0;
    }

    return status;
}


/*****************************************************************************
 * FUNCTION
 *  TruncateLastUnwantedSymbols
 * DESCRIPTION
 *  Truncate use number last unwanted symbols
 * PARAMETERS
 *  buf         [?]             
 *  len         [IN]            
 *  a(?)        [IN/OUT]        Address of string
 *  b(?)        [IN]            String length
 * RETURNS
 *  void
 *****************************************************************************/
static void TruncateLastUnwantedSymbols(S8 *buf, int len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    int i, last = 0;
    int c;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < len; i += ENCODING_LENGTH)
    {
        c = GetAsciiOrUCS2Char(&buf[i]);
        if ((c != 'p') && (c != 'w') && (c != '-'))
        {
            last = i;
        }
    }
    if (i > last)
    {
        last += ENCODING_LENGTH;
    }
    PutAsciiOrUCS2Char(&buf[last], '\0');
}


/*****************************************************************************
 * FUNCTION
 *  ObtainNumbersFromMessageText
 * DESCRIPTION
 *  Obtain number list from message content
 * PARAMETERS
 *  phNumber        [?]         
 *  smsText         [?]         
 *  bufLen          [IN]        
 *  startindex      [IN]        
 *  a(?)            [IN]        Message phone number
 *  d(?)            [IN]        Number list start index
 *  c(?)            [IN]        Message length
 *  b(?)            [IN]        Message content
 * RETURNS
 *  current use number list amount
 *****************************************************************************/
U16 ObtainNumbersFromMessageText(char *phNumber, U8 *smsText, U16 bufLen, U8 startindex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    int i;
    int c;
    S8 thisNum[(MAX_DIGITS + 1) * ENCODING_LENGTH];
    int pickNow = 0;
    U8 inBracket = 0;
    int thisNumIndex = 0;
    int currNumListIndex = startindex;
    U8 maxNumLen = MAX_DIGITS;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_ucs2strlen((S8*) phNumber))
    {
        phNumber = GetPhoneNumber(phNumber);

        if (phNumber)
        {
            if (g_msg_cntx.numbersList[currNumListIndex])
            {
                OslMfree(g_msg_cntx.numbersList[currNumListIndex]);
            }

            g_msg_cntx.numbersList[currNumListIndex] = OslMalloc((mmi_ucs2strlen(phNumber) + 2) * ENCODING_LENGTH);
            mmi_ucs2cpy((S8*) g_msg_cntx.numbersList[currNumListIndex], phNumber);
            currNumListIndex++;
        }
    }
    if (currNumListIndex == MAX_USE_NUMBERS)
    {
        return (U16) currNumListIndex;
    }

    for (i = 0; i < bufLen;)
    {
        c = GetAsciiOrUCS2Char((S8*) & smsText[i]);
        i += ENCODING_LENGTH;
        if (IsSymbolValid(c, inBracket, (U8) thisNumIndex) && (thisNumIndex < (maxNumLen - 1) * ENCODING_LENGTH))
        {
            /* if first character is '+',  maxNumLen need to be change to make sure the length of the number is (MAX_DIGITS -1)*/
            if (thisNumIndex == 0 && c == '+')
            {
                maxNumLen = MAX_DIGITS + 1;
            }
            if ((c != '-') && (c != '(') && (c != ')'))
            {
                PutAsciiOrUCS2Char(&thisNum[thisNumIndex], (S16) c);
                thisNumIndex += ENCODING_LENGTH;
            }
            if (c == '(')
            {
                inBracket++;
            }
            else if ((c == ')') && inBracket)
            {
                inBracket--;
            }
        }
        else
        {
            pickNow = 1;
            while (thisNumIndex && (i < bufLen))
            {
                if (!IS_NUM(c))
                {
                    /* to handle the scenario number'+'number  ex. "123+123"  should be parsed as 123 and +123, instead of 123 */
                    if (c == '+')
                    {
                        i -= ENCODING_LENGTH;
                    }
                }
                /* a stream of number that exceeds 40 digits, the number starting from 41 digits will become the next use number */
                else    /* c is a num */
                {
                    i -= ENCODING_LENGTH;
                }
                break;
                // c = GetAsciiOrUCS2Char((S8*) & smsText[i]);
                // i += ENCODING_LENGTH;
            }
        }

        if (i >= bufLen)
        {
            pickNow = 1;
        }

        if (pickNow)
        {
            int c1 = 0;

            pickNow = 0;
            if (thisNumIndex && ((c1 = GetAsciiOrUCS2Char((S8*) & thisNum[thisNumIndex - ENCODING_LENGTH])) == 'w')
                || (c1 == 'p'))
            {
                TruncateLastUnwantedSymbols(thisNum, thisNumIndex);
            }

            PutAsciiOrUCS2Char(&thisNum[thisNumIndex], '\0');
            if (!AlreadyExists(thisNum, currNumListIndex))
            {
                if (thisNumIndex >= (USE_NUM_MIN_LENGTH * ENCODING_LENGTH))
                {
                    if (g_msg_cntx.numbersList[currNumListIndex])
                    {
                        OslMfree(g_msg_cntx.numbersList[currNumListIndex]);
                    }

                    g_msg_cntx.numbersList[currNumListIndex] = OslMalloc((mmi_ucs2strlen(thisNum) + 2) * ENCODING_LENGTH);
                    mmi_ucs2cpy((S8*) g_msg_cntx.numbersList[currNumListIndex], thisNum);
                    currNumListIndex++;
                    if (currNumListIndex == MAX_USE_NUMBERS)
                    {
                        break;
                    }
                }
            }
            thisNumIndex = 0;
            maxNumLen = MAX_DIGITS;
        }
    }
    return (U16) currNumListIndex;
}

#ifdef __MMI_MESSAGES_CHAT__


/*****************************************************************************
 * FUNCTION
 *  ObtainChatNumbersFromMessageTextWrapper
 * DESCRIPTION
 *  Obtain number list from chat message content
 * PARAMETERS
 *  phNumber            [?]         
 *  chatroomindex       [IN]        
 *  a(?)                [IN]        Message phone number
 *  b(?)                [IN]        Message room index
 * RETURNS
 *  current use number list amount
 *****************************************************************************/
U16 ObtainChatNumbersFromMessageTextWrapper(char *phNumber, S16 chatroomindex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 bufLen = 0;
    U8 *smsText = NULL;
    S16 j;
    U16 currindex = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (j = 0; j < GetNumOfMessage(chatroomindex); j++)
    {
        smsText = GetMemoryPointer(j, chatroomindex);
        bufLen = (S16) mmi_ucs2strlen((PS8) smsText);
        bufLen = bufLen * ENCODING_LENGTH;
        if (j == 0)
        {
            currindex = ObtainNumbersFromMessageText(phNumber, smsText, bufLen, 0);
        }
        else
        {
            currindex = ObtainNumbersFromMessageText(NULL, smsText, bufLen, (U8) currindex);
        }
        if (currindex == MAX_USE_NUMBERS)
        {
            return currindex;
        }
    }
    /* chat room message content is empty but the destination number should still be displayed in the use number list */
    if (GetNumOfMessage(chatroomindex) == 0)
    {
        if (mmi_ucs2strlen((S8*) phNumber))
        {
            phNumber = GetPhoneNumber(phNumber);
            if (phNumber)
            {
                if (g_msg_cntx.numbersList[currindex])
                {
                    OslMfree(g_msg_cntx.numbersList[currindex]);
                }

                g_msg_cntx.numbersList[currindex] = OslMalloc((mmi_ucs2strlen(phNumber) + 2) * ENCODING_LENGTH);
                mmi_ucs2cpy((S8*) g_msg_cntx.numbersList[currindex], phNumber);
                currindex++;
            }
        }
    }
    return currindex;
}


/*****************************************************************************
 * FUNCTION
 *  GetNewChatSmsIndDisplayStr
 * DESCRIPTION
 *  Get chat message indication string for dislpay
 * PARAMETERS
 *  void
 * RETURNS
 *  NewChatMessageFromXxxStr
 *****************************************************************************/
PU8 GetNewChatSmsIndDisplayStr(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION("*-------[MessagesIdleApp.c] GetNewSmsIndDisplayStr -------*\n");
    return NewChatMessageFromXxxStr;
}


/*****************************************************************************
 * FUNCTION
 *  GetNewChatMsgIndDisplayString
 * DESCRIPTION
 *  Compose new chat message indication string
 * PARAMETERS
 *  number      [?]         
 *  length      [IN]        
 *  type        [IN]        
 *  a(?)        [IN]        Message phone number
 *  c(?)        [IN]        Message number type
 *  b(?)        [IN]        Message number length
 * RETURNS
 *  void
 *****************************************************************************/
void GetNewChatMsgIndDisplayString(U8 *number, U8 length, U8 type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION("*-------[MessagesIdleApp.c] GetNewMsgIndDisplayString -------*\n");
    memset(&NewChatMessageFromXxxStr, 0, sizeof(NewChatMessageFromXxxStr));
    if (length)
    {
        PS8 phbName = NULL;
        PU8 pPhoneNumberPtr = ConvertL4NumberStructToDisplay(number, length, type);

        phbName = lookUpNumber((S8*) pPhoneNumberPtr);
        if (phbName != NULL)
        {
            if (mmi_ucs2cmp(phbName, ""))
            {
                mmi_ucs2ncpy(
                    (PS8) NewChatMessageFromXxxStr,
                    (PS8) phbName,
                    (U32) (sizeof(NewChatMessageFromXxxStr) / ENCODING_LENGTH) - 1);
            }
            else
            {
                mmi_ucs2ncat(
                    (PS8) NewChatMessageFromXxxStr,
                    (PS8) pPhoneNumberPtr,
                    (U32) (sizeof(NewChatMessageFromXxxStr) / ENCODING_LENGTH) - 1);
            }
        }
        else
        {
            mmi_ucs2ncat(
                (PS8) NewChatMessageFromXxxStr,
                (PS8) pPhoneNumberPtr,
                (U32) (sizeof(NewChatMessageFromXxxStr) / ENCODING_LENGTH) - 1);
        }
        if (pPhoneNumberPtr)
        {
            OslMfree(pPhoneNumberPtr);
            pPhoneNumberPtr = NULL;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  DeleteChatMsg
 * DESCRIPTION
 *  Delete chat message
 * PARAMETERS
 *  index       [IN]        
 *  a(?)        [IN]        Message index
 * RETURNS
 *  void
 *****************************************************************************/
void DeleteChatMsg(S32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_ind_chat_index = (U16) index;
}


/*****************************************************************************
 * FUNCTION
 *  GetConcatenatedMessage
 * DESCRIPTION
 *  Concatenate message for chat room screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void GetConcatenatedMessage(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMSData *pEMSdata;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    GetEMSDataForView(&pEMSdata, 1);    /* force to clear old content and initialize */

    EMSUnPack(pEMSdata, 1, PendingSaveSendData.totalSegments, PendingSaveSendData.TPUD_p, PendingSaveSendData.TPUDLen, PendingSaveSendData.dcs);
    return;
}
#endif /* __MMI_MESSAGES_CHAT__ */ 

#ifdef __MMI_MESSAGES_TEMPLATE__


/*****************************************************************************
 * FUNCTION
 *  ReadTemplateFromNVRAM
 * DESCRIPTION
 *  Read template from NVRAM
 * PARAMETERS
 *  index       [IN]        
 *  a(?)        [IN]        Index
 * RETURNS
 *  void
 *****************************************************************************/
void ReadTemplateFromNVRAM(U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 error;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (index >= NVRAM_SMS_RECORD_TOTAL)
    {
        PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "### ERROR: ReadTemplateFromNVRAM: index out of bound");
        return;
    }

    memset(g_msg_cntx.scratchTemplRec, 0, NVRAM_SMS_TEMPL_RECORD_SIZE + ENCODING_LENGTH);
    if (ReadRecord(NVRAM_EF_SMS_LID, (U16) (index + 1), g_msg_cntx.scratchTemplRec, NVRAM_SMS_TEMPL_RECORD_SIZE, &error)
        < 0)
    {
        g_msg_cntx.scratchTemplRec[0] = '\0';
    }
    return;
}


/*****************************************************************************
 * FUNCTION
 *  WriteTemplateToNVRAM
 * DESCRIPTION
 *  Write template to NVRAM
 * PARAMETERS
 *  index       [IN]        
 *  a(?)        [IN]        Index
 * RETURNS
 *  TRUE: write success, FALSE: write fail
 *****************************************************************************/
U8 WriteTemplateToNVRAM(U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S16 error;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (index >= NVRAM_SMS_RECORD_TOTAL)
    {
        return FALSE;
    }

    if (WriteRecord
        (NVRAM_EF_SMS_LID, (U16) (index + 1 + 1), g_msg_cntx.scratchTemplRec, NVRAM_SMS_TEMPL_RECORD_SIZE,
         &error) != NVRAM_SMS_TEMPL_RECORD_SIZE)
    {
        return FALSE;
    }
    return TRUE;
}

#if defined(_MUTILANG_TEMPLATE_) || defined(__MMI_MESSAGES_SIMCHINESE_TEMPLATE__)


/*****************************************************************************
 * FUNCTION
 *  SetTemplateLanguage
 * DESCRIPTION
 *  Set template language
 * PARAMETERS
 *  langtype        [IN]        
 *  a(?)            [IN]        Language type
 * RETURNS
 *  void
 *****************************************************************************/
void SetTemplateLanguage(U8 langtype)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    S16 error;
    S8 tempLang[SSC_SIZE];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(tempLang, 0, SSC_SIZE);
    switch (langtype)
    {
        case MSG_TEMPLATE_LANG_ENGLISH:
            memcpy(tempLang, SSC_ENGLISH, SSC_SIZE);
            break;
        case MSG_TEMPLATE_LANG_SIMCHINESE:
            memcpy(tempLang, SSC_SCHINESE, SSC_SIZE);
            break;
        case MSG_TEMPLATE_LANG_TRACHINESE:
            memcpy(tempLang, SSC_TCHINESE, SSC_SIZE);
            break;
    }
    for (i = 0; i < MAX_LANGUAGES; i++)
    {
        if (strcmp((PS8) gLanguageArray[i].aLangSSC, (S8*) tempLang) == 0)
        {
            if (gCurrLangIndex != i)
            {
                SetCurrentLanguage(i);
                WriteValue(NVRAM_SETTING_LANG, &i, DS_BYTE, &error);
                break;
            }
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  UnsetTemplateLanguage
 * DESCRIPTION
 *  Unset template language
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void UnsetTemplateLanguage(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 i = 0;
    S16 error;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < MAX_LANGUAGES; i++)
    {
        if (strcmp((PS8) gLanguageArray[i].aLangSSC, (PS8) currLang) == 0)
        {
            if (gCurrLangIndex != i)
            {
                SetCurrentLanguage(i);
                WriteValue(NVRAM_SETTING_LANG, &i, DS_BYTE, &error);
                break;
            }
        }
    }
}
#endif /* defined(_MUTILANG_TEMPLATE_) || defined(__MMI_MESSAGES_SIMCHINESE_TEMPLATE__) */ 


/*****************************************************************************
 * FUNCTION
 *  WriteDefaultTemplateToNVRAM
 * DESCRIPTION
 *  Write default template to NVRAM
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
U8 WriteDefaultTemplateToNVRAM(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i = 0;
    S8 *tmpl_str;
    U8 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < NUM_TEMPLATES; i++)
    {
        U16 templateindex = i + CalTemplateBase();

        tmpl_str = GetString(templateStrings[i]);
        memset(g_msg_cntx.scratchTemplRec, 0, NVRAM_SMS_TEMPL_RECORD_SIZE + ENCODING_LENGTH);
        if (tmpl_str)
        {
            memcpy(g_msg_cntx.scratchTemplRec, tmpl_str, (mmi_ucs2strlen(tmpl_str) + 1) * ENCODING_LENGTH);
        }
        result = WriteTemplateToNVRAM(templateindex);
        if (result == FALSE)
        {
            return FALSE;
        }
    }
    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  InitTemplates
 * DESCRIPTION
 *  Init templates
 * PARAMETERS
 *  void
 * RETURNS
 *  TRUE: init success, FALSE: init fail
 *****************************************************************************/
U8 InitTemplates(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    static int initDone = 0;
    static S8 templateSignature[MAX_TEMPLATE_LENGTH + 1] = "AAA";
    S8 buffer[NVRAM_SMS_TEMPL_RECORD_SIZE];
    S16 error;
    int i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (initDone)
    {
        return TRUE;
    }

    initDone = 1;

    if (ReadRecord(NVRAM_EF_SMS_LID, 1, buffer, NVRAM_SMS_TEMPL_RECORD_SIZE, &error) < 0)
    {
        buffer[0] = '\0';
    }

    if (buffer[0] == 'A')
    {
        return TRUE;
    }

#if defined (_MUTILANG_TEMPLATE_) || defined (__MMI_MESSAGES_SIMCHINESE_TEMPLATE__)
    memset(currLang, 0, SSC_SIZE);
    memcpy(currLang, (PS8) gLanguageArray[gCurrLangIndex].aLangSSC, SSC_SIZE);
#ifdef _MUTILANG_TEMPLATE_
    for (i = 0; i < TOTAL_TEMPLATE_LANGUAGE; i++)
    {
        SetTemplateLanguage((U8) i);
        if (!WriteDefaultTemplateToNVRAM())
        {
            return FALSE;
        }
    }
#else /* _MUTILANG_TEMPLATE_ */ 
    SetTemplateLanguage(MSG_TEMPLATE_LANG_SIMCHINESE);
    if (!WriteDefaultTemplateToNVRAM())
    {
        return FALSE;
    }
#endif /* _MUTILANG_TEMPLATE_ */ 
    UnsetTemplateLanguage();
#else /* defined (_MUTILANG_TEMPLATE_) || defined (__MMI_MESSAGES_SIMCHINESE_TEMPLATE__) */ 
    if (!WriteDefaultTemplateToNVRAM())
    {
        return FALSE;
    }
#endif /* defined (_MUTILANG_TEMPLATE_) || defined (__MMI_MESSAGES_SIMCHINESE_TEMPLATE__) */ 

    if (WriteRecord(NVRAM_EF_SMS_LID, 1, templateSignature, NVRAM_SMS_TEMPL_RECORD_SIZE, &error) <
        NVRAM_SMS_TEMPL_RECORD_SIZE)
    {
        return FALSE;
    }

    return TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  DeInitTemplates
 * DESCRIPTION
 *  Deinit templates
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void DeInitTemplates(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    int i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < NUM_TEMPLATES; i++)
    {
        if (g_msg_cntx.templates[i])
        {
            OslMfree(g_msg_cntx.templates[i]);
            g_msg_cntx.templates[i] = NULL;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  LoadTemplatesInDisplayList
 * DESCRIPTION
 *  Load templates to display list
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void LoadTemplatesInDisplayList(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 i;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    DeInitTemplates();
    for (i = 0; i < NUM_TEMPLATES; i++)
    {
        U16 templateindex = i + CalTemplateBase() + 1;

        ReadTemplateFromNVRAM(templateindex);
        g_msg_cntx.templates[i] = OslMalloc((mmi_ucs2strlen(g_msg_cntx.scratchTemplRec) + 1) * ENCODING_LENGTH);
        mmi_ucs2cpy(g_msg_cntx.templates[i], g_msg_cntx.scratchTemplRec);
    }
}


/*****************************************************************************
 * FUNCTION
 *  GetTemplatesToEdit
 * DESCRIPTION
 *  Get templates to edit.
 * PARAMETERS
 *  buffer      [?]             
 *  index       [IN]            
 *  a(?)        [IN/OUT]        Address of string
 *  b(?)        [IN]            Current highlight index
 * RETURNS
 *  void
 *****************************************************************************/
void GetTemplatesToEdit(S8 *buffer, U32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_msg_cntx.templates[index])
    {
        mmi_ucs2cpy((PS8) buffer, (PS8) g_msg_cntx.templates[index]);
    }
    else
    {
        buffer[0] = buffer[1] = '\0';
    }
}


/*****************************************************************************
 * FUNCTION
 *  DeleteTemplate
 * DESCRIPTION
 *  Delete template
 * PARAMETERS
 *  index       [IN]        
 *  a(?)        [IN]        Index
 * RETURNS
 *  TRUE: delete success, FALSE: delete fail
 *****************************************************************************/
U8 DeleteTemplate(U32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 templateindex = (U16) index + CalTemplateBase();
    U8 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(g_msg_cntx.scratchTemplRec, 0, NVRAM_SMS_TEMPL_RECORD_SIZE + ENCODING_LENGTH);
    result = WriteTemplateToNVRAM(templateindex);
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  StoreTemplate
 * DESCRIPTION
 *  Store templates
 * PARAMETERS
 *  index       [IN]        
 *  a(?)        [IN]        Index
 *  b(?)        [IN]        Address of string
 * RETURNS
 *  TRUE: store success, FALSE: store fail
 *****************************************************************************/
U8 StoreTemplate(U32 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 templateindex = (U16) index + CalTemplateBase();
    U8 result;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    result = WriteTemplateToNVRAM(templateindex);
    return result;
}


/*****************************************************************************
 * FUNCTION
 *  CalTemplateBase
 * DESCRIPTION
 *  Calculate template base
 * PARAMETERS
 *  void
 * RETURNS
 *  template base
 *****************************************************************************/
U16 CalTemplateBase(void)
{
#ifdef _MUTILANG_TEMPLATE_
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 tempLangOffset = 0;
    U16 tempBase = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (IsTrChineseSet())
    {
        tempLangOffset = (U8) MSG_TEMPLATE_LANG_TRACHINESE;
    }
    else if (IsSmChineseSet())
    {
        tempLangOffset = (U8) MSG_TEMPLATE_LANG_SIMCHINESE;
    }
    else
    {
        tempLangOffset = (U8) MSG_TEMPLATE_LANG_ENGLISH;
    }
    tempBase = tempLangOffset * NUM_TEMPLATES;
    return tempBase;
#else /* _MUTILANG_TEMPLATE_ */ 
    return 0;
#endif /* _MUTILANG_TEMPLATE_ */ 
}

#endif /* __MMI_MESSAGES_TEMPLATE__ */ 


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_check_interrupt
 * DESCRIPTION
 *  check if there is an interrupt (incoming call ringing or alarm playing).
 * PARAMETERS
 *  void
 * RETURNS
 *  1: interrupt existed, 0: interrupt not existed
 *****************************************************************************/
U8 mmi_msg_check_interrupt(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (isIncomingCall() || AlmIsTonePlaying())
    {
        PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                             "*-------[MessagesMiscell.c] mmi_msg_check_interrupt return TRUE -------*\n");
        return TRUE;
    }
    else
    {
        return FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_check_ascii_number
 * DESCRIPTION
 *  check if the encoding of number string is ascii or not
 * PARAMETERS
 *  number_string       [?]         
 *  length              [IN]        
 * RETURNS
 *  KAL_TRUE: ascii encoding, KAL_FALSE: Otherwise
 *****************************************************************************/
kal_bool mmi_msg_check_ascii_number(U8 *number_string, U16 length)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    U8 *number = number_string;
    U16 len = length;
    int i = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    for (i = 0; i < len; i++)
    {
        if (number[i] == 0)
        {
            PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                                 "*-------[MessagesMiscell.c] mmi_msg_check_ascii_number return FALSE -------*\n");
            return KAL_FALSE;
        }
    }

    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                         "*-------[MessagesMiscell.c] mmi_msg_check_ascii_number return TRUE -------*\n");
    return KAL_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_clear_action_queue
 * DESCRIPTION
 *  check if the action queue is needed to be cleared to avoid the case that the screen
 *  is back to idle from input number editor without clearing the action queue.
 * PARAMETERS
 *  void
 * RETURNS
 *  1: cleared required, 0: cleared not required
 *****************************************************************************/
U8 mmi_msg_need_clear_action_queue(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_msg_cntx.msg_status != MSG_STATUS_IDLE)
    {
        return TRUE;
    }
    else
    {
        return FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_new_msg_ind
 * DESCRIPTION
 *  check if new msg indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  1: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_new_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Return false if the new msg is deleted by AT */
    if (g_msg_cntx.msg_ind_index == MMI_FRM_SMS_INVALID_INDEX || mmi_frm_sms_msg_box[g_msg_cntx.msg_ind_index].startindex == MMI_FRM_SMS_INVALID_INDEX)
    {
        g_msg_cntx.msg_ind_in_idle = FALSE;
        g_msg_cntx.msg_ind_after_call = FALSE;
        return KAL_FALSE;
    }
    else
    {
        return g_msg_cntx.msg_ind_in_idle;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_new_msg_ind_call_end
 * DESCRIPTION
 *  Check if new msg indication after call end is required
 * PARAMETERS
 *  void
 * RETURNS
 *  1: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_new_msg_ind_call_end(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_msg_cntx.msg_ind_after_call;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_reset_new_msg_ind_call_end
 * DESCRIPTION
 *  Reset new msg indication after call end
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_reset_new_msg_ind_call_end(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_ind_after_call = FALSE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_class0_msg_ind
 * DESCRIPTION
 *  Check if class 0 message indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  1: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_class0_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    return g_msg_cntx.msg_class0_ind;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_mem_full_ind
 * DESCRIPTION
 *  Check if msg full indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  1: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_mem_full_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_msg_cntx.msg_full_ind;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_mem_exceed_ind
 * DESCRIPTION
 *  Check if msg exceed indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  1: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_mem_exceed_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_msg_cntx.msg_exceed_ind;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_delivery_report_ind
 * DESCRIPTION
 *  Check if delivery report indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  non-0: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_delivery_report_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_msg_cntx.msg_deliver_ind;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_waiting_ind
 * DESCRIPTION
 *  Check if msg waiting indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  non-0: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_waiting_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_msg_cntx.msg_waiting_ind;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_msg_waiting_ind
 * DESCRIPTION
 *  Indicate msg waiting
 * PARAMETERS
 *  type        [IN]        
 *  a(?)        [IN]        Waiting msg type
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_msg_waiting_ind(U8 type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_waiting_ind = type + 1;
    TurnOnBacklight(GPIO_BACKLIGHT_SHORT_TIME);

    if (IsMMIInIdleState() || (GetMessagesCurrScrnID() == SCR_ID_MSG_MSG_WAITING_IND))
    {
        PlayMessageArrivalTone();
        ClearKeyEvents();
        if (IsKeyPadLockState())
        {
            EntryIdleScreen();
        }
        else
        {
            mmi_msg_entry_msg_waiting_ind();
        }
    }
    else
    {
        /* do not interrupt a call, otherwise, incoming call's video and sound may be interrupted */
        if (!isInCall() && !AlmIsTonePlaying())
        {
            mmi_msg_entry_new_msg_popup(g_msg_cntx.msg_waiting_ind);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_go_back_from_msg_waiting_ind
 * DESCRIPTION
 *  Reset msg waiting ind before go back screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_go_back_from_msg_waiting_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_waiting_ind = 0;
    if (strBuff != NULL)
    {
        OslMfree(strBuff);
        strBuff = NULL;
    }
    GoBackHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_end_key_from_msg_waiting_ind
 * DESCRIPTION
 *  Reset msg waiting ind before go to idle
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_end_key_from_msg_waiting_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_waiting_ind = 0;
    if (strBuff != NULL)
    {
        OslMfree(strBuff);
        strBuff = NULL;
    }
    ExecCurrEndKeyDownHandler();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_msg_waiting_msg
 * DESCRIPTION
 *  Get msg waiting msg
 * PARAMETERS
 *  void
 * RETURNS
 *  string for msg waiting indication
 *****************************************************************************/
U8 *mmi_msg_get_msg_waiting_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *tempStr = NULL;
    U8 ascii_num[16];
    U16 num = g_msg_cntx.msg_waiting_info[g_msg_cntx.msg_waiting_line_number].number[g_msg_cntx.msg_waiting_ind - 1];
#ifdef __MMI_DUAL_SIM_MASTER__
	U8 isSalve = g_msg_cntx.msg_waiting_info[g_msg_cntx.msg_waiting_line_number].isSlave;
#endif
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (strBuff != NULL)
    {
        OslMfree(strBuff);
        strBuff = NULL;
    }
    strBuff = OslMalloc(64);

	if (g_msg_cntx.msg_waiting_is_show_number)
	{

        memset(ascii_num, 0, 16);
        sprintf((S8*) ascii_num, "%d ", num);
        mmi_asc_to_ucs2((S8*) strBuff, (S8*) ascii_num);

        switch (g_msg_cntx.msg_waiting_ind)
        {
            case MSG_NEW_VOICEMAIL:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_VOICEMAIL_NUM_IND);
			#else
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_VOICEMAIL_NUM_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_VOICEMAIL_NUM_IND);
				}
			#endif
                break;
            case MSG_NEW_FAX:                
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_FAX_NUM_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_FAX_NUM_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_FAX_NUM_IND);
				}			
			#endif				
                break;
            case MSG_NEW_EMAIL:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_EMAIL_NUM_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_EMAIL_NUM_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_EMAIL_NUM_IND);
				}						
			#endif		
                break;
            case MSG_NEW_NETOTHER:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_VOICEMAIL_NUM_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_NET_OTHER_NUM_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_NET_OTHER_NUM_IND);
				}			
			#endif		
                break;
						
            default:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_VOICEMAIL_NUM_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_VOICEMAIL_NUM_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_VOICEMAIL_NUM_IND);
				}			
			#endif		
                break;
        }
        mmi_ucs2cat((S8*) strBuff, (S8*) tempStr);
    }
    else
    {
        switch (g_msg_cntx.msg_waiting_ind)
        {
            case MSG_NEW_VOICEMAIL:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_VOICEMAIL_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_VOICEMAIL_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_VOICEMAIL_IND);
				}		
			#endif
                break;
            case MSG_NEW_FAX:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_FAX_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_FAX_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_FAX_IND);
				}		
			#endif
				break;
            case MSG_NEW_EMAIL:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_EMAIL_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_EMAIL_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_EMAIL_IND);
				}		
			#endif
                break;
            case MSG_NEW_NETOTHER:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_VOICEMAIL_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_NET_OTHER_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_NET_OTHER_IND);
				}		
			#endif
                break;				
            default:
			#ifndef __MMI_DUAL_SIM_MASTER__
                tempStr = (U8*) GetString((U16) STR_VOICEMAIL_IND);
			#else				
				if (isSalve == FALSE)
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_MASTER_VOICEMAIL_IND);
				}
				else
				{
					tempStr = (U8*) GetString((U16) STRING_MTPNP_SLAVE_VOICEMAIL_IND);
				}		
			#endif
                break;
        }
        mmi_ucs2cpy((S8*) strBuff, (S8*) tempStr);    	
    }
    
    return strBuff;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_msg_waiting_ind
 * DESCRIPTION
 *  Entry msg waiting indication screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_msg_waiting_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *tempstr = mmi_msg_get_msg_waiting_msg();

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_MSG_WAITING_IND, mmi_msg_stop_msg_sub_anm, NULL, NULL);
    SetMessagesCurrScrnID(SCR_ID_MSG_MSG_WAITING_IND);
    ForceSubLCDScreen(mmi_msg_start_msg_sub_anm);
    
    if (IsKeyPadLockState() == 0)
    {
        GetCurrEndKeyDownHandler();
        ShowCategory141Screen(
            0,
            0,
            0,
            0,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            (U8*) tempstr,
            IMG_NEW_VOICEMAIL_NOTIFICATION_MSG,
            NULL);

        SetRightSoftkeyFunction(mmi_msg_go_back_from_msg_waiting_ind, KEY_EVENT_UP);
        SetKeyHandler(mmi_msg_end_key_from_msg_waiting_ind, KEY_END, KEY_EVENT_DOWN);
    }
    else
    {
        ShowCategory141Screen(
            0,
            0,
            g_keylock_context.KeyLockLSKStringID,
            g_keylock_context.KeyLockLSKIconID,
            g_keylock_context.KeyLockRSKStringID,
            g_keylock_context.KeyLockRSKIconID,
            (U8*) tempstr,
            IMG_NEW_VOICEMAIL_NOTIFICATION_MSG,
            NULL);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_deliver_report_ind
 * DESCRIPTION
 *  Indicate delivery report
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_deliver_report_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_deliver_ind++;
    TurnOnBacklight(GPIO_BACKLIGHT_SHORT_TIME);

    if (IsMMIInIdleState() || (GetMessagesCurrScrnID() == SCR_ID_MSG_DELIVER_REPORT))
    {
    #ifdef __MMI_DUAL_SIM_MASTER__
    	if (g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind - 1]->isFromMaster == FALSE)
    	{
    		mmi_msg_set_msg_type_as_slave();
    	}
	#endif /* __MMI_DUAL_SIM_MASTER__ */
        PlayMessageArrivalTone();
        ClearKeyEvents();
        if (IsKeyPadLockState())
        {
            EntryIdleScreen();
        }
        else
        {
            mmi_msg_entry_deliver_report_ind();
        }
    }
    else
    {
        /* do not interrupt a call, otherwise, incoming call's video and sound may be interrupted */
        if (!isInCall() && !AlmIsTonePlaying())
        {
	    #ifdef __MMI_DUAL_SIM_MASTER__
	    	if (g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind - 1]->isFromMaster == FALSE)
	    	{
	    		mmi_msg_set_msg_type_as_slave();
	    	}
		#endif /* __MMI_DUAL_SIM_MASTER__ */

            mmi_msg_entry_new_msg_popup(MSG_NEW_DELIVERY_REPORT);
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_go_back_from_deliver_report_ind
 * DESCRIPTION
 *  Free delivery report before go back screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_go_back_from_deliver_report_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_msg_cntx.msg_deliver_ind != 0)
    {
        g_msg_cntx.msg_deliver_ind--;
    }
    if (g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind] != NULL)
    {
        OslMfree(g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind]);
        g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind] = NULL;
    }
    GoBackHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_end_key_from_deliver_report_ind
 * DESCRIPTION
 *  Free delivery report before go to idle
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_end_key_from_deliver_report_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    while (g_msg_cntx.msg_deliver_ind != 0)
    {
        g_msg_cntx.msg_deliver_ind--;
        if (g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind] != NULL)
        {
            OslMfree(g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind]);
            g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind] = NULL;
        }
    }
    ExecCurrEndKeyDownHandler();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_deliver_report_status
 * DESCRIPTION
 *  Get delivery report status
 * PARAMETERS
 *  status      [?]             
 *  imgID       [?]             
 *  strID       [?]             
 *  a(?)        [IN/OUT]        Status
 *  c(?)        [IN/OUT]        String ID
 *  b(?)        [IN/OUT]        Image ID
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_get_deliver_report_status(U32 *status, U16 *imgID, U16 *strID)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
#ifndef __MMI_DUAL_SIM_MASTER__
    if (g_msg_cntx.msg_deliver_report[(g_msg_cntx.msg_deliver_ind - 1)]->delivered == ST_COMP_MSG_RECV_BY_SME)
    {
        *status = 1;
        *imgID = IMG_MESSAGE_SENT;
        *strID = STR_SUCCESS_CAPTION;
    }
    else
    {
        *status = 0;
        *imgID = IMG_MESSAGE_UNSENT;
        *strID = STR_FAILURE_CAPTION;
    }
#else /* __MMI_DUAL_SIM_MASTER__ */
	if (g_msg_cntx.msg_deliver_report[g_msg_cntx.msg_deliver_ind - 1]->isFromMaster == FALSE)
	{
		if (g_msg_cntx.msg_deliver_report[(g_msg_cntx.msg_deliver_ind - 1)]->delivered == ST_COMP_MSG_RECV_BY_SME)
    	{
       	    *status = 1;
        	*imgID = IMG_SLAVE_MESSAGE_SENT;
        	*strID = STR_SUCCESS_CAPTION;
    	}
    	else
    	{
       	    *status = 0;
        	*imgID = IMG_SLAVE_MESSAGE_UNSENT;
        	*strID = STR_FAILURE_CAPTION;
    	}
	}
	else
	{
		if (g_msg_cntx.msg_deliver_report[(g_msg_cntx.msg_deliver_ind - 1)]->delivered == ST_COMP_MSG_RECV_BY_SME)
    	{
       	    *status = 1;
        	*imgID = IMG_MASTER_MESSAGE_SENT;
        	*strID = STR_SUCCESS_CAPTION;
    	}
    	else
    	{
       	    *status = 0;
        	*imgID = IMG_MASTER_MESSAGE_UNSENT;
        	*strID = STR_FAILURE_CAPTION;
    	}
	}
#endif /* __MMI_DUAL_SIM_MASTER__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_deliver_report_msg
 * DESCRIPTION
 *  Get delivery report msg
 * PARAMETERS
 *  void
 * RETURNS
 *  string for delivery report indication
 *****************************************************************************/
U8 *mmi_msg_get_deliver_report_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    static S8 buffer[120 * ENCODING_LENGTH];
    S8 buf2[10];
    S8 temp[MAX_DIGITS * ENCODING_LENGTH];
    S8 *name;
    S8 ts_date[(MAX_TIMESTAMP_SIZE + 1) * ENCODING_LENGTH];
    S8 ts_time[(MAX_TIMESTAMP_SIZE + 1) * ENCODING_LENGTH];
    U8 type = g_msg_cntx.msg_deliver_report[(g_msg_cntx.msg_deliver_ind - 1)]->type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_asc_to_ucs2(buf2, "\n");

    memset(temp, 0, MAX_DIGITS * ENCODING_LENGTH);
    if (type)
    {
        mmi_asc_to_ucs2(temp, "+");
    }
    mmi_asc_n_to_ucs2(
        (temp + type * ENCODING_LENGTH),
        (S8*) g_msg_cntx.msg_deliver_report[(g_msg_cntx.msg_deliver_ind - 1)]->number,
        MSG_NUM_LEN);
    name = lookUpNumber(temp);
    if (mmi_ucs2strlen(name))
    {
        mmi_ucs2cpy(buffer, name);
    }
    else
    {
        mmi_ucs2cpy(buffer, temp);
    }

    mmi_msg_get_msg_date_time(
        ts_date,
        ts_time,
        g_msg_cntx.msg_deliver_report[(g_msg_cntx.msg_deliver_ind - 1)]->timestamp);
    mmi_ucs2cat(buffer, buf2);
    mmi_ucs2cat(buffer, ts_date);
    mmi_ucs2cat(buffer, buf2);
    mmi_ucs2cat(buffer, ts_time);
    mmi_ucs2cat(buffer, buf2);

    return (U8*) buffer;

}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_deliver_report_ind
 * DESCRIPTION
 *  Entry delivery report indication screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_deliver_report_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    U16 drStatusIconID = 0;
    U16 drStatusStrID = 0;
    U32 drStatus = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_DELIVER_REPORT, mmi_msg_exit_generic, NULL, NULL);
    SetMessagesCurrScrnID(SCR_ID_MSG_DELIVER_REPORT);
    
    if (IsKeyPadLockState() == 0)
    {
        mmi_msg_get_deliver_report_status(&drStatus, &drStatusIconID, &drStatusStrID);
        guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_DELIVER_REPORT);

        GetCurrEndKeyDownHandler();
        ShowCategory145Screen(
            ((U8*) GetString(STR_STATUS_REPORT_MESSAGE_DELIVERD_MSG)),
            IMG_SMS_ENTRY_SCRN_CAPTION,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            0,
            0,
            drStatusIconID,
            ((U8*) GetString(drStatusStrID)),
            mmi_msg_get_deliver_report_msg(),
            drStatus,
            guiBuffer);

        SetLeftSoftkeyFunction(mmi_msg_go_back_from_deliver_report_ind, KEY_EVENT_UP);
        SetKeyHandler(mmi_msg_end_key_from_deliver_report_ind, KEY_END, KEY_EVENT_DOWN);
    }
    else    /* keypad is locked */
    {
        mmi_msg_get_deliver_report_status(&drStatus, &drStatusIconID, &drStatusStrID);
        ShowCategory145Screen(
            ((PU8) GetString(STR_STATUS_REPORT_MESSAGE_DELIVERD_MSG)),
            IMG_SMS_ENTRY_SCRN_CAPTION,
            g_keylock_context.KeyLockLSKStringID,
            g_keylock_context.KeyLockLSKIconID,
            g_keylock_context.KeyLockRSKStringID,
            g_keylock_context.KeyLockRSKIconID,
            drStatusIconID,
            ((PU8) GetString(drStatusStrID)),
            mmi_msg_get_deliver_report_msg(),
            drStatus,
            NULL);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_mem_exceed_ind
 * DESCRIPTION
 *  Indicate memory exceed
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_mem_exceed_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_exceed_ind = TRUE;
    TurnOnBacklight(GPIO_BACKLIGHT_SHORT_TIME);
    if (IsMMIInIdleState())
    {
        ClearKeyEvents();
        if (IsKeyPadLockState())
        {
            EntryIdleScreen();
        }
        else
        {
            mmi_msg_entry_mem_exceed_ind();
        }
    }
#ifdef __MMI_MESSAGES_CHAT__
    else
    {
        EntrySmsMemoryFullIndInChatApp();
    }
#endif /* __MMI_MESSAGES_CHAT__ */ 
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_go_back_from_mem_exceed_ind
 * DESCRIPTION
 *  Reset msg exceed flag before go back screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_go_back_from_mem_exceed_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_exceed_ind = FALSE;
    GoBackHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_end_key_from_mem_exceed_ind
 * DESCRIPTION
 *  Reset msg exceed flag before go to idle
 * PARAMETERS
 *  void
 *  nnoe(?)
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_end_key_from_mem_exceed_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_exceed_ind = FALSE;
    ExecCurrEndKeyDownHandler();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_mem_exceed_ind
 * DESCRIPTION
 *  Entry memory exceed indication
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_mem_exceed_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 str_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_msg_cntx.msg_exceed_type == SMSAL_MEM_EXCEED_NORMAL)
    {
    #ifndef __MMI_DUAL_SIM_MASTER__
        str_id = STR_SMS_MEMORY_EXCEEDED;
	#else
		if (g_msg_cntx.msg_exceed_from_slave == FALSE)
		{
			str_id = STRING_MTPNP_MASTER_SMS_MEMORY_EXCEEDED;
		}
		else
		{
			str_id = STRING_MTPNP_SLAVE_SMS_MEMORY_EXCEEDED;
		}
	#endif
    }
    else if (g_msg_cntx.msg_exceed_type == SMSAL_SM_EXCEED_WITH_CLASS2)
    {
    #ifndef __MMI_DUAL_SIM_MASTER__
        str_id = STR_SMS_SIM_MEMORY_EXCEEDED;
	#else		
		if (g_msg_cntx.msg_exceed_from_slave == FALSE)
		{
			str_id = STRING_MTPNP_MASTER_SMS_SIM_MEMORY_EXCEEDED;
		}
		else
		{
			str_id = STRING_MTPNP_SLAVE_SMS_SIM_MEMORY_EXCEEDED;
		}
	#endif
    }

    EntryNewScreen(SCR_ID_MSG_EXCEED_IND, NULL, NULL, NULL);
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS,
                         "*-------[MessagesIdleApp.c] EntryDisplaySmsMemoryExceededIndication -------*\n");

    if (IsKeyPadLockState() == 0)
    {
        GetCurrEndKeyDownHandler();
        ShowCategory2Screen(
            STR_SCR6042_CAPTION,
            IMG_SMS_ENTRY_SCRN_CAPTION,
            0,
            0,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            str_id,
            NULL);
        SetRightSoftkeyFunction(mmi_msg_go_back_from_mem_exceed_ind, KEY_EVENT_UP);
        SetKeyHandler(mmi_msg_go_back_from_mem_exceed_ind, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(mmi_msg_end_key_from_mem_exceed_ind, KEY_END, KEY_EVENT_DOWN);
    }
    else
    {
        ShowCategory2Screen(
            STR_SCR6042_CAPTION,
            IMG_SMS_ENTRY_SCRN_CAPTION,
            g_keylock_context.KeyLockLSKStringID,
            g_keylock_context.KeyLockLSKIconID,
            g_keylock_context.KeyLockRSKStringID,
            g_keylock_context.KeyLockRSKIconID,
            str_id,
            NULL);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_class0_msg_ind
 * DESCRIPTION
 *  Indicate class 0 message
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_class0_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_class0_ind = TRUE;
    TurnOnBacklight(GPIO_BACKLIGHT_SHORT_TIME);

    if (IsMMIInIdleState() || GetMessagesCurrScrnID() == SCR_ID_MSG_CLASS0_MSG)
    {
	#ifdef __MMI_DUAL_SIM_MASTER__
		if (g_msg_cntx.msg_class0_p->isSlave == TRUE)
		{
			mmi_msg_set_msg_type_as_slave();
		}		
	#endif /* __MMI_DUAL_SIM_MASTER__ */
        PlayMessageArrivalTone();
        ClearKeyEvents();
        if (IsKeyPadLockState())
        {
            EntryIdleScreen();
        }
        else
        {
            mmi_msg_entry_class0_msg_ind();
        }
    }
    else
    {
        /* do not interrupt a call, otherwise, incoming call's video and sound may be interrupted */
        if (!isInCall() && !AlmIsTonePlaying())
        {
		#ifdef __MMI_DUAL_SIM_MASTER__
			if (g_msg_cntx.msg_class0_p->isSlave == TRUE)
			{
				mmi_msg_set_msg_type_as_slave();
			}		
		#endif /* __MMI_DUAL_SIM_MASTER__ */
            mmi_msg_entry_new_msg_popup(MSG_NEW_MSG_CLASS0);
        }

        /* In option, use number, or any other screen after class 0 messages screens*/
        if (IsScreenPresent(SCR_ID_MSG_CLASS0_MSG))
        {
        	g_msg_cntx.free_class0_data_flag = FALSE;

			/* Should Delete the top screen first if it have a delete callback funtion;
			   The both screen screen SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST,
			   SCR_ID_MSG_CLASS0_MSG have a callback function */
			if (IsScreenPresent(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST))
			{
				DeleteScreenIfPresent(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST);
				DeleteScreenIfPresent(SCR_ID_MSG_USE_URL_OPTION);
			}
            DeleteScreenIfPresent(SCR_ID_MSG_CLASS0_MSG);
            DeleteScreenIfPresent(SCR_ID_MSG_CLASS0_OPTION);
            DeleteScreenIfPresent(SCR_ID_MSG_CLASS0_OPTION_USE_NUMBER_LIST);
       }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_class0_msg
 * DESCRIPTION
 *  Get class 0 message
 * PARAMETERS
 *  void
 * RETURNS
 *  EMSData bufForDisplay
 *****************************************************************************/
EMSData *mmi_msg_get_class0_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    EMSData *pEms;
    U16 textLen = g_msg_cntx.msg_class0_p->length;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    textLen = (textLen / 2);
    GetEMSDataForView(&pEms, 1);
    AddString(pEms, g_msg_cntx.msg_class0_p->data, textLen, NULL);
    GetEMSDataForView(&pEms, 0);
    return pEms;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_class0_header
 * DESCRIPTION
 *  Get class 0 message header
 * PARAMETERS
 *  void
 * RETURNS
 *  class 0 message header
 *****************************************************************************/
U8 *mmi_msg_get_class0_header(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    static S8 buffer[120 * ENCODING_LENGTH];
    S8 buf2[10];
    S8 temp[MAX_DIGITS * ENCODING_LENGTH];
    S8 *name;
    S8 ts_date[(MAX_TIMESTAMP_SIZE + 1) * ENCODING_LENGTH];
    S8 ts_time[(MAX_TIMESTAMP_SIZE + 1) * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_asc_to_ucs2(buf2, "\n");
    mmi_ucs2cpy(buffer, GetString(STR_SMS_MESSAGE_HEADER_FROM));
    mmi_ucs2cat(buffer, buf2);

    mmi_ucs2cpy(temp, (S8*) g_msg_cntx.msg_class0_p->number);
    name = lookUpNumber(temp);
    if (mmi_ucs2strlen(name))
    {
        mmi_ucs2cat(buffer, name);
    }
    else
    {
        mmi_ucs2cat(buffer, temp);
    }

    mmi_msg_get_msg_date_time(ts_date, ts_time, g_msg_cntx.msg_class0_p->timestamp);
    mmi_ucs2cat(buffer, buf2);
    mmi_ucs2cat(buffer, ts_date);
    mmi_ucs2cat(buffer, buf2);
    mmi_ucs2cat(buffer, ts_time);
    mmi_ucs2cat(buffer, buf2);

    return (U8*) buffer;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_class0_msg_option
 * DESCRIPTION
 *  Entry class 0 msg option screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_class0_msg_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    U16 numItems = 0;
    U16 nStrItemList[MAX_SUB_MENUS];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CLASS0_OPTION, mmi_msg_exit_generic, mmi_msg_entry_class0_msg_option, NULL);
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[MessagesMiscell.c] mmi_msg_entry_class0_msg_option *\n");
    GetCurrEndKeyDownHandler();
    
    SetMessagesScrnIdToDelHistoryNodes(SCR_ID_MSG_CLASS0_OPTION);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLASS0_OPTION);

    numItems = GetNumOfChild_Ext(SMS_CLSASS0_OPT_MENUID);
    GetSequenceStringIds_Ext(SMS_CLSASS0_OPT_MENUID, nStrItemList);
    SetParentHandler(SMS_CLSASS0_OPT_MENUID);

    RegisterHighlightHandler(ExecuteCurrHiliteHandler);
    SetMessagesCurrScrnID(SCR_ID_MSG_CLASS0_OPTION);

    ShowCategory52Screen(
        STR_SCR6028_CAPTION,
        IMG_SMS_ENTRY_SCRN_CAPTION,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        numItems,
        nStrItemList,
        (U16*) gIndexIconsImageList,
        NULL,
        0,
        0,
        guiBuffer);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_pre_entry_class0_msg_option
 * DESCRIPTION
 *  Pre entry class 0 option
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_pre_entry_class0_msg_option(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    history h;
    S16 nHistory = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    h.scrnID = SCR_ID_MSG_CLASS0_MSG;
    h.entryFuncPtr = mmi_msg_entry_class0_msg_ind;
    mmi_ucs2cpy((S8*) h.inputBuffer, (S8*) & nHistory);
    GetCategoryHistory(h.guiBuffer);
    AddHistory(h);

    mmi_msg_entry_class0_msg_option();
}

    
/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_class_0_opt_use_number
 * DESCRIPTION
 *  Entry function for class 0 use number
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_class_0_opt_use_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 numbersCount = 0;
    U8 *guiBuffer = NULL;
    S8 number[MAX_DIGITS_SMS * ENCODING_LENGTH];

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[MessagesMiscell.c] mmi_msg_entry_class_0_opt_use_number *\n");

    memset((S8*) number, 0, sizeof(number));
    numbersCount = ObtainNumbersFromMessageText((S8*) g_msg_cntx.msg_class0_p->number, 
                                                g_msg_cntx.msg_class0_p->data, 
                                                (U16) g_msg_cntx.msg_class0_p->length, 
                                                0);
    if (numbersCount > 0)
    {
        EntryNewScreen(SCR_ID_MSG_CLASS0_OPTION_USE_NUMBER_LIST, mmi_msg_exit_generic, mmi_msg_entry_class_0_opt_use_number, NULL);
        GetCurrEndKeyDownHandler();

        guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLASS0_OPTION_USE_NUMBER_LIST);
        RegisterHighlightHandler(GetHiliteIndex);
        SetMessagesCurrScrnID(SCR_ID_MSG_CLASS0_OPTION_USE_NUMBER_LIST);

        ShowCategory53Screen(
            STR_USE_NUMBER_CAPTION,
            IMG_SMS_ENTRY_SCRN_CAPTION,
            STR_GLOBAL_DIAL,
            IMG_SMS_COMMON_NOIMAGE,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            numbersCount,
            (U8 **) g_msg_cntx.numbersList,
            (U16*) gIndexIconsImageList,
            NULL,
            0,
            0,
            guiBuffer);
        
#if defined(__MMI_WLAN_FEATURES__) && defined(__MMI_VOIP__)
	    switch (mmi_netset_get_active_preferred_mode())
	    {
	        case P_WLAN_ONLY:
		        SetLeftSoftkeyFunction(mmi_msg_dial_use_voip_number, KEY_EVENT_UP);
        		SetKeyHandler(mmi_msg_dial_use_voip_number, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
		        SetKeyHandler(mmi_msg_dial_use_voip_number, KEY_SEND, KEY_EVENT_UP);
	            break;

	        case P_GSM_PREFERRED:
		        SetLeftSoftkeyFunction(mmi_netset_entry_dial_mode_selection, KEY_EVENT_UP);
        		SetKeyHandler(mmi_netset_entry_dial_mode_selection, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
		        SetKeyHandler(mmi_msg_dial_use_number, KEY_SEND, KEY_EVENT_UP);
	            mmi_netset_register_call_entry_func(mmi_msg_dial_use_number, mmi_msg_dial_use_voip_number);
	            break;
				
	        case P_WLAN_PREFERRED:
		        SetLeftSoftkeyFunction(mmi_netset_entry_dial_mode_selection, KEY_EVENT_UP);
        		SetKeyHandler(mmi_netset_entry_dial_mode_selection, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
				SetKeyHandler(mmi_msg_dial_use_voip_number, KEY_SEND, KEY_EVENT_UP);
	            mmi_netset_register_call_entry_func(mmi_msg_dial_use_number, mmi_msg_dial_use_voip_number);
	            break;

	        case P_GSM_ONLY:
	        default:
			    SetLeftSoftkeyFunction(mmi_msg_dial_use_number, KEY_EVENT_UP);
        		SetKeyHandler(mmi_msg_dial_use_number, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
			    SetKeyHandler(mmi_msg_dial_use_number, KEY_SEND, KEY_EVENT_UP);
	            break;
	    }
#else /* defined(__MMI_WLAN_FEATURES__) && defined(__MMI_VOIP__) */
#ifdef __MMI_DUAL_SIM_MASTER__
       SetLeftSoftkeyFunction(mmi_msg_dial_use_number_ext, KEY_EVENT_UP);
       SetKeyHandler(mmi_msg_dial_use_number_ext, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
	   MTPNP_PFAL_CC_HandleSendKeys(mmi_msg_dial_use_number,KEY_EVENT_UP);
#else /* __MMI_DUAL_SIM_MASTER__ */
       SetLeftSoftkeyFunction(mmi_msg_dial_use_number, KEY_EVENT_UP);
       SetKeyHandler(mmi_msg_dial_use_number, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
       SetKeyHandler(mmi_msg_dial_use_number, KEY_SEND, KEY_EVENT_UP);
#endif /* __MMI_DUAL_SIM_MASTER__ */
#endif /* defined(__MMI_WLAN_FEATURES__) && defined(__MMI_VOIP__) */

        SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
        SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    }
    else
    {
        DisplayPopup(
            (PU8) GetString(STR_NONUMBER_NOTIFICATION),
            IMG_GLOBAL_EMPTY,
            1,
            MESSAGES_POPUP_TIME_OUT,
            (U8) EMPTY_LIST_TONE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_highlight_class0_opt_use_number
 * DESCRIPTION
 *  Highlight class 0 use number handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_highlight_class0_opt_use_number(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_highlight_generic(
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        mmi_msg_entry_class_0_opt_use_number,
        GoBackHistory);
}


#ifdef __MMI_MESSAGES_USE_URL__
static U8 mmi_msg_class0_delete_url_screen_callback(void);


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_highlight_class0_opt_use_url
 * DESCRIPTION
 *  Highlight class 0 use URL handler
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_highlight_class0_opt_use_url(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_highlight_generic(
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        mmi_msg_entry_class_0_opt_use_url,
        GoBackHistory);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_class_0_opt_use_url
 * DESCRIPTION
 *  Entry function for class 0 use url
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_class_0_opt_use_url(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "*[MessagesMiscell.c] mmi_msg_entry_class_0_opt_use_url *\n");

    g_msg_cntx.URLCount = mmi_msg_get_url_list_from_msgtxt((S8*)g_msg_cntx.msg_class0_p->data, g_msg_cntx.msg_class0_p->length);

    if (g_msg_cntx.URLCount > 0)
    {
        EntryNewScreen(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST, mmi_msg_exit_generic, mmi_msg_entry_class_0_opt_use_url, NULL);

        guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST);
        RegisterHighlightHandler(GetHiliteIndex);
        SetMessagesCurrScrnID(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST);

		SetDelScrnIDCallbackHandler(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST, (HistoryDelCBPtr)mmi_msg_class0_delete_url_screen_callback);

        ShowCategory53Screen(
            STR_USE_URL_LIST_CAPTION,
            IMG_SMS_ENTRY_SCRN_CAPTION,
            STR_GLOBAL_OPTIONS,
            IMG_SMS_COMMON_NOIMAGE,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            g_msg_cntx.URLCount,
            (U8 **) g_msg_cntx.URLlist,
            (U16*) gIndexIconsImageList,
            NULL,
            0,
            0,
            guiBuffer);
        SetLeftSoftkeyFunction(mmi_msg_entry_use_url_option, KEY_EVENT_UP);
        SetKeyHandler(mmi_msg_entry_use_url_option, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(mmi_msg_entry_open_url, KEY_SEND, KEY_EVENT_UP);
        SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
        SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
    }
    else
    {
        DisplayPopup(
            (PU8) GetString(STR_NOURL_NOTIFICATION),
            IMG_GLOBAL_EMPTY,
            1,
            MESSAGES_POPUP_TIME_OUT,
            (U8) EMPTY_LIST_TONE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_class0_delete_url_screen_callback
 * DESCRIPTION
 *  Delete Use URL Screen Callbakc Function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
static U8 mmi_msg_class0_delete_url_screen_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	mmi_msg_free_url_list();
    ClearDelScrnIDCallbackHandler(SCR_ID_MSG_CLASS0_OPTION_USE_URL_LIST, NULL);
	return MMI_FALSE;
}

#endif /* __MMI_MESSAGES_USE_URL__ */


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_delete_class0_ind_screen_callback
 * DESCRIPTION
 *  Delete Class Indication Screen Callbakc Function
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
U8 mmi_msg_delete_class0_ind_screen_callback(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
	if (g_msg_cntx.free_class0_data_flag == TRUE)
	{
		mmi_msg_free_class0_data();
	}

    ClearDelScrnIDCallbackHandler(SCR_ID_MSG_CLASS0_MSG, NULL);
	return MMI_FALSE;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_msg_free_class0_data
 * DESCRIPTION
 *  Reset class 0 message data
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_free_class0_data(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_class0_ind = FALSE;
    if (g_msg_cntx.msg_class0_p != NULL)
    {
        if (g_msg_cntx.msg_class0_p->data != NULL)
        {
            OslMfree(g_msg_cntx.msg_class0_p->data);
            g_msg_cntx.msg_class0_p->data = NULL;
        }
        OslMfree(g_msg_cntx.msg_class0_p);
        g_msg_cntx.msg_class0_p = NULL;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_class0_msg_ind
 * DESCRIPTION
 *  Entry class 0 message indication
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_class0_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    EMSData *pClass0Ems = NULL;
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CLASS0_MSG, mmi_msg_stop_msg_sub_anm, NULL, NULL);
    SetMessagesCurrScrnID(SCR_ID_MSG_CLASS0_MSG);    
    ForceSubLCDScreen(mmi_msg_start_msg_sub_anm);
	g_msg_cntx.free_class0_data_flag = TRUE;
    pClass0Ems = mmi_msg_get_class0_msg();

    if (IsKeyPadLockState() == 0)
    {
        guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLASS0_MSG);

		SetDelScrnIDCallbackHandler(SCR_ID_MSG_CLASS0_MSG, (HistoryDelCBPtr)mmi_msg_delete_class0_ind_screen_callback);

        ShowCategory39Screen(
            STR_SCR6024_CAPTION,
            IMG_SMS_ENTRY_SCRN_CAPTION,
            STR_GLOBAL_OPTIONS,
            IMG_SMS_COMMON_NOIMAGE,
            STR_GLOBAL_BACK,
            IMG_SMS_COMMON_NOIMAGE,
            pClass0Ems,
            mmi_msg_get_class0_header(),
            guiBuffer);

        SetLeftSoftkeyFunction(mmi_msg_pre_entry_class0_msg_option, KEY_EVENT_UP);
        SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    }
    else
    {
        ShowCategory39Screen(
            STR_SCR6024_CAPTION,
            IMG_SMS_ENTRY_SCRN_CAPTION,
            g_keylock_context.KeyLockLSKStringID,
            g_keylock_context.KeyLockLSKIconID,
            g_keylock_context.KeyLockRSKStringID,
            g_keylock_context.KeyLockRSKIconID,
            pClass0Ems,
            mmi_msg_get_class0_header(),
            NULL);
        /* prevent category scrolling */
        SetKeyHandler(NULL, KEY_UP_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(NULL, KEY_DOWN_ARROW, KEY_EVENT_DOWN);
        SetKeyHandler(NULL, KEY_VOL_UP, KEY_EVENT_DOWN);
        SetKeyHandler(NULL, KEY_VOL_DOWN, KEY_EVENT_DOWN);
    }
}

  U16 sms_unread=0; 

void mmi_msg_count_unread_sms(void)
{

       
    U16 i = 0;
    U16 totalinbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX);

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_msg_cntx.msg_full_ind == FALSE)
    {
       // PRINT_INFORMATION_2((MMI_TRACE_G6_SMS,
        //                     "*-------[SmsMoMtGuiInterface.c] mmi_msg_set_msg_icon g_msg_cntx.msg_full_ind==FALSE -------*\n"));

        if (totalinbox != MMI_FRM_SMS_INVALID_INDEX)
        {

          //  PRINT_INFORMATION_2((MMI_TRACE_G6_SMS,
          //                       "*-------[SmsMoMtGuiInterface.c] mmi_msg_set_msg_icon totalinbox: %d -------*\n",
                  //               totalinbox));
   	     sms_unread=0; 
            while (i < totalinbox)
            {
                if ((mmi_frm_sms_get_status(MMI_FRM_SMS_APP_INBOX, i) & 0x0f) == MMI_FRM_SMS_APP_UNREAD)
                {
                  //   PRINT_INFORMATION_2((MMI_TRACE_G6_SMS,
                        //                 "*-------[SmsMoMtGuiInterface.c] mmi_msg_set_msg_icon UNREAD found -------*\n"));
			sms_unread+=1;
                }
                i++;
            }
        }
    }
	//kal_prompt_trace(MOD_MMI,"sms_unreadsms_unreadsms_unread=%d",sms_unread);
}

U16 mmi_msg_get_unread_sms_num(void)
{
  
 return sms_unread;
}

/*****************************************************************************
 * FUNCTION
 *  mmi_msg_new_msg_ind
 * DESCRIPTION
 *  Indicate new message
 * PARAMETERS
 *  index       [IN]        
 *  a(?)        [IN]        L4 index of new message
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_new_msg_ind(U16 index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 type;
    U16 list_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/

    /* Do not play notification if flight mode. */
    /* It happens if the incomplete SMS message that arrives before flight mode timeouts in flight mode. */
    if (0 != mmi_bootup_get_active_flight_mode())
    {
    #ifndef __MMI_DUAL_SIM_MASTER__
        mmi_msg_set_msg_icon(FALSE, FALSE);
	mmi_msg_count_unread_sms();  
    #else /* __MMI_DUAL_SIM_MASTER__ */
	    MTPNP_PFAL_Refresh_StatusBar_Card1_SMS_Display(MTPNP_FALSE, MTPNP_FALSE);
	    MTPNP_PFAL_Refresh_StatusBar_Card2_SMS_Display(MTPNP_FALSE, MTPNP_FALSE);
    #endif /* __MMI_DUAL_SIM_MASTER__ */
        PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "mmi_msg_new_msg_ind IN FLIGHT MODE!! \n");
        return;
    }
    
    g_msg_cntx.msg_ind_index = index;   /* it should be sms frm index, not l4 index */
    g_msg_cntx.msg_ind_in_idle = TRUE;

    if (isInCall() && !GetWapCallPresent())
    {
        g_msg_cntx.msg_ind_after_call = TRUE;
    }

    TurnOnBacklight(GPIO_BACKLIGHT_SHORT_TIME);
#ifndef __MMI_DUAL_SIM_MASTER__
    mmi_msg_set_msg_icon(FALSE, FALSE);
#else /* __MMI_DUAL_SIM_MASTER__ */
	MTPNP_PFAL_Refresh_StatusBar_Card1_SMS_Display(MTPNP_FALSE, MTPNP_FALSE);
	MTPNP_PFAL_Refresh_StatusBar_Card2_SMS_Display(MTPNP_FALSE, MTPNP_FALSE);
#endif /* __MMI_DUAL_SIM_MASTER__ */

    mmi_frm_sms_get_list_index(&type, &list_index, g_msg_cntx.msg_ind_index);
#ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
    if (type == MMI_FRM_SMS_SIM)
    {
        g_msg_cntx.sim_msg_ind_index = index;
        g_msg_cntx.sim_msg_ind_in_idle = TRUE;
    }
#endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */

#ifdef __MMI_UNIFIED_MESSAGE__
    if (IsMMIInIdleState() || GetExitScrnID() == SCR_ID_UM_NEW_MSG_IND
    #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
        || GetExitScrnID() == SCR_ID_MSG_NEW_SIM_MSG_IND
    #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        )
#else   /* __MMI_UNIFIED_MESSAGE__ */ 
    if (IsMMIInIdleState() || GetMessagesCurrScrnID() == SCR_ID_MSG_NEW_MSG_IND)
#endif  /* __MMI_UNIFIED_MESSAGE__ */         
    {
#ifdef __MMI_UNIFIED_MESSAGE__
    #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
        if (type == MMI_FRM_SMS_SIM)
    #else /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        if (!IsMMIInIdleState() && GetExitScrnID() != SCR_ID_UM_NEW_MSG_IND)
    #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
    
#endif /* __MMI_UNIFIED_MESSAGE__ */
        {
        #ifdef __MMI_DUAL_SIM_MASTER__
        	if (!mmi_frm_msg_is_from_master_sim(index))
    		{
    			mmi_msg_set_msg_type_as_slave();
    		}
		#endif /* __MMI_DUAL_SIM_MASTER__ */
            PlayMessageArrivalTone();
            StartLEDPatternMessageIn();
            StartTimer(MESSAGES_SUBLCD_TIMER_ID, MESSAGES_SUBLCD_TIME_OUT, mmi_msg_callback_msg_sub_anm);
            ClearKeyEvents();

            if (IsKeyPadLockState())
            {
                EntryIdleScreen();
            }
            else
            {
            #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
                mmi_msg_entry_new_sim_msg_ind();
            #else /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
                mmi_msg_entry_new_msg_ind();
            #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
            }
        }
    }
    else
    {
    #ifndef __MMI_UNIFIED_MESSAGE__
        /* it is in the inbox list or the inbox list screen is in the history */
        if (GetMessagesCurrScrnID() == SCR_ID_MSG_INBOX_LIST || IsScreenPresent(SCR_ID_MSG_INBOX_LIST))
    #else /* __MMI_UNIFIED_MESSAGE__ */ 
    
    #ifdef __UNIFIED_MESSAGE_LIST_OPTION_SUPPORT__
        if (GetExitScrnID() == SCR_ID_MSG_INBOX_LIST_OPTION || IsScreenPresent(SCR_ID_MSG_INBOX_LIST_OPTION)
        #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
            || GetExitScrnID() == SCR_ID_MSG_SIMBOX_LIST_OPTION || IsScreenPresent(SCR_ID_MSG_SIMBOX_LIST_OPTION)
        #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        )
    #else /* __UNIFIED_MESSAGE_LIST_OPTION_SUPPORT__ */
        if (GetExitScrnID() == SCR_ID_MSG_INBOX_MSG || IsScreenPresent(SCR_ID_MSG_INBOX_MSG))
    #endif /* __UNIFIED_MESSAGE_LIST_OPTION_SUPPORT__ */
        
    #endif /* __MMI_UNIFIED_MESSAGE__ */ 
        {
            mmi_frm_sms_get_list_index(&type, &list_index, g_msg_cntx.msg_ind_index);
        #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
            if (type == MMI_FRM_SMS_APP_SIM && list_index <= g_msg_cntx.currBoxIndex &&
                msgbox_info.totalinbox == mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX))
            {
                g_msg_cntx.currBoxIndex++;              
            }
            else
        #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
            /* highlighter will be moved one position down only when the new message lists in front of the current highlighter and the new message does not make any incomplete message complete in inbox */
            if (type == MMI_FRM_SMS_APP_INBOX && list_index <= g_msg_cntx.currBoxIndex &&
                msgbox_info.totalinbox < mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX))
            {
                g_msg_cntx.currBoxIndex++;

                /* Update msgbox_info.totalinbox immediately. */
                msgbox_info.totalinbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX);
            }
        }
        /* do not interrupt a call, otherwise, incoming call's video and sound may be interrupted */
        if (isInCall() && !GetWapCallPresent())
        {
            /* in case it is in the sms main menu from the in-call option */
            if (mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_NOBOX) != MMI_FRM_SMS_INVALID_INDEX)
            {
                msgbox_info.totalinbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX);
                msgbox_info.totaloutbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_OUTBOX);
                msgbox_info.totaldraftbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_DRAFTS);
                mmi_msg_set_msg_num_hint(msgbox_info.totalinbox, msgbox_info.totaloutbox, msgbox_info.totaldraftbox);
                RefreshMessagesMenuList();
            }

            /* If current screen is inbox list, refresh the inbox list */
            if (GetExitScrnID() == SCR_ID_MSG_INBOX_LIST)
            {
                mmi_msg_entry_inbox_list();
                DeleteScreenIfPresent(SCR_ID_MSG_INBOX_LIST);
            }

            playRequestedTone(SMS_IN_CALL_TONE);
        }
        else if (!AlmIsTonePlaying())
        {
        #if defined (__MMI_SMART_MESSAGE_MT__) || (defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__))
            switch (g_msg_cntx.dest_port)
            {
                case 0x1581:
                    mmi_msg_entry_new_msg_popup(MSG_NEW_MSG_RINGTONE);
                    break;
                case 0x158A:
                    mmi_msg_entry_new_msg_popup(MSG_NEW_MSG_PICTURE);
                    break;
                default:
                    mmi_msg_entry_new_msg_popup(MSG_NEW_MSG_NORMAL);
                    break;
            }
        #else /* defined (__MMI_SMART_MESSAGE_MT__) || (defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)) */
        #ifdef __MMI_DUAL_SIM_MASTER__
        	if (!mmi_frm_msg_is_from_master_sim(index))
    		{
    			mmi_msg_set_msg_type_as_slave();
    		}
		#endif /* __MMI_DUAL_SIM_MASTER__ */
            mmi_msg_entry_new_msg_popup(MSG_NEW_MSG_NORMAL);
        #endif /* defined (__MMI_SMART_MESSAGE_MT__) || (defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)) */ 
        #ifdef __MMI_MESSAGES_PREFER_STORAGE_MEMORY_STATUS__
            mmi_msg_refresh_memory_status();
        #endif 
        }
    }

#ifdef __MMI_UNIFIED_MESSAGE__
#ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
    if (type != MMI_FRM_SMS_SIM)
#endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
    {
        U16 type;
        U16 list_index;
        U8 *timestamp = NULL;
        UI_time datetime;
        U32 converted_timestamp = 0;

        mmi_frm_sms_get_list_index(&type, &list_index, index);
        timestamp = mmi_frm_sms_get_timestamp(MMI_FRM_SMS_INBOX, list_index);

        datetime.nYear = timestamp[0] + 2000;
        if (datetime.nYear > 2090)
        {
            datetime.nYear = datetime.nYear - 100;
        }
        datetime.nMonth = timestamp[1];
        datetime.nDay = timestamp[2];
        datetime.nHour = timestamp[3];
        datetime.nMin = timestamp[4];
        datetime.nSec = timestamp[5];

        converted_timestamp = mmi_dt_mytime_2_utc_sec((MYTIME*) & datetime, MMI_TRUE);
    
        mmi_msg_send_new_msg_ind(UM_MSG_BOX_TYPE_INBOX, list_index, converted_timestamp);
        mmi_msg_send_refresh_ind(UM_MSG_BOX_TYPE_INBOX);
    }
   
#endif /* __MMI_UNIFIED_MESSAGE__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_new_msg_ind_string
 * DESCRIPTION
 *  Get new msg indication string
 * PARAMETERS
 *  void
 * RETURNS
 *  new msg indication string
 *****************************************************************************/
U8 *mmi_msg_get_new_msg_ind_string(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    static S8 buffer[120 * ENCODING_LENGTH];
    S8 temp[MAX_DIGITS * ENCODING_LENGTH];
    S8 *name;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(buffer, 0, 120 * ENCODING_LENGTH);
    memset(temp, 0, MAX_DIGITS * ENCODING_LENGTH);
    mmi_asc_n_to_ucs2(temp,
    	(S8*)mmi_frm_sms_get_address(MMI_FRM_SMS_APP_NOBOX, g_msg_cntx.msg_ind_index),
    	MAX_DIGITS_SMS);
    name = lookUpNumber(temp);
    if (mmi_ucs2strlen(name))
    {
        mmi_ucs2cpy(buffer, name);
    }
    else
    {
        mmi_ucs2cpy(buffer, temp);
    }

    return (U8*) buffer;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_go_back_from_new_msg_ind
 * DESCRIPTION
 *  Reset new msg indication before go back screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_go_back_from_new_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_ind_in_idle = FALSE;
    GoBackHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_end_key_from_new_msg_ind
 * DESCRIPTION
 *  Reset new msg indication before go to idle
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_end_key_from_new_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.msg_ind_in_idle = FALSE;
    ExecCurrEndKeyDownHandler();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_new_msg_ind
 * DESCRIPTION
 *  Entry new message indication
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_new_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_NEW_MSG_IND, mmi_msg_stop_msg_sub_anm, NULL, NULL);
    SetMessagesCurrScrnID(SCR_ID_MSG_NEW_MSG_IND);
    ForceSubLCDScreen(mmi_msg_start_msg_sub_anm);
    GetCurrEndKeyDownHandler();

	g_msg_cntx.msg_ind_after_call = FALSE;
#ifndef __MMI_DUAL_SIM_MASTER__
    if (IsKeyPadLockState() == 0)
    {
        ShowCategory154Screen(
            0,
            0,
            STR_SCR6035_LSK,
            IMG_SMS_COMMON_NOIMAGE,
            STR_GLOBAL_BACK,
            IMG_SMS_COMMON_NOIMAGE,
            (PU8) GetString(STR_NEW_MESSAGE_FROM_ID),
            (PU8) mmi_msg_get_new_msg_ind_string(),
            IMG_NEW_MESSAGE_NOTIFICATION_MSG_IN_IDLE,
            NULL);
        SetRightSoftkeyFunction(mmi_msg_go_back_from_new_msg_ind, KEY_EVENT_UP);
        SetLeftSoftkeyFunction(mmi_msg_get_msg_new, KEY_EVENT_UP);
        SetKeyHandler(mmi_msg_end_key_from_new_msg_ind, KEY_END, KEY_EVENT_DOWN);
    }
    else    /* keypad is locked */
    {
        ShowCategory154Screen(
            0,
            0,
            g_keylock_context.KeyLockLSKStringID,
            g_keylock_context.KeyLockLSKIconID,
            g_keylock_context.KeyLockRSKStringID,
            g_keylock_context.KeyLockRSKIconID,
            (PU8) GetString(STR_NEW_MESSAGE_FROM_ID),
            (PU8) mmi_msg_get_new_msg_ind_string(),
            IMG_NEW_MESSAGE_NOTIFICATION_MSG_IN_IDLE,
            NULL);
        ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
    }
#else /* __MMI_DUAL_SIM_MASTER__ */
	if (!mmi_frm_msg_is_from_master_sim(g_msg_cntx.msg_ind_index))
	{
		if (IsKeyPadLockState() == 0)
	    {
		    ShowCategory154Screen(
		        0,
		        0,
		        STR_SCR6035_LSK,
		        IMG_SMS_COMMON_NOIMAGE,
		        STR_GLOBAL_BACK,
		        IMG_SMS_COMMON_NOIMAGE,
		        (PU8) GetString(STRING_MTPNP_NEW_SLAVE_MESSAGE_FROM_ID),
		        (PU8) mmi_msg_get_new_msg_ind_string(),
		        IMG_NEW_MESSAGE_NOTIFICATION_MSG,
		        NULL);
		    SetRightSoftkeyFunction(mmi_msg_go_back_from_new_msg_ind, KEY_EVENT_UP);
		    SetLeftSoftkeyFunction(mmi_msg_get_msg_new, KEY_EVENT_UP);
		    SetKeyHandler(mmi_msg_end_key_from_new_msg_ind, KEY_END, KEY_EVENT_DOWN);
	    }
	    else    /* keypad is locked */
	    {
		    ShowCategory154Screen(
		        0,
		        0,
		        g_keylock_context.KeyLockLSKStringID,
		        g_keylock_context.KeyLockLSKIconID,
		        g_keylock_context.KeyLockRSKStringID,
		        g_keylock_context.KeyLockRSKIconID,
		        (PU8) GetString(STRING_MTPNP_NEW_SLAVE_MESSAGE_FROM_ID),
		        (PU8) mmi_msg_get_new_msg_ind_string(),
		        IMG_NEW_MESSAGE_NOTIFICATION_MSG,
		        NULL);
		    ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
	    }
	}
	else
	{
		if (IsKeyPadLockState() == 0)
	    {
	        ShowCategory154Screen(
	            0,
	            0,
	            STR_SCR6035_LSK,
	            IMG_SMS_COMMON_NOIMAGE,
	            STR_GLOBAL_BACK,
	            IMG_SMS_COMMON_NOIMAGE,
	            (PU8) GetString(STRING_MTPNP_NEW_MASTER_MESSAGE_FROM_ID),
	            (PU8) mmi_msg_get_new_msg_ind_string(),
	            IMG_NEW_MESSAGE_NOTIFICATION_MSG,
	            NULL);
	        SetRightSoftkeyFunction(mmi_msg_go_back_from_new_msg_ind, KEY_EVENT_UP);
	        SetLeftSoftkeyFunction(mmi_msg_get_msg_new, KEY_EVENT_UP);
	        SetKeyHandler(mmi_msg_end_key_from_new_msg_ind, KEY_END, KEY_EVENT_DOWN);
	    }
	    else    /* keypad is locked */
	    {
	        ShowCategory154Screen(
	            0,
	            0,
	            g_keylock_context.KeyLockLSKStringID,
	            g_keylock_context.KeyLockLSKIconID,
	            g_keylock_context.KeyLockRSKStringID,
	            g_keylock_context.KeyLockRSKIconID,
	            (PU8) GetString(STRING_MTPNP_NEW_MASTER_MESSAGE_FROM_ID),
	            (PU8) mmi_msg_get_new_msg_ind_string(),
	            IMG_NEW_MESSAGE_NOTIFICATION_MSG,
	            NULL);
	        ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
	    }
	}
#endif /* __MMI_DUAL_SIM_MASTER__ */
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_start_msg_sub_anm
 * DESCRIPTION
 *  Start sub-LCD msg animation
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_start_msg_sub_anm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (!isInCall())
    {
        ExecSubLCDCurrExitHandler();
        if (GetMessagesCurrScrnID() == SCR_ID_MSG_MSG_WAITING_IND)
        {
            ShowCategory304Screen(IMG_NEW_VOICEMAIL_PIC_SUBLCD_MSG, NULL);
        }
        else
        {
            ShowCategory304Screen(IMG_NEW_SMS_PIC_SUBLCD_MSG, NULL);
        }
        SetSubLCDExitHandler(mmi_msg_callback_msg_sub_anm);
        //              StartLEDPatternMessageIn ();
        //              StartTimer(MESSAGES_SUBLCD_TIMER_ID, MESSAGES_SUBLCD_TIME_OUT, mmi_msg_callback_msg_sub_anm);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_stop_msg_sub_anm
 * DESCRIPTION
 *  Stop sub-LCD msg animation
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_stop_msg_sub_anm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetMessagesCurrScrnID(0);   /* messagesCurrScrnID */
    mmi_msg_callback_msg_sub_anm();
    GoBackSubLCDHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_callback_msg_sub_anm
 * DESCRIPTION
 *  Call back sub-LCD msg animation
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_callback_msg_sub_anm(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    StopLEDPatternMessageIn();
    StopTimer(MESSAGES_SUBLCD_TIMER_ID);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_exit_inbox_list_dummy
 * DESCRIPTION
 *  Dummy exit inbox list, for new message indication
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_exit_inbox_list_dummy(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    history currHistory;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset(&currHistory, 0, sizeof(currHistory));
    currHistory.scrnID = SCR_ID_MSG_INBOX_LIST;

    SetMessagesCurrScrnID(0);
    g_msg_cntx.MessagesScrnIdToDelHistoryNodes = SCR_ID_MSG_INBOX_LIST;
    g_msg_cntx.MessagesScrnIdDelUptoHistoryNodes = SCR_ID_MSG_INBOX_LIST;

    currHistory.entryFuncPtr = mmi_msg_entry_inbox_list;
    memset((S8*) currHistory.inputBuffer, 0, ENCODING_LENGTH);

    AddHistory(currHistory);
}

#ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__

/*****************************************************************************
 * FUNCTION
 *  mmi_msg_need_new_sim_msg_ind
 * DESCRIPTION
 *  check if new msg indication is required
 * PARAMETERS
 *  void
 * RETURNS
 *  1: indication required, 0: indication not required
 *****************************************************************************/
U8 mmi_msg_need_new_sim_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* Return false if the new msg is deleted by AT */
    if (mmi_frm_sms_msg_box[g_msg_cntx.sim_msg_ind_index].startindex == MMI_FRM_SMS_INVALID_INDEX)
    {
        g_msg_cntx.sim_msg_ind_in_idle = FALSE;
        g_msg_cntx.msg_ind_after_call = FALSE;
        return KAL_FALSE;
    }
    else
    {
        return g_msg_cntx.sim_msg_ind_in_idle;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_go_back_from_new_sim_msg_ind
 * DESCRIPTION
 *  Reset new sim msg indication before go back screen
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_go_back_from_new_sim_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.sim_msg_ind_in_idle = FALSE;
    GoBackHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_end_key_from_new_sim_msg_ind
 * DESCRIPTION
 *  Reset new sim msg indication before go to idle
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_end_key_from_new_sim_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.sim_msg_ind_in_idle = FALSE;
    ExecCurrEndKeyDownHandler();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_entry_new_sim_msg_ind
 * DESCRIPTION
 *  Entry new sim message indication
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_entry_new_sim_msg_ind(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_NEW_SIM_MSG_IND, mmi_msg_stop_msg_sub_anm, NULL, NULL);
    SetMessagesCurrScrnID(SCR_ID_MSG_NEW_SIM_MSG_IND);
    ForceSubLCDScreen(mmi_msg_start_msg_sub_anm);
    GetCurrEndKeyDownHandler();

    g_msg_cntx.msg_ind_after_call = FALSE;
    if (IsKeyPadLockState() == 0)
    {
        ShowCategory154Screen(
            0,
            0,
            STR_SCR6035_LSK,
            IMG_SMS_COMMON_NOIMAGE,
            STR_GLOBAL_BACK,
            IMG_SMS_COMMON_NOIMAGE,
            (PU8) GetString(STR_NEW_SIM_MESSAGE_FROM_ID),
            (PU8) mmi_msg_get_new_msg_ind_string(),
            IMG_NEW_MESSAGE_NOTIFICATION_MSG_IN_IDLE,
            NULL);
        SetRightSoftkeyFunction(mmi_msg_go_back_from_new_sim_msg_ind, KEY_EVENT_UP);
        SetLeftSoftkeyFunction(mmi_msg_get_sim_msg_new, KEY_EVENT_UP);
        SetKeyHandler(mmi_msg_end_key_from_new_sim_msg_ind, KEY_END, KEY_EVENT_DOWN);
    }
    else    /* keypad is locked */
    {
        ShowCategory154Screen(
            0,
            0,
            g_keylock_context.KeyLockLSKStringID,
            g_keylock_context.KeyLockLSKIconID,
            g_keylock_context.KeyLockRSKStringID,
            g_keylock_context.KeyLockRSKIconID,
            (PU8) GetString(STR_NEW_SIM_MESSAGE_FROM_ID),
            (PU8) mmi_msg_get_new_msg_ind_string(),
            IMG_NEW_MESSAGE_NOTIFICATION_MSG_IN_IDLE,
            NULL);
        ClearKeyHandler(KEY_END, KEY_EVENT_DOWN);
    }
}

#endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT_ */

#ifdef __MMI_MESSAGES_CLUB__
#include "ProfileGprots.h"
#ifndef NVRAM_MSG_CLUB_RECORD_SIZE
#define NVRAM_MSG_CLUB_RECORD_SIZE  10
#endif 
#ifndef NVRAM_MSG_CLUB_RECORD_TOTAL
#define NVRAM_MSG_CLUB_RECORD_TOTAL 1
#endif 
#ifndef NVRAM_MSG_CLUB_NUM_RECORD_SIZE
#define NVRAM_MSG_CLUB_NUM_RECORD_SIZE 5
#endif 
#ifndef NVRAM_MSG_CLUB_NUM_RECORD_TOTAL
#define NVRAM_MSG_CLUB_NUM_RECORD_TOTAL   1
#endif 

#define MSG_CLUB_SCREEN_NUM      6
#define MSG_CLUB_MENUITEM_NUM 25
#define MSG_CLUB_INPUT_BUFF_LEN  50
#define MSG_CLUB_INPUT_DA_LEN    15
#define MSG_CLUB_INPUT_NAME_LEN  30
#define MSG_CLUB_INPUT_SMS_LEN   120
#define MSG_CLUB_INPUT_PWD_LEN   16
#define MSG_CLUB_INPUT_SEPEATE    "#"

U8 msg_club_level_1_index = 0;
U8 msg_club_level_2_index = 0;
U8 msg_club_level_3_index = 0;

static msg_club_entry_menu_struct MSGClubScreen[MSG_CLUB_SCREEN_NUM];
static msg_club_entry_menu_struct MSGClubMenuItem[MSG_CLUB_MENUITEM_NUM];
static msg_club_entry_dy_db_zf_struct MSGClubSMSItem;
static msg_club_code_enum MSGClubInputType;
static msg_club_network_enum MSGClubNetwork;
static S8 *MSGClubInputBuff;
static S8 *MSGClubInputBuff2;
static U8 MSGClubInputLen;
static U8 MSGClubInputLen2;
static U16 MSGClubTitle;
static U16 MSGClubTitle2;
static U8 MSGClubCount = 0;

extern S8 gHomePLMNNum[];
extern const msg_club_entry_menu_struct MenuMSGClub[];
extern const msg_club_entry_menu_struct MenuVoice[];
extern const msg_club_service_num_struct NumService[];
extern const msg_club_entry_dy_db_zf_struct MenuExtra[];
extern const U16 InputString[];
extern UI_string_type get_string_lang(MMI_ID_TYPE i, S8 *ssc_str);


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_make_call
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_make_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MakeCall(g_msg_cntx.smsPhoneNumber);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_exit_make_call
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_exit_make_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    stopRequestedTone(WARNING_TONE);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_make_call
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_make_call(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 textbuf[MSG_CLUB_CODE_LENGTH];
    S8 textbufucs2[MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH];
    S16 error;
    msg_club_entry_voice_struct *itemInfo = (msg_club_entry_voice_struct*) MSGClubScreen[MSGClubCount].childEntry;
    U16 numType = itemInfo[msg_club_level_2_index].codeType;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CONFIRMATION, mmi_msg_club_exit_make_call, NULL, NULL);

    memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
    memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
    memset(g_msg_cntx.smsPhoneNumber, 0, (MAX_DIGITS + 1) * ENCODING_LENGTH);
    mmi_asc_to_ucs2(textbufucs2, (S8*) itemInfo[msg_club_level_2_index].codeVoice.codeNum);
    mmi_ucs2cpy(g_msg_cntx.smsPhoneNumber, textbufucs2);

    if ((numType & NUMBER_END) == NUMBER_END)
    {
        memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        ReadRecord(NVRAM_EF_MSG_CLUB_NUM_LID, 1, textbuf, NVRAM_MSG_CLUB_NUM_RECORD_SIZE, &error);
        mmi_asc_to_ucs2(textbufucs2, textbuf);
        mmi_ucs2cat(g_msg_cntx.smsPhoneNumber, textbufucs2);
    }

    ShowCategory154Screen(
        0,
        0,
        STR_GLOBAL_YES,
        IMG_SMS_COMMON_NOIMAGE,
        STR_GLOBAL_NO,
        IMG_SMS_COMMON_NOIMAGE,
        (PU8) get_string_lang(STR_GLOBAL_DIAL, SSC_SCHINESE),
        (PU8) g_msg_cntx.smsPhoneNumber,
        IMG_GLOBAL_QUESTION,
        NULL);
    /*
     * ShowCategory164Screen(STR_GLOBAL_YES, IMG_GLOBAL_YES,
     * STR_GLOBAL_NO, IMG_GLOBAL_NO,
     * STR_GLOBAL_DIAL, IMG_GLOBAL_QUESTION, NULL); 
     */
    SetLeftSoftkeyFunction(mmi_msg_club_make_call, KEY_EVENT_UP);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    playRequestedTone(WARNING_TONE);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_send_msg_rsp
 * DESCRIPTION
 *  
 * PARAMETERS
 *  number      [?]         
 *  mod         [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_send_msg_rsp(void *number, module_type mod, U16 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    switch (result)
    {
        case MMI_FRM_SMS_OK:
            DisplayPopup(
                (PU8) GetString(STR_SMS_SEND_SUCCESS),
                IMG_SEND_SUCCESS_PIC_MSG,
                1,
                MESSAGES_POPUP_TIME_OUT,
                (U8) SUCCESS_TONE);
            mmi_frm_sms_delete_screen_history();
            AlmEnableSPOF();
            break;
        case MMI_FRM_SMS_ABORT:
            DisplayPopup(
                (PU8) GetString(STR_ABORT_SENDING_SMS),
                IMG_GLOBAL_ACTIVATED,
                1,
                MESSAGES_POPUP_TIME_OUT,
                (U8) SUCCESS_TONE);
            mmi_frm_sms_delete_screen_history();
            AlmEnableSPOF();
            break;
        case MMI_FRM_SMS_NOTREADY:
            DisplayPopup(
                (PU8) GetString(STR_SMS_MSG_NOT_READY_YET),
                IMG_SEND_FAIL_PIC_MSG,
                1,
                MESSAGES_POPUP_TIME_OUT,
                (U8) ERROR_TONE);
            AlmEnableSPOF();
            break;
        case MMI_FRM_SMS_RETURN:
        case MMI_FRM_SMS_END:
            break;
        default:
            DisplayPopup(
                (PU8) GetString(STR_SMS_SEND_FAILED),
                IMG_SEND_FAIL_PIC_MSG,
                1,
                MESSAGES_POPUP_TIME_OUT,
                (U8) ERROR_TONE);
            mmi_frm_sms_delete_screen_history();
            AlmEnableSPOF();
            break;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_send_msg_req
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_send_msg_req(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 textbuf[MSG_CLUB_CODE_LENGTH];
    S8 textbufucs2[MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH];
    S8 codebufucs2[(MSG_CLUB_CODE_LENGTH + MSG_CLUB_INPUT_BUFF_LEN) * ENCODING_LENGTH];
    EMSData *pEMS;
    S16 error;
    U8 result;
    history temphistory;
    U8 service = msg_club_level_3_index;
    U8 serviceNum[MSG_CLUB_LONG_CODE_LENGTH + 1];
    U16 serviceType;

    U8 codeNum[MSG_CLUB_LONG_CODE_LENGTH];
    U16 codeType;

    U8 serviceCode[MSG_CLUB_SHORT_CODE_LENGTH * ENCODING_LENGTH];
    U8 servicePrefix = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
   /****************phone number********************/
    memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
    memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
    memset(g_msg_cntx.smsPhoneNumber, 0, (MAX_DIGITS + 1) * ENCODING_LENGTH);
    memset(serviceNum, 0, MSG_CLUB_LONG_CODE_LENGTH + 1);

    if ((MSGClubNetwork == MSG_CLUB_CU) && ((MSGClubSMSItem.strInput_codeCU & 0x0f) > 1))
    {
        memcpy(
            (S8*) & MSGClubSMSItem,
            (S8*) & MenuExtra[(MSGClubSMSItem.strInput_codeCU & 0x0f)],
            sizeof(msg_club_entry_dy_db_zf_struct));
    }

    PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "service=%d*\n", service);
    switch (service)
    {
        case MSG_CLUB_SERVICE_SUBSCRIBE:
            memcpy(
                serviceNum,
                NumService[MSGClubSMSItem.serverType].serverDY[MSGClubNetwork].codeNum,
                MSG_CLUB_LONG_CODE_LENGTH);
            serviceType = NumService[MSGClubSMSItem.serverType].serverDY[MSGClubNetwork].codeType;
            break;
        case MSG_CLUB_SERVICE_ORDER:
            memcpy(
                serviceNum,
                NumService[MSGClubSMSItem.serverType].serverDB[MSGClubNetwork].codeNum,
                MSG_CLUB_LONG_CODE_LENGTH);
            serviceType = NumService[MSGClubSMSItem.serverType].serverDB[MSGClubNetwork].codeType;
            PRINT_INFORMATION_2(MMI_TRACE_G6_SMS, "serviceType=%d*\n", serviceType);
            break;
        case MSG_CLUB_SERVICE_EXPLAIN:
            memcpy(
                serviceNum,
                NumService[MSGClubSMSItem.serverType].serverZF[MSGClubNetwork].codeNum,
                MSG_CLUB_LONG_CODE_LENGTH);
            serviceType = NumService[MSGClubSMSItem.serverType].serverZF[MSGClubNetwork].codeType;
            break;
        case MSG_CLUB_SERVICE_CANCEL:
            memcpy(
                serviceNum,
                NumService[MSGClubSMSItem.serverType].serverTD[MSGClubNetwork].codeNum,
                MSG_CLUB_LONG_CODE_LENGTH);
            serviceType = NumService[MSGClubSMSItem.serverType].serverTD[MSGClubNetwork].codeType;
            break;
    }

    /* service number */
    mmi_asc_to_ucs2((S8*) textbufucs2, (S8*) serviceNum);
    mmi_ucs2cat(g_msg_cntx.smsPhoneNumber, textbufucs2);

    if ((serviceType & NUMBER_END) == NUMBER_END)
    {
        /* handset number */
        memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        ReadRecord(NVRAM_EF_MSG_CLUB_NUM_LID, 1, textbuf, NVRAM_MSG_CLUB_NUM_RECORD_SIZE, &error);
        mmi_asc_to_ucs2(textbufucs2, textbuf);
        mmi_ucs2cat(g_msg_cntx.smsPhoneNumber, textbufucs2);

    }
    if ((serviceType & CODE_END) == CODE_END)
    {
        memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        mmi_asc_to_ucs2(textbufucs2, mmi_msg_club_get_number_end());
        mmi_ucs2cat(g_msg_cntx.smsPhoneNumber, textbufucs2);
    }

    /* product code */
    ReleaseEMSEditBuffer();
    memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
    memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
    memset(codebufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
    memset(serviceCode, 0, MSG_CLUB_SHORT_CODE_LENGTH * ENCODING_LENGTH);
    memset(codeNum, 0, MSG_CLUB_LONG_CODE_LENGTH - 1);

    switch (service)
    {
        case MSG_CLUB_SERVICE_SUBSCRIBE:
            memcpy(codeNum, MSGClubSMSItem.codeDY.codeNum, MSG_CLUB_LONG_CODE_LENGTH - 1);
            mmi_asc_to_ucs2((S8*) serviceCode, mmi_msg_club_get_code_subscribe());
            codeType = MSGClubSMSItem.codeDY.codeType;
            break;
        case MSG_CLUB_SERVICE_ORDER:
            memcpy(codeNum, MSGClubSMSItem.codeDB.codeNum, MSG_CLUB_LONG_CODE_LENGTH - 1);
            mmi_asc_to_ucs2((S8*) serviceCode, mmi_msg_club_get_code_order());
            codeType = MSGClubSMSItem.codeDB.codeType;
            break;
        case MSG_CLUB_SERVICE_EXPLAIN:
            memcpy(codeNum, MSGClubSMSItem.codeZF.codeNum, MSG_CLUB_LONG_CODE_LENGTH - 1);
            mmi_asc_to_ucs2((S8*) serviceCode, mmi_msg_club_get_code_explain());
            codeType = MSGClubSMSItem.codeZF.codeType;
            break;
        case MSG_CLUB_SERVICE_CANCEL:
            memcpy(codeNum, MSGClubSMSItem.codeTD.codeNum, MSG_CLUB_SHORT_CODE_LENGTH);
            codeType = 0;
            break;
    }
    if ((codeType & PHONE_PRE) == PHONE_PRE)
    {
        memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        memset(codebufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        ReadRecord(NVRAM_EF_MSG_CLUB_LID, 1, textbuf, NVRAM_MSG_CLUB_RECORD_SIZE, &error);
        mmi_asc_to_ucs2(codebufucs2, textbuf);
        servicePrefix = 1;
    }

    if ((codeType & NUMBER_PRE) == NUMBER_PRE)
    {
        memset(textbuf, 0, MSG_CLUB_CODE_LENGTH);
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        ReadRecord(NVRAM_EF_MSG_CLUB_NUM_LID, 1, textbuf, NVRAM_MSG_CLUB_NUM_RECORD_SIZE, &error);
        mmi_asc_to_ucs2(textbufucs2, textbuf);
        mmi_ucs2cat(codebufucs2, textbufucs2);
        servicePrefix = 1;
    }

    if (servicePrefix == 1)
    {
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        mmi_asc_to_ucs2(textbufucs2, mmi_msg_club_get_code_sms());
        mmi_ucs2cat(codebufucs2, textbufucs2);
    }

    if ((codeType & CODE_PRE) == CODE_PRE)
    {
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        mmi_asc_to_ucs2(textbufucs2, mmi_msg_club_get_code_dummy());
        mmi_ucs2cat(codebufucs2, textbufucs2);
    }

    if (servicePrefix == 1)
    {
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        mmi_asc_to_ucs2(textbufucs2, mmi_msg_club_get_code_devide());
        mmi_ucs2cat(codebufucs2, textbufucs2);
    }

    if ((codeType & SERVICE_PRE) == SERVICE_PRE)
    {
        mmi_ucs2cat(codebufucs2, (S8*) serviceCode);
    }

    memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
    mmi_asc_to_ucs2(textbufucs2, (S8*) codeNum);
    mmi_ucs2cat(codebufucs2, textbufucs2);

    if ((codeType & SER_END) == SER_END)
    {
        mmi_ucs2cat(codebufucs2, (S8*) serviceCode);
    }

    if ((MSGClubInputType & INPUT_CODE) == INPUT_CODE)
    {
        mmi_ucs2cat(codebufucs2, MSGClubInputBuff);
    }

    if (MSGClubInputLen2)
    {
        memset(textbufucs2, 0, MSG_CLUB_CODE_LENGTH * ENCODING_LENGTH);
        mmi_asc_to_ucs2((S8*) textbufucs2, MSG_CLUB_INPUT_SEPEATE);
        mmi_ucs2cat(codebufucs2, textbufucs2);
        mmi_ucs2cat(codebufucs2, MSGClubInputBuff2);
    }

    memset(&temphistory, 0, sizeof(temphistory));
    GetHistory(SCR_ID_MSG_WRITE, &temphistory);
    pEMS = GetEMSDataForEdit(0, 0);
    /* NOTE: change function name to a general one!!!! */

    if ((MSGClubInputType & INPUT_CHI) == INPUT_CHI)
    {
        result = AppendEMSString(
                    INPUT_TYPE_ALPHANUMERIC_SENTENCECASE,
                    pEMS,
                    (U8*) codebufucs2,
                    SMSAL_UCS2_DCS,
                    temphistory.guiBuffer);
    }
    else
    {
        result = AppendEMSString(
                    INPUT_TYPE_ALPHANUMERIC_SENTENCECASE,
                    pEMS,
                    (U8*) codebufucs2,
                    SMSAL_DEFAULT_DCS,
                    temphistory.guiBuffer);
    }

    if (result)
    {
        mmi_frm_sms_send_struct *sendData = OslMalloc(sizeof(mmi_frm_sms_send_struct));

        memset((S8*) sendData, 0, sizeof(mmi_frm_sms_send_struct));
        memset(sendData->number, 0, MAX_DIGITS_SMS);
        if (mmi_ucs2strlen((S8*) smsPhoneNumber))
        {
            mmi_ucs2_to_asc((S8*) sendData->number, (S8*) smsPhoneNumber);
        }
        mmi_frm_sms_send_sms(mmi_msg_club_send_msg_rsp, MOD_MMI, sendData);
        OslMfree(sendData);
    }
    else
    {
        DisplayPopup(
            (PU8) GetString(STR_SMS_DOES_NOT_SUPPORT),
            IMG_GLOBAL_UNFINISHED,
            1,
            MESSAGES_POPUP_TIME_OUT,
            (U8) ERROR_TONE);
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_input_sms
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_input_sms(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CLUB_SMS_INPUT, NULL, mmi_msg_club_entry_input_sms, NULL);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLUB_SMS_INPUT);
    if ((MSGClubInputType & INPUT_PWD) == INPUT_PWD)
    {
        ShowCategory5Screen(
            MSGClubTitle2,
            IMG_MESSAGE_CLUB_ID,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            INPUT_TYPE_PHONE_NUMBER,
            (U8*) MSGClubInputBuff2,
            MSGClubInputLen2 + 1,
            guiBuffer);
    }
    else
    {
        ShowCategory5Screen(
            MSGClubTitle2,
            IMG_MESSAGE_CLUB_ID,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            INPUT_TYPE_ALPHANUMERIC_SENTENCECASE,
            (U8*) MSGClubInputBuff2,
            MSGClubInputLen2 + 1,
            guiBuffer);
    }
    SetLeftSoftkeyFunction(mmi_msg_club_send_msg, KEY_EVENT_UP);
    SetCategory5RightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_send_msg, KEY_SEND, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_input_done
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_input_done(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (MSGClubInputLen2)
    {
        mmi_msg_club_entry_input_sms();
    }
    else
    {
        mmi_msg_club_send_msg();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_input
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_input(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CLUB_NUM_INPUT, NULL, mmi_msg_club_entry_input, NULL);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLUB_NUM_INPUT);
    if (((MSGClubInputType & INPUT_NUM) == INPUT_NUM) || ((MSGClubInputType & INPUT_DA) == INPUT_DA))
    {
        ShowCategory5Screen(
            MSGClubTitle,
            IMG_MESSAGE_CLUB_ID,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            INPUT_TYPE_PHONE_NUMBER,
            (U8*) MSGClubInputBuff,
            MSGClubInputLen + 1,
            guiBuffer);
    }
    else
    {
        ShowCategory5Screen(
            MSGClubTitle,
            IMG_MESSAGE_CLUB_ID,
            STR_GLOBAL_OK,
            IMG_GLOBAL_OK,
            STR_GLOBAL_BACK,
            IMG_GLOBAL_BACK,
            INPUT_TYPE_ALPHANUMERIC_SENTENCECASE,
            (U8*) MSGClubInputBuff,
            MSGClubInputLen + 1,
            guiBuffer);
    }
    SetLeftSoftkeyFunction(mmi_msg_club_entry_input_done, KEY_EVENT_UP);
    SetCategory5RightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_entry_input_done, KEY_SEND, KEY_EVENT_UP);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_pre_entry_send_msg
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_pre_entry_send_msg(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MSGClubInputType = 0;
    if (MSGClubInputBuff != NULL)
    {
        OslMfree(MSGClubInputBuff);
        MSGClubInputBuff = NULL;
    }
    if (MSGClubInputBuff2 != NULL)
    {
        OslMfree(MSGClubInputBuff2);
        MSGClubInputBuff2 = NULL;
    }
    if ((msg_club_level_3_index == MSG_CLUB_SERVICE_SUBSCRIBE)
        && ((MSGClubSMSItem.codeDY.codeType & INPUT_CODE) == INPUT_CODE))
    {
        MSGClubInputType = MSGClubSMSItem.codeDY.codeType;
    }
    if ((msg_club_level_3_index == MSG_CLUB_SERVICE_ORDER)
        && ((MSGClubSMSItem.codeDB.codeType & INPUT_CODE) == INPUT_CODE))
    {
        MSGClubInputType = MSGClubSMSItem.codeDB.codeType;
    }
    if ((msg_club_level_3_index == MSG_CLUB_SERVICE_EXPLAIN)
        && ((MSGClubSMSItem.codeZF.codeType & INPUT_CODE) == INPUT_CODE))
    {
        MSGClubInputType = MSGClubSMSItem.codeZF.codeType;
    }
    if (MSGClubInputType)
    {
        if ((MSGClubInputType & INPUT_DA) == INPUT_DA)
        {
            MSGClubInputLen = MSG_CLUB_INPUT_DA_LEN;
            MSGClubTitle = STR_MSG_CLUB_ENTER_QQ;
        }
        else if ((MSGClubInputType & INPUT_NAME) == INPUT_NAME)
        {
            MSGClubInputLen = MSG_CLUB_INPUT_NAME_LEN;
            MSGClubTitle = STR_MSG_CLUB_ENTER_NICKNAME;
        }
        else
        {
            MSGClubInputLen = MSG_CLUB_INPUT_BUFF_LEN;
            if ((MSGClubInputType & INPUT_NUM) == INPUT_NUM)
            {
                MSGClubTitle = STR_MSG_CLUB_ENTER_NUMBER;
            }
            else
            {
                MSGClubTitle = STR_MSG_CLUB_ENTER_NAME;
            }
        }
        MSGClubInputBuff = OslMalloc((MSGClubInputLen + 1) * ENCODING_LENGTH);
        memset(MSGClubInputBuff, 0, (MSGClubInputLen + 1) * ENCODING_LENGTH);

        if ((MSGClubInputType & INPUT_SMS) == INPUT_SMS)
        {
            MSGClubInputLen2 = MSG_CLUB_INPUT_SMS_LEN;
            MSGClubTitle2 = STR_MSG_CLUB_ENTER_MSG;
        }
        else if ((MSGClubInputType & INPUT_PWD) == INPUT_PWD)
        {
            MSGClubInputLen2 = MSG_CLUB_INPUT_PWD_LEN;
            MSGClubTitle2 = STR_MSG_CLUB_ENTER_PWD;
        }
        else
        {
            MSGClubInputLen2 = 0;
        }
        if (MSGClubInputLen2)
        {
            MSGClubInputBuff2 = OslMalloc((MSGClubInputLen2 + 1) * ENCODING_LENGTH);
            memset(MSGClubInputBuff2, 0, (MSGClubInputLen2 + 1) * ENCODING_LENGTH);
        }
        if ((MSGClubSMSItem.strInput_codeCU & 0xf0) > 0)
        {
            mmi_msg_club_pre_entry_input();
        }
        else
        {
            mmi_msg_club_entry_input();
        }
    }
    else
    {
        mmi_msg_club_send_msg();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_highlight_subscribe
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_highlight_subscribe(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_highlight_generic(
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        mmi_msg_club_pre_entry_send_msg,
        GoBackHistory);
    ClearKeyHandler(KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    msg_club_level_3_index = MSG_CLUB_SERVICE_SUBSCRIBE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_highlight_order
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_highlight_order(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_highlight_generic(
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        mmi_msg_club_pre_entry_send_msg,
        GoBackHistory);
    ClearKeyHandler(KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    msg_club_level_3_index = MSG_CLUB_SERVICE_ORDER;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_highlight_explain
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_highlight_explain(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_highlight_generic(
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        mmi_msg_club_pre_entry_send_msg,
        GoBackHistory);
    ClearKeyHandler(KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    msg_club_level_3_index = MSG_CLUB_SERVICE_EXPLAIN;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_highlight_quit
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_highlight_quit(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_highlight_generic(
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        mmi_msg_club_pre_entry_send_msg,
        GoBackHistory);
    ClearKeyHandler(KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    msg_club_level_3_index = MSG_CLUB_SERVICE_CANCEL;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_set_menu_highlight_handler
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_set_menu_highlight_handler(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    SetHiliteHandler(MENU_MSG_CLUB_SUBSCRIBE, mmi_msg_club_highlight_subscribe);
    SetHiliteHandler(MENU_MSG_CLUB_ORDER, mmi_msg_club_highlight_order);
    SetHiliteHandler(MENU_MSG_CLUB_EXPLAIN, mmi_msg_club_highlight_explain);
    SetHiliteHandler(MENU_MSG_CLUB_QUIT, mmi_msg_club_highlight_quit);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_go_back_menu
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_go_back_menu(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memset((S8*) & MSGClubScreen[MSGClubCount], 0, sizeof(msg_club_entry_menu_struct));
    MSGClubCount--;
    GoBackHistory();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_level_3_get_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  nIndex      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_level_3_get_index(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_club_level_3_index = (U8) nIndex;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_level_2_get_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  nIndex      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_level_2_get_index(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_club_level_2_index = (U8) nIndex;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_voice_submenu
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_voice_submenu(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    U8 *itemList[MSG_CLUB_MENUITEM_NUM];
    U8 itemNum = MSGClubScreen[MSGClubCount].childNum;
    U8 i;
    U8 *caption;
    msg_club_entry_voice_struct *itemInfo = (msg_club_entry_voice_struct*) MSGClubScreen[MSGClubCount].childEntry;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (MSGClubScreen[MSGClubCount].childNum == 0)
    {
        msg_club_level_2_index = 0;
        mmi_msg_club_entry_make_call();
        memset((S8*) & MSGClubScreen[MSGClubCount], 0, sizeof(msg_club_entry_menu_struct));
        MSGClubCount--;
        return;
    }

    EntryNewScreen(SCR_ID_MSG_CLUB_VOICE_SUBMENU, NULL, mmi_msg_club_entry_voice_submenu, NULL);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLUB_VOICE_SUBMENU);
    for (i = 0; i < MSGClubScreen[MSGClubCount].childNum; i++)
#ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
        itemList[i] = (U8*) get_string_lang(itemInfo[i].stringID, SSC_ENGLISH);
#else 
        itemList[i] = (U8*) GetString(itemInfo[i].stringID);
#endif 
    RegisterHighlightHandler(mmi_msg_club_level_2_get_index);

#ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
    caption = (U8*) get_string_lang(MSGClubScreen[MSGClubCount].stringID, SSC_ENGLISH);
#else 
    caption = (U8*) GetString(MSGClubScreen[MSGClubCount].stringID);
#endif 
    ShowCategory353Screen(
        caption,
        IMG_MESSAGE_CLUB_ID,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        itemNum,
        itemList,
        (U16*) gIndexIconsImageList,
        NULL,
        0,
        0,
        guiBuffer);

    SetLeftSoftkeyFunction(mmi_msg_club_entry_make_call, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_entry_make_call, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetRightSoftkeyFunction(mmi_msg_club_go_back_menu, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_go_back_menu, KEY_LEFT_ARROW, KEY_EVENT_DOWN);

}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_level_3
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_level_3(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer;
    U16 nStrItemList[MAX_SUB_MENUS];
    U8 *itemList[MSG_CLUB_MENUITEM_NUM];
    U16 numItems;
    U32 menuItemId = -1;
    U32 menuItemId1 = -1;
    U32 maskingByte = -1;
    U8 i = 0;
    U8 *captionStr;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CLUB_LEVEL_3, NULL, mmi_msg_club_entry_level_3, NULL);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLUB_LEVEL_3);
    SetParentHandler(MENU_MSG_CLUB_OPTION);
    RegisterHighlightHandler(ExecuteCurrHiliteHandler);
    numItems = GetNumOfChild(MENU_MSG_CLUB_OPTION);
    GetSequenceStringIds(MENU_MSG_CLUB_OPTION, nStrItemList);
    mmi_msg_club_set_menu_highlight_handler();

    menuItemId = GetChildMenuIDIndexByParentMenuID(MENU_MSG_CLUB_OPTION, MENU_MSG_CLUB_SUBSCRIBE);
    if (menuItemId != -1)
    {
        if (strcmp((S8*) MSGClubSMSItem.codeDY.codeNum, "") == 0)
        {
            ResetBit(maskingByte, menuItemId /* 1 */ );
        }
        else
        {
        #ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
            itemList[i] = (U8*) get_string_lang(STR_MSG_CLUB_SUBSCRIBE, SSC_ENGLISH);
        #else 
            itemList[i] = (U8*) GetString(STR_MSG_CLUB_SUBSCRIBE);
        #endif 
            i++;
        }
    }
    menuItemId = GetChildMenuIDIndexByParentMenuID(MENU_MSG_CLUB_OPTION, MENU_MSG_CLUB_ORDER);
    if (menuItemId != -1)
    {
        if (strcmp((S8*) MSGClubSMSItem.codeDB.codeNum, "") == 0)
        {
            ResetBit(maskingByte, menuItemId /* 2 */ );
        }
        else
        {
        #ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
            itemList[i] = (U8*) get_string_lang(STR_MSG_CLUB_ORDER, SSC_ENGLISH);
        #else 
            itemList[i] = (U8*) GetString(STR_MSG_CLUB_ORDER);
        #endif 
            i++;
        }
    }
    menuItemId = GetChildMenuIDIndexByParentMenuID(MENU_MSG_CLUB_OPTION, MENU_MSG_CLUB_EXPLAIN);
    if (menuItemId != -1)
    {
        if (strcmp((S8*) MSGClubSMSItem.codeZF.codeNum, "") == 0)
        {
            ResetBit(maskingByte, menuItemId /* 3 */ );
        }
        else
        {
        #ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
            itemList[i] = (U8*) get_string_lang(STR_MSG_CLUB_INQUIRE, SSC_ENGLISH);
        #else 
            itemList[i] = (U8*) GetString(STR_MSG_CLUB_INQUIRE);
        #endif 
            i++;
        }
    }
    menuItemId = GetChildMenuIDIndexByParentMenuID(MENU_MSG_CLUB_OPTION, MENU_MSG_CLUB_QUIT);
    if (menuItemId != -1)
    {
        if (strcmp((S8*) MSGClubSMSItem.codeTD.codeNum, "") == 0)
        {
            ResetBit(maskingByte, menuItemId /* 4 */ );
        }
        else
        {
        #ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
            itemList[i] = (U8*) get_string_lang(STR_MSG_CLUB_QUIT, SSC_ENGLISH);
        #else 
            itemList[i] = (U8*) GetString(STR_MSG_CLUB_QUIT);
        #endif 
            i++;
        }
    }

    MaskHiliteItems(MENU_MSG_CLUB_OPTION, maskingByte);
    numItems = MaskItems(nStrItemList, (U8) numItems, maskingByte);

#ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
    captionStr = (U8*) get_string_lang(MSGClubSMSItem.stringID, SSC_ENGLISH);
#else 
    captionStr = (U8*) GetString(MSGClubSMSItem.stringID);
#endif 

    ShowCategory353Screen(
        captionStr,
        IMG_MESSAGE_CLUB_ID,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        numItems,
        itemList,
        (U16*) gIndexIconsImageList,
        NULL,
        0,
        0,
        guiBuffer);
    SetRightSoftkeyFunction(GoBackHistory, KEY_EVENT_UP);   /* MTK Jo */
    SetKeyHandler(GoBackHistory, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_pre_entry_level_3
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_pre_entry_level_3(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    msg_club_entry_dy_db_zf_struct *itemInfo =
        (msg_club_entry_dy_db_zf_struct*) MSGClubScreen[MSGClubCount].childEntry;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    memcpy((S8*) & MSGClubSMSItem, (S8*) & itemInfo[msg_club_level_2_index], sizeof(msg_club_entry_dy_db_zf_struct));
    if ((strcmp((S8*) MSGClubSMSItem.codeDY.codeNum, "") != 0)
        || (strcmp((S8*) MSGClubSMSItem.codeDB.codeNum, "") != 0))
    {
        mmi_msg_club_entry_level_3();
    }
    else
    {
        if (strcmp((S8*) MSGClubSMSItem.codeZF.codeNum, "") != 0)
        {
            msg_club_level_3_index = MSG_CLUB_SERVICE_EXPLAIN;
        }
        else
        {
            msg_club_level_3_index = MSG_CLUB_SERVICE_CANCEL;
        }
        mmi_msg_club_pre_entry_send_msg();
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_level_2
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_level_2(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    S32 hiliteitem = 0;
    U8 *itemList[MSG_CLUB_MENUITEM_NUM];
    U8 itemNum = MSGClubScreen[MSGClubCount].childNum;
    U8 i;
    U8 *captionStr;
    msg_club_entry_dy_db_zf_struct *itemInfo =
        (msg_club_entry_dy_db_zf_struct*) MSGClubScreen[MSGClubCount].childEntry;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(SCR_ID_MSG_CLUB_LEVEL_2, NULL, mmi_msg_club_entry_level_2, NULL);
    guiBuffer = GetCurrGuiBuffer(SCR_ID_MSG_CLUB_LEVEL_2);
    for (i = 0; i < MSGClubScreen[MSGClubCount].childNum; i++)
    {
    #ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
        itemList[i] = (U8*) get_string_lang(itemInfo[i].stringID, SSC_ENGLISH);
    #else 
        itemList[i] = (U8*) GetString(itemInfo[i].stringID);
    #endif 
    }

    RegisterHighlightHandler(mmi_msg_club_level_2_get_index);

#ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
    captionStr = (U8*) get_string_lang(MSGClubMenuItem[msg_club_level_1_index].stringID, SSC_ENGLISH);
#else 
    captionStr = (U8*) GetString(MSGClubMenuItem[msg_club_level_1_index].stringID);
#endif 
    ShowCategory353Screen(
        captionStr,
        IMG_MESSAGE_CLUB_ID,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        itemNum,
        itemList,
        (U16*) gIndexIconsImageList,
        NULL,
        0,
        0,
        guiBuffer);

    SetLeftSoftkeyFunction(mmi_msg_club_pre_entry_level_3, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_pre_entry_level_3, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetRightSoftkeyFunction(mmi_msg_club_go_back_menu, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_go_back_menu, KEY_LEFT_ARROW, KEY_EVENT_DOWN);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_level_1_get_index
 * DESCRIPTION
 *  
 * PARAMETERS
 *  nIndex      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_level_1_get_index(S32 nIndex)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    msg_club_level_1_index = (U8) nIndex;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_pre_entry_menu
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_pre_entry_menu(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    MSGClubCount++;
    memcpy(
        (S8*) & MSGClubScreen[MSGClubCount],
        (S8*) & MSGClubMenuItem[msg_club_level_1_index],
        sizeof(msg_club_entry_menu_struct));
    if ((MSGClubScreen[MSGClubCount].childType & MSG_CLUB_MENU) == MSG_CLUB_MENU)
    {
        mmi_msg_club_entry_level_1();
    }
    else if ((MSGClubScreen[MSGClubCount].childType & MSG_CLUB_VOICE_MENU) == MSG_CLUB_VOICE_MENU)
    {
        mmi_msg_club_entry_voice_submenu();
    }
    else if (MSGClubScreen[MSGClubCount].childNum > 0)
    {
        mmi_msg_club_entry_level_2();
    }
    else
    {
        msg_club_entry_dy_db_zf_struct *itemInfo =
            (msg_club_entry_dy_db_zf_struct*) MSGClubScreen[MSGClubCount].childEntry;
        memcpy((S8*) & MSGClubSMSItem, (S8*) & itemInfo[0], sizeof(msg_club_entry_dy_db_zf_struct));
        memset((S8*) & MSGClubScreen[MSGClubCount], 0, sizeof(msg_club_entry_menu_struct));
        MSGClubCount--;
        if ((strcmp((S8*) MSGClubSMSItem.codeDY.codeNum, "") != 0)
            || (strcmp((S8*) MSGClubSMSItem.codeDB.codeNum, "") != 0))
        {
            mmi_msg_club_entry_level_3();
        }
        else
        {
            if (strcmp((S8*) MSGClubSMSItem.codeZF.codeNum, "") != 0)
            {
                msg_club_level_3_index = MSG_CLUB_SERVICE_EXPLAIN;
            }
            else
            {
                msg_club_level_3_index = MSG_CLUB_SERVICE_CANCEL;
            }
            mmi_msg_club_pre_entry_send_msg();
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_club_entry_level_1
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_club_entry_level_1(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U8 *guiBuffer = NULL;
    U8 *itemList[MSG_CLUB_MENUITEM_NUM];
    U8 itemNum = 0;
    U8 i, j = 0;
    U8 *captionStr;
    msg_club_entry_menu_struct *itemInfo = (msg_club_entry_menu_struct*) MSGClubScreen[MSGClubCount].childEntry;
    U16 scrIndex = SCR_ID_MSG_CLUB_LEVEL_1 + (U16) MSGClubCount;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    EntryNewScreen(scrIndex, NULL, mmi_msg_club_entry_level_1, NULL);
    guiBuffer = GetCurrGuiBuffer(scrIndex);
    for (i = 0; i < MSGClubScreen[MSGClubCount].childNum; i++)
    {
        if (((itemInfo[i].childType & MSG_CLUB_CT_ONLY) == MSG_CLUB_CT_ONLY) && (MSGClubNetwork != MSG_CLUB_CT))
        {
            continue;
        }
    #ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
        itemList[j] = (U8*) get_string_lang(itemInfo[i].stringID, SSC_ENGLISH);
    #else 
        itemList[j] = (U8*) GetString(itemInfo[i].stringID);
    #endif 
        memcpy((S8*) & MSGClubMenuItem[j], (S8*) & itemInfo[i], sizeof(msg_club_entry_menu_struct));
        j++;
    }
    itemNum = j;
    RegisterHighlightHandler(mmi_msg_club_level_1_get_index);

#ifdef __MMI_MESSAGES_CLUB_SIM_CHINESE__
    captionStr = (U8*) get_string_lang(MSGClubScreen[MSGClubCount].stringID, SSC_ENGLISH);
#else 
    captionStr = (U8*) GetString(MSGClubScreen[MSGClubCount].stringID);
#endif 

    ShowCategory353Screen(
        captionStr,
        IMG_MESSAGE_CLUB_ID,
        STR_GLOBAL_OK,
        IMG_GLOBAL_OK,
        STR_GLOBAL_BACK,
        IMG_GLOBAL_BACK,
        itemNum,
        itemList,
        (U16*) gIndexIconsImageList,
        NULL,
        0,
        0,
        guiBuffer);

    SetLeftSoftkeyFunction(mmi_msg_club_pre_entry_menu, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_pre_entry_menu, KEY_RIGHT_ARROW, KEY_EVENT_DOWN);
    SetRightSoftkeyFunction(mmi_msg_club_go_back_menu, KEY_EVENT_UP);
    SetKeyHandler(mmi_msg_club_go_back_menu, KEY_LEFT_ARROW, KEY_EVENT_DOWN);

}


/*****************************************************************************
 * FUNCTION
 *  EntryMsgClub
 * DESCRIPTION
 *  
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void EntryMsgClub(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    /* micha0422 */
    if ((strncmp(gHomePLMNNum, "46000", 5) == 0) || (strncmp(gHomePLMNNum, "46002", 5) == 0))
    {
        MSGClubNetwork = MSG_CLUB_CT;
    }
    else if (strncmp(gHomePLMNNum, "46001", 5) == 0)
    {
        MSGClubNetwork = MSG_CLUB_CU;
    }
    else
    {
        MSGClubNetwork = MSG_CLUB_NETWORK_TOTAL;
    }
    if (MSGClubNetwork == MSG_CLUB_NETWORK_TOTAL)
    {
        DisplayPopup(
            (PU8) GetString(STR_SMS_DOES_NOT_SUPPORT),
            IMG_GLOBAL_UNFINISHED,
            1,
            MESSAGES_POPUP_TIME_OUT,
            (U8) ERROR_TONE);
    }
    else
    {
        MSGClubCount = 0;
        memset(MSGClubScreen, 0, sizeof(msg_club_entry_menu_struct) * MSG_CLUB_SCREEN_NUM);
        MSGClubScreen[0].stringID = STR_MSG_CLUB;
        MSGClubScreen[0].childNum = mmi_msg_club_get_item_total();
        MSGClubScreen[0].childType = MSG_CLUB_MENU;
        MSGClubScreen[0].childEntry = (void*)MenuMSGClub;
        mmi_msg_club_entry_level_1();
    }

}

#endif /* __MMI_MESSAGES_CLUB__ */ 

#ifdef __MMI_UNIFIED_MESSAGE__


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_um_entry_msg
 * DESCRIPTION
 *  entry sms msg
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_um_entry_msg(UmMsgBoxType msg_box_type, kal_uint16 msg_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    UmMsgBoxType type = msg_box_type;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.currBoxIndex = msg_index;

    switch (type)
    {
    #ifdef __UNIFIED_MESSAGE_LIST_OPTION_SUPPORT__
        case UM_MSG_BOX_TYPE_INBOX:
        {
            /* Update the totalinbox value in order to get the current inbox list size  */
            msgbox_info.totalinbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX);
            mmi_msg_pre_entry_list_option_req(MMI_FRM_SMS_APP_INBOX);            
            break;
        }
        case UM_MSG_BOX_TYPE_SENT:
        {            
            mmi_msg_pre_entry_list_option_req(MMI_FRM_SMS_APP_OUTBOX);
            break;
        }
        case UM_MSG_BOX_TYPE_UNSENT:
		{
		    mmi_msg_pre_entry_list_option_req(MMI_FRM_SMS_APP_UNSENT);
			break;
        }

        case UM_MSG_BOX_TYPE_DRAFT:
        {
            mmi_msg_pre_entry_list_option_req(MMI_FRM_SMS_APP_DRAFTS);
            break;
        }
    #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__        
        case UM_MSG_BOX_TYPE_ARCHIVE:
        {            	
            mmi_msg_pre_entry_list_option_req(MMI_FRM_SMS_APP_ARCHIVE);
            break;
        }		
    #endif
#ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
        case UM_MSG_BOX_TYPE_SIM:
        {            
            mmi_msg_pre_entry_list_option_req(MMI_FRM_SMS_APP_SIM);
            break;
        }
    #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
    #else /* __UNIFIED_MESSAGE_LIST_OPTION_SUPPORT__ */
        case UM_MSG_BOX_TYPE_INBOX:
        {
            /* Update the totalinbox value in order to get the current inbox list size  */
            msgbox_info.totalinbox = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX);
            mmi_msg_get_msg_inbox();
            break;
        }
        case UM_MSG_BOX_TYPE_SENT:
        {
            mmi_msg_get_msg_outbox();
            break;
        }
        case UM_MSG_BOX_TYPE_UNSENT:
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
			mmi_msg_pre_entry_option_unsent();
#else  /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */	
			mmi_msg_get_msg_unsentbox();
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
			break;

        case UM_MSG_BOX_TYPE_DRAFT:
        {
            mmi_msg_get_msg_draftbox();
            break;
        }
    #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
        case UM_MSG_BOX_TYPE_ARCHIVE:
        {
            mmi_msg_get_msg_archive();
            break;
        }
    #endif
   #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
        case UM_MSG_BOX_TYPE_SIM:
        {            
            mmi_msg_get_msg_simbox();
            break;
        }
    #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
    
    #endif /* __UNIFIED_MESSAGE_LIST_OPTION_SUPPORT__ */                    
        default:
        {
            MMI_ASSERT(0);
            break;
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_um_entry_write
 * DESCRIPTION
 *  entry function for sms editor by Unified Message
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_um_entry_write(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.sendMessageCase = SEND_CASE_SEND_ONLY;
    g_msg_cntx.PhbSmsInterfaceState = MMI_SEND_ONLY;
    mmi_msg_entry_write_msg();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_um_entry_template
 * DESCRIPTION
 *  entry function for sms template
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_um_entry_template(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_entry_template_list();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_um_entry_setting
 * DESCRIPTION
 *  entry function for sms setting
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_um_entry_setting(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    mmi_msg_pre_entry_msg_settings();
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_set_background_process
 * DESCRIPTION
 *  set if SMS is in the background process
 * PARAMETERS
 *  flag        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_set_background_process(kal_bool flag)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.is_background_process = (U8) flag;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_check_background_process
 * DESCRIPTION
 *  check if SMS is in the background process
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
kal_bool mmi_msg_check_background_process(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (g_msg_cntx.is_background_process)
    {
        return KAL_TRUE;
    }
    else
    {
        return KAL_FALSE;
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_set_post_send_action_type
 * DESCRIPTION
 *  set the type of action after send
 * PARAMETERS
 *  action      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_set_post_send_action_type(U8 action)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    g_msg_cntx.post_send_action = action;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_post_send_action_type
 * DESCRIPTION
 *  get post send action type
 * PARAMETERS
 *  void
 * RETURNS
 *  void
 *****************************************************************************/
U8 mmi_msg_get_post_send_action_type(void)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    return g_msg_cntx.post_send_action;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_msg_num
 * DESCRIPTION
 *  get sms msg number of each msg box
 * PARAMETERS
 *  inbox_msg_number            [?]     
 *  inbox_unread_msg_number     [?]     
 *  unsent_msg_number           [?]     
 *  sent_msg_number             [?]     
 *  draft_msg_number            [?]     
 *  archive_msg_number          [?]    
 *  sim_msg_number              [?]   
 * RETURNS
 *  void
 *****************************************************************************/
kal_bool mmi_msg_get_msg_num(
            kal_uint16 *inbox_msg_number,
            kal_uint16 *inbox_unread_msg_number,
            kal_uint16 *unsent_msg_number,
            kal_uint16 *sent_msg_number,
            kal_uint16 *draft_msg_number
            #ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__            
            , kal_uint16 *archive_msg_number
            #endif
            #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
            , kal_uint16 *sim_msg_number
            #endif
            ) 
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_uint16 i = 0;
    U16 type = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (*inbox_msg_number == MMI_FRM_SMS_INVALID_INDEX)
    {
        return KAL_FALSE;
    }

    *inbox_msg_number = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_INBOX);
    *sent_msg_number = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_OUTBOX);
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__            
    *archive_msg_number = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_ARCHIVE); 
#endif
#ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
    *sim_msg_number = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_SIM); 
#endif
    *inbox_unread_msg_number = 0;
    *unsent_msg_number = 0;
    *draft_msg_number = 0;

    while (i < *inbox_msg_number)
    {
        type = mmi_frm_sms_get_status(MMI_FRM_SMS_APP_INBOX, i) & 0x0f;

        if (type == MMI_FRM_SMS_APP_UNREAD)
        {
            (*inbox_unread_msg_number)++;
        }
        i++;
    }

    *unsent_msg_number = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_UNSENT);
    *draft_msg_number = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_DRAFTS);    

    return KAL_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_list_info
 * DESCRIPTION
 *  get sms list info
 * PARAMETERS
 *  msg_box_type        [IN]        
 *  start_entry         [IN]        
 *  max_msg_number      [IN]        
 *  msg_number          [?]         
 *  list_info           [?]         
 *  more                [?]         
 * RETURNS
 *  void
 *****************************************************************************/
kal_bool mmi_msg_get_list_info(
            UmMsgBoxType msg_box_type,
            kal_uint16 start_entry,
            kal_uint16 max_msg_number,
            kal_uint16 *msg_number,
            mmi_um_list_info_struct *list_info,
            kal_bool *more)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_uint16 msg_list_index = start_entry;
    kal_uint16 i = 0;
    U8 *timestamp = NULL;
    U16 sms_msg_box_type = 0;
    kal_uint16 sms_msg_box_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *msg_number = 0;

    switch (msg_box_type)
    {
        case UM_MSG_BOX_TYPE_INBOX:
        {
            sms_msg_box_type = MMI_FRM_SMS_INBOX;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_INBOX);
            break;
        }
        case UM_MSG_BOX_TYPE_UNSENT:
        {
            sms_msg_box_type = MMI_FRM_SMS_UNSENT;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_UNSENT);
            break;
        }
        case UM_MSG_BOX_TYPE_SENT:
        {
            sms_msg_box_type = MMI_FRM_SMS_OUTBOX;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_OUTBOX);
            break;
        }
        case UM_MSG_BOX_TYPE_DRAFT:
        {
            sms_msg_box_type = MMI_FRM_SMS_DRAFTS;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_DRAFTS);
            break;
        }
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__        
        case UM_MSG_BOX_TYPE_ARCHIVE:
        {
            sms_msg_box_type = MMI_FRM_SMS_ARCHIVE;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_ARCHIVE);
            break;
        }
#endif
    #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
        case UM_MSG_BOX_TYPE_SIM:
        {
            sms_msg_box_type = MMI_FRM_SMS_SIM;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_SIM);
            break;
        }
    #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        default:
        {
            MMI_ASSERT(0);
            break;
        }
    }

    for (; (i < max_msg_number); i++)
    {
        UI_time datetime;

        if (msg_list_index >= sms_msg_box_size)
        {
            *more = KAL_FALSE;
            return KAL_TRUE;
        }

        timestamp = mmi_frm_sms_get_timestamp(sms_msg_box_type, msg_list_index);

        if (timestamp[1] == 0)
        {
            list_info[i].timestamp = 0;
        }
        else
        {
            datetime.nYear = timestamp[0] + 2000;
            if (datetime.nYear > 2090)
            {
                datetime.nYear = datetime.nYear - 100;
            }

            datetime.nMonth = timestamp[1];
            datetime.nDay = timestamp[2];

            datetime.nHour = timestamp[3];
            datetime.nMin = timestamp[4];
            datetime.nSec = timestamp[5];

            list_info[i].timestamp = mmi_dt_mytime_2_utc_sec((MYTIME*) & datetime, MMI_TRUE);
        }

        list_info[i].msg_index = msg_list_index;

        (*msg_number)++;

        msg_list_index++;
    }

    /* For inbox and sent */
    if (msg_list_index < sms_msg_box_size)
    {
        *more = KAL_TRUE;
    }
    else
    {
        *more = KAL_FALSE;
    }

    return KAL_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_msg_info
 * DESCRIPTION
 *  get sms msg info
 * PARAMETERS
 *  msg_box_type        [IN]        
 *  start_entry         [IN]        
 *  req_msg_number      [IN]        
 *  rsp_msg_number      [?]         
 *  msg_info            [?]         
 * RETURNS
 *  void
 *****************************************************************************/
kal_bool mmi_msg_get_msg_info(
            UmMsgBoxType msg_box_type,
            kal_uint16 start_entry,
            kal_uint16 req_msg_number,
            kal_uint16 *rsp_msg_number,
            mmi_um_msg_info_struct *msg_info)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_uint16 msg_list_index = start_entry;
    kal_uint16 i = 0;
    U8 *timestamp = NULL;
    U16 sms_msg_box_type = 0;
    kal_uint16 sms_msg_box_size = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    *rsp_msg_number = 0;

    switch (msg_box_type)
    {
        case UM_MSG_BOX_TYPE_INBOX:
        {
            sms_msg_box_type = MMI_FRM_SMS_INBOX;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_INBOX);
            break;
        }
        case UM_MSG_BOX_TYPE_UNSENT:
        {
            sms_msg_box_type = MMI_FRM_SMS_UNSENT;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_UNSENT);
            break;
        }
        case UM_MSG_BOX_TYPE_SENT:
        {
            sms_msg_box_type = MMI_FRM_SMS_OUTBOX;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_OUTBOX);
            break;
        }
        case UM_MSG_BOX_TYPE_DRAFT:
        {
            sms_msg_box_type = MMI_FRM_SMS_DRAFTS;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_DRAFTS);
            break;
        }
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__    
        case UM_MSG_BOX_TYPE_ARCHIVE:
        {
            sms_msg_box_type = MMI_FRM_SMS_ARCHIVE;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_ARCHIVE);
            break;
        }
#endif
    #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
        case UM_MSG_BOX_TYPE_SIM:
        {
            sms_msg_box_type = MMI_FRM_SMS_SIM;
            sms_msg_box_size = mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_SIM);
            break;
        }
    #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
        default:
        {
            MMI_ASSERT(0);
            break;
        }
    }

    for (; (i < req_msg_number); i++)
    {
        UI_time datetime;
        U16 sms_status;

        if (msg_list_index >= sms_msg_box_size)
        {
            break;
        }

        timestamp = mmi_frm_sms_get_timestamp(sms_msg_box_type, msg_list_index);

        if (timestamp[1] == 0)
        {
            msg_info[i].timestamp = 0;
        }
        else
        {
            datetime.nYear = timestamp[0] + 2000;
            if (datetime.nYear > 2090)
            {
                datetime.nYear = datetime.nYear - 100;
            }

            datetime.nMonth = timestamp[1];
            datetime.nDay = timestamp[2];

            datetime.nHour = timestamp[3];
            datetime.nMin = timestamp[4];
            datetime.nSec = timestamp[5];
            msg_info[i].timestamp = applib_dt_sec_local_to_utc(mmi_dt_mytime_2_utc_sec((MYTIME*) &datetime, MMI_TRUE));
        }
        msg_info[i].msg_index = msg_list_index;

        msg_info[i].address_type = UM_ADDR_TYPE_PHONE_NUMBER;
        mmi_msg_get_address(sms_msg_box_type, msg_list_index, msg_info[i].address, MMI_UM_MAX_ADDR_LEN);
        msg_info[i].address_length = mmi_ucs2strlen((S8*) msg_info[i].address);

        sms_status = mmi_frm_sms_get_sms_status(sms_msg_box_type, msg_list_index);

        if (!mmi_frm_sms_check_complete(sms_msg_box_type, msg_list_index))
        {
            mmi_ucs2ncpy(
                (S8*) msg_info[i].subject,
                (S8*) GetString(STR_UM_INCOMPLETE_ID),
                MMI_UM_MAX_SUBJECT_LEN);
            msg_info[i].subject_length = mmi_ucs2strlen((S8*) GetString(STR_UM_INCOMPLETE_ID));
        }
        else if ((sms_status >> 12) == SMSAL_MTI_STATUS_REPORT)
        {
            mmi_ucs2ncpy(
                (S8*) msg_info[i].subject,
                (S8*) GetString(STR_DELIVERY_REPORT_MENUENTRY),
                MMI_UM_MAX_SUBJECT_LEN);
            msg_info[i].subject_length = mmi_ucs2strlen((S8*) GetString(STR_DELIVERY_REPORT_MENUENTRY));
        }
        else if ((sms_status >> 12) == SMSAL_MTI_UNSPECIFIED)
        {
            mmi_ucs2ncpy(
                (S8*) msg_info[i].subject,
                (S8*) GetString(STR_UM_NOT_SUPPORT_ID),
                MMI_UM_MAX_SUBJECT_LEN);
            msg_info[i].subject_length = mmi_ucs2strlen((S8*) GetString(STR_UM_NOT_SUPPORT_ID));
        }
        else
        {
            mmi_frm_sms_get_content(
                sms_msg_box_type,
                msg_list_index,
                msg_info[i].subject,
                (kal_uint8) mmi_msg_get_max_content_size());
            msg_info[i].subject_length = mmi_ucs2strlen((S8*) msg_info[i].subject);

        #ifdef __MMI_MESSAGES_CHAT__
            if (msg_box_type == UM_MSG_BOX_TYPE_INBOX && CheckForInvitationMsg((U8*) msg_info[i].subject, msg_info[i].subject_length * 2, FALSE))
            {
                S8 *chat_invitation_pattern = mmi_msg_chat_get_invitation_pattern();
                U8 len = mmi_ucs2strlen(chat_invitation_pattern);

                memcpy(
                    (S8*) msg_info[i].subject,
                    (S8*) (msg_info[i].subject + len),
                    (msg_info[i].subject_length - len) * ENCODING_LENGTH);
                memset(
                    (S8*) (msg_info[i].subject + (msg_info[i].subject_length - len) * ENCODING_LENGTH),
                    0,
                    len * ENCODING_LENGTH);
                msg_info[i].subject_length -= len;
            }
        #endif /* __MMI_MESSAGES_CHAT__ */ 
        }

        msg_info[i].icon_id = mmi_msg_get_icon(sms_msg_box_type, msg_list_index);

        (*rsp_msg_number)++;

        msg_list_index++;
    }

    return KAL_TRUE;
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_address
 * DESCRIPTION
 *  get sms address
 * PARAMETERS
 *  msg_type            [IN]        
 *  msg_index           [IN]        
 *  address             [?]         
 *  max_address_len     [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_get_address(kal_uint16 msg_type, kal_uint16 msg_index, kal_wchar *address, kal_uint8 max_address_len)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    S8 temp[(MAX_DIGITS_SMS + 1) * ENCODING_LENGTH];
    S8 *name;

    U16 type = msg_type;
    kal_uint16 index = msg_index;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (((mmi_frm_sms_get_status(type, index) & 0xf000) >> 12) == SMSAL_MTI_STATUS_REPORT)
    {
        mmi_ucs2ncpy((S8*) address, (S8*) GetString(STR_INBOX_REPORT_ID), max_address_len);
    }
    else
    {
        memset(temp, 0, (MAX_DIGITS_SMS + 1) * ENCODING_LENGTH);
        mmi_asc_n_to_ucs2(temp,
        	(S8*)mmi_frm_sms_get_address(type, index),
        	MAX_DIGITS_SMS);

        if (mmi_ucs2strlen(temp) == 0)
        {
            mmi_ucs2cpy((S8*) address, (S8*) GetString(STR_OUTBOX_LIST_MESSAGE));
        }
        else
        {
            name = lookUpNumber(temp);
            if (mmi_ucs2strlen(name))
            {
                mmi_ucs2cpy((S8*) address, name);
            }
            else
            {
                mmi_ucs2cpy((S8*) address, temp);
            }
        }
    }
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_get_icon
 * DESCRIPTION
 *  get sms icon id
 * PARAMETERS
 *  msg_type        [IN]        
 *  msg_index       [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
#ifndef __MMI_DUAL_SIM_MASTER__
kal_uint16 mmi_msg_get_icon(kal_uint16 msg_type, kal_uint16 msg_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_uint16 icon_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (msg_type == MMI_FRM_SMS_INBOX)
    {
        if ((mmi_frm_sms_get_status(msg_type, (U16) msg_index) & 0x0f) == MMI_FRM_SMS_APP_UNREAD)
        {
            icon_id = IMG_MESSAGE_UNREAD;
        }
        else
        {
            if (mmi_frm_sms_check_complete(msg_type, (U16) msg_index) == TRUE)
            {
                icon_id = IMG_MESSAGE_READ;
            }
            else
            {
                icon_id = IMG_MESSAGE_SS_NCOMP;
            }
        }
    }
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__    
    else if (msg_type == MMI_FRM_SMS_ARCHIVE)
    {
        mmi_frm_sms_msgbox_enum srcBoxType = mmi_frm_sms_get_archive_src_box_type(msg_type, msg_index) ; 
		
        if (srcBoxType == MMI_FRM_SMS_UNREAD)  /*if the msg is not NCOMP and unread, show unread icon*/
        {
            icon_id = IMG_MESSAGE_UNREAD;
        }
        else if (!mmi_frm_sms_check_complete(msg_type, (U16) msg_index) )
        {
            icon_id = IMG_MESSAGE_SS_NCOMP;
        }
        else if (srcBoxType == MMI_FRM_SMS_INBOX)
        {
            icon_id = IMG_MESSAGE_READ;
        }		
        else
        {
            icon_id = IMG_MESSAGE_SENT;
        }
    }
#endif
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
	else if (msg_type == MMI_FRM_SMS_UNSENT)
	{
		U8 unsent_status;
		
		unsent_status = mmi_frm_sms_get_unsent_status(msg_index);

		switch (unsent_status)
		{
		case MMI_FRM_SMS_APP_WAITING:
			icon_id = IMG_MESSAGE_WAITING;
			break;

		case MMI_FRM_SMS_APP_FAILTOSEND:
			icon_id = IMG_MESSAGE_FAILTOSENT;
			break;
			
		case MMI_FRM_SMS_APP_SENDING:
			icon_id = IMG_MESSAGE_SENDING;
			break;

		default:
			MMI_ASSERT(0);
			break;	
		}
	}
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
    else
    {
        if (mmi_frm_sms_check_complete(msg_type, (U16) msg_index) == FALSE)
        {
            icon_id = IMG_MESSAGE_SS_NCOMP;
        }
        else
        {
        #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
            if (msg_type == MMI_FRM_SMS_SIM)
            {
                msg_type = mmi_frm_sms_get_status(msg_type, (U16) msg_index);
                msg_type &= 0x0f; 
                if (msg_type == MMI_FRM_SMS_UNREAD)
                {
                    icon_id = IMG_MESSAGE_UNREAD;

                    return icon_id;
                }
                else if (msg_type == MMI_FRM_SMS_INBOX)
                {
                    icon_id = IMG_MESSAGE_READ;

                    return icon_id;
                }
            }
        #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
            {
                if (msg_type == MMI_FRM_SMS_OUTBOX)
                {
                    icon_id = IMG_MESSAGE_SENT;
                }
                else
                {
                    icon_id = IMG_MESSAGE_UNSENT;
                }
            }
        }
    }
    return icon_id;
}
#else /* __MMI_DUAL_SIM_MASTER__ */
kal_uint16 mmi_msg_get_icon(kal_uint16 msg_type, kal_uint16 msg_index)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    kal_uint16 icon_id = 0;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (mmi_frm_sms_record_is_slave_sms(msg_type, msg_index)) {
        if (msg_type == MMI_FRM_SMS_INBOX)
        {
            if ((mmi_frm_sms_get_status(msg_type, (U16) msg_index) & 0x0f) == MMI_FRM_SMS_APP_UNREAD)
            {
                icon_id = IMG_SLAVE_MESSAGE_UNREAD;
            }
            else
            {
                if (mmi_frm_sms_check_complete(msg_type, (U16) msg_index) == TRUE)
                {
                    icon_id = IMG_SLAVE_MESSAGE_READ;
                }
                else
                {
                    icon_id = IMG_SLAVE_MESSAGE_SS_NCOMP;
                }
            }
        }
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__    
        else if (msg_type == MMI_FRM_SMS_ARCHIVE)
        {
            mmi_frm_sms_msgbox_enum srcBoxType = mmi_frm_sms_get_archive_src_box_type(msg_type, msg_index) ; 
    		
            if (srcBoxType == MMI_FRM_SMS_UNREAD)  /*if the msg is not NCOMP and unread, show unread icon*/
            {
                icon_id = IMG_MESSAGE_UNREAD;
            }
            else if (!mmi_frm_sms_check_complete(msg_type, (U16) msg_index) )
            {
                icon_id = IMG_MESSAGE_SS_NCOMP;
            }
            else if (srcBoxType == MMI_FRM_SMS_INBOX)
            {
                icon_id = IMG_MESSAGE_READ;
            }		
            else
            {
                icon_id = IMG_MESSAGE_SENT;
            }
        }
#endif
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    	else if (msg_type == MMI_FRM_SMS_UNSENT)
    	{
    		U8 unsent_status;
    		
    		unsent_status = mmi_frm_sms_get_unsent_status(msg_index);

    		switch (unsent_status)
    		{
    		case MMI_FRM_SMS_APP_WAITING:
    			icon_id = IMG_MESSAGE_WAITING;
    			break;

    		case MMI_FRM_SMS_APP_FAILTOSEND:
    			icon_id = IMG_MESSAGE_FAILTOSENT;
    			break;
    			
    		case MMI_FRM_SMS_APP_SENDING:
    			icon_id = IMG_MESSAGE_SENDING;
    			break;

    		default:
    			MMI_ASSERT(0);
    			break;	
    		}
    	}
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
        else
        {
            if (mmi_frm_sms_check_complete(msg_type, (U16) msg_index) == FALSE)
            {
                icon_id = IMG_SLAVE_MESSAGE_SS_NCOMP;
            }
            else
            {
            #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
                if (msg_type == MMI_FRM_SMS_SIM)
                {
                    msg_type = mmi_frm_sms_get_status(msg_type, (U16) msg_index);
                    msg_type &= 0x0f; 
                    if (msg_type == MMI_FRM_SMS_UNREAD)
                    {
                        icon_id = IMG_SLAVE_MESSAGE_UNREAD;

                        return icon_id;
                    }
                    else if (msg_type == MMI_FRM_SMS_INBOX)
                    {
                        icon_id = IMG_SLAVE_MESSAGE_READ;

                        return icon_id;
                    }
                }
            #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
                {
                    if (msg_type == MMI_FRM_SMS_OUTBOX)
                    {
                        icon_id = IMG_SLAVE_MESSAGE_SENT;
                    }
                    else
                    {
                        icon_id = IMG_SLAVE_MESSAGE_UNSENT;
                    }
                }
            }
        }
    } else {
        if (msg_type == MMI_FRM_SMS_INBOX)
        {
            if ((mmi_frm_sms_get_status(msg_type, (U16) msg_index) & 0x0f) == MMI_FRM_SMS_APP_UNREAD)
            {
                icon_id = IMG_MASTER_MESSAGE_UNREAD;
            }
            else
            {
                if (mmi_frm_sms_check_complete(msg_type, (U16) msg_index) == TRUE)
                {
                    icon_id = IMG_MASTER_MESSAGE_READ;
                }
                else
                {
                    icon_id = IMG_MASTER_MESSAGE_SS_NCOMP;
                }
            }
        }
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__    
        else if (msg_type == MMI_FRM_SMS_ARCHIVE)
        {
            mmi_frm_sms_msgbox_enum srcBoxType = mmi_frm_sms_get_archive_src_box_type(msg_type, msg_index) ; 
    		
            if (srcBoxType == MMI_FRM_SMS_UNREAD)  /*if the msg is not NCOMP and unread, show unread icon*/
            {
                icon_id = IMG_MESSAGE_UNREAD;
            }
            else if (!mmi_frm_sms_check_complete(msg_type, (U16) msg_index) )
            {
                icon_id = IMG_MESSAGE_SS_NCOMP;
            }
            else if (srcBoxType == MMI_FRM_SMS_INBOX)
            {
                icon_id = IMG_MESSAGE_READ;
            }		
            else
            {
                icon_id = IMG_MESSAGE_SENT;
            }
        }
#endif
#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
    	else if (msg_type == MMI_FRM_SMS_UNSENT)
    	{
    		U8 unsent_status;
    		
    		unsent_status = mmi_frm_sms_get_unsent_status(msg_index);

    		switch (unsent_status)
    		{
    		case MMI_FRM_SMS_APP_WAITING:
    			icon_id = IMG_MESSAGE_WAITING;
    			break;

    		case MMI_FRM_SMS_APP_FAILTOSEND:
    			icon_id = IMG_MESSAGE_FAILTOSENT;
    			break;
    			
    		case MMI_FRM_SMS_APP_SENDING:
    			icon_id = IMG_MESSAGE_SENDING;
    			break;

    		default:
    			MMI_ASSERT(0);
    			break;	
    		}
    	}
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */
        else
        {
            if (mmi_frm_sms_check_complete(msg_type, (U16) msg_index) == FALSE)
            {
                icon_id = IMG_MASTER_MESSAGE_SS_NCOMP;
            }
            else
            {
            #ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
                if (msg_type == MMI_FRM_SMS_SIM)
                {
                    msg_type = mmi_frm_sms_get_status(msg_type, (U16) msg_index);
                    msg_type &= 0x0f; 
                    if (msg_type == MMI_FRM_SMS_UNREAD)
                    {
                        icon_id = IMG_MASTER_MESSAGE_UNREAD;

                        return icon_id;
                    }
                    else if (msg_type == MMI_FRM_SMS_INBOX)
                    {
                        icon_id = IMG_MASTER_MESSAGE_READ;

                        return icon_id;
                    }
                }
            #endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */
                {
                    if (msg_type == MMI_FRM_SMS_OUTBOX)
                    {
                        icon_id = IMG_MASTER_MESSAGE_SENT;
                    }
                    else
                    {
                        icon_id = IMG_MASTER_MESSAGE_UNSENT;
                    }
                }
            }
        }
    }
    return icon_id;
}
#endif /* __MMI_DUAL_SIM_MASTER__ */

/*****************************************************************************
 * FUNCTION
 *  mmi_msg_handle_delete_folder_by_um
 * DESCRIPTION
 *  delete sms msg box
 * PARAMETERS
 *  msg_box_type        [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_handle_delete_folder_by_um(UmMsgBoxType msg_box_type)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 index = MMI_FRM_SMS_INVALID_INDEX;
    U8 *bitmap = NULL;
	U8 result = FALSE;
	
    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/	
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
    if ((msg_box_type & UM_MSG_BOX_TYPE_ARCHIVE))
    {
        mmi_frm_sms_delete_archive_folder();
        if (msg_box_type == UM_MSG_BOX_TYPE_ARCHIVE)
		{
			mmi_msg_delete_folder_by_um_callback(NULL, MOD_MMI, MMI_FRM_SMS_OK);
			
			return;
		}	
    }   
#endif

    bitmap = OslMalloc(sizeof(U8) * 480); // 480 > Max umber of archive
    memset((S8*) bitmap, 0, sizeof(U8) * 480);

#ifdef __UNIFIED_MESSAGE_SIMBOX_SUPPORT__
    if ((msg_box_type & UM_MSG_BOX_TYPE_SIM))
    {
        result = mmi_frm_sms_get_sms_bitmap(MMI_FRM_SMS_SIM, index, bitmap);
    }
#endif /* __UNIFIED_MESSAGE_SIMBOX_SUPPORT__ */

    if ((msg_box_type & UM_MSG_BOX_TYPE_INBOX))
    {
        result = mmi_frm_sms_get_sms_bitmap(MMI_FRM_SMS_INBOX, index, bitmap);
    }

    if ((msg_box_type & UM_MSG_BOX_TYPE_SENT))
    {
        result = mmi_frm_sms_get_sms_bitmap(MMI_FRM_SMS_OUTBOX, index, bitmap);
    }

    if ((msg_box_type & UM_MSG_BOX_TYPE_UNSENT))
    {
        result = mmi_frm_sms_get_sms_bitmap(MMI_FRM_SMS_UNSENT, index, bitmap);
    }

    if ((msg_box_type & UM_MSG_BOX_TYPE_DRAFT))
    {
        result = mmi_frm_sms_get_sms_bitmap(MMI_FRM_SMS_DRAFTS, index, bitmap);
    }

	if (result == FALSE)
	{
		mmi_msg_delete_folder_by_um_callback(NULL, MOD_MMI, MMI_FRM_SMS_ERROR);
	}
	else
	{
    	mmi_frm_sms_delete_sms_by_bitmap(mmi_msg_delete_folder_by_um_callback, MOD_MMI, bitmap);
	}
	
    OslMfree(bitmap);
}


/*****************************************************************************
 * FUNCTION
 *  mmi_msg_delete_folder_by_um_callback
 * DESCRIPTION
 *  delete sms msg box
 * PARAMETERS
 *  dummy       [?]         
 *  mod         [IN]        
 *  result      [IN]        
 * RETURNS
 *  void
 *****************************************************************************/
void mmi_msg_delete_folder_by_um_callback(void *dummy, module_type mod, U16 result)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    mmi_um_delete_folder_rsp_struct *msg =
        (mmi_um_delete_folder_rsp_struct*) OslConstructDataPtr(sizeof(mmi_um_delete_folder_rsp_struct));

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (result == MMI_FRM_SMS_OK)
    {
        msg->result = KAL_TRUE;
    }
    else
    {
        msg->result = KAL_FALSE;
    }
#ifdef __UNIFIED_MESSAGE_ARCHIVE_SUPPORT__
    if (mmi_frm_sms_get_archive_del_folder_result() == MMI_FALSE)
    {
        msg->result = KAL_FALSE;
        mmi_frm_sms_clear_archive_del_folder_result();
    }
#endif
    if (mmi_frm_sms_get_sms_list_size(MMI_FRM_SMS_APP_INBOX) == 0)
    {
#ifndef __MMI_DUAL_SIM_MASTER__
        mmi_msg_set_msg_icon(FALSE, FALSE);
#else /* __MMI_DUAL_SIM_MASTER__ */
        MTPNP_PFAL_Refresh_StatusBar_Card1_SMS_Display(MTPNP_FALSE, MTPNP_FALSE);
        MTPNP_PFAL_Refresh_StatusBar_Card2_SMS_Display(MTPNP_FALSE, MTPNP_FALSE);
#endif /* __MMI_DUAL_SIM_MASTER__ */
	}

#ifdef __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__
	mmi_msg_update_unsent_icon();
#endif /* __UNIFIED_MESSAGE_BACKGROUND_SEND_SUPPORT__ */

    msg->msg_type = UM_MSG_TYPE_SMS;
    mmi_msg_send_message(MOD_MMI, MOD_MMI, 0, PRT_MSG_ID_MMI_UM_DELETE_FOLDER_RSP, (oslParaType*) msg, NULL);
}

#endif /* __MMI_UNIFIED_MESSAGE__ */


#if(!UI_DISABLE_EMS_CATEGORY_SCREENS)
#if(!EMS_USE_GSM_EXTENDED)

/* Call after EMSUnpack */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertGSM7BitDefaultEncodingToAscii
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertGSM7BitDefaultEncodingToAscii(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
    {
    #if(EMS_BYTE_ORDER_BIG_ENDIAN)
        c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
    #else 
        c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
    #endif 
        if ((c & 0xff00) != 0)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
        }
        else if (c == EMS_ESCAPE_CHARACTER)
        {
            c = EMS_SPACE_CHARACTER;
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
        }
        else
        {
            if (c == EMS_CR_CHARACTER)
            {
                ForwardCurrentPosition(data, 1);
                CancelCurrentPosition(data, 1);
                BackwardCurrentPosition(data, 1);
            }
            else
            {
                c = DefaultToAsciiArray[c];
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
        }
        if (ForwardCurrentPosition(data, 1) != 1)
        {
            break;
        }
    }
    ResetCurrentPosition(data);
}

/* Call before EMSPack  */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertAsciiEncodingToGSM7BitDefault
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertAsciiEncodingToGSM7BitDefault(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
    {
    #if(EMS_BYTE_ORDER_BIG_ENDIAN)
        c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
    #else 
        c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
    #endif 
        if ((c & 0xff00) == 0)
        {
            c = AsciiToDefaultArray[c];
        }
    #if(EMS_BYTE_ORDER_BIG_ENDIAN)
        textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
        textBuffer[OffsetToText + 0] = (U8) (c >> 8);
    #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
        textBuffer[OffsetToText] = (U8) (c & 0xff);
        textBuffer[OffsetToText + 1] = (U8) (c >> 8);
    #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
        if (ForwardCurrentPosition(data, 1) != 1)
        {
            break;
        }
    }
    ResetCurrentPosition(data);
}

#if defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__)

/* Start : JP */
/* Call after EMSUnpack */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertGSM7BitDefaultEncodingToAsciiWithExtended
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertGSM7BitDefaultEncodingToAsciiWithExtended(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;
    EMSObject *object;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
            if (gui_EMS_input_box_get_next_object(data, &data->CurrentPosition, &c, &object) != 1)
            {
                continue;
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if (c == EMS_ESCAPE_CHARACTER)
            {
                U16 next_char = 0;

            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);

                if (ForwardCurrentPosition(data, 1) != 1)
                {
                    break;
                }
                CancelCurrentPosition(data, 1);
                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
                c = DefaultToExtendedAsciiArray[c];

                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                //textBuffer[OffsetToText]=(U8)(c&0xff);
                //textBuffer[OffsetToText+1]=(U8)(c>>8);
                next_char =
                    (U16) (textBuffer[data->CurrentPosition.OffsetToText] |
                           (textBuffer[data->CurrentPosition.OffsetToText + 1] << 8));

                /* if(ForwardCurrentPosition(data,1)!=1) break; */
                data->CurrentPosition.OffsetToText += ENCODING_LENGTH;  /* JP 20050701 */
                CancelCurrentPosition(data, 1);
                textBufferLength -= ENCODING_LENGTH;    /* JP */

                /* OffsetToText=data->CurrentPosition.OffsetToText; */

                /* c=(U16)(textBuffer[OffsetToText]|(textBuffer[OffsetToText+1]<<8)); */
                c = next_char;
                c = DefaultToExtendedAsciiArray[c];
                if (c == 0x00)
                {
                    textBuffer[OffsetToText] = (U8) (next_char & 0xff);
                    textBuffer[OffsetToText + 1] = (U8) (next_char >> 8);
                    data->CurrentPosition.OffsetToText -= 2;
                }
                else
                {
                    textBuffer[OffsetToText] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 1] = (U8) (c >> 8);
                }
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else
            {
                c = DefaultToAsciiArray[c];
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            /* if(ForwardCurrentPosition(data,1)!=1) break; */
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER_UCS2) c=EMS_EURO_CHARACTER; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    ResetCurrentPosition(data);
}

/* Call before EMSPack  */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertAsciiEncodingToGSM7BitDefaultWithExtended
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertAsciiEncodingToGSM7BitDefaultWithExtended(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;
    EMSObject *object;

#if(EMS_BYTE_ORDER_BIG_ENDIAN)
    U8 ESC_string[] = {0x00, 0x1B};
#else 
    U8 ESC_string[] = {0x1B, 0x00};
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);

    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
            if (gui_EMS_input_box_get_next_object(data, &data->CurrentPosition, &c, &object) != 1)
            {
                continue;
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if (UI_TEST_GSM_EXTENDED(c))
            {
                data->CurrentPosition.OffsetToText -= ENCODING_LENGTH;  /* JP 20050701 */
                AddString(data, ESC_string, 1, NULL);
                OffsetToText = data->CurrentPosition.OffsetToText;
                /* MTK Elvis 20031126 */
                textBufferLength += ENCODING_LENGTH;
                /* MTK end */
                c = ExtendedAsciiToDefaultArray[c];
                data->CurrentPosition.OffsetToText += ENCODING_LENGTH;  /* JP 20050701 */

            }
            else
            {
                c = AsciiToDefaultArray[c];
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            // if(ForwardCurrentPosition(data,1)!=1) break; /* JP */
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER) c=EMS_EURO_CHARACTER_UCS2; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    ResetCurrentPosition(data);
}

#else /* defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__) */ 

/* Call after EMSUnpack */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertGSM7BitDefaultEncodingToAsciiWithExtended
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertGSM7BitDefaultEncodingToAsciiWithExtended(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if ((c & 0xff00) != 0)
            {
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else if (c == EMS_ESCAPE_CHARACTER)
            {
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);

                /* if(ForwardCurrentPosition(data,1)!=1) break; */
                data->CurrentPosition.OffsetToText += 2;
                if ((OffsetToText = data->CurrentPosition.OffsetToText) >= textBufferLength)
                {
                    break;
                }

                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
                c = DefaultToExtendedAsciiArray[c];
                if (c == 0x00)
                {
                    CancelCurrentPosition(data, 1);
                    textBufferLength = data->textLength;
                    data->CurrentPosition.OffsetToText -= 2;
                }
                else
                {
                    textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 0] = (U8) (c >> 8);
                }
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);

                /* if(ForwardCurrentPosition(data,1)!=1) break; */
                data->CurrentPosition.OffsetToText += 2;

                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
                c = DefaultToExtendedAsciiArray[c];
                if (c == 0x00)
                {
                    CancelCurrentPosition(data, 1);
                    textBufferLength = data->textLength;
                    data->CurrentPosition.OffsetToText -= 2;
                }
                else
                {
                    textBuffer[OffsetToText] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 1] = (U8) (c >> 8);
                }
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else
            {
                c = DefaultToAsciiArray[c];
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            /* if(ForwardCurrentPosition(data,1)!=1) break; */
            data->CurrentPosition.OffsetToText += 2;

        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER_UCS2) c=EMS_EURO_CHARACTER; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            /* if(ForwardCurrentPosition(data,1)!=1) break; */
            data->CurrentPosition.OffsetToText += 2;

        }
    }
    ResetCurrentPosition(data);
}

/* Call before EMSPack  */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertAsciiEncodingToGSM7BitDefaultWithExtended
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertAsciiEncodingToGSM7BitDefaultWithExtended(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if ((c & 0xff00) == 0)
            {
                if (c == EMS_ESCAPE_CHARACTER)
                {
                #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                    textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 0] = (U8) (c >> 8);
                #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                    textBuffer[OffsetToText] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 1] = (U8) (c >> 8);
                #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                    /* if(ForwardCurrentPosition(data,1)!=1) break; */
                    data->CurrentPosition.OffsetToText += 2;
                    if ((OffsetToText = data->CurrentPosition.OffsetToText) >= textBufferLength)
                    {
                        break;
                    }
                    OffsetToText = data->CurrentPosition.OffsetToText;

                #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                    c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
                #else 
                    c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
                #endif 
                    c = ExtendedAsciiToDefaultArray[c];
                }
                else
                {
                    c = AsciiToDefaultArray[c];
                }
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            /* if(ForwardCurrentPosition(data,1)!=1) break; */
            data->CurrentPosition.OffsetToText += 2;
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER) c=EMS_EURO_CHARACTER_UCS2; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            /* if(ForwardCurrentPosition(data,1)!=1) break; */
            data->CurrentPosition.OffsetToText += 2;
        }
    }
    ResetCurrentPosition(data);
}

#endif /* defined(__MMI_SMART_MESSAGE_MO__) && !defined(__MMI_MESSAGES_EMS__) */ 
/* End : JP */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertGSM7BitDefaultEncodingToAsciiWithoutEMSlib
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertGSM7BitDefaultEncodingToAsciiWithoutEMSlib(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    data->CurrentPosition.OffsetToText = 0;
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if ((c & 0xff00) != 0)
            {
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else if (c == EMS_ESCAPE_CHARACTER)
            {

                U16 tempOffsetToText = data->CurrentPosition.OffsetToText;

                while ((tempOffsetToText + 2) < textBufferLength)
                {
                    textBuffer[tempOffsetToText] = textBuffer[tempOffsetToText + 2];
                    textBuffer[tempOffsetToText + 1] = textBuffer[tempOffsetToText + 3];
                    tempOffsetToText = tempOffsetToText + 2;
                }
                textBuffer[tempOffsetToText] = 0;
                textBuffer[tempOffsetToText + 1] = 0;
                textBufferLength = textBufferLength - 2;
                data->textLength = data->textLength - 2;

            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                //textBuffer[OffsetToText+1]=(U8)(c&0xff);
                //textBuffer[OffsetToText+0]=(U8)(c>>8);

                if ((data->CurrentPosition.OffsetToText + 2) > textBufferLength)
                {
                    break;
                }
                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
                c = DefaultToExtendedAsciiArray[c];

                if (c == 0x00)
                {
                    data->CurrentPosition.OffsetToText -= 2;
                }
                else
                {
                    textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 0] = (U8) (c >> 8);
                }
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                //textBuffer[OffsetToText]=(U8)(c&0xff);
                //textBuffer[OffsetToText+1]=(U8)(c>>8);

                if ((data->CurrentPosition.OffsetToText + 2) > textBufferLength)
                {
                    break;
                }
                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
                c = DefaultToExtendedAsciiArray[c];

                if (c == 0x00)
                {
                    data->CurrentPosition.OffsetToText -= 2;
                }
                else
                {
                    textBuffer[OffsetToText] = (U8) (c & 0xff);
                    textBuffer[OffsetToText + 1] = (U8) (c >> 8);
                }
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else
            {
                c = DefaultToAsciiArray[c];
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            data->CurrentPosition.OffsetToText += 2;
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER_UCS2) c=EMS_EURO_CHARACTER; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            data->CurrentPosition.OffsetToText += 2;
        }
    }
    data->CurrentPosition.OffsetToText = 0;
}

#else /* (!EMS_USE_GSM_EXTENDED) */ 

/* Call after EMSUnpack */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertGSM7BitDefaultEncodingToAscii
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertGSM7BitDefaultEncodingToAscii(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if (c == EMS_ESCAPE_CHARACTER)
            {
                c = EMS_SPACE_CHARACTER;
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else
            {
                c = DefaultToAsciiArray[c];
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER_UCS2) c=EMS_EURO_CHARACTER; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    ResetCurrentPosition(data);
}

/* Call before EMSPack  */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertAsciiEncodingToGSM7BitDefault
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertAsciiEncodingToGSM7BitDefault(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            c = AsciiToDefaultArray[c];
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER) c=EMS_EURO_CHARACTER_UCS2; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    ResetCurrentPosition(data);
}

/* Call after EMSUnpack */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertGSM7BitDefaultEncodingToAsciiWithExtended
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertGSM7BitDefaultEncodingToAsciiWithExtended(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;
    EMSObject *object;

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);
    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
            if (gui_EMS_input_box_get_next_object(data, &data->CurrentPosition, &c, &object) != 1)
            {
                continue;
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if (c == EMS_ESCAPE_CHARACTER)
            {
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);

                if (ForwardCurrentPosition(data, 1) != 1)
                {
                    break;
                }
                CancelCurrentPosition(data, 1);
                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
                c = DefaultToExtendedAsciiArray[c];

                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);

                if (ForwardCurrentPosition(data, 1) != 1)
                {
                    break;
                }
                CancelCurrentPosition(data, 1);
                OffsetToText = data->CurrentPosition.OffsetToText;

                c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
                c = DefaultToExtendedAsciiArray[c];

                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            else
            {
                c = DefaultToAsciiArray[c];
            #if(EMS_BYTE_ORDER_BIG_ENDIAN)
                textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 0] = (U8) (c >> 8);
            #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
                textBuffer[OffsetToText] = (U8) (c & 0xff);
                textBuffer[OffsetToText + 1] = (U8) (c >> 8);
            #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            }
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER_UCS2) c=EMS_EURO_CHARACTER; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    ResetCurrentPosition(data);
}

/* Call before EMSPack  */


/*****************************************************************************
 * FUNCTION
 *  EMS_ConvertAsciiEncodingToGSM7BitDefaultWithExtended
 * DESCRIPTION
 *  
 * PARAMETERS
 *  data        [?]     
 * RETURNS
 *  void
 *****************************************************************************/
void EMS_ConvertAsciiEncodingToGSM7BitDefaultWithExtended(EMSData *data)
{
    /*----------------------------------------------------------------*/
    /* Local Variables                                                */
    /*----------------------------------------------------------------*/
    U16 c, OffsetToText;
    U8 *textBuffer = data->textBuffer;
    U16 textBufferLength = data->textLength;
    EMSObject *object;

#if(EMS_BYTE_ORDER_BIG_ENDIAN)
    U8 ESC_string[] = {0x00, 0x1B};
#else 
    U8 ESC_string[] = {0x1B, 0x00};
#endif 

    /*----------------------------------------------------------------*/
    /* Code Body                                                      */
    /*----------------------------------------------------------------*/
    if (textBuffer == NULL)
    {
        return;
    }
    ResetCurrentPosition(data);

    if (data->dcs == SMSAL_DEFAULT_DCS)
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
            if (gui_EMS_input_box_get_next_object(data, &data->CurrentPosition, &c, &object) != 1)
            {
                continue;
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            if (UI_TEST_GSM_EXTENDED(c))
            {
                AddString(data, ESC_string, 1, NULL);
                OffsetToText = data->CurrentPosition.OffsetToText;
                /* MTK Elvis 20031126 */
                textBufferLength += ENCODING_LENGTH;
                /* MTK end */
                c = ExtendedAsciiToDefaultArray[c];
            }
            else
            {
                c = AsciiToDefaultArray[c];
            }
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    else
    {
        while ((OffsetToText = data->CurrentPosition.OffsetToText) < textBufferLength)
        {
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            c = (U16) (textBuffer[OffsetToText + 1] | (textBuffer[OffsetToText] << 8));
        #else 
            c = (U16) (textBuffer[OffsetToText] | (textBuffer[OffsetToText + 1] << 8));
        #endif 
            /* if(c==EMS_EURO_CHARACTER) c=EMS_EURO_CHARACTER_UCS2; */
        #if(EMS_BYTE_ORDER_BIG_ENDIAN)
            textBuffer[OffsetToText + 1] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 0] = (U8) (c >> 8);
        #else /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            textBuffer[OffsetToText] = (U8) (c & 0xff);
            textBuffer[OffsetToText + 1] = (U8) (c >> 8);
        #endif /* (EMS_BYTE_ORDER_BIG_ENDIAN) */ 
            if (ForwardCurrentPosition(data, 1) != 1)
            {
                break;
            }
        }
    }
    ResetCurrentPosition(data);
}

#endif /* (!EMS_USE_GSM_EXTENDED) */
#endif /* (!UI_DISABLE_EMS_CATEGORY_SCREENS) */ 


#endif /* __MOD_SMSAL__ */ 

